<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree with Spouse & Children</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 0; padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    #root {
      background: white;
      margin: 20px;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
      width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }
    input[type="text"], input[type="email"], input[type="password"], input[type="date"], select {
      width: 100%;
      padding: 8px 10px;
      margin: 6px 0 12px;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      width: 100%;
      padding: 10px;
      background: #4a90e2;
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #357ABD;
    }
    label {
      display: flex;
      align-items: center;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    label input[type="checkbox"] {
      margin-right: 8px;
      transform: scale(1.2);
    }
    .error {
      color: red;
      margin: 10px 0;
      font-size: 0.9rem;
      text-align: center;
    }
    .member {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .member-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .member-buttons button {
      margin-left: 8px;
      background: #f44336;
      padding: 6px 10px;
      font-size: 0.8rem;
      border-radius: 5px;
      transition: background 0.3s ease;
      cursor: pointer;
      border: none;
    }
    .member-buttons button.edit {
      background: #4caf50;
    }
    .member-buttons button:hover {
      opacity: 0.8;
    }
    .death-symbol {
      color: red;
      font-weight: bold;
      margin-left: 6px;
    }
    .logout-btn {
      background: #e67e22;
      margin-bottom: 20px;
    }
    .toggle-link {
      background: none;
      border: none;
      color: #4a90e2;
      cursor: pointer;
      text-decoration: underline;
      font-size: 0.9rem;
      margin-top: 12px;
      display: block;
      text-align: center;
    }
    .relation-list {
      font-size: 0.9rem;
      color: #555;
      margin-top: -10px;
      margin-bottom: 10px;
      padding-left: 10px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React and ReactDOM from CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const firebaseConfig = {
      apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
      authDomain: "project-955237504610034331.firebaseapp.com",
      databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
      projectId: "project-955237504610034331",
      storageBucket: "project-955237504610034331.firebasestorage.app",
      messagingSenderId: "76212939677",
      appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
      measurementId: "G-RCJ4P82PVM"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    function Login({ onLogin }) {
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [isNewUser, setIsNewUser] = useState(false);
      const [error, setError] = useState("");

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError("");
        try {
          if (isNewUser) {
            await auth.createUserWithEmailAndPassword(email, password);
          } else {
            await auth.signInWithEmailAndPassword(email, password);
          }
          onLogin();
        } catch (err) {
          setError(err.message);
        }
      };

      return (
        <div>
          <h2>{isNewUser ? "Sign Up" : "Sign In"}</h2>
          <form onSubmit={handleSubmit}>
            <input
              type="email"
              placeholder="Email"
              value={email}
              onChange={e => setEmail(e.target.value)}
              required
            />
            <input
              type="password"
              placeholder="Password"
              value={password}
              onChange={e => setPassword(e.target.value)}
              required
            />
            <button type="submit">{isNewUser ? "Sign Up" : "Sign In"}</button>
          </form>
          {error && <p className="error">{error}</p>}
          <button
            className="toggle-link"
            onClick={() => {
              setIsNewUser(!isNewUser);
              setError("");
            }}
          >
            {isNewUser ? "Already have an account? Sign In" : "No account? Sign Up"}
          </button>
        </div>
      );
    }

    function FamilyTree({ onLogout }) {
      const [members, setMembers] = useState({});
      const [form, setForm] = useState({
        id: null,
        name: "",
        birthdate: "",
        death: false,
        spouseId: "",
        childrenIds: []
      });
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const membersRef = db.ref("members");
        membersRef.on("value", snapshot => {
          const data = snapshot.val() || {};
          setMembers(data);
          setLoading(false);
        });

        return () => membersRef.off();
      }, []);

      const handleChange = e => {
        const { name, value, type, checked, options } = e.target;
        if (type === "select-multiple") {
          // multi-select for childrenIds
          const selected = [];
          for (let i = 0; i < options.length; i++) {
            if (options[i].selected) selected.push(options[i].value);
          }
          setForm(f => ({ ...f, [name]: selected }));
        } else if (type === "checkbox") {
          setForm(f => ({ ...f, [name]: checked }));
        } else {
          setForm(f => ({ ...f, [name]: value }));
        }
      };

      const handleSubmit = e => {
        e.preventDefault();
        if (form.name.trim() === "" || form.birthdate === "") return;

        const memberData = {
          name: form.name,
          birthdate: form.birthdate,
          death: form.death,
          spouseId: form.spouseId || null,
          childrenIds: form.childrenIds.length > 0 ? form.childrenIds.reduce((acc, id) => { acc[id] = true; return acc; }, {}) : null
        };

        if (form.id) {
          db.ref("members/" + form.id).update(memberData);
        } else {
          db.ref("members").push(memberData);
        }
        setForm({ id: null, name: "", birthdate: "", death: false, spouseId: "", childrenIds: [] });
      };

      const handleEdit = (id) => {
        const m = members[id];
        setForm({
          id,
          name: m.name || "",
          birthdate: m.birthdate || "",
          death: m.death || false,
          spouseId: m.spouseId || "",
          childrenIds: m.childrenIds ? Object.keys(m.childrenIds) : []
        });
      };

      const handleDelete = (id) => {
        if (confirm("Are you sure you want to delete this member?")) {
          db.ref("members/" + id).remove();
          // Remove references from other members (spouse, children)
          Object.entries(members).forEach(([mid, m]) => {
            let update = false;
            if (m.spouseId === id) {
              db.ref("members/" + mid + "/spouseId").remove();
              update = true;
            }
            if (m.childrenIds && m.childrenIds[id]) {
              db.ref("members/" + mid + "/childrenIds/" + id).remove();
              update = true;
            }
          });
          if (form.id === id) {
            setForm({ id: null, name: "", birthdate: "", death: false, spouseId: "", childrenIds: [] });
          }
        }
      };

      if (loading) return <p>Loading family members...</p>;

      // Filter out current member from spouse and children selects to avoid self reference
      const otherMembers = Object.entries(members).filter(([id]) => id !== form.id);

      // Helper to show member name or fallback
      const getNameById = (id) => {
        return members[id]?.name || "Unknown";
      };

      return (
        <div>
          <button className="logout-btn" onClick={onLogout}>Logout</button>
          <h2>Family Tree</h2>
          <form onSubmit={handleSubmit}>
            <input
              type="text"
              name="name"
              placeholder="Name"
              value={form.name}
              onChange={handleChange}
              required
            />
            <input
              type="date"
              name="birthdate"
              value={form.birthdate}
              onChange={handleChange}
              required
            />
            <label>
              <input
                type="checkbox"
                name="death"
                checked={form.death}
                onChange={handleChange}
              />
              Deceased
            </label>

            <label>Spouse (optional):
              <select
                name="spouseId"
                value={form.spouseId}
                onChange={handleChange}
              >
                <option value="">-- None --</option>
                {otherMembers.map(([id, m]) => (
                  <option key={id} value={id}>{m.name}</option>
                ))}
              </select>
            </label>

            <label>Children (optional):  
              <select
                multiple
                name="childrenIds"
                value={form.childrenIds}
                onChange={handleChange}
                size={Math.min(5, otherMembers.length)}
              >
                {otherMembers.map(([id, m]) => (
                  <option key={id} value={id}>{m.name}</option>
                ))}
              </select>
            </label>

            <button type="submit">{form.id ? "Update" : "Add"} Member</button>
          </form>

          <div style={{ marginTop: "20px" }}>
            {Object.entries(members).length === 0 && <p>No members yet</p>}
            {Object.entries(members).map(([id, m]) => (
              <div key={id} className="member">
                <div className="member-header">
                  <div>
                    <strong>{m.name}</strong>{" "}
                    <span>(b: {m.birthdate})</span>
                    {m.death && <span className="death-symbol">†</span>}
                  </div>
                  <div className="member-buttons">
                    <button className="edit" onClick={() => handleEdit(id)}>Edit</button>
                    <button onClick={() => handleDelete(id)}>Delete</button>
                  </div>
                </div>
                <div className="relation-list">
                  <div>Spouse: {m.spouseId ? getNameById(m.spouseId) : "None"}</div>
                  <div>Children: {m.childrenIds ? Object.keys(m.childrenIds).map(cid => getNameById(cid)).join(", ") : "None"}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged((user) => {
          setUser(user);
          setLoading(false);
        });
        return unsubscribe;
      }, []);

      if (loading) return <p style={{textAlign: "center"}}>Loading...</p>;

      if (!user) return <Login onLogin={() => setUser(auth.currentUser)} />;

      return <FamilyTree onLogout={() => auth.signOut()} />;
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
