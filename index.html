<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree</title>
  <style>
    /* ... (keep all your existing styles exactly as is) ... */
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
    }
    #login-container, #app-container {
      max-width: 700px;
      margin: 40px auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
      padding: 20px;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      box-sizing: border-box;
    }
    input[type="text"], input[type="date"], input[type="email"], input[type="password"] {
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      cursor: pointer;
      border-radius: 4px;
      border: none;
      background-color: #2563eb;
      color: white;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #1e40af;
    }
    #login-btn, #logout-btn {
      width: 100%;
    }
    #birthday-notifications {
      background: #d1fae5;
      color: #065f46;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 6px;
      font-weight: bold;
    }
    .tree-node {
      margin-left: 20px;
      position: relative;
      border-left: 1px dashed #ccc;
      padding-left: 12px;
      margin-bottom: 8px;
    }
    .node-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }
    .arrow {
      display: inline-block;
      width: 16px;
      user-select: none;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .arrow.collapsed {
      transform: rotate(-90deg);
    }
    input[type="text"].name-input {
      width: 140px;
    }
    input[type="date"].birthday-input,
    input[type="date"].died-input {
      width: 130px;
    }
    .node-buttons {
      display: flex;
      gap: 8px;
      margin-left: auto;
      flex-wrap: nowrap;
    }
    .node-buttons button {
      font-size: 0.85rem;
      padding: 4px 10px;
      width: auto;
    }
    .node-buttons button.add-child-btn {
      background-color: #10b981;
    }
    .node-buttons button.add-spouse-btn {
      background-color: #3b82f6;
    }
    .node-buttons button.delete-btn {
      background-color: #ef4444;
    }
    .node-buttons button:hover {
      filter: brightness(85%);
    }
    .add-child-form, .add-spouse-form {
      margin-left: 36px;
      margin-bottom: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .add-child-form input[type="text"], .add-spouse-form input[type="text"],
    .add-child-form input[type="date"], .add-spouse-form input[type="date"] {
      font-size: 0.9rem;
      padding: 5px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .add-child-form input[type="text"], .add-spouse-form input[type="text"] {
      width: 140px;
    }
    .add-child-form input[type="date"], .add-spouse-form input[type="date"] {
      width: 130px;
    }
    .add-child-form button, .add-spouse-form button {
      background-color: #10b981;
      padding: 6px 12px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      color: white;
    }
    .add-child-form button:hover, .add-spouse-form button:hover {
      filter: brightness(90%);
    }
    #add-root-container {
      margin-bottom: 20px;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 6px;
      background: #f3f4f6;
    }
    #add-root-container h3 {
      margin-top: 0;
    }
    #add-root-form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    #add-root-form input[type="text"], #add-root-form input[type="date"] {
      flex: 1 1 180px;
      padding: 8px;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #add-root-form button {
      flex: 0 0 auto;
      background-color: #2563eb;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      color: white;
    }

    /* --- Improved Login Page Styles --- */
    #login-container {
      max-width: 400px;
      padding: 30px 40px;
      box-shadow: 0 8px 24px rgb(0 0 0 / 0.2);
      border-radius: 12px;
      background: white;
    }
    #login-container h2 {
      text-align: center;
      margin-bottom: 25px;
      font-weight: 700;
      color: #2563eb;
    }
    #login-container input {
      width: 100%;
      margin-bottom: 15px;
      font-size: 1.1rem;
      padding: 12px;
      border: 2px solid #ccc;
      border-radius: 8px;
      transition: border-color 0.3s;
    }
    #login-container input:focus {
      border-color: #2563eb;
      outline: none;
    }
    #login-btn {
      font-size: 1.1rem;
      padding: 12px;
      border-radius: 8px;
    }

    /* Horizontal scrolling container for family tree */
    #family-trees-container {
      overflow-x: auto;
      overflow-y: auto;
      white-space: nowrap;
      padding-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fefefe;
      max-height: 600px;
    }
    #family-trees-container > div {
      display: inline-block;
      vertical-align: top;
      white-space: normal;
      min-width: 400px;
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script> <!-- For OAuth -->

</head>
<body>

<div id="login-container">
  <h2>Login to Family Tree</h2>
  <input id="email" type="email" placeholder="Email" autocomplete="username" />
  <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
  <button id="login-btn">Login</button>

</div>

<div id="app-container" style="display:none;">
  <div id="birthday-notifications"></div>
  <button id="logout-btn">Logout</button>

  <div id="add-root-container">
    <h3>Add Root Person</h3>
    <form id="add-root-form">
      <input type="text" id="root-name" placeholder="Name" required />
      <input type="date" id="root-birthday" required />
      <button type="submit">Add Root Person</button>
    </form>
  </div>

  <div id="family-trees-container"></div>
</div>

<script>
  // Firebase config - replace with your own config here
  const firebaseConfig = {
  apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
  authDomain: "project-955237504610034331.firebaseapp.com",
  databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
  projectId: "project-955237504610034331",
  storageBucket: "project-955237504610034331.firebasestorage.app",
  messagingSenderId: "76212939677",
  appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
  measurementId: "G-RCJ4P82PVM"
};
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  const loginContainer = document.getElementById('login-container');
  const appContainer = document.getElementById('app-container');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const birthdayNotifications = document.getElementById('birthday-notifications');
  const familyTreesContainer = document.getElementById('family-trees-container');
  const addRootForm = document.getElementById('add-root-form');
  const rootNameInput = document.getElementById('root-name');
  const rootBirthdayInput = document.getElementById('root-birthday');

  // Authenticate user
  loginBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) {
      alert("Please enter email and password.");
      return;
    }
    try {
      await auth.signInWithEmailAndPassword(email, password);
    } catch (e) {
      alert("Login failed: " + e.message);
    }
  };

  logoutBtn.onclick = async () => {
    await auth.signOut();
  };

  auth.onAuthStateChanged(async user => {
    if (user) {
      loginContainer.style.display = 'none';
      appContainer.style.display = 'block';
      loadFamilyTrees(user.uid);
      setupBirthdayCheck(user.uid);
    } else {
      loginContainer.style.display = 'block';
      appContainer.style.display = 'none';
    }
  });

  // Load family trees for user
  async function loadFamilyTrees(uid) {
    familyTreesContainer.innerHTML = '';
    const snapshot = await db.ref('familyTrees').orderByChild('owner').equalTo(uid).once('value');
    const trees = snapshot.val();
    if (!trees) {
      familyTreesContainer.textContent = "No family trees found. Add a root person to get started.";
      return;
    }
    for (const treeId in trees) {
      const treeDiv = document.createElement('div');
      treeDiv.className = 'family-tree';
      familyTreesContainer.appendChild(treeDiv);
      renderPerson(trees[treeId].root, treeDiv, treeId, null);
    }
  }

  // Save family tree back to Firebase
  async function saveFamilyTree(treeId, root) {
    await db.ref('familyTrees/' + treeId + '/root').set(root);
  }

  // Render person recursively
  function renderPerson(person, container, treeId, parentNode) {
    if (!person) return;

    const nodeDiv = document.createElement('div');
    nodeDiv.className = 'tree-node';

    // Header with arrow and name input, birthday input, died input, and buttons
    const header = document.createElement('div');
    header.className = 'node-header';

    const arrow = document.createElement('span');
    arrow.textContent = '▼';
    arrow.className = 'arrow';
    if (!person.children || person.children.length === 0) {
      arrow.style.visibility = 'hidden';
    }
    header.appendChild(arrow);

    // Name input
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.className = 'name-input';
    nameInput.value = person.name || '';
    nameInput.title = "Click to edit name";
    header.appendChild(nameInput);

    // Birthday input
    const birthdayInput = document.createElement('input');
    birthdayInput.type = 'date';
    birthdayInput.className = 'birthday-input';
    birthdayInput.value = person.birthday || '';
    birthdayInput.title = "Click to edit birthday";
    header.appendChild(birthdayInput);

    // Died input (new)
    const diedInput = document.createElement('input');
    diedInput.type = 'date';
    diedInput.className = 'died-input';
    diedInput.value = person.died || '';
    diedInput.title = "Click to edit died date";
    header.appendChild(diedInput);

    // Buttons container
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'node-buttons';

    // Add child button
    const addChildBtn = document.createElement('button');
    addChildBtn.textContent = 'Add Child';
    addChildBtn.className = 'add-child-btn';
    buttonsDiv.appendChild(addChildBtn);

    // Add spouse button
    const addSpouseBtn = document.createElement('button');
    addSpouseBtn.textContent = 'Add Spouse';
    addSpouseBtn.className = 'add-spouse-btn';
    buttonsDiv.appendChild(addSpouseBtn);

    // Delete button
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Delete';
    deleteBtn.className = 'delete-btn';
    buttonsDiv.appendChild(deleteBtn);

    header.appendChild(buttonsDiv);
    nodeDiv.appendChild(header);
    container.appendChild(nodeDiv);

    // Children container
    const childrenContainer = document.createElement('div');
    childrenContainer.className = 'children-container';
    nodeDiv.appendChild(childrenContainer);

    // Spouse container (render spouse as a node sibling, but indented)
    if (person.spouse) {
      const spouseDiv = document.createElement('div');
      spouseDiv.className = 'tree-node';
      spouseDiv.style.marginLeft = '30px';

      const spouseHeader = document.createElement('div');
      spouseHeader.className = 'node-header';

      const spouseArrow = document.createElement('span');
      spouseArrow.textContent = '▶';
      spouseArrow.className = 'arrow collapsed';
      spouseArrow.style.visibility = 'hidden'; // spouse has no children displayed as subtree here
      spouseHeader.appendChild(spouseArrow);

      // Spouse name input
      const spouseNameInput = document.createElement('input');
      spouseNameInput.type = 'text';
      spouseNameInput.className = 'name-input';
      spouseNameInput.value = person.spouse.name || '';
      spouseNameInput.title = "Click to edit spouse's name";
      spouseHeader.appendChild(spouseNameInput);

      // Spouse birthday input
      const spouseBirthdayInput = document.createElement('input');
      spouseBirthdayInput.type = 'date';
      spouseBirthdayInput.className = 'birthday-input';
      spouseBirthdayInput.value = person.spouse.birthday || '';
      spouseBirthdayInput.title = "Click to edit spouse's birthday";
      spouseHeader.appendChild(spouseBirthdayInput);

      // Spouse died input (new)
      const spouseDiedInput = document.createElement('input');
      spouseDiedInput.type = 'date';
      spouseDiedInput.className = 'died-input';
      spouseDiedInput.value = person.spouse.died || '';
      spouseDiedInput.title = "Click to edit spouse's died date";
      spouseHeader.appendChild(spouseDiedInput);

      // Spouse delete button
      const spouseDeleteBtn = document.createElement('button');
      spouseDeleteBtn.textContent = 'Delete Spouse';
      spouseDeleteBtn.className = 'delete-btn';
      spouseDeleteBtn.style.marginLeft = 'auto';
      spouseHeader.appendChild(spouseDeleteBtn);

      spouseDiv.appendChild(spouseHeader);
      container.appendChild(spouseDiv);

      // Spouse delete handler
      spouseDeleteBtn.onclick = async () => {
        if (confirm(`Delete spouse ${person.spouse.name}?`)) {
          delete person.spouse;
          await saveFamilyTree(treeId, personRoot(treeId));
          container.innerHTML = '';
          renderPerson(personRoot(treeId), container.parentNode, treeId, null);
        }
      };

      // Spouse name edit handler
      spouseNameInput.oninput = () => {
        person.spouse.name = spouseNameInput.value;
        saveFamilyTree(treeId, personRoot(treeId));
      };

      // Spouse birthday edit handler
      spouseBirthdayInput.onchange = () => {
        person.spouse.birthday = spouseBirthdayInput.value;
        saveFamilyTree(treeId, personRoot(treeId));
        checkBirthdays();
      };

      // Spouse died edit handler (new)
      spouseDiedInput.onchange = () => {
        person.spouse.died = spouseDiedInput.value;
        saveFamilyTree(treeId, personRoot(treeId));
      };
    }

    // Arrow toggle children visibility
    arrow.onclick = () => {
      if (arrow.classList.contains('collapsed')) {
        arrow.classList.remove('collapsed');
        childrenContainer.style.display = 'block';
      } else {
        arrow.classList.add('collapsed');
        childrenContainer.style.display = 'none';
      }
    };

    // Initially collapse children if any
    if (person.children && person.children.length > 0) {
      arrow.classList.remove('collapsed');
      childrenContainer.style.display = 'block';
    } else {
      arrow.classList.add('collapsed');
      childrenContainer.style.display = 'none';
    }

    // Name edit
    nameInput.oninput = () => {
      person.name = nameInput.value;
      saveFamilyTree(treeId, personRoot(treeId));
    };

    // Birthday edit
    birthdayInput.onchange = () => {
      person.birthday = birthdayInput.value;
      saveFamilyTree(treeId, personRoot(treeId));
      checkBirthdays();
    };

    // Died edit (new)
    diedInput.onchange = () => {
      person.died = diedInput.value;
      saveFamilyTree(treeId, personRoot(treeId));
    };

    // Add child
    addChildBtn.onclick = () => {
      if (nodeDiv.querySelector('.add-child-form')) return; // Prevent multiple forms

      const form = document.createElement('form');
      form.className = 'add-child-form';

      const nameInp = document.createElement('input');
      nameInp.type = 'text';
      nameInp.placeholder = 'Child Name';
      nameInp.required = true;
      form.appendChild(nameInp);

      const birthdayInp = document.createElement('input');
      birthdayInp.type = 'date';
      birthdayInp.required = true;
      form.appendChild(birthdayInp);

      const diedInp = document.createElement('input');  // Died date for child
      diedInp.type = 'date';
      diedInp.placeholder = 'Died (optional)';
      form.appendChild(diedInp);

      const submitBtn = document.createElement('button');
      submitBtn.type = 'submit';
      submitBtn.textContent = 'Add';
      form.appendChild(submitBtn);

      nodeDiv.appendChild(form);

      form.onsubmit = async (e) => {
        e.preventDefault();
        const newChild = {
          name: nameInp.value,
          birthday: birthdayInp.value,
        };
        if(diedInp.value) newChild.died = diedInp.value;
        if (!person.children) person.children = [];
        person.children.push(newChild);
        await saveFamilyTree(treeId, personRoot(treeId));
        container.innerHTML = '';
        renderPerson(personRoot(treeId), container.parentNode, treeId, null);
      };
    };

    // Add spouse
    addSpouseBtn.onclick = () => {
      if (person.spouse) {
        alert("Spouse already exists.");
        return;
      }
      if (nodeDiv.querySelector('.add-spouse-form')) return; // Prevent multiple forms

      const form = document.createElement('form');
      form.className = 'add-spouse-form';

      const nameInp = document.createElement('input');
      nameInp.type = 'text';
      nameInp.placeholder = 'Spouse Name';
      nameInp.required = true;
      form.appendChild(nameInp);

      const birthdayInp = document.createElement('input');
      birthdayInp.type = 'date';
      birthdayInp.required = true;
      form.appendChild(birthdayInp);

      const diedInp = document.createElement('input'); // Died date for spouse
      diedInp.type = 'date';
      diedInp.placeholder = 'Died (optional)';
      form.appendChild(diedInp);

      const submitBtn = document.createElement('button');
      submitBtn.type = 'submit';
      submitBtn.textContent = 'Add';
      form.appendChild(submitBtn);

      nodeDiv.appendChild(form);

      form.onsubmit = async (e) => {
        e.preventDefault();
        person.spouse = {
          name: nameInp.value,
          birthday: birthdayInp.value,
        };
        if(diedInp.value) person.spouse.died = diedInp.value;
        await saveFamilyTree(treeId, personRoot(treeId));
        container.innerHTML = '';
        renderPerson(personRoot(treeId), container.parentNode, treeId, null);
      };
    };

    // Delete person
    deleteBtn.onclick = async () => {
      if (!confirm(`Delete ${person.name} and all descendants?`)) return;
      if (!parentNode) {
        // root node delete whole tree
        await db.ref('familyTrees/' + treeId).remove();
        familyTreesContainer.innerHTML = '';
        familyTreesContainer.textContent = "No family trees found. Add a root person to get started.";
        return;
      }

      // Remove this person from parent's children array
      const idx = parentNode.children.indexOf(person);
      if (idx !== -1) {
        parentNode.children.splice(idx, 1);
        await saveFamilyTree(treeId, personRoot(treeId));
        container.parentNode.innerHTML = '';
        renderPerson(personRoot(treeId), container.parentNode, treeId, null);
      }
    };

    // Render children recursively
    if (person.children && person.children.length > 0) {
      for (const child of person.children) {
        renderPerson(child, childrenContainer, treeId, person);
      }
    }
  }

  // Returns the root person of a tree from container's treeId
  // (This assumes only one root per tree, simplifies tree structure)
  function personRoot(treeId) {
    return db.ref('familyTrees/' + treeId + '/root').get().then(snap => snap.val());
  }

  // Add root person handler
  addRootForm.onsubmit = async (e) => {
    e.preventDefault();
    const name = rootNameInput.value.trim();
    const birthday = rootBirthdayInput.value;
    if (!name || !birthday) {
      alert("Name and birthday required.");
      return;
    }
    const newTreeRef = db.ref('familyTrees').push();
    await newTreeRef.set({
      owner: auth.currentUser.uid,
      root: { name, birthday }
    });
    rootNameInput.value = '';
    rootBirthdayInput.value = '';
    loadFamilyTrees(auth.currentUser.uid);
  };

  // Birthday check function
  function setupBirthdayCheck(uid) {
    db.ref('familyTrees').orderByChild('owner').equalTo(uid).on('value', snapshot => {
      const trees = snapshot.val();
      const today = new Date();
      let notifications = [];
      if (trees) {
        for (const treeId in trees) {
          const root = trees[treeId].root;
          traverseAndCheckBirthday(root, today, notifications);
        }
      }
      if (notifications.length > 0) {
        birthdayNotifications.textContent = "Birthdays Today: " + notifications.join(', ');
      } else {
        birthdayNotifications.textContent = '';
      }
    });
  }

  function traverseAndCheckBirthday(person, today, notifications) {
    if (!person) return;
    if (person.birthday && !person.died) {
      const bdate = new Date(person.birthday);
      if (bdate.getDate() === today.getDate() && bdate.getMonth() === today.getMonth()) {
        notifications.push(person.name);
      }
    }
    if (person.spouse) {
      if (person.spouse.birthday && !person.spouse.died) {
        const bdate = new Date(person.spouse.birthday);
        if (bdate.getDate() === today.getDate() && bdate.getMonth() === today.getMonth()) {
          notifications.push(person.spouse.name + " (spouse)");
        }
      }
    }
    if (person.children && person.children.length > 0) {
      for (const child of person.children) {
        traverseAndCheckBirthday(child, today, notifications);
      }
    }
  }

  // Re-check birthdays on input changes
  function checkBirthdays() {
    const user = auth.currentUser;
    if (user) {
      setupBirthdayCheck(user.uid);
    }
  }
</script>

</body>
</html>
