<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Family Tree</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <style>
    #cy { width: 100%; height: 80vh; border: 1px solid #ccc; }
    #login { margin-bottom: 10px; }
  </style>
</head>
<body>
  <div id="login">
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button onclick="login()">Login</button>
    <button onclick="signup()">Signup</button>
    <button onclick="logout()">Logout</button>
  </div>
  <div>
    <button onclick="addMember()">Add Member</button>
    <button onclick="checkBirthdays()">Check Birthdays</button>
  </div>
  <div id="cy"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
      authDomain: "project-955237504610034331.firebaseapp.com",
      databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
      projectId: "project-955237504610034331",
      storageBucket: "project-955237504610034331.firebasestorage.app",
      messagingSenderId: "76212939677",
      appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
      measurementId: "G-RCJ4P82PVM"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let cy;

    function initCytoscape(familyData) {
      const elements = [];
      for (const key in familyData) {
        const member = familyData[key];
        elements.push({ data: { id: key, label: `${member.name}\n${member.birthday}` } });
        if (member.parentId) {
          elements.push({ data: { id: `${member.parentId}-${key}`, source: member.parentId, target: key } });
        }
      }
      cy = cytoscape({
        container: document.getElementById('cy'),
        elements: elements,
        layout: { name: 'breadthfirst' },
        style: [
          {
            selector: 'node',
            style: {
              'label': 'data(label)',
              'text-valign': 'center',
              'text-halign': 'center',
              'background-color': '#61bffc'
            }
          },
          {
            selector: 'edge',
            style: { 'width': 3, 'line-color': '#ccc' }
          }
        ]
      });

      cy.on('tap', 'node', function(evt){
        const id = evt.target.id();
        const member = familyData[id];
        const newName = prompt("Edit name", member.name);
        const newBday = prompt("Edit birthday (YYYY-MM-DD)", member.birthday);
        if (newName && newBday) {
          db.ref('family/' + id).update({ name: newName, birthday: newBday });
        }
        if (confirm("Delete this member?")) {
          db.ref('family/' + id).remove();
        }
      });
    }

    function loadFamilyTree() {
      db.ref('family').on('value', (snap) => {
        const data = snap.val() || {};
        if (cy) cy.destroy();
        initCytoscape(data);
      });
    }

    function addMember() {
      const name = prompt("Name:");
      const birthday = prompt("Birthday (YYYY-MM-DD):");
      const parentId = prompt("Parent ID (optional):");
      if (name && birthday) {
        const newRef = db.ref('family').push();
        newRef.set({ name, birthday, parentId: parentId || null });
      }
    }

    function login() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, pass).catch(err => alert(err.message));
    }

    function signup() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      auth.createUserWithEmailAndPassword(email, pass).catch(err => alert(err.message));
    }

    function logout() {
      auth.signOut();
    }

    auth.onAuthStateChanged(user => {
      if (user) loadFamilyTree();
      else { if (cy) cy.destroy(); }
    });

    function checkBirthdays() {
      db.ref('family').once('value').then(snap => {
        const data = snap.val() || {};
        const today = new Date().toISOString().slice(5, 10);
        const birthdays = [];
        for (const key in data) {
          const bday = data[key].birthday?.slice(5, 10);
          if (bday === today) birthdays.push(data[key].name);
        }
        if (birthdays.length) alert("Today's Birthdays:\n" + birthdays.join('\n'));
        else alert("No birthdays today.");
      });
    }
  </script>
</body>
</html>

<!-- Firebase Cloud Function (index.js) -->
// Deploy using: firebase deploy --only functions
const functions = require("firebase-functions");
const admin = require("firebase-admin");
admin.initializeApp();

exports.dailyBirthdayNotifier = functions.pubsub.schedule("every day 09:00").timeZone("Asia/Manila").onRun(async (context) => {
  const snapshot = await admin.database().ref("family").once("value");
  const members = snapshot.val() || {};
  const today = new Date().toISOString().slice(5, 10);
  const names = [];

  for (const key in members) {
    const bday = members[key].birthday?.slice(5, 10);
    if (bday === today) names.push(members[key].name);
  }

  if (names.length) {
    console.log("Today's birthdays:", names.join(", "));
    // Extend here to send email/push notifications
  } else {
    console.log("No birthdays today.");
  }

  return null;
});
