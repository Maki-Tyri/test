<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree Editable with Search</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    .children-container {
      transition: max-height 0.3s ease, opacity 0.3s ease;
      overflow: hidden;
    }
    .highlight {
      background-color: #ffe58f;
      border-radius: 0.25rem;
      box-shadow: 0 0 8px 2px #ffd666aa;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">

  <div id="root" class="w-full max-w-4xl bg-white p-6 rounded shadow"></div>

  <script type="text/babel">

    const { useState, useRef, useEffect } = React;
    let nextId = 100;

    const initialFamilyData = {
      id: 1,
      name: "Lolo",
      spouses: [
        { id: 1, name: "Lola", birthday: "1932-02-14", deathday: "2005-11-20" },
        { id: 2, name: "Lola 2", birthday: "1935-03-01", deathday: "" }
      ],
      birthday: "1930-01-01",
      deathday: "2000-12-31",
      children: [
        {
          id: 2,
          name: "Tito",
          spouses: [
            { id: 3, name: "Tita", birthday: "1962-06-15", deathday: "" }
          ],
          birthday: "1960-05-20",
          deathday: "",
          children: [
            { id: 3, name: "Anak ni Tito 1", spouses: [], birthday: "1985-04-15", deathday: "" },
            { id: 4, name: "Anak ni Tito 2", spouses: [], birthday: "1987-09-10", deathday: "" },
          ],
        },
        {
          id: 5,
          name: "Tita",
          spouses: [
            { id: 6, name: "Tito", birthday: "1961-07-07", deathday: "" }
          ],
          birthday: "1965-08-30",
          deathday: "",
          children: [
            { id: 6, name: "Anak ni Tita 1", spouses: [], birthday: "1990-02-25", deathday: "" },
          ],
        },
      ],
    };

    function EditableField({ label, value, type = "text", onChange }) {
      const [editing, setEditing] = useState(false);
      const [tempValue, setTempValue] = useState(value || "");

      function save() {
        onChange(tempValue);
        setEditing(false);
      }

      return (
        <div className="flex items-center space-x-1 text-sm text-gray-700">
          <span className="font-semibold">{label}:</span>
          {editing ? (
            type === "date" ? (
              <input
                type="date"
                value={tempValue}
                onChange={e => setTempValue(e.target.value)}
                onBlur={save}
                onKeyDown={e => { if (e.key === "Enter") save(); }}
                autoFocus
                className="border border-gray-300 rounded px-1 py-0.5 w-32"
              />
            ) : (
              <input
                type="text"
                value={tempValue}
                onChange={e => setTempValue(e.target.value)}
                onBlur={save}
                onKeyDown={e => { if (e.key === "Enter") save(); }}
                autoFocus
                className="border border-gray-300 rounded px-1 py-0.5 w-32"
              />
            )
          ) : (
            <span
              className="cursor-pointer hover:text-blue-600"
              onClick={() => setEditing(true)}
              title={`Click to edit ${label.toLowerCase()}`}
            >
              {value || <em className="text-gray-400">(none)</em>}
            </span>
          )}
        </div>
      );
    }

    function SpouseItem({ spouse, onUpdate, onDelete, highlight }) {
      const [editName, setEditName] = useState(false);
      const [tempName, setTempName] = useState(spouse.name);
      const [showDates, setShowDates] = useState(false);

      function saveName() {
        onUpdate({ ...spouse, name: tempName });
        setEditName(false);
      }

      function updateField(field, val) {
        onUpdate({ ...spouse, [field]: val });
      }

      return (
        <div className={`flex items-center space-x-2 text-sm text-gray-700 italic ${highlight ? "highlight" : ""}`}>
          {/* Name */}
          {editName ? (
            <input
              type="text"
              value={tempName}
              onChange={e => setTempName(e.target.value)}
              onBlur={saveName}
              onKeyDown={e => { if (e.key === "Enter") saveName(); }}
              autoFocus
              className="border border-gray-400 rounded px-1 py-0.5 w-32"
            />
          ) : (
            <span
              className="cursor-pointer hover:text-blue-600"
              onClick={() => setShowDates(!showDates)}
              title="Click to toggle spouse details"
              onDoubleClick={() => setEditName(true)}
            >
              {spouse.name || <em>(unnamed)</em>}
            </span>
          )}

          {/* Birthday & Deathday - toggle visible */}
          {showDates && (
            <>
              <EditableField
                label="Bday"
                type="date"
                value={spouse.birthday}
                onChange={val => updateField("birthday", val)}
              />
              <EditableField
                label="Dday"
                type="date"
                value={spouse.deathday}
                onChange={val => updateField("deathday", val)}
              />
              <button
                onClick={() => onDelete(spouse.id)}
                className="text-red-600 hover:text-red-800 font-bold select-none"
                title="Delete spouse"
              >
                ×
              </button>
            </>
          )}
        </div>
      );
    }

    function TreeNode({
      node,
      onUpdate,
      onDelete,
      highlightIds = new Set(),
      ancestorsOpenIds = new Set(),
      descendantsOpenIds = new Set(),
      scrollToId = null,
      onScrollHandled,
    }) {
      const [open, setOpen] = useState(false);
      const [editName, setEditName] = useState(false);
      const [tempName, setTempName] = useState(node.name);
      const [showDates, setShowDates] = useState(false);
      const ref = useRef(null);

      useEffect(() => {
        if (
          ancestorsOpenIds.has(node.id) ||
          descendantsOpenIds.has(node.id) ||
          node.id === scrollToId
        ) {
          setOpen(true);
        }
      }, [ancestorsOpenIds, descendantsOpenIds, scrollToId]);

      useEffect(() => {
        if (scrollToId === node.id && ref.current) {
          ref.current.scrollIntoView({ behavior: "smooth", block: "center" });
          onScrollHandled && onScrollHandled();
        }
      }, [scrollToId]);

      function updateNode(newNode) {
        onUpdate(newNode);
      }

      function saveName() {
        updateNode({ ...node, name: tempName });
        setEditName(false);
      }

      function updateBirthday(val) {
        updateNode({ ...node, birthday: val });
      }

      function updateDeathday(val) {
        updateNode({ ...node, deathday: val });
      }

      function addChild() {
        const newChild = {
          id: nextId++,
          name: "New Child",
          spouses: [],
          birthday: "",
          deathday: "",
          children: [],
        };
        const newChildren = node.children ? [...node.children, newChild] : [newChild];
        updateNode({ ...node, children: newChildren });
        setOpen(true);
      }

      function handleDelete() {
        if (confirm(`Delete ${node.name} and all descendants?`)) {
          onDelete(node.id);
        }
      }

      function updateChild(updatedChild) {
        const newChildren = (node.children || []).map(c =>
          c.id === updatedChild.id ? updatedChild : c
        );
        updateNode({ ...node, children: newChildren });
      }

      function deleteChild(id) {
        const newChildren = (node.children || []).filter(c => c.id !== id);
        updateNode({ ...node, children: newChildren });
      }

      // Spouse handlers
      function addSpouse() {
        if (!node.spouses) node.spouses = [];
        if (node.spouses.length >= 2) return;
        const newSpouse = {
          id: nextId++,
          name: "New Spouse",
          birthday: "",
          deathday: "",
        };
        const newSpouses = [...node.spouses, newSpouse];
        updateNode({ ...node, spouses: newSpouses });
      }

      function updateSpouse(updatedSpouse) {
        const newSpouses = node.spouses.map(s => (s.id === updatedSpouse.id ? updatedSpouse : s));
        updateNode({ ...node, spouses: newSpouses });
      }

      function deleteSpouse(id) {
        const newSpouses = node.spouses.filter(s => s.id !== id);
        updateNode({ ...node, spouses: newSpouses });
      }

      const highlight = highlightIds.has(node.id);

      return (
        <div
          ref={ref}
          className={`border-l border-gray-300 pl-4 mb-4 ${highlight ? "highlight" : ""}`}
        >
          <div className="flex items-center space-x-2">
            <button
              onClick={() => setOpen(!open)}
              className="select-none text-blue-600 font-bold"
              title={open ? "Collapse children" : "Expand children"}
            >
              {open ? "▼" : "▶"}
            </button>

            {editName ? (
              <input
                type="text"
                value={tempName}
                onChange={e => setTempName(e.target.value)}
                onBlur={saveName}
                onKeyDown={e => { if (e.key === "Enter") saveName(); }}
                autoFocus
                className="border border-gray-400 rounded px-1 py-0.5 w-48"
              />
            ) : (
              <span
                className="cursor-pointer font-semibold text-lg hover:text-blue-700"
                onClick={() => setShowDates(!showDates)}
                onDoubleClick={() => setEditName(true)}
                title="Click to toggle dates, double-click to edit name"
              >
                {node.name || <em>(unnamed)</em>}
              </span>
            )}

            {/* Add spouse button */}
            <div className="flex space-x-2 ml-4">
              {node.spouses && node.spouses.length > 0 ? (
                node.spouses.map(spouse => (
                  <SpouseItem
                    key={spouse.id}
                    spouse={spouse}
                    onUpdate={updateSpouse}
                    onDelete={deleteSpouse}
                    highlight={highlightIds.has(spouse.id)}
                  />
                ))
              ) : (
                <span className="italic text-gray-400">(no spouses)</span>
              )}

              {(!node.spouses || node.spouses.length < 2) && (
                <button
                  onClick={addSpouse}
                  className="ml-2 text-green-600 font-bold select-none"
                  title="Add spouse"
                >
                  +
                </button>
              )}
            </div>

            <button
              onClick={addChild}
              className="ml-auto text-green-700 font-bold select-none"
              title="Add child"
            >
              + Child
            </button>

            {node.id !== 1 && (
              <button
                onClick={handleDelete}
                className="ml-2 text-red-600 font-bold select-none"
                title="Delete person"
              >
                ×
              </button>
            )}
          </div>

          {/* Birthday & Deathday - toggle visible */}
          {showDates && (
            <div className="ml-8 mt-1 flex space-x-4">
              <EditableField label="Bday" type="date" value={node.birthday} onChange={updateBirthday} />
              <EditableField label="Dday" type="date" value={node.deathday} onChange={updateDeathday} />
            </div>
          )}

          {/* Children */}
          {open && node.children && node.children.length > 0 && (
            <div className="children-container mt-2 ml-6 border-l border-gray-300 pl-4">
              {node.children.map(child => (
                <TreeNode
                  key={child.id}
                  node={child}
                  onUpdate={updateChild}
                  onDelete={deleteChild}
                  highlightIds={highlightIds}
                  ancestorsOpenIds={ancestorsOpenIds}
                  descendantsOpenIds={descendantsOpenIds}
                  scrollToId={scrollToId}
                  onScrollHandled={onScrollHandled}
                />
              ))}
            </div>
          )}
        </div>
      );
    }

    // Find person by name (case insensitive, partial match)
    function findPersonByName(node, name, found = []) {
      if (node.name.toLowerCase().includes(name.toLowerCase())) found.push(node);
      for (const spouse of node.spouses || []) {
        if (spouse.name.toLowerCase().includes(name.toLowerCase())) {
          found.push({ ...spouse, isSpouse: true, parentId: node.id });
        }
      }
      for (const child of node.children || []) {
        findPersonByName(child, name, found);
      }
      return found;
    }

    // Find all ancestors of a node by id (return set of ids)
    function findAncestors(node, targetId, path = []) {
      if (node.id === targetId) return new Set(path);
      for (const child of node.children || []) {
        const result = findAncestors(child, targetId, [...path, node.id]);
        if (result) return result;
      }
      return null;
    }

    // Find all descendants of a node by id (return set of ids)
    function findDescendants(node, targetId) {
      if (node.id === targetId) {
        const ids = new Set();
        function collect(n) {
          ids.add(n.id);
          (n.children || []).forEach(c => collect(c));
          (n.spouses || []).forEach(s => ids.add(s.id));
        }
        collect(node);
        return ids;
      }
      for (const child of node.children || []) {
        const result = findDescendants(child, targetId);
        if (result) return result;
      }
      return null;
    }

    function FamilyTree() {
      const [family, setFamily] = useState(initialFamilyData);
      const [searchTerm, setSearchTerm] = useState("");
      const [searchResults, setSearchResults] = useState([]);
      const [highlightIds, setHighlightIds] = useState(new Set());
      const [ancestorsOpenIds, setAncestorsOpenIds] = useState(new Set());
      const [descendantsOpenIds, setDescendantsOpenIds] = useState(new Set());
      const [scrollToId, setScrollToId] = useState(null);

      // Update family helper
      function updateNode(updatedNode) {
        function recursiveUpdate(node) {
          if (node.id === updatedNode.id) return updatedNode;
          return {
            ...node,
            children: (node.children || []).map(recursiveUpdate),
          };
        }
        setFamily(family => recursiveUpdate(family));
      }

      function deleteNode(id) {
        function recursiveDelete(node) {
          if (!node.children) return node;
          const filteredChildren = node.children.filter(c => c.id !== id);
          const newChildren = filteredChildren.map(recursiveDelete);
          return { ...node, children: newChildren };
        }
        setFamily(family => {
          if (family.id === id) return family; // cannot delete root
          return recursiveDelete(family);
        });
      }

      // Search effect
      useEffect(() => {
        if (searchTerm.trim().length === 0) {
          setSearchResults([]);
          setHighlightIds(new Set());
          setAncestorsOpenIds(new Set());
          setDescendantsOpenIds(new Set());
          setScrollToId(null);
          return;
        }
        const found = findPersonByName(family, searchTerm.trim());
        setSearchResults(found);
      }, [searchTerm, family]);

      // When user clicks a search result
      function onSelectSearchResult(person) {
        if (person.isSpouse) {
          setHighlightIds(new Set([person.id, person.parentId]));
          setAncestorsOpenIds(new Set());
          setDescendantsOpenIds(new Set());
          setScrollToId(person.parentId);
        } else {
          const ancestors = findAncestors(family, person.id) || new Set();
          const descendants = findDescendants(family, person.id) || new Set();
          const allHighlight = new Set([...ancestors, ...descendants, person.id]);
          setHighlightIds(allHighlight);
          setAncestorsOpenIds(ancestors);
          setDescendantsOpenIds(descendants);
          setScrollToId(person.id);
        }
        setSearchResults([]);
        setSearchTerm(person.name);
      }

      return (
        <div>
          <h1 className="text-3xl font-bold mb-6 text-center">Family Tree</h1>

          <div className="relative mb-6">
            <input
              type="text"
              placeholder="Search family by name..."
              value={searchTerm}
              onChange={e => setSearchTerm(e.target.value)}
              className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
            />
            {searchResults.length > 0 && (
              <ul className="absolute z-10 bg-white border border-gray-300 rounded w-full max-h-48 overflow-y-auto mt-1 shadow-lg">
                {searchResults.map((person, i) => (
                  <li
                    key={`${person.id}-${i}`}
                    onClick={() => onSelectSearchResult(person)}
                    className="px-3 py-2 cursor-pointer hover:bg-blue-100"
                    title={person.isSpouse ? `Spouse of ID ${person.parentId}` : ""}
                  >
                    {person.name} {person.isSpouse && "(Spouse)"}
                  </li>
                ))}
              </ul>
            )}
          </div>

          <TreeNode
            node={family}
            onUpdate={updateNode}
            onDelete={deleteNode}
            highlightIds={highlightIds}
            ancestorsOpenIds={ancestorsOpenIds}
            descendantsOpenIds={descendantsOpenIds}
            scrollToId={scrollToId}
            onScrollHandled={() => setScrollToId(null)}
          />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<FamilyTree />);

  </script>

</body>
</html>
