<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      max-width: 600px;
      margin: auto;
      background: #f0f2f5;
    }
    input, button {
      font-size: 1rem;
    }
    button {
      cursor: pointer;
    }
    .member {
      border: 1px solid #aaa;
      background: #fafafa;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .member-header {
      display: flex;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      font-weight: bold;
    }
    label {
      display: block;
      margin-top: 6px;
    }
    input[type="text"], input[type="date"] {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      margin-top: 4px;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      margin-top: 6px;
    }
    .checkbox-label input {
      margin-right: 6px;
    }
    .error {
      color: red;
      margin-top: 10px;
    }
    .logout-btn, .add-root-btn {
      margin-bottom: 20px;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
    }
    .logout-btn {
      background-color: #f44336;
      color: white;
    }
    .add-root-btn {
      background-color: #4CAF50;
      color: white;
      margin-left: 10px;
    }
    .children-container {
      margin-left: 20px;
      border-left: 2px solid #ccc;
      padding-left: 10px;
      margin-top: 10px;
    }
    .spouse-container {
      margin-top: 10px;
      padding: 10px;
      border: 1px dashed #888;
      background: #fff;
    }
    .btn-small {
      margin-top: 10px;
      margin-right: 10px;
      padding: 6px 12px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React, ReactDOM CDN -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <script type="text/babel">

    const { useState, useEffect } = React;

    // Firebase config and init
    const firebaseConfig = {
      apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
      authDomain: "project-955237504610034331.firebaseapp.com",
      databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
      projectId: "project-955237504610034331",
      storageBucket: "project-955237504610034331.firebasestorage.app",
      messagingSenderId: "76212939677",
      appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
      measurementId: "G-RCJ4P82PVM"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Login Component
    function Login({ onLogin }) {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');

      const handleSubmit = e => {
        e.preventDefault();
        setError('');
        auth.signInWithEmailAndPassword(email, password)
          .then(userCredential => {
            onLogin(userCredential.user);
          })
          .catch(err => setError(err.message));
      };

      return (
        <form onSubmit={handleSubmit} style={{maxWidth: 400, margin: 'auto'}}>
          <h2>Login</h2>
          <input
            type="email"
            placeholder="Email"
            value={email}
            onChange={e => setEmail(e.target.value)}
            required
            style={{ display: 'block', width: '100%', marginBottom: 10, padding: 8 }}
          />
          <input
            type="password"
            placeholder="Password"
            value={password}
            onChange={e => setPassword(e.target.value)}
            required
            style={{ display: 'block', width: '100%', marginBottom: 10, padding: 8 }}
          />
          <button type="submit" style={{padding: 10, width: '100%'}}>Login</button>
          {error && <p className="error">{error}</p>}
        </form>
      );
    }

    // Member component (recursive for children)
    function Member({ id, memberData, members, onSave, onAddChild, onAddSpouse }) {
      const [expanded, setExpanded] = useState(false);
      const [name, setName] = useState(memberData.name || '');
      const [birthDate, setBirthDate] = useState(memberData.birthDate || '');
      const [isDeceased, setIsDeceased] = useState(memberData.isDeceased || false);
      const [dateDied, setDateDied] = useState(memberData.dateDied || '');
      const [spouseId, setSpouseId] = useState(memberData.spouseId || null);
      // Children is an array of member IDs
      const childrenIds = memberData.children || [];

      useEffect(() => {
        // Update local states if memberData changes (e.g. from Firebase)
        setName(memberData.name || '');
        setBirthDate(memberData.birthDate || '');
        setIsDeceased(memberData.isDeceased || false);
        setDateDied(memberData.dateDied || '');
        setSpouseId(memberData.spouseId || null);
      }, [memberData]);

      const toggleExpand = () => setExpanded(!expanded);

      const saveData = () => {
        const updated = {
          name,
          birthDate,
          spouseId,
          isDeceased,
          dateDied: isDeceased ? dateDied : null,
          children: childrenIds,
        };
        onSave(id, updated);
        setExpanded(false);
      };

      const addChildHandler = () => {
        onAddChild(id);
        setExpanded(true); // keep expanded so user can see child added
      };

      const addSpouseHandler = () => {
        onAddSpouse(id, spouseId, setSpouseId);
        setExpanded(true);
      };

      return (
        <div className="member">
          <div className="member-header" onClick={toggleExpand}>
            <span>{name || "Unnamed Member"}</span>
            <button>{expanded ? "âˆ’" : "+"}</button>
          </div>
          {expanded && (
            <div style={{ marginTop: 10 }}>
              <label>
                Name:
                <input type="text" value={name} onChange={e => setName(e.target.value)} />
              </label>
              <label>
                Birth Date:
                <input type="date" value={birthDate} onChange={e => setBirthDate(e.target.value)} />
              </label>
              <label className="checkbox-label">
                <input type="checkbox" checked={isDeceased} onChange={e => setIsDeceased(e.target.checked)} />
                Deceased
              </label>
              {isDeceased && (
                <label>
                  Date Died:
                  <input type="date" value={dateDied} onChange={e => setDateDied(e.target.value)} />
                </label>
              )}
              <div>
                <button className="btn-small" onClick={addChildHandler}>Add Child</button>
                <button className="btn-small" onClick={addSpouseHandler}>
                  {spouseId ? "Edit Spouse" : "Add Spouse"}
                </button>
              </div>
              <button onClick={saveData} style={{ marginTop: 10, padding: '8px 16px' }}>Save</button>

              {/* Spouse section */}
              {spouseId && members[spouseId] && (
                <div className="spouse-container">
                  <h4>Spouse:</h4>
                  <Member
                    id={spouseId}
                    memberData={members[spouseId]}
                    members={members}
                    onSave={onSave}
                    onAddChild={onAddChild}
                    onAddSpouse={onAddSpouse}
                  />
                </div>
              )}

              {/* Children section */}
              {childrenIds.length > 0 && (
                <div className="children-container">
                  <h4>Children:</h4>
                  {childrenIds.map(childId => {
                    const childData = members[childId];
                    if (!childData) return <p key={childId}>Loading child data...</p>;
                    return (
                      <Member
                        key={childId}
                        id={childId}
                        memberData={childData}
                        members={members}
                        onSave={onSave}
                        onAddChild={onAddChild}
                        onAddSpouse={onAddSpouse}
                      />
                    );
                  })}
                </div>
              )}
            </div>
          )}
        </div>
      );
    }

    // Main App
    function App() {
      const [user, setUser] = useState(null);
      const [members, setMembers] = useState({});
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(u => {
          setUser(u);
          setLoading(false);
        });
        return () => unsubscribe();
      }, []);

      useEffect(() => {
        if (!user) return;

        const membersRef = database.ref('members');
        membersRef.on('value', snapshot => {
          setMembers(snapshot.val() || {});
        });

        return () => database.ref('members').off();
      }, [user]);

      const logout = () => auth.signOut();

      const saveMember = (id, data) => {
        database.ref('members/' + id).set(data);
      };

      // Add root member - same as before
      const addRootMember = () => {
        const name = prompt("Enter new root member's name:");
        if (!name) return alert("Name is required.");
        const newMemberRef = database.ref('members').push();
        newMemberRef.set({
          name,
          birthDate: '',
          spouseId: null,
          children: [],
          isDeceased: false,
          dateDied: null,
        });
      };

      // Add child member
      const addChild = (parentId) => {
        const newChildRef = database.ref('members').push();
        newChildRef.set({
          name: '',
          birthDate: '',
          spouseId: null,
          children: [],
          isDeceased: false,
          dateDied: null,
        }).then(() => {
          // After child is created, update parent's children array
          const childId = newChildRef.key;
          const parentChildren = members[parentId]?.children || [];
          database.ref('members/' + parentId + '/children').set([...parentChildren, childId]);
        });
      };

      // Add or edit spouse for a member
      // spouseSetter is a setter to update spouseId state inside Member component
      const addOrEditSpouse = (memberId, currentSpouseId, spouseSetter) => {
        if (currentSpouseId) {
          // Spouse exists, do nothing (or maybe could edit)
          spouseSetter(currentSpouseId);
          return;
        }
        // Create new spouse member
        const newSpouseRef = database.ref('members').push();
        newSpouseRef.set({
          name: '',
          birthDate: '',
          spouseId: memberId, // Link back to this member as spouse
          children: [],
          isDeceased: false,
          dateDied: null,
        }).then(() => {
          const spouseId = newSpouseRef.key;
          spouseSetter(spouseId);
          // Update current member spouseId
          database.ref('members/' + memberId + '/spouseId').set(spouseId);
        });
      };

      if (loading) return <p>Loading...</p>;

      if (!user) return <Login onLogin={setUser} />;

      return (
        <div>
          <h1>Family Tree</h1>
          <button className="logout-btn" onClick={logout}>Logout</button>
          <button className="add-root-btn" onClick={addRootMember}>Add Root Member</button>

          {Object.keys(members).length === 0 && <p>No members found.</p>}

          {Object.entries(members).map(([id, member]) => (
            // Only show members that don't have a parent (root-level)
            // To avoid duplicates, exclude members that are children of others or spouses of others
            !Object.values(members).some(m => (m.children || []).includes(id) || m.spouseId === id) &&
            <Member
              key={id}
              id={id}
              memberData={member}
              members={members}
              onSave={saveMember}
              onAddChild={addChild}
              onAddSpouse={addOrEditSpouse}
            />
          ))}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>
