<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Tree App</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
    color: #222;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* Container */
  #app-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: 1200px;
    margin: 20px auto;
    padding: 10px;
    background: rgba(255 255 255 / 0.85);
    border-radius: 12px;
    box-shadow: 0 8px 24px rgb(0 0 0 / 0.1);
    overflow-x: auto;
  }

  /* Login Page */
  #login-page {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  #login-page form {
    background: rgba(255 255 255 / 0.15);
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.25);
    width: 90%;
    max-width: 350px;
    backdrop-filter: blur(10px);
    color: white;
  }
  #login-page h2 {
    text-align: center;
    margin-bottom: 24px;
  }
  #login-page label {
    display: block;
    margin: 12px 0 6px;
    font-weight: 600;
  }
  #login-page input[type="email"],
  #login-page input[type="password"] {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: none;
    outline: none;
    font-size: 16px;
  }
  #login-page button {
    margin-top: 20px;
    width: 100%;
    padding: 14px;
    background: #6b5b95;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
    color: white;
    font-size: 16px;
    transition: background-color 0.3s ease;
  }
  #login-page button:hover {
    background: #8e79b7;
  }
  #login-page .error-msg {
    color: #ff6b6b;
    margin-top: 10px;
    text-align: center;
  }

  /* Family Tree */
  #family-tree {
    display: flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    padding-bottom: 60px; /* for footer space */
  }

  /* Members Container */
  #members-container {
    display: flex;
    gap: 40px;
    align-items: flex-start;
    padding: 20px;
  }

  /* Single Member Card */
  .member-card {
    background: #fff;
    border-radius: 12px;
    padding: 16px 20px;
    min-width: 250px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .member-card span.name {
    font-weight: 700;
    font-size: 1.2em;
  }
  .member-card span.detail {
    font-size: 0.9em;
    color: #555;
  }
  .member-card span.died {
    color: #d9534f;
    font-weight: 600;
  }

  /* Buttons */
  button.add-btn {
    margin-top: 10px;
    padding: 6px 10px;
    background-color: #3498db;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-size: 0.9em;
  }
  button.add-btn:hover {
    background-color: #2980b9;
  }

  /* Connections Sidebar */
  #connections-sidebar {
    width: 250px;
    border-left: 2px solid #ccc;
    padding-left: 20px;
    overflow-y: auto;
  }
  #connections-sidebar h3 {
    margin-top: 0;
    font-size: 1.2em;
    font-weight: 700;
    border-bottom: 2px solid #3498db;
    padding-bottom: 6px;
  }
  #connections-list {
    list-style: none;
    padding-left: 0;
    font-size: 0.9em;
  }
  #connections-list li {
    margin-bottom: 12px;
  }
  #connections-list strong {
    color: #2980b9;
  }

  /* Footer */
  footer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    backdrop-filter: blur(15px);
    background: rgba(255 255 255 / 0.25);
    color: #333;
    text-align: center;
    padding: 10px 0;
    font-weight: 600;
    border-top: 1px solid rgba(0,0,0,0.1);
    user-select: none;
  }

  /* Responsive */
  @media (max-width: 900px) {
    #family-tree {
      flex-direction: column;
      overflow-x: visible;
    }
    #members-container {
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
    }
    #connections-sidebar {
      width: 100%;
      border-left: none;
      border-top: 2px solid #ccc;
      padding-left: 0;
      padding-top: 10px;
      margin-top: 20px;
    }
  }
</style>
</head>
<body>

<div id="login-page">
  <form id="login-form">
    <h2>Login to Family Tree</h2>
    <label for="email">Email</label>
    <input id="email" type="email" placeholder="Email" required />
    <label for="password">Password</label>
    <input id="password" type="password" placeholder="Password" required />
    <button type="submit">Login</button>
    <p class="error-msg" id="login-error"></p>
  </form>
</div>

<div id="app-container" style="display:none;">
  <div id="family-tree">
    <div id="members-container"></div>
    <div id="connections-sidebar">
      <h3>Connections</h3>
      <ul id="connections-list"></ul>
    </div>
  </div>
  <button id="logout-btn" style="margin-top:10px; padding:10px 16px; border:none; border-radius:8px; cursor:pointer; background:#d9534f; color:white; font-weight:600;">Logout</button>
</div>

<footer>&copy; 2025 Maki Web. All rights reserved</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
    authDomain: "project-955237504610034331.firebaseapp.com",
    databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
    projectId: "project-955237504610034331",
    storageBucket: "project-955237504610034331.firebasestorage.app",
    messagingSenderId: "76212939677",
    appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
    measurementId: "G-RCJ4P82PVM"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // UI Elements
  const loginPage = document.getElementById('login-page');
  const loginForm = document.getElementById('login-form');
  const loginError = document.getElementById('login-error');
  const appContainer = document.getElementById('app-container');
  const membersContainer = document.getElementById('members-container');
  const connectionsList = document.getElementById('connections-list');
  const logoutBtn = document.getElementById('logout-btn');

  // --- AUTH ---
  auth.onAuthStateChanged(user => {
    if (user) {
      loginPage.style.display = 'none';
      appContainer.style.display = 'flex';
      loadFamilyTree();
    } else {
      loginPage.style.display = 'flex';
      appContainer.style.display = 'none';
    }
  });

  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    loginError.textContent = '';
    const email = loginForm.email.value;
    const password = loginForm.password.value;
    auth.signInWithEmailAndPassword(email, password)
      .catch(err => {
        loginError.textContent = err.message;
      });
  });

  logoutBtn.onclick = () => {
    auth.signOut();
  };

  // --- FAMILY TREE FUNCTIONS ---
  function createMemberElement(memberId, memberData, parentId=null, spouseIndex=null) {
    // memberData example:
    // { name, birth, died, spouses: {spouseId: {...}, ...} }
    // or children inside spouse data: spouses -> children

    const card = document.createElement('div');
    card.classList.add('member-card');
    card.dataset.id = memberId;

    const nameSpan = document.createElement('span');
    nameSpan.className = 'name';
    nameSpan.textContent = memberData.name || '(No Name)';
    card.appendChild(nameSpan);

    const birthSpan = document.createElement('span');
    birthSpan.className = 'detail';
    birthSpan.textContent = `Born: ${memberData.birth || 'N/A'}`;
    card.appendChild(birthSpan);

    if(memberData.died){
      const diedSpan = document.createElement('span');
      diedSpan.className = 'died';
      diedSpan.textContent = `Died: ${memberData.died}`;
      card.appendChild(diedSpan);
    }

    // BUTTONS for adding relatives
    // If root member, show Add Spouse button
    if(!parentId && !spouseIndex){
      const addSpouseBtn = document.createElement('button');
      addSpouseBtn.textContent = '+ Add Spouse';
      addSpouseBtn.classList.add('add-btn');
      addSpouseBtn.onclick = () => addSpouse(memberId);
      card.appendChild(addSpouseBtn);
    }

    // If spouse card (spouseIndex defined), show Add Child button
    if(spouseIndex !== null){
      const addChildBtn = document.createElement('button');
      addChildBtn.textContent = '+ Add Child';
      addChildBtn.classList.add('add-btn');
      addChildBtn.onclick = () => addChild(memberId, spouseIndex);
      card.appendChild(addChildBtn);
    }

    // Show spouses if root member
    if(!parentId && memberData.spouses){
      for(let [idx, [spId, spouseData]] of Object.entries(Object.entries(memberData.spouses))){
        idx = Number(idx);
        const spouseCard = createSpouseElement(spId, spouseData, memberId, idx);
        card.appendChild(spouseCard);
      }
    }

    return card;
  }

  function createSpouseElement(spouseId, spouseData, memberId, spouseIndex){
    const spouseCard = document.createElement('div');
    spouseCard.classList.add('member-card');
    spouseCard.style.marginLeft = '20px';
    spouseCard.style.backgroundColor = '#f4f6f8';

    const nameSpan = document.createElement('span');
    nameSpan.className = 'name';
    nameSpan.textContent = spouseData.name || '(No Name)';
    spouseCard.appendChild(nameSpan);

    const birthSpan = document.createElement('span');
    birthSpan.className = 'detail';
    birthSpan.textContent = `Born: ${spouseData.birth || 'N/A'}`;
    spouseCard.appendChild(birthSpan);

    if(spouseData.died){
      const diedSpan = document.createElement('span');
      diedSpan.className = 'died';
      diedSpan.textContent = `Died: ${spouseData.died}`;
      spouseCard.appendChild(diedSpan);
    }

    // Add Child button
    const addChildBtn = document.createElement('button');
    addChildBtn.textContent = '+ Add Child';
    addChildBtn.classList.add('add-btn');
    addChildBtn.onclick = () => addChild(memberId, spouseIndex);
    spouseCard.appendChild(addChildBtn);

    // Show children of spouse
    if(spouseData.children){
      for(let [childId, childData] of Object.entries(spouseData.children)){
        const childCard = document.createElement('div');
        childCard.classList.add('member-card');
        childCard.style.marginLeft = '30px';
        childCard.style.backgroundColor = '#e9f0f7';

        const childName = document.createElement('span');
        childName.className = 'name';
        childName.textContent = childData.name || '(No Name)';
        childCard.appendChild(childName);

        const childBirth = document.createElement('span');
        childBirth.className = 'detail';
        childBirth.textContent = `Born: ${childData.birth || 'N/A'}`;
        childCard.appendChild(childBirth);

        if(childData.died){
          const childDied = document.createElement('span');
          childDied.className = 'died';
          childDied.textContent = `Died: ${childData.died}`;
          childCard.appendChild(childDied);
        }

        spouseCard.appendChild(childCard);
      }
    }

    return spouseCard;
  }

  function loadFamilyTree() {
    membersContainer.innerHTML = '';
    connectionsList.innerHTML = '';
    // Load members from Firebase Realtime DB
    db.ref('members').once('value').then(snapshot => {
      const members = snapshot.val();
      if(!members){
        // No members - add button to add root member
        const addRootBtn = document.createElement('button');
        addRootBtn.textContent = '+ Add Root Member';
        addRootBtn.classList.add('add-btn');
        addRootBtn.style.margin = '20px auto';
        addRootBtn.onclick = addRootMember;
        membersContainer.appendChild(addRootBtn);
        return;
      }
      // Show members
      for(let [memberId, memberData] of Object.entries(members)){
        const memberCard = createMemberElement(memberId, memberData);
        membersContainer.appendChild(memberCard);
      }
      buildConnectionsSidebar(members);
    });
  }

  // Add root member (if no members)
  function addRootMember() {
    const name = prompt('Enter name for new root member:');
    if(!name) return alert('Name is required');
    const birth = prompt('Enter birthdate (optional):');
    const died = prompt('Enter death date (optional):');

    // Create new member object
    const newMember = { name, birth: birth || '', died: died || '', spouses: {} };
    // Push to DB
    const newKey = db.ref('members').push().key;
    db.ref('members/' + newKey).set(newMember).then(() => {
      loadFamilyTree();
    });
  }

  // Add spouse for a member
  function addSpouse(memberId){
    const name = prompt('Enter spouse name:');
    if(!name) return alert('Name is required');
    const birth = prompt('Enter spouse birthdate (optional):');
    const died = prompt('Enter spouse death date (optional):');

    const newSpouse = { name, birth: birth || '', died: died || '', children: {} };

    // Add spouse to member's spouses object
    db.ref(`members/${memberId}/spouses`).once('value').then(snapshot => {
      let spouses = snapshot.val() || {};
      // Generate a new spouseId key
      const newSpouseKey = db.ref().push().key;
      spouses[newSpouseKey] = newSpouse;
      db.ref(`members/${memberId}/spouses`).set(spouses).then(() => {
        loadFamilyTree();
      });
    });
  }

  // Add child for spouse
  function addChild(memberId, spouseIndex){
    // Get spouse key from member's spouses (since spouseIndex is array index)
    db.ref(`members/${memberId}/spouses`).once('value').then(snapshot => {
      const spouses = snapshot.val() || {};
      const spouseKeys = Object.keys(spouses);
      if(!spouseKeys[spouseIndex]){
        return alert('Spouse not found');
      }
      const spouseKey = spouseKeys[spouseIndex];
      const name = prompt('Enter child name:');
      if(!name) return alert('Name is required');
      const birth = prompt('Enter child birthdate (optional):');
      const died = prompt('Enter child death date (optional):');

      const newChild = { name, birth: birth || '', died: died || '' };

      // Add child to spouse's children
      const childrenRef = db.ref(`members/${memberId}/spouses/${spouseKey}/children`);
      childrenRef.once('value').then(csnap => {
        const children = csnap.val() || {};
        const newChildKey = db.ref().push().key;
        children[newChildKey] = newChild;
        childrenRef.set(children).then(() => {
          loadFamilyTree();
        });
      });
    });
  }

  // Build connections sidebar showing relationships nicely
  function buildConnectionsSidebar(members){
    connectionsList.innerHTML = '';
    for(let [id, data] of Object.entries(members)){
      const li = document.createElement('li');
      let text = `<strong>${data.name}</strong><br/>Born: ${data.birth || 'N/A'}`;
      if(data.died) text += `<br/>Died: ${data.died}`;

      // Spouses
      if(data.spouses){
        const spousesArr = Object.values(data.spouses);
        text += `<br/>Spouse${spousesArr.length > 1 ? 's' : ''}: `;
        text += spousesArr.map(s => s.name).join(', ');
        // Children count
        const totalChildren = spousesArr.reduce((sum,s) => sum + (s.children ? Object.keys(s.children).length : 0), 0);
        if(totalChildren) text += `<br/>Children: ${totalChildren}`;
      }

      li.innerHTML = text;
      connectionsList.appendChild(li);
    }
  }
</script>
</body>
</html>
