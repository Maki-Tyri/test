<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Family Tree App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .blink {
      animation: blink-animation 1.5s ease-in-out;
    }
    @keyframes blink-animation {
      0%, 100% { background-color: inherit; }
      50% { background-color: yellow; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root" class="p-4 max-w-6xl mx-auto"></div>

  <!-- React + Firebase + Babel -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Main App -->
  <script type="text/babel">

    const { useState, useEffect } = React;
    const { initializeApp } = firebase;
    const { getDatabase, ref, onValue, set } = firebase.database;

    const firebaseConfig = {
  apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
  authDomain: "project-955237504610034331.firebaseapp.com",
  databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
  projectId: "project-955237504610034331",
  storageBucket: "project-955237504610034331.firebasestorage.app",
  messagingSenderId: "76212939677",
  appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
  measurementId: "G-RCJ4P82PVM"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function TreeNode({ node, updateNode, searchTerm, highlightMap }) {
      const [collapsed, setCollapsed] = useState(false);

      const isHighlighted = highlightMap?.[node.id]?.highlight;
      const isBlinking = highlightMap?.[node.id]?.blink;

      function updateField(field, value) {
        const updatedNode = { ...node, [field]: value };
        updateNodeRecursive(node.id, updatedNode);
      }

      function addChild() {
        const newChild = {
          id: crypto.randomUUID(),
          name: "New Child",
          dob: "",
          children: [],
          spouses: []
        };
        const updatedNode = {
          ...node,
          children: [...(node.children || []), newChild]
        };
        updateNodeRecursive(node.id, updatedNode);
      }

      function addSpouse() {
        const newSpouse = {
          id: crypto.randomUUID(),
          name: "New Spouse",
          dob: ""
        };
        const updatedNode = {
          ...node,
          spouses: [...(node.spouses || []), newSpouse]
        };
        updateNodeRecursive(node.id, updatedNode);
      }

      function updateNodeRecursive(targetId, updatedSubtree) {
        function updateRecursively(current) {
          if (current.id === targetId) {
            return updatedSubtree;
          }
          return {
            ...current,
            children: current.children?.map(updateRecursively) || []
          };
        }
        updateNode(prev => updateRecursively(prev));
      }

      return (
        <div className="ml-4 border-l-2 border-gray-300 pl-4 mt-2">
          <div className={`rounded-lg p-2 ${isHighlighted ? "bg-green-100" : ""} ${isBlinking ? "blink" : ""}`}>
            <div className="flex items-center space-x-2">
              <button
                className="text-sm text-blue-600"
                onClick={() => setCollapsed(!collapsed)}
              >
                {collapsed ? "▶" : "▼"}
              </button>
              <input
                className="border px-2 py-1 rounded text-sm"
                value={node.name}
                onChange={e => updateField("name", e.target.value)}
              />
              <input
                className="border px-2 py-1 rounded text-sm"
                value={node.dob}
                placeholder="DOB"
                onChange={e => updateField("dob", e.target.value)}
              />
              <button onClick={addChild} className="text-xs bg-blue-500 text-white px-2 py-1 rounded">+ Child</button>
              <button onClick={addSpouse} className="text-xs bg-purple-500 text-white px-2 py-1 rounded">+ Spouse</button>
            </div>

            {node.spouses?.map(s => (
              <div key={s.id} className={`ml-6 mt-1 text-sm italic ${highlightMap?.[s.id]?.highlight ? "bg-green-50" : ""} ${highlightMap?.[s.id]?.blink ? "blink" : ""}`}>
                Spouse: <input
                  className="border px-2 py-1 rounded text-sm"
                  value={s.name}
                  onChange={e => {
                    const newSpouses = node.spouses.map(sp => sp.id === s.id ? { ...sp, name: e.target.value } : sp);
                    updateField("spouses", newSpouses);
                  }}
                />
              </div>
            ))}
          </div>

          {!collapsed && node.children?.map(child => (
            <TreeNode
              key={child.id}
              node={child}
              updateNode={updateNode}
              searchTerm={searchTerm}
              highlightMap={highlightMap}
            />
          ))}
        </div>
      );
    }

    function App() {
      const [treeData, setTreeData] = useState(null);
      const [searchTerm, setSearchTerm] = useState("");
      const [highlightMap, setHighlightMap] = useState({});

      useEffect(() => {
        const treeRef = ref(db, "tree");
        onValue(treeRef, snapshot => {
          const data = snapshot.val();
          if (data) setTreeData(data);
        });
      }, []);

      useEffect(() => {
        if (!treeData || !searchTerm) {
          setHighlightMap({});
          return;
        }

        const found = {};
        const blinkMap = {};

        function dfs(node, ancestors = []) {
          const match = node.name?.toLowerCase().includes(searchTerm.toLowerCase());
          if (match) {
            found[node.id] = true;
            ancestors.forEach(a => (found[a] = true));
            blinkMap[node.id] = true;
          }
          node.children?.forEach(child => dfs(child, [...ancestors, node.id]));
        }

        dfs(treeData);

        const resultMap = {};

        function buildMap(node) {
          resultMap[node.id] = {
            highlight: !!found[node.id],
            blink: !!blinkMap[node.id],
          };
          node.spouses?.forEach(s => {
            resultMap[s.id] = {
              highlight: !!found[s.id],
              blink: !!blinkMap[s.id],
            };
          });
          node.children?.forEach(buildMap);
        }

        buildMap(treeData);
        setHighlightMap(resultMap);

        if (Object.keys(blinkMap).length > 0) {
          setTimeout(() => {
            const noBlinkMap = {};
            Object.entries(resultMap).forEach(([id, v]) => {
              noBlinkMap[id] = { ...v, blink: false };
            });
            setHighlightMap(noBlinkMap);
          }, 1500);
        }
      }, [searchTerm, treeData]);

      function updateTree(newData) {
        setTreeData(newData);
        set(ref(db, "tree"), newData);
      }

      return (
        <div className="p-4">
          <h1 className="text-2xl font-bold mb-4">Family Tree</h1>
          <input
            type="text"
            placeholder="Search name..."
            className="border p-2 rounded w-full mb-4"
            value={searchTerm}
            onChange={e => setSearchTerm(e.target.value)}
          />
          <div>
            {treeData ? (
              <TreeNode
                node={treeData}
                updateNode={updateTree}
                searchTerm={searchTerm}
                highlightMap={highlightMap}
              />
            ) : (
              <div>Loading tree...</div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
