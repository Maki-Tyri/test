// public/index.html
/*
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Family Tree App</title>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
*/

// src/index.css
/*
@tailwind base;
@tailwind components;
@tailwind utilities;
*/

// src/main.jsx (or index.jsx)
import React from "react";
import ReactDOM from "react-dom/client";
import App from "./App";
import "./index.css";

ReactDOM.createRoot(document.getElementById("root")).render(
  <React.StrictMode><App /></React.StrictMode>
);

// src/App.jsx
import React, { useState } from "react";
import FamilyTree from "./FamilyTree";

const initialTree = {
  id: "1",
  name: "Lolo Juan",
  children: [
    {
      id: "2",
      name: "Tatay Pedro",
      children: [
        { id: "4", name: "Ako", children: [] }
      ],
    },
    { id: "3", name: "Tiyo Mario", children: [] },
  ],
};

export default function App() {
  const [treeData, setTreeData] = useState(initialTree);

  const updateNode = (id, updatedName) => {
    const update = (node) => {
      if (node.id === id) return { ...node, name: updatedName };
      return { ...node, children: node.children.map(update) };
    };
    setTreeData(update(treeData));
  };

  const deleteNode = (id) => {
    const remove = (node) => ({
      ...node,
      children: node.children.filter(c => c.id !== id).map(remove),
    });
    setTreeData(remove(treeData));
  };

  return (
    <div className="w-full h-screen">
      <FamilyTree family={treeData} updateNode={updateNode} deleteNode={deleteNode} />
    </div>
  );
}

// src/FamilyTree.jsx
import React, { useRef, useState } from "react";
import TreeNode from "./TreeNode";

const FamilyTree = ({ family, updateNode, deleteNode }) => {
  const [scale, setScale] = useState(1);
  const [highlightIds, setHighlightIds] = useState([]);
  const [openIds, setOpenIds] = useState([]);
  const [scrollToId, setScrollToId] = useState(null);

  const wrapperRef = useRef(null);
  const isDragging = useRef(false);
  const lastPosition = useRef({ x: 0, y: 0 });

  const startDragging = (e) => {
    isDragging.current = true;
    lastPosition.current = { x: e.clientX, y: e.clientY };
    document.body.style.userSelect = "none";
  };

  const stopDragging = () => {
    isDragging.current = false;
    document.body.style.userSelect = "auto";
  };

  const onDragging = (e) => {
    if (!isDragging.current || !wrapperRef.current) return;
    const dx = e.clientX - lastPosition.current.x;
    const dy = e.clientY - lastPosition.current.y;
    wrapperRef.current.scrollLeft -= dx;
    wrapperRef.current.scrollTop -= dy;
    lastPosition.current = { x: e.clientX, y: e.clientY };
  };

  const searchAndHighlight = (node, targetName, ancestors = []) => {
    let matches = [];
    if (node.name.toLowerCase().includes(targetName.toLowerCase())) {
      matches.push(node.id);
      matches.push(...ancestors);
    }
    for (let child of node.children || []) {
      matches.push(...searchAndHighlight(child, targetName, [...ancestors, node.id]));
    }
    return matches;
  };

  const handleSearch = (e) => {
    const name = e.target.value.trim();
    if (!name) {
      setHighlightIds([]);
      setOpenIds([]);
      return;
    }
    const matches = searchAndHighlight(family, name);
    setHighlightIds(matches);
    setOpenIds(matches);
    setScrollToId(matches[0] || null);
  };

  const onScrollHandled = () => {
    setScrollToId(null);
  };

  const zoomIn = () => setScale((s) => Math.min(s + 0.1, 3));
  const zoomOut = () => setScale((s) => Math.max(s - 0.1, 0.3));

  return (
    <div className="w-screen h-screen flex flex-col">
      <div className="p-2 flex gap-2 bg-gray-100 border-b">
        <input
          type="text"
          placeholder="Search name..."
          onChange={handleSearch}
          className="p-1 border rounded flex-grow"
        />
        <button onClick={zoomOut} className="px-2 py-1 bg-gray-200 rounded">-</button>
        <button onClick={zoomIn} className="px-2 py-1 bg-gray-200 rounded">+</button>
      </div>

      <div
        ref={wrapperRef}
        onMouseDown={startDragging}
        onMouseMove={onDragging}
        onMouseUp={stopDragging}
        onMouseLeave={stopDragging}
        className="flex-1 overflow-auto cursor-grab active:cursor-grabbing bg-white"
      >
        <div
          style={{
            transform: `scale(${scale})`,
            transformOrigin: "top left",
            width: "2000px",
            height: "2000px",
            padding: "2rem",
          }}
        >
          <TreeNode
            node={family}
            onUpdate={updateNode}
            onDelete={deleteNode}
            highlightIds={highlightIds}
            openIds={openIds}
            scrollToId={scrollToId}
            onScrollHandled={onScrollHandled}
          />
        </div>
      </div>
    </div>
  );
};

export default FamilyTree;

// src/TreeNode.jsx
import React, { useEffect, useRef } from "react";

const TreeNode = ({
  node,
  onUpdate,
  onDelete,
  highlightIds,
  openIds,
  scrollToId,
  onScrollHandled,
}) => {
  const ref = useRef(null);
  const isHighlighted = highlightIds.includes(node.id);
  const isOpen = openIds.includes(node.id);

  useEffect(() => {
    if (scrollToId === node.id && ref.current) {
      ref.current.scrollIntoView({ behavior: "smooth", block: "center", inline: "center" });
      onScrollHandled();
    }
  }, [scrollToId, node.id, onScrollHandled]);

  return (
    <div ref={ref} className="relative inline-block text-center m-4">
      <div
        className={`inline-block px-4 py-2 border rounded shadow ${
          isHighlighted ? "bg-yellow-200" : "bg-white"
        }`}
      >
        <div>{node.name}</div>
        <div className="mt-1 space-x-2 text-sm">
          <button
            onClick={() => {
              const newName = prompt("New name:", node.name);
              if (newName && newName.trim() !== "") onUpdate(node.id, newName.trim());
            }}
            aria-label="Edit"
          >
            ‚úèÔ∏è
          </button>
          <button
            onClick={() => {
              if (window.confirm(`Delete ${node.name}?`)) onDelete(node.id);
            }}
            aria-label="Delete"
          >
            üóëÔ∏è
          </button>
        </div>
      </div>

      {isOpen && node.children?.length > 0 && (
        <div className="mt-4 flex justify-center space-x-8">
          {node.children.map((child) => (
            <TreeNode
              key={child.id}
              node={child}
              onUpdate={onUpdate}
              onDelete={onDelete}
              highlightIds={highlightIds}
              openIds={openIds}
              scrollToId={scrollToId}
              onScrollHandled={onScrollHandled}
            />
          ))}
        </div>
      )}
    </div>
  );
};

export default TreeNode;
