<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree with Spouse Lines & Contextual Relation Dropdown</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <style>
    /* Spouse connection line container */
    .spouse-line-container {
      position: relative;
      display: flex;
      align-items: center;
      margin-left: 1.5rem; /* match indent */
      margin-bottom: 0.5rem;
    }
    .spouse-line {
      position: absolute;
      height: 3px;
      background: #db2777; /* stronger pink */
      top: 50%;
      left: 0;
      right: 0;
      border-radius: 2px;
      z-index: 0;
      /* improved line style for non-siblings */
      box-shadow: 0 0 4px #f472b6;
    }
    .spouse-name {
      background: white;
      padding: 0 0.4rem;
      position: relative;
      z-index: 1;
      font-style: italic;
      color: #be185d; /* deeper pink */
      font-weight: 700;
      font-size: 0.95rem;
      border-radius: 4px;
      border: 1.5px solid #db2777;
      user-select: none;
      cursor: default;
      box-shadow: 0 1px 3px rgba(219, 39, 119, 0.4);
    }

    /* FamilyMember container polish */
    .family-member {
      margin-left: 1.5rem;
      padding: 0.25rem 0.5rem;
      border-left-width: 3px;
      border-color: #818cf8; /* indigo-400 */
      position: relative;
      transition: background-color 0.3s ease;
      border-radius: 0 6px 6px 0;
    }
    .family-member:hover {
      background-color: rgba(147, 197, 253, 0.15); /* light indigo hover */
    }

    /* Member name styling */
    .member-name {
      font-weight: 700;
      color: #4338ca; /* indigo-800 */
      font-size: 1.05rem;
      user-select: text;
    }
    .member-relation {
      font-size: 0.85rem;
      color: #6b7280; /* gray-500 */
      font-style: italic;
      margin-left: 0.25rem;
    }
    .member-dates {
      font-size: 0.75rem;
      color: #9ca3af; /* gray-400 */
      margin-left: 0.4rem;
    }
    .member-deceased {
      color: #db2777; /* pink-600 */
      font-weight: 700;
      margin-left: 0.5rem;
      user-select: none;
    }

    /* Buttons polish */
    button.action-btn {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.15rem 0.4rem;
      border-radius: 0.375rem;
      border: none;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    button.action-btn:hover {
      filter: brightness(110%);
    }
    button.edit-btn {
      color: #4f46e5; /* indigo-600 */
      background-color: #c7d2fe; /* indigo-200 */
    }
    button.child-btn {
      color: #15803d; /* green-700 */
      background-color: #bbf7d0; /* green-200 */
    }
    button.spouse-btn {
      color: #db2777; /* pink-600 */
      background-color: #fecdd3; /* pink-200 */
    }
    button.delete-btn {
      color: #b91c1c; /* red-700 */
      background-color: #fecaca; /* red-200 */
      margin-left: 0.5rem;
    }

    /* MemberForm polish */
    form.member-form {
      margin-left: 1.5rem;
      padding: 1rem;
      border-left: 4px solid #6366f1; /* indigo-500 */
      background-color: #eef2ff; /* indigo-50 */
      border-radius: 0 8px 8px 0;
      box-shadow: 0 4px 8px rgba(99, 102, 241, 0.15);
    }
    form.member-form input[type="text"],
    form.member-form select,
    form.member-form input[type="date"] {
      border: 1.5px solid #a5b4fc; /* indigo-300 */
      padding: 0.5rem;
      border-radius: 0.375rem;
      font-size: 0.9rem;
      transition: border-color 0.3s ease;
      width: 100%;
    }
    form.member-form input[type="text"]:focus,
    form.member-form select:focus,
    form.member-form input[type="date"]:focus {
      border-color: #4338ca; /* indigo-800 */
      outline: none;
      box-shadow: 0 0 5px #4338ca;
    }
    form.member-form label {
      font-weight: 600;
      font-size: 0.9rem;
      color: #4338ca;
    }
    form.member-form button {
      font-weight: 700;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
      transition: background-color 0.25s ease;
    }
    form.member-form button.save-btn {
      background-color: #4338ca;
      color: white;
      margin-right: 0.5rem;
    }
    form.member-form button.save-btn:hover {
      background-color: #3730a3;
    }
    form.member-form button.cancel-btn {
      background-color: #a5b4fc;
      color: #3730a3;
    }
    form.member-form button.cancel-btn:hover {
      background-color: #818cf8;
      color: white;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 min-h-screen text-gray-900">

<div id="root" class="p-4 max-w-5xl mx-auto"></div>

<footer class="fixed bottom-0 w-full text-center py-2 bg-white bg-opacity-10 text-white backdrop-blur-md text-sm">
  &copy; 2025 Maki Web. All rights reserved
</footer>

<script type="text/javascript">
const { useState, useEffect } = React;

const firebaseConfig = {
  apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
  authDomain: "project-955237504610034331.firebaseapp.com",
  databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
  projectId: "project-955237504610034331",
  storageBucket: "project-955237504610034331.firebasestorage.app",
  messagingSenderId: "76212939677",
  appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
  measurementId: "G-RCJ4P82PVM"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

function Login({ onLogin }) {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [isRegister, setIsRegister] = useState(false);
  const [error, setError] = useState(null);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError(null);
    try {
      if (isRegister) {
        await auth.createUserWithEmailAndPassword(email, password);
      } else {
        await auth.signInWithEmailAndPassword(email, password);
      }
      onLogin();
    } catch (err) {
      setError(err.message);
    }
  };

  return React.createElement("div", { className: "max-w-md mx-auto mt-24 p-8 bg-white bg-opacity-70 rounded-lg shadow-lg backdrop-blur-md" },
    React.createElement("h2", { className: "text-3xl font-bold mb-6 text-center" }, isRegister ? "Register" : "Login"),
    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-4" },
      React.createElement("input", {
        type: "email",
        placeholder: "Email",
        required: true,
        value: email,
        onChange: e => setEmail(e.target.value),
        className: "w-full px-4 py-2 border rounded-md"
      }),
      React.createElement("input", {
        type: "password",
        placeholder: "Password",
        required: true,
        value: password,
        onChange: e => setPassword(e.target.value),
        className: "w-full px-4 py-2 border rounded-md"
      }),
      React.createElement("button", {
        type: "submit",
        className: "w-full bg-indigo-600 text-white py-2 rounded-md"
      }, isRegister ? "Register" : "Login")
    ),
    error && React.createElement("p", { className: "text-red-600 text-center mt-4" }, error),
    React.createElement("p", {
      className: "mt-6 text-indigo-600 text-center cursor-pointer hover:underline select-none",
      onClick: () => setIsRegister(!isRegister)
    }, isRegister ? "Already have an account? Login" : "No account? Register")
  );
}

// Relation dropdown options by context
const relationOptionsByContext = {
  child: ["Son", "Daughter"],
  spouse: ["Spouse"],
  edit: ["Father", "Mother", "Son", "Daughter", "Spouse", "Brother", "Sister"]
};

function MemberForm({ initialData = {}, onCancel, onSave, members, parentId, formType }) {
  // formType = "child" | "spouse" | "edit"
  const [form, setForm] = useState({
    name: initialData.name || "",
    relation: initialData.relation || (formType === "spouse" ? "Spouse" : ""),
    birthDate: initialData.birthDate || "",
    deathDate: initialData.deathDate || "",
    deceased: initialData.deceased || false,
    spouseId: initialData.spouseId || "",
  });

  // Filter spouse options to exclude self
  const spouseOptions = members.filter(m => m.id !== initialData.id);

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!form.name.trim()) {
      alert("Name is required");
      return;
    }
    onSave({ ...initialData, ...form, parentId, id: initialData.id || Date.now().toString() });
  };

  const options = relationOptionsByContext[formType] || relationOptionsByContext.edit;

  return React.createElement("form", { onSubmit: handleSubmit, className: "member-form" },
    React.createElement("input", {
      type: "text",
      placeholder: "Name",
      value: form.name,
      onChange: e => setForm({ ...form, name: e.target.value }),
      required: true
    }),
    // If formType is spouse, relation is fixed as "Spouse" and disabled
    formType === "spouse"
      ? React.createElement("input", {
          type: "text",
          value: "Spouse",
          disabled: true,
          className: "bg-gray-100 cursor-not-allowed"
        })
      : React.createElement("select", {
          value: form.relation,
          onChange: e => setForm({ ...form, relation: e.target.value }),
          required: true
        },
          React.createElement("option", { value: "" }, "-- Select Relation --"),
          options.map(r =>
            React.createElement("option", { key: r, value: r }, r)
          )
        ),
    React.createElement("div", { className: "flex space-x-2 mt-2" },
      React.createElement("input", {
        type: "date",
        value: form.birthDate,
        onChange: e => setForm({ ...form, birthDate: e.target.value }),
        placeholder: "Birth Date"
      }),
      React.createElement("input", {
        type: "date",
        value: form.deathDate,
        onChange: e => setForm({ ...form, deathDate: e.target.value }),
        placeholder: "Death Date"
      })
    ),
    React.createElement("label", { className: "flex items-center space-x-2 mt-2" },
      React.createElement("input", {
        type: "checkbox",
        checked: form.deceased,
        onChange: e => setForm({ ...form, deceased: e.target.checked })
      }),
      React.createElement("span", null, "Deceased")
    ),
    React.createElement("div", { className: "mt-3 flex space-x-2" },
      React.createElement("button", { type: "submit", className: "save-btn" }, "Save"),
      React.createElement("button", { type: "button", className: "cancel-btn", onClick: onCancel }, "Cancel")
    )
  );
}

function SpouseLine({ spouses }) {
  if (!spouses || spouses.length < 1) return null;

  return React.createElement("div", { className: "spouse-line-container" },
    React.createElement("div", { className: "spouse-line" }),
    spouses.map(s => React.createElement("div", { key: s.id, className: "spouse-name" }, s.name))
  );
}

function FamilyMember({ member, members, addMember, editMember, deleteMember }) {
  const [isEditing, setIsEditing] = useState(false);
  const [addingChild, setAddingChild] = useState(false);
  const [addingSpouse, setAddingSpouse] = useState(false);

  const spouses = members.filter(m => m.spouseId === member.id || member.spouseId === m.id);

  const children = members.filter(m => m.parentId === member.id);

  const handleEditSave = (data) => {
    editMember(data);
    setIsEditing(false);
  };

  const handleAddChild = (data) => {
    addMember(data);
    setAddingChild(false);
  };

  const handleAddSpouse = (data) => {
    addMember(data);
    setAddingSpouse(false);
  };

  return React.createElement("div", { className: "family-member" },
    isEditing
      ? React.createElement(MemberForm, {
          initialData: member,
          onCancel: () => setIsEditing(false),
          onSave: handleEditSave,
          members,
          formType: "edit"
        })
      : React.createElement("div", null,
        React.createElement("span", { className: "member-name" }, member.name),
        member.relation && React.createElement("span", { className: "member-relation" }, ` (${member.relation})`),
        member.birthDate && React.createElement("span", { className: "member-dates" }, ` b. ${member.birthDate}`),
        member.deathDate && React.createElement("span", { className: "member-dates" }, ` d. ${member.deathDate}`),
        member.deceased && React.createElement("span", { className: "member-deceased" }, "†"),
        React.createElement("div", { className: "mt-1 flex space-x-1" },
          React.createElement("button", {
            onClick: () => setAddingChild(true),
            className: "action-btn child-btn",
            title: "Add Child"
          }, "+ Child"),
          React.createElement("button", {
            onClick: () => setAddingSpouse(true),
            className: "action-btn spouse-btn",
            title: "Add Spouse"
          }, "+ Spouse"),
          React.createElement("button", {
            onClick: () => setIsEditing(true),
            className: "action-btn edit-btn",
            title: "Edit Member"
          }, "Edit"),
          React.createElement("button", {
            onClick: () => {
              if (confirm(`Delete member "${member.name}" and all their descendants?`)) {
                deleteMember(member.id);
              }
            },
            className: "action-btn delete-btn",
            title: "Delete Member"
          }, "Delete")
        )
      ),
    spouses.length > 0 && React.createElement(SpouseLine, { spouses }),
    children.length > 0 && React.createElement("div", { className: "ml-6 border-l-2 border-indigo-400 pl-3 mt-2 space-y-1" },
      children.map(c =>
        React.createElement(FamilyMember, { key: c.id, member: c, members, addMember, editMember, deleteMember })
      )
    ),
    addingChild && React.createElement(MemberForm, {
      onCancel: () => setAddingChild(false),
      onSave: handleAddChild,
      members,
      parentId: member.id,
      formType: "child"
    }),
    addingSpouse && React.createElement(MemberForm, {
      onCancel: () => setAddingSpouse(false),
      onSave: handleAddSpouse,
      members,
      parentId: null,
      formType: "spouse"
    })
  );
}

function FamilyTree({ members, addMember, editMember, deleteMember }) {
  // Root members = those without parents
  const roots = members.filter(m => !m.parentId);

  return React.createElement("div", null,
    roots.map(r =>
      React.createElement(FamilyMember, { key: r.id, member: r, members, addMember, editMember, deleteMember })
    )
  );
}

function App() {
  const [user, setUser] = useState(null);
  const [members, setMembers] = useState([]);

  // Listen auth state
  useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged(u => {
      setUser(u);
      if (u) {
        loadMembers(u.uid);
      } else {
        setMembers([]);
      }
    });
    return unsubscribe;
  }, []);

  function loadMembers(uid) {
    db.ref(`familyTrees/${uid}`).on("value", snapshot => {
      const data = snapshot.val();
      if (data) {
        const arr = Object.entries(data).map(([id, val]) => ({ ...val, id }));
        setMembers(arr);
      } else {
        setMembers([]);
      }
    });
  }

  function saveMember(member) {
    if (!user) return;
    db.ref(`familyTrees/${user.uid}/${member.id}`).set(member);
  }

  function deleteMemberRecursive(id) {
    if (!user) return;

    // Get all descendants recursively
    function getDescendants(mid) {
      let result = [];
      const directChildren = members.filter(m => m.parentId === mid);
      for (const child of directChildren) {
        result.push(child.id);
        result = result.concat(getDescendants(child.id));
      }
      return result;
    }

    const allToDelete = [id, ...getDescendants(id)];

    allToDelete.forEach(mid => {
      db.ref(`familyTrees/${user.uid}/${mid}`).remove();
    });
  }

  const addMember = (member) => {
    saveMember(member);
  };

  const editMember = (member) => {
    saveMember(member);
  };

  const deleteMember = (id) => {
    deleteMemberRecursive(id);
  };

  if (!user) {
    return React.createElement(Login, { onLogin: () => {} });
  }

  return React.createElement("div", null,
    React.createElement("div", { className: "mb-4 flex justify-between items-center" },
      React.createElement("h1", { className: "text-4xl font-extrabold text-white drop-shadow-lg" }, "Family Tree"),
      React.createElement("button", {
        className: "text-sm text-white bg-red-600 hover:bg-red-700 rounded px-3 py-1",
        onClick: () => auth.signOut()
      }, "Logout")
    ),
    React.createElement(FamilyTree, { members, addMember, editMember, deleteMember })
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
</script>

</body>
</html>
