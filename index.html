<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Tree App</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f2f5;
  }

  /* Container with flex for responsiveness */
  #app-container {
    display: flex;
    height: calc(100vh - 50px);
    max-height: calc(100vh - 50px);
    overflow: hidden;
  }

  /* Sidebar: family tree container on left */
  #family-tree-container {
    flex: 1 1 400px;
    min-width: 320px;
    max-width: 600px;
    overflow-y: auto;
    background: #fff;
    padding: 16px;
    border-right: 2px solid #ddd;
    position: relative;
  }

  /* Connections sidebar on right */
  #connections-container {
    width: 280px;
    background: #fafafa;
    border-left: 2px solid #ddd;
    overflow-y: auto;
    padding: 12px 16px;
    font-size: 0.9rem;
    color: #444;
  }

  /* Responsive: stack on mobile */
  @media (max-width: 720px) {
    #app-container {
      flex-direction: column;
      height: auto;
      max-height: none;
    }
    #family-tree-container, #connections-container {
      max-width: 100%;
      width: 100%;
      height: auto;
      border: none;
    }
    #connections-container {
      border-top: 2px solid #ddd;
    }
  }

  /* Family Tree node styling */
  .tree-node {
    background: #e9f0ff;
    border-radius: 8px;
    margin-bottom: 12px;
    padding: 10px 12px;
    box-shadow: 0 2px 5px rgb(0 123 255 / 0.15);
    position: relative;
  }
  .spouses-container {
    display: flex;
    gap: 10px;
    margin-top: 8px;
    position: relative;
  }
  .spouse-node {
    background: #dceefc;
    flex: 1 1 0;
  }
  .node-header {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }
  input[type=text], input[type=date] {
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 1rem;
    min-width: 100px;
  }
  input[type=checkbox] {
    transform: scale(1.2);
    cursor: pointer;
  }
  .node-buttons {
    margin-left: auto;
    display: flex;
    gap: 6px;
  }
  button {
    border: none;
    background-color: #007bff;
    color: white;
    padding: 4px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
  }
  button.delete-btn {
    background-color: #dc3545;
  }
  button:hover {
    opacity: 0.85;
  }
  .children-container {
    margin-left: 24px;
    border-left: 2px solid #007bff;
    padding-left: 12px;
    margin-top: 10px;
  }

  /* Connections box on right */
  #connections-container h3 {
    margin-top: 0;
    border-bottom: 2px solid #007bff;
    padding-bottom: 6px;
  }
  #connections-list {
    list-style: none;
    padding-left: 0;
    max-height: 80vh;
    overflow-y: auto;
  }
  #connections-list li {
    margin-bottom: 8px;
  }

  /* SVG connectors in tree nodes */
  svg.connector-svg {
    position: absolute;
    pointer-events: none;
    overflow: visible;
  }

  /* Footer fixed glass style */
  footer {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 50px;
    background: rgba(255 255 255 / 0.35);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    color: #444;
    border-top: 1px solid rgba(0,0,0,0.1);
    z-index: 9999;
  }

  /* LOGIN PAGE STYLES */
  #login-page {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #3a86ff, #8338ec);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  }
  #login-container {
    background: rgba(255 255 255 / 0.15);
    padding: 30px 36px;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    color: white;
    width: 320px;
    text-align: center;
  }
  #login-container h2 {
    margin-bottom: 20px;
    font-weight: 700;
  }
  #login-container input[type="email"],
  #login-container input[type="password"] {
    width: 100%;
    padding: 10px 14px;
    margin-bottom: 16px;
    border-radius: 8px;
    border: none;
    outline: none;
    font-size: 1rem;
  }
  #login-container button {
    width: 100%;
    background: #ff4d6d;
    border-radius: 8px;
    padding: 12px 0;
    font-weight: 700;
    font-size: 1.1rem;
    transition: background 0.3s ease;
  }
  #login-container button:hover {
    background: #ff2e56;
  }
  #login-error {
    color: #ffbaba;
    margin-bottom: 10px;
    min-height: 20px;
  }
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="login-page">
  <div id="login-container">
    <h2>Family Tree Login</h2>
    <div id="login-error"></div>
    <input type="email" id="email" placeholder="Email" autocomplete="username" required />
    <input type="password" id="password" placeholder="Password" autocomplete="current-password" required />
    <button id="login-btn">Log In</button>
  </div>
</div>

<!-- APP CONTAINER -->
<div id="app-container" style="display:none;">
  <div id="family-tree-container"></div>
  <div id="connections-container">
    <h3>Relationships</h3>
    <ul id="connections-list"></ul>
  </div>
</div>

<footer>&copy; 2025 Maki Web. All rights reserved</footer>

<script>
  // Firebase config + init
  const firebaseConfig = {
    apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
    authDomain: "project-955237504610034331.firebaseapp.com",
    databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
    projectId: "project-955237504610034331",
    storageBucket: "project-955237504610034331.firebasestorage.app",
    messagingSenderId: "76212939677",
    appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
    measurementId: "G-RCJ4P82PVM"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  // DOM Elements
  const loginPage = document.getElementById('login-page');
  const appContainer = document.getElementById('app-container');
  const familyTreeContainer = document.getElementById('family-tree-container');
  const connectionsList = document.getElementById('connections-list');
  const loginBtn = document.getElementById('login-btn');
  const loginError = document.getElementById('login-error');

  // Simple login logic with Firebase Auth (email/pass)
  loginBtn.addEventListener('click', () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    loginError.textContent = '';
    if (!email || !password) {
      loginError.textContent = 'Please fill all fields.';
      return;
    }
    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        loginPage.style.display = 'none';
        appContainer.style.display = 'flex';
        startListeningToFamilyTree();
      })
      .catch((err) => {
        loginError.textContent = err.message;
      });
  });

  // Log out on auth state changed (optional)
  auth.onAuthStateChanged(user => {
    if (!user) {
      loginPage.style.display = 'flex';
      appContainer.style.display = 'none';
    }
  });

  // FAMILY TREE DATA & RENDERING

  let familyTrees = {}; // keyed by id from DB

  function startListeningToFamilyTree() {
    db.ref('familyTrees').on('value', (snapshot) => {
      familyTrees = snapshot.val() || {};
      renderFamilyTrees();
      renderConnections();
    });
  }

  function saveFamilyTrees() {
    // Save current familyTrees back to firebase realtime DB
    db.ref('familyTrees').set(familyTrees);
  }

  // --- RENDERING FAMILY TREES ---

  function renderFamilyTrees() {
    familyTreeContainer.innerHTML = '';
    for (const id in familyTrees) {
      renderNode(familyTrees[id], familyTreeContainer, id, null);
    }
  }

  // Create SVG line helper
  function createLine(x1, y1, x2, y2) {
    const ns = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(ns, "svg");
    svg.classList.add('connector-svg');
    svg.style.left = Math.min(x1, x2) + "px";
    svg.style.top = Math.min(y1, y2) + "px";
    svg.style.width = Math.abs(x2 - x1) + "px";
    svg.style.height = Math.abs(y2 - y1) + "px";
    svg.style.position = "absolute";
    svg.style.pointerEvents = "none";

    const line = document.createElementNS(ns, "line");
    line.setAttribute("x1", x1 < x2 ? 0 : Math.abs(x2 - x1));
    line.setAttribute("y1", y1 < y2 ? 0 : Math.abs(y2 - y1));
    line.setAttribute("x2", x1 < x2 ? Math.abs(x2 - x1) : 0);
    line.setAttribute("y2", y1 < y2 ? Math.abs(y2 - y1) : 0);
    line.setAttribute("stroke", "#007bff");
    line.setAttribute("stroke-width", "2");
    line.setAttribute("marker-end", "url(#arrowhead)");

    svg.appendChild(line);
    return svg;
  }

  // Render single family node
  function renderNode(node, container, nodeId, parentId) {
    const nodeDiv = document.createElement('div');
    nodeDiv.classList.add('tree-node');
    nodeDiv.dataset.id = nodeId;

    // Header: name + dates + died checkbox
    const header = document.createElement('div');
    header.classList.add('node-header');

    // Name input
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = node.name || '';
    nameInput.placeholder = 'Full Name';
    nameInput.addEventListener('change', e => {
      node.name = e.target.value;
      saveFamilyTrees();
      renderConnections();
    });
    header.appendChild(nameInput);

    // Born date
    const bornInput = document.createElement('input');
    bornInput.type = 'date';
    bornInput.value = node.born || '';
    bornInput.title = "Date of Birth";
    bornInput.addEventListener('change', e => {
      node.born = e.target.value;
      saveFamilyTrees();
      renderConnections();
    });
    header.appendChild(bornInput);

    // Died date
    const diedInput = document.createElement('input');
    diedInput.type = 'date';
    diedInput.value = node.died || '';
    diedInput.title = "Date of Death";
    diedInput.addEventListener('change', e => {
      node.died = e.target.value;
      saveFamilyTrees();
      renderConnections();
    });
    header.appendChild(diedInput);

    // Died checkbox for quick toggle
    const diedCheckbox = document.createElement('input');
    diedCheckbox.type = 'checkbox';
    diedCheckbox.checked = !!node.died;
    diedCheckbox.title = "Mark as Deceased";
    diedCheckbox.addEventListener('change', e => {
      if (e.target.checked) {
        // If no died date set, default to today
        if (!node.died) {
          node.died = new Date().toISOString().substring(0, 10);
          diedInput.value = node.died;
        }
      } else {
        node.died = '';
        diedInput.value = '';
      }
      saveFamilyTrees();
      renderConnections();
    });
    header.appendChild(diedCheckbox);

    // Delete node button
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Delete';
    deleteBtn.classList.add('delete-btn');
    deleteBtn.title = "Delete this person";
    deleteBtn.addEventListener('click', () => {
      deleteNode(nodeId);
    });
    header.appendChild(deleteBtn);

    nodeDiv.appendChild(header);

    // Spouses container
    const spousesCont = document.createElement('div');
    spousesCont.classList.add('spouses-container');

    if (node.spouses) {
      // Sort spouses by name for consistent ordering
      const spouseIds = Object.keys(node.spouses).sort((a,b) => {
        const na = node.spouses[a].name.toLowerCase();
        const nb = node.spouses[b].name.toLowerCase();
        return na.localeCompare(nb);
      });
      spouseIds.forEach(sid => {
        const spouse = node.spouses[sid];
        const spouseDiv = document.createElement('div');
        spouseDiv.classList.add('spouse-node');

        // Spouse name and born/died
        const spouseHeader = document.createElement('div');
        spouseHeader.classList.add('node-header');

        const spouseName = document.createElement('input');
        spouseName.type = 'text';
        spouseName.value = spouse.name || '';
        spouseName.placeholder = 'Spouse Name';
        spouseName.addEventListener('change', e => {
          spouse.name = e.target.value;
          saveFamilyTrees();
          renderConnections();
        });
        spouseHeader.appendChild(spouseName);

        const spouseBorn = document.createElement('input');
        spouseBorn.type = 'date';
        spouseBorn.value = spouse.born || '';
        spouseBorn.title = "Date of Birth";
        spouseBorn.addEventListener('change', e => {
          spouse.born = e.target.value;
          saveFamilyTrees();
          renderConnections();
        });
        spouseHeader.appendChild(spouseBorn);

        const spouseDied = document.createElement('input');
        spouseDied.type = 'date';
        spouseDied.value = spouse.died || '';
        spouseDied.title = "Date of Death";
        spouseDied.addEventListener('change', e => {
          spouse.died = e.target.value;
          saveFamilyTrees();
          renderConnections();
        });
        spouseHeader.appendChild(spouseDied);

        const spouseDiedCheckbox = document.createElement('input');
        spouseDiedCheckbox.type = 'checkbox';
        spouseDiedCheckbox.checked = !!spouse.died;
        spouseDiedCheckbox.title = "Mark as Deceased";
        spouseDiedCheckbox.addEventListener('change', e => {
          if (e.target.checked) {
            if (!spouse.died) {
              spouse.died = new Date().toISOString().substring(0, 10);
              spouseDied.value = spouse.died;
            }
          } else {
            spouse.died = '';
            spouseDied.value = '';
          }
          saveFamilyTrees();
          renderConnections();
        });
        spouseHeader.appendChild(spouseDiedCheckbox);

        // Buttons: Add child to spouse, Delete spouse
        const spouseButtons = document.createElement('div');
        spouseButtons.classList.add('node-buttons');

        const addChildBtn = document.createElement('button');
        addChildBtn.textContent = '+Child';
        addChildBtn.title = "Add child to this spouse";
        addChildBtn.addEventListener('click', () => {
          addChild(nodeId, sid);
        });
        spouseButtons.appendChild(addChildBtn);

        const deleteSpouseBtn = document.createElement('button');
        deleteSpouseBtn.textContent = 'Delete Spouse';
        deleteSpouseBtn.classList.add('delete-btn');
        deleteSpouseBtn.title = "Remove this spouse";
        deleteSpouseBtn.addEventListener('click', () => {
          deleteSpouse(nodeId, sid);
        });
        spouseButtons.appendChild(deleteSpouseBtn);

        spouseHeader.appendChild(spouseButtons);

        spouseDiv.appendChild(spouseHeader);

        // Children of spouse
        if (spouse.children) {
          const childrenCont = document.createElement('div');
          childrenCont.classList.add('children-container');
          const childIds = Object.keys(spouse.children);
          childIds.forEach(cid => {
            renderNode(spouse.children[cid], childrenCont, cid, nodeId);
          });
          spouseDiv.appendChild(childrenCont);
        }

        spousesCont.appendChild(spouseDiv);
      });
    }

    // Add spouse button
    const addSpouseBtn = document.createElement('button');
    addSpouseBtn.textContent = '+ Add Spouse';
    addSpouseBtn.addEventListener('click', () => {
      addSpouse(nodeId);
    });
    spousesCont.appendChild(addSpouseBtn);

    nodeDiv.appendChild(spousesCont);

    container.appendChild(nodeDiv);

    // After appending, draw lines to children
    drawConnections(nodeDiv, node, nodeId);
  }

  // Add spouse to a person
  function addSpouse(nodeId) {
    if (!familyTrees[nodeId].spouses) familyTrees[nodeId].spouses = {};
    const newSpouseId = generateId();
    familyTrees[nodeId].spouses[newSpouseId] = {
      name: '',
      born: '',
      died: '',
      children: {}
    };
    saveFamilyTrees();
  }

  // Add child to a spouse
  function addChild(parentId, spouseId) {
    if (!familyTrees[parentId].spouses[spouseId].children) {
      familyTrees[parentId].spouses[spouseId].children = {};
    }
    const newChildId = generateId();
    familyTrees[parentId].spouses[spouseId].children[newChildId] = {
      name: '',
      born: '',
      died: '',
      spouses: {}
    };
    saveFamilyTrees();
  }

  // Delete a person (and all their family)
  function deleteNode(nodeId) {
    delete familyTrees[nodeId];
    saveFamilyTrees();
  }

  // Delete spouse
  function deleteSpouse(nodeId, spouseId) {
    delete familyTrees[nodeId].spouses[spouseId];
    saveFamilyTrees();
  }

  // Utility to generate ID
  function generateId() {
    return Math.random().toString(36).slice(2, 10);
  }

  // DRAW CONNECTIONS FOR EACH NODE TO THEIR CHILDREN - arrows on left side
  function drawConnections(nodeDiv, node, nodeId) {
    // Remove old connectors inside nodeDiv
    [...nodeDiv.querySelectorAll('svg.connector-svg')].forEach(el => el.remove());

    if (!node.spouses) return;

    // For each spouse, connect nodeDiv to spouse children
    Object.entries(node.spouses).forEach(([spouseId, spouse]) => {
      if (!spouse.children) return;

      const spouseDiv = [...nodeDiv.querySelectorAll('.spouse-node')].find(d => {
        return d.querySelector('input[type=text]').value === spouse.name;
      });
      if (!spouseDiv) return;

      // Coordinates for nodeDiv and children container
      const containerRect = familyTreeContainer.getBoundingClientRect();
      const nodeRect = nodeDiv.getBoundingClientRect();
      const spouseRect = spouseDiv.getBoundingClientRect();

      // Connect main person to spouse node horizontally (they are side by side)
      // We can skip if already close

      // Connect spouses and children vertically
      const childrenCont = spouseDiv.querySelector('.children-container');
      if (!childrenCont) return;

      const children = [...childrenCont.children];
      children.forEach(childNodeDiv => {
        const childRect = childNodeDiv.getBoundingClientRect();

        // Draw vertical line from spouse bottom center to child top center
        const x1 = spouseRect.left - containerRect.left + spouseRect.width/2;
        const y1 = spouseRect.bottom - containerRect.top;

        const x2 = childRect.left - containerRect.left + childRect.width/2;
        const y2 = childRect.top - containerRect.top;

        const svgLine = createLine(x1, y1, x2, y2);
        familyTreeContainer.appendChild(svgLine);
      });

      // Also draw horizontal connection between main node and spouses
      const xNode = nodeRect.right - containerRect.left;
      const yNode = nodeRect.top + nodeRect.height/2 - containerRect.top;

      const xSpouse = spouseRect.left - containerRect.left;
      const ySpouse = spouseRect.top + spouseRect.height/2 - containerRect.top;

      // Only draw if gap > 10px to avoid overlap
      if (xSpouse - xNode > 10) {
        const svgLine = createLine(xNode, yNode, xSpouse, ySpouse);
        familyTreeContainer.appendChild(svgLine);
      }
    });
  }

  // RENDER CONNECTIONS ON THE RIGHT SIDE panel
  function renderConnections() {
    connectionsList.innerHTML = '';

    // For every node and their spouses and children, list relationship text
    for (const nodeId in familyTrees) {
      const node = familyTrees[nodeId];
      const nodeName = node.name || '[No name]';

      if (node.spouses) {
        for (const spouseId in node.spouses) {
          const spouse = node.spouses[spouseId];
          const spouseName = spouse.name || '[No name]';

          // Spouse relation
          const liSpouse = document.createElement('li');
          liSpouse.textContent = `${nodeName} ↔ ${spouseName} (Spouse)`;
          connectionsList.appendChild(liSpouse);

          // Children relations
          if (spouse.children) {
            for (const childId in spouse.children) {
              const child = spouse.children[childId];
              const childName = child.name || '[No name]';
              const liChild = document.createElement('li');
              liChild.textContent = `${nodeName} + ${spouseName} → ${childName} (Child)`;
              connectionsList.appendChild(liChild);
            }
          }
        }
      }
    }
  }
</script>

<!-- SVG Arrowhead definition for lines -->
<svg width="0" height="0" style="position:absolute;visibility:hidden">
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
        refX="10" refY="3.5" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L10,3.5 L0,7" fill="#007bff" />
    </marker>
  </defs>
</svg>

</body>
</html>
