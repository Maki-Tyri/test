<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Tree App</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0 20px 60px;
    background: #f5f5f5;
  }
  h2 { margin-top: 0; }
  #login-container, #app-container {
    max-width: 900px;
    margin: 20px auto;
    background: white;
    padding: 20px;
    border-radius: 6px;
    box-shadow: 0 0 12px #ccc;
  }
  #birthday-notifications {
    background: #fffbcc;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 20px;
    font-weight: bold;
    color: #7a6600;
  }
  form {
    margin-bottom: 20px;
  }
  input[type=text], input[type=password], input[type=email], input[type=date] {
    padding: 6px 10px;
    font-size: 14px;
    margin-right: 10px;
    border: 1px solid #ccc;
    border-radius: 3px;
  }
  button {
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 4px;
    border: none;
    background-color: #007bff;
    color: white;
    font-weight: bold;
    transition: background-color 0.2s ease;
  }
  button:hover {
    background-color: #0056b3;
  }
  footer {
    text-align: center;
    padding: 15px 0;
    font-size: 14px;
    color: #666;
    background-color: #f1f1f1;
    position: fixed;
    bottom: 0;
    width: 100%;
  }

  /* Family Tree Styling */
  #family-trees-container {
    display: flex;
    gap: 40px;
    flex-wrap: wrap;
    justify-content: flex-start;
  }

  .tree-node {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 10px 15px;
    margin-bottom: 20px;
    box-shadow: 0 2px 5px rgb(0 0 0 / 0.1);
    position: relative;
    min-width: 200px;
  }

  /* Node header */
  .node-header {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }

  .node-header input[type=text] {
    flex-grow: 1;
    min-width: 100px;
  }
  .node-header input[type=date] {
    max-width: 140px;
  }

  .node-buttons {
    margin-left: auto;
    display: flex;
    gap: 6px;
  }

  .node-buttons button {
    background-color: #28a745;
    padding: 4px 8px;
    font-size: 13px;
  }
  .node-buttons button.delete-btn {
    background-color: #dc3545;
  }
  .node-buttons button:hover {
    opacity: 0.85;
  }

  /* Arrows & Connectors */
  .arrow {
    user-select: none;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    width: 16px;
    display: flex;
    justify-content: center;
  }

  /* Containers for children and spouses */
  .children-container,
  .spouses-container {
    margin-left: 40px;
    position: relative;
    padding-left: 20px;
    border-left: 2px solid #007bff;
  }

  /* Spouses horizontally aligned */
  .spouses-container {
    display: flex;
    gap: 15px;
    margin-top: 12px;
    margin-left: 0;
    padding-left: 0;
    border-left: none;
    position: relative;
  }

  /* Horizontal connector line between spouses */
  .spouse-connector {
    position: absolute;
    top: 12px;
    left: 0;
    right: 0;
    height: 2px;
    background: #007bff;
    z-index: 0;
  }

  /* Spouse individual box */
  .spouse-node {
    position: relative;
    z-index: 1;
  }

  /* SVG connectors */
  svg.connector-svg {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    overflow: visible;
    z-index: 0;
  }

  /* Add Child / Spouse forms styling */
  form.add-child-form,
  form.add-spouse-form {
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  form.add-child-form input,
  form.add-spouse-form input {
    flex-shrink: 0;
  }
  form.add-child-form button,
  form.add-spouse-form button {
    background-color: #17a2b8;
  }
  form.add-child-form button:hover,
  form.add-spouse-form button:hover {
    background-color: #117a8b;
  }
  label {
    font-size: 13px;
  }
</style>
</head>
<body>

<div id="login-container">
  <h2>Login</h2>
  <input id="email" type="email" placeholder="Email" />
  <input id="password" type="password" placeholder="Password" />
  <button id="login-btn">Login</button>
</div>

<div id="app-container" style="display:none;">
  <button id="logout-btn">Logout</button>
  <div id="birthday-notifications"></div>

  <h3>Add Root Person</h3>
  <form id="add-root-form">
    <input type="text" id="root-name" placeholder="Name" required />
    <input type="date" id="root-birthday" required />
    <label for="root-died">Died</label>
    <input type="checkbox" id="root-died" />
    <input type="date" id="root-died-date" style="display:none; margin-left:10px;" />
    <button type="submit">Add Root</button>
  </form>

  <div id="family-trees-container"></div>
</div>

<footer>&copy; 2025 Maki Web. All rights reserved</footer>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
  // Firebase Config & Initialization
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    databaseURL: "YOUR_DATABASE_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();

  // UI Elements
  const loginContainer = document.getElementById('login-container');
  const appContainer = document.getElementById('app-container');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const birthdayNotifications = document.getElementById('birthday-notifications');
  const familyTreesContainer = document.getElementById('family-trees-container');

  // Root form elements (for died checkbox/date)
  const rootDiedCheckbox = document.getElementById('root-died');
  const rootDiedDateInput = document.getElementById('root-died-date');
  rootDiedCheckbox.addEventListener('change', () => {
    rootDiedDateInput.style.display = rootDiedCheckbox.checked ? 'inline-block' : 'none';
  });

  // Authentication
  loginBtn.addEventListener('click', () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) {
      alert('Please enter email and password.');
      return;
    }
    auth.signInWithEmailAndPassword(email, password).catch(err => alert(err.message));
  });

  logoutBtn.addEventListener('click', () => {
    auth.signOut();
  });

  auth.onAuthStateChanged(user => {
    if (user) {
      loginContainer.style.display = 'none';
      appContainer.style.display = 'block';
      loadFamilyTrees();
    } else {
      loginContainer.style.display = 'block';
      appContainer.style.display = 'none';
      birthdayNotifications.textContent = '';
      familyTreesContainer.innerHTML = '';
    }
  });

  // Family Trees Data
  let familyTrees = {};

  // Load Family Trees
  function loadFamilyTrees() {
    const userId = auth.currentUser.uid;
    const userTreesRef = database.ref(`familyTrees/${userId}`);
    userTreesRef.off();

    userTreesRef.on('value', snapshot => {
      familyTrees = snapshot.val() || {};
      renderFamilyTrees();
      showTodayBirthdays();
    });
  }

  // Save Family Trees
  function saveFamilyTrees() {
    const userId = auth.currentUser.uid;
    database.ref(`familyTrees/${userId}`).set(familyTrees);
  }

  // Add Root Person Form Submit
  const addRootForm = document.getElementById('add-root-form');
  addRootForm.addEventListener('submit', e => {
    e.preventDefault();
    const name = document.getElementById('root-name').value.trim();
    const birthday = document.getElementById('root-birthday').value;
    const died = rootDiedCheckbox.checked;
    const diedDate = rootDiedDateInput.value;

    if (!name || !birthday) {
      alert('Please fill in the name and birthday.');
      return;
    }
    if (died && !diedDate) {
      alert('Please enter date of death.');
      return;
    }

    const treeId = Date.now().toString();
    familyTrees[treeId] = {
      id: treeId,
      name,
      birthday,
      died: died ? true : false,
      diedDate: died ? diedDate : '',
      children: {},
      spouses: {}
    };
    saveFamilyTrees();
    addRootForm.reset();
    rootDiedDateInput.style.display = 'none';
  });

  // Show Today's Birthdays and Death Anniversaries
  function showTodayBirthdays() {
    birthdayNotifications.textContent = '';
    const today = new Date();
    const monthDay = today.toISOString().slice(5,10);

    let notifications = [];

    for (const treeId in familyTrees) {
      const tree = familyTrees[treeId];
      checkNode(tree);
    }

    function checkNode(node) {
      if (node.birthday && node.birthday.slice(5,10) === monthDay) {
        notifications.push(`${node.name} has birthday today!`);
      }
      if (node.died && node.diedDate && node.diedDate.slice(5,10) === monthDay) {
        notifications.push(`Remembering ${node.name}, who passed away today.`);
      }
      for (const childId in node.children || {}) {
        checkNode(node.children[childId]);
      }
      for (const spouseId in node.spouses || {}) {
        checkNode(node.spouses[spouseId]);
      }
    }

    if (notifications.length > 0) {
      birthdayNotifications.innerHTML = notifications.join('<br>');
    }
  }

  // Render Family Trees
  function renderFamilyTrees() {
    familyTreesContainer.innerHTML = '';
    for (const treeId in familyTrees) {
      const tree = familyTrees[treeId];
      const treeDiv = document.createElement('div');
      treeDiv.style.position = 'relative';
      treeDiv.style.minWidth = '300px';
      renderNode(tree, treeDiv, treeId, null);
      familyTreesContainer.appendChild(treeDiv);
    }
  }

  // Helper: Create SVG line connector
  function createLine(x1, y1, x2, y2) {
    const ns = "http://www.w3.org/2000/svg";
    const line = document.createElementNS(ns, "line");
    line.setAttribute("x1", x1);
    line.setAttribute("y1", y1);
    line.setAttribute("x2", x2);
    line.setAttribute("y2", y2);
    line.setAttribute("stroke", "#007bff");
    line.setAttribute("stroke-width", "2");
    return line;
  }

  // Render one node (person) recursively
  // parentDiv: where this node will be appended
  // parentId: parent's id (used for connections)
  function renderNode(node, parentDiv, nodeId, parentNodeDiv) {
    const nodeDiv = document.createElement('div');
    nodeDiv.className = 'tree-node';
    nodeDiv.dataset.id = nodeId;

    // Node Header: Name + birthday + died checkbox + died date
    const header = document.createElement('div');
    header.className = 'node-header';

    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = node.name;
    nameInput.title = "Name";
    header.appendChild(nameInput);

    const birthdayInput = document.createElement('input');
    birthdayInput.type = 'date';
    birthdayInput.value = node.birthday || '';
    birthdayInput.title = "Birthday";
    header.appendChild(birthdayInput);

    const diedCheckbox = document.createElement('input');
    diedCheckbox.type = 'checkbox';
    diedCheckbox.checked = node.died || false;
    diedCheckbox.title = "Died";
    header.appendChild(diedCheckbox);

    const diedDateInput = document.createElement('input');
    diedDateInput.type = 'date';
    diedDateInput.value = node.diedDate || '';
    diedDateInput.style.display = diedCheckbox.checked ? 'inline-block' : 'none';
    diedDateInput.title = "Date of Death";
    diedDateInput.style.marginLeft = '8px';
    header.appendChild(diedDateInput);

    diedCheckbox.addEventListener('change', () => {
      diedDateInput.style.display = diedCheckbox.checked ? 'inline-block' : 'none';
      node.died = diedCheckbox.checked;
      if (!diedCheckbox.checked) {
        node.diedDate = '';
        diedDateInput.value = '';
      }
      saveNodeChanges();
    });

    // Save changes on input changes
    nameInput.addEventListener('input', () => {
      node.name = nameInput.value;
      saveNodeChanges();
      showTodayBirthdays();
    });
    birthdayInput.addEventListener('change', () => {
      node.birthday = birthdayInput.value;
      saveNodeChanges();
      showTodayBirthdays();
    });
    diedDateInput.addEventListener('change', () => {
      node.diedDate = diedDateInput.value;
      saveNodeChanges();
      showTodayBirthdays();
    });

    // Buttons: Add Child, Add Spouse, Delete
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'node-buttons';

    // Add Child button
    const addChildBtn = document.createElement('button');
    addChildBtn.textContent = '+Child';
    addChildBtn.title = 'Add Child';
    addChildBtn.addEventListener('click', () => {
      showAddChildForm(node, nodeId, childrenContainer);
    });
    buttonsDiv.appendChild(addChildBtn);

    // Add Spouse button
    const addSpouseBtn = document.createElement('button');
    addSpouseBtn.textContent = '+Spouse';
    addSpouseBtn.title = 'Add Spouse';
    addSpouseBtn.addEventListener('click', () => {
      showAddSpouseForm(node, nodeId, spousesContainer);
    });
    buttonsDiv.appendChild(addSpouseBtn);

    // Delete button (only if not root)
    if (parentNodeDiv !== null) {
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete';
      deleteBtn.className = 'delete-btn';
      deleteBtn.title = 'Delete Person';
      deleteBtn.addEventListener('click', () => {
        if (confirm(`Delete ${node.name} and all their descendants?`)) {
          deleteNode(nodeId, parentNodeDiv.dataset.id);
        }
      });
      buttonsDiv.appendChild(deleteBtn);
    }

    header.appendChild(buttonsDiv);
    nodeDiv.appendChild(header);

    // Spouses container - horizontal layout, spouses side by side
    const spousesContainer = document.createElement('div');
    spousesContainer.className = 'spouses-container';

    // Horizontal connector line between spouses
    if (Object.keys(node.spouses || {}).length > 1) {
      const spouseLine = document.createElement('div');
      spouseLine.className = 'spouse-connector';
      spousesContainer.appendChild(spouseLine);
    }

    // Render each spouse inside spousesContainer
    for (const spouseId in node.spouses || {}) {
      const spouse = node.spouses[spouseId];
      const spouseDiv = document.createElement('div');
      spouseDiv.className = 'tree-node spouse-node';
      spouseDiv.dataset.id = spouseId;

      // Spouse header
      const spouseHeader = document.createElement('div');
      spouseHeader.className = 'node-header';

      const spouseNameInput = document.createElement('input');
      spouseNameInput.type = 'text';
      spouseNameInput.value = spouse.name;
      spouseNameInput.title = 'Spouse Name';
      spouseHeader.appendChild(spouseNameInput);

      const spouseBirthdayInput = document.createElement('input');
      spouseBirthdayInput.type = 'date';
      spouseBirthdayInput.value = spouse.birthday || '';
      spouseBirthdayInput.title = 'Spouse Birthday';
      spouseHeader.appendChild(spouseBirthdayInput);

      const spouseDiedCheckbox = document.createElement('input');
      spouseDiedCheckbox.type = 'checkbox';
      spouseDiedCheckbox.checked = spouse.died || false;
      spouseDiedCheckbox.title = 'Spouse Died';
      spouseHeader.appendChild(spouseDiedCheckbox);

      const spouseDiedDateInput = document.createElement('input');
      spouseDiedDateInput.type = 'date';
      spouseDiedDateInput.value = spouse.diedDate || '';
      spouseDiedDateInput.style.display = spouseDiedCheckbox.checked ? 'inline-block' : 'none';
      spouseDiedDateInput.title = 'Date of Death';
      spouseDiedDateInput.style.marginLeft = '8px';
      spouseHeader.appendChild(spouseDiedDateInput);

      spouseDiedCheckbox.addEventListener('change', () => {
        spouseDiedDateInput.style.display = spouseDiedCheckbox.checked ? 'inline-block' : 'none';
        spouse.died = spouseDiedCheckbox.checked;
        if (!spouseDiedCheckbox.checked) {
          spouse.diedDate = '';
          spouseDiedDateInput.value = '';
        }
        saveNodeChanges();
      });

      spouseNameInput.addEventListener('input', () => {
        spouse.name = spouseNameInput.value;
        saveNodeChanges();
        showTodayBirthdays();
      });
      spouseBirthdayInput.addEventListener('change', () => {
        spouse.birthday = spouseBirthdayInput.value;
        saveNodeChanges();
        showTodayBirthdays();
      });
      spouseDiedDateInput.addEventListener('change', () => {
        spouse.diedDate = spouseDiedDateInput.value;
        saveNodeChanges();
        showTodayBirthdays();
      });

      // Spouse buttons: Add Child, Delete
      const spouseButtonsDiv = document.createElement('div');
      spouseButtonsDiv.className = 'node-buttons';

      const spouseAddChildBtn = document.createElement('button');
      spouseAddChildBtn.textContent = '+Child';
      spouseAddChildBtn.title = 'Add Child';
      spouseAddChildBtn.addEventListener('click', () => {
        showAddChildForm(spouse, spouseId, childrenContainer);
      });
      spouseButtonsDiv.appendChild(spouseAddChildBtn);

      const spouseDeleteBtn = document.createElement('button');
      spouseDeleteBtn.textContent = 'Delete';
      spouseDeleteBtn.className = 'delete-btn';
      spouseDeleteBtn.title = 'Delete Spouse';
      spouseDeleteBtn.addEventListener('click', () => {
        if (confirm(`Delete spouse ${spouse.name} and all their descendants?`)) {
          deleteSpouse(node, nodeId, spouseId);
        }
      });
      spouseButtonsDiv.appendChild(spouseDeleteBtn);

      spouseHeader.appendChild(spouseButtonsDiv);
      spouseDiv.appendChild(spouseHeader);

      spousesContainer.appendChild(spouseDiv);
    }

    nodeDiv.appendChild(spousesContainer);

    // Children container - vertical layout with left border line (arrow)
    const childrenContainer = document.createElement('div');
    childrenContainer.className = 'children-container';

    // Render children nodes recursively
    for (const childId in node.children || {}) {
      renderNode(node.children[childId], childrenContainer, childId, nodeDiv);
    }

    nodeDiv.appendChild(childrenContainer);

    parentDiv.appendChild(nodeDiv);

    // After DOM elements are appended, draw SVG connectors for children & spouses
    setTimeout(() => {
      drawConnectors(nodeDiv);
    }, 10);

    // Save changes helper
    function saveNodeChanges() {
      saveFamilyTrees();
    }
  }

  // Show Add Child form inline under children container
  function showAddChildForm(parentNode, parentNodeId, childrenContainer) {
    // Prevent multiple forms
    if (childrenContainer.querySelector('.add-child-form')) return;

    const form = document.createElement('form');
    form.className = 'add-child-form';

    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.placeholder = 'Child Name';
    nameInput.required = true;
    form.appendChild(nameInput);

    const birthdayInput = document.createElement('input');
    birthdayInput.type = 'date';
    birthdayInput.required = true;
    form.appendChild(birthdayInput);

    const diedCheckbox = document.createElement('input');
    diedCheckbox.type = 'checkbox';
    form.appendChild(diedCheckbox);

    const diedDateInput = document.createElement('input');
    diedDateInput.type = 'date';
    diedDateInput.style.display = 'none';
    diedDateInput.style.marginLeft = '6px';
    form.appendChild(diedDateInput);

    diedCheckbox.addEventListener('change', () => {
      diedDateInput.style.display = diedCheckbox.checked ? 'inline-block' : 'none';
      if (!diedCheckbox.checked) diedDateInput.value = '';
    });

    const addBtn = document.createElement('button');
    addBtn.type = 'submit';
    addBtn.textContent = 'Add Child';
    form.appendChild(addBtn);

    form.addEventListener('submit', e => {
      e.preventDefault();
      if (!nameInput.value.trim() || !birthdayInput.value) {
        alert('Please enter name and birthday for child.');
        return;
      }
      if (diedCheckbox.checked && !diedDateInput.value) {
        alert('Please enter date of death.');
        return;
      }

      const childId = Date.now().toString();
      if (!parentNode.children) parentNode.children = {};
      parentNode.children[childId] = {
        id: childId,
        name: nameInput.value.trim(),
        birthday: birthdayInput.value,
        died: diedCheckbox.checked,
        diedDate: diedCheckbox.checked ? diedDateInput.value : '',
        children: {},
        spouses: {}
      };
      saveFamilyTrees();
      renderFamilyTrees();
    });

    childrenContainer.appendChild(form);
  }

  // Show Add Spouse form inline under spouses container
  function showAddSpouseForm(parentNode, parentNodeId, spousesContainer) {
    if (spousesContainer.querySelector('.add-spouse-form')) return;

    const form = document.createElement('form');
    form.className = 'add-spouse-form';

    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.placeholder = 'Spouse Name';
    nameInput.required = true;
    form.appendChild(nameInput);

    const birthdayInput = document.createElement('input');
    birthdayInput.type = 'date';
    birthdayInput.required = true;
    form.appendChild(birthdayInput);

    const diedCheckbox = document.createElement('input');
    diedCheckbox.type = 'checkbox';
    form.appendChild(diedCheckbox);

    const diedDateInput = document.createElement('input');
    diedDateInput.type = 'date';
    diedDateInput.style.display = 'none';
    diedDateInput.style.marginLeft = '6px';
    form.appendChild(diedDateInput);

    diedCheckbox.addEventListener('change', () => {
      diedDateInput.style.display = diedCheckbox.checked ? 'inline-block' : 'none';
      if (!diedCheckbox.checked) diedDateInput.value = '';
    });

    const addBtn = document.createElement('button');
    addBtn.type = 'submit';
    addBtn.textContent = 'Add Spouse';
    form.appendChild(addBtn);

    form.addEventListener('submit', e => {
      e.preventDefault();
      if (!nameInput.value.trim() || !birthdayInput.value) {
        alert('Please enter name and birthday for spouse.');
        return;
      }
      if (diedCheckbox.checked && !diedDateInput.value) {
        alert('Please enter date of death.');
        return;
      }

      const spouseId = Date.now().toString();
      if (!parentNode.spouses) parentNode.spouses = {};
      parentNode.spouses[spouseId] = {
        id: spouseId,
        name: nameInput.value.trim(),
        birthday: birthdayInput.value,
        died: diedCheckbox.checked,
        diedDate: diedCheckbox.checked ? diedDateInput.value : '',
        children: {},
        spouses: {}
      };
      saveFamilyTrees();
      renderFamilyTrees();
    });

    spousesContainer.appendChild(form);
  }

  // Delete a node from parent's children
  function deleteNode(nodeId, parentId) {
    if (!parentId) {
      delete familyTrees[nodeId];
    } else {
      // search all familyTrees for parent and delete child
      for (const treeId in familyTrees) {
        const node = familyTrees[treeId];
        if (deleteChildRecursive(node, parentId, nodeId)) break;
      }
    }
    saveFamilyTrees();
  }

  function deleteChildRecursive(node, parentId, nodeId) {
    if (node.id === parentId && node.children && node.children[nodeId]) {
      delete node.children[nodeId];
      return true;
    }
    for (const childId in node.children || {}) {
      if (deleteChildRecursive(node.children[childId], parentId, nodeId)) return true;
    }
    for (const spouseId in node.spouses || {}) {
      if (deleteChildRecursive(node.spouses[spouseId], parentId, nodeId)) return true;
    }
    return false;
  }

  // Delete spouse from parent node
  function deleteSpouse(parentNode, parentNodeId, spouseId) {
    if (parentNode.spouses && parentNode.spouses[spouseId]) {
      delete parentNode.spouses[spouseId];
      saveFamilyTrees();
      renderFamilyTrees();
    }
  }

  // Draw SVG connectors for children and spouses inside a node div
  function drawConnectors(nodeDiv) {
    // Remove previous SVGs
    [...nodeDiv.querySelectorAll('svg.connector-svg')].forEach(svg => svg.remove());

    const rect = nodeDiv.getBoundingClientRect();

    // Connect spouses with horizontal line (already done by CSS)
    // Connect parent to each child with vertical lines

    // Find children container
    const childrenContainer = nodeDiv.querySelector('.children-container');
    if (!childrenContainer) return;

    // Create SVG to cover from bottom of parent node to top of children container
    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.classList.add('connector-svg');

    // Position SVG relative to nodeDiv's top-left corner, absolute positioned
    svg.style.position = 'absolute';
    svg.style.top = '0px';
    svg.style.left = '0px';
    svg.style.width = nodeDiv.offsetWidth + 'px';
    svg.style.height = nodeDiv.offsetHeight + 'px';
    svg.style.pointerEvents = 'none';
    nodeDiv.style.position = 'relative'; // ensure relative position for svg absolute

    // Parent bottom center point
    const parentBox = nodeDiv.querySelector('.node-header').getBoundingClientRect();
    const parentBottomX = nodeDiv.offsetWidth / 2;
    const parentBottomY = parentBox.bottom - nodeDiv.getBoundingClientRect().top;

    // For each child, draw vertical line connecting parent to child
    const childrenNodes = childrenContainer.querySelectorAll('.tree-node');

    childrenNodes.forEach(childDiv => {
      const childBox = childDiv.querySelector('.node-header').getBoundingClientRect();
      const childX = childDiv.offsetLeft + childDiv.offsetWidth / 2;
      const childY = childBox.top - nodeDiv.getBoundingClientRect().top;

      // Draw vertical line down from parentBottomX, parentBottomY to childY - 10
      const line1 = document.createElementNS(svg.namespaceURI, 'line');
      line1.setAttribute('x1', parentBottomX);
      line1.setAttribute('y1', parentBottomY);
      line1.setAttribute('x2', parentBottomX);
      line1.setAttribute('y2', childY - 10);
      line1.setAttribute('stroke', '#007bff');
      line1.setAttribute('stroke-width', '2');
      svg.appendChild(line1);

      // Draw horizontal line from parentBottomX to childX at childY - 10
      const line2 = document.createElementNS(svg.namespaceURI, 'line');
      line2.setAttribute('x1', parentBottomX);
      line2.setAttribute('y1', childY - 10);
      line2.setAttribute('x2', childX);
      line2.setAttribute('y2', childY - 10);
      line2.setAttribute('stroke', '#007bff');
      line2.setAttribute('stroke-width', '2');
      svg.appendChild(line2);

      // Draw vertical line down from childY -10 to childY (to child's box top)
      const line3 = document.createElementNS(svg.namespaceURI, 'line');
      line3.setAttribute('x1', childX);
      line3.setAttribute('y1', childY - 10);
      line3.setAttribute('x2', childX);
      line3.setAttribute('y2', childY);
      line3.setAttribute('stroke', '#007bff');
      line3.setAttribute('stroke-width', '2');
      svg.appendChild(line3);
    });

    nodeDiv.appendChild(svg);
  }

</script>
</body>
</html>
