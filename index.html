<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree with Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
    window.firebaseImports = { initializeApp, getDatabase, ref, onValue, set, update };
  </script>
  <style>
    .highlight {
      background-color: #ffe58f;
      border-radius: 0.25rem;
      box-shadow: 0 0 8px 2px #ffd666aa;
      animation: none;
    }

    .blink-highlight {
      animation: blink 1s infinite;
      background-color: #ffd666;
      border-radius: 0.25rem;
      box-shadow: 0 0 8px 2px #ffb700cc;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .node-box {
      display: inline-block;
      border: 2px solid #93c5fd;
      border-radius: 0.5rem;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.5rem;
      background: white;
      box-shadow: 0 2px 6px rgb(147 197 253 / 0.5);
      position: relative;
      max-width: 100%;
    }

    .tree-node-container {
      border-left: 2px solid #93c5fd;
      margin-left: 1rem;
      padding-left: 1rem;
    }

    #tree-scroll-container {
      width: 100%;
      max-width: 100vw;
      height: 70vh;
      overflow: auto;
      border: 1px solid #cbd5e1;
      border-radius: 0.5rem;
      padding: 1rem;
      background: #f9fafb;
      box-sizing: border-box;
      user-select: none;
    }

    .toggle-expand-btn {
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      background-color: #3b82f6;
      color: white;
      font-weight: 600;
      border-radius: 0.375rem;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    .toggle-expand-btn:hover {
      background-color: #2563eb;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">
  <div id="root" class="w-full max-w-6xl bg-white p-6 rounded shadow"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { initializeApp, getDatabase, ref, onValue, set } = window.firebaseImports;

    const firebaseConfig = {
      apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
      authDomain: "project-955237504610034331.firebaseapp.com",
      databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
      projectId: "project-955237504610034331",
      storageBucket: "project-955237504610034331.appspot.com",
      messagingSenderId: "76212939677",
      appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
      measurementId: "G-RCJ4P82PVM"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    function TreeNode({ node, search, highlightSet }) {
      const isMatch = search && node.name.toLowerCase().includes(search.toLowerCase());
      const isBlink = highlightSet.has(node.id);
      return (
        <div className={`mb-2`}>
          <div className={`node-box ${isMatch ? "highlight" : ""} ${isBlink ? "blink-highlight" : ""}`}>
            {node.name}
          </div>
          {node.children && node.children.length > 0 && (
            <div className="tree-node-container">
              {node.children.map((child, idx) => (
                <TreeNode key={idx} node={child} search={search} highlightSet={highlightSet} />
              ))}
            </div>
          )}
        </div>
      );
    }

    function collectAncestorIds(tree, targetName) {
      const ancestors = new Set();
      function dfs(node, path) {
        if (node.name.toLowerCase().includes(targetName.toLowerCase())) {
          path.forEach(p => ancestors.add(p.id));
          ancestors.add(node.id);
          return true;
        }
        for (const child of node.children || []) {
          if (dfs(child, [...path, node])) return true;
        }
        return false;
      }
      dfs(tree, []);
      return ancestors;
    }

    function App() {
      const [treeData, setTreeData] = useState(null);
      const [search, setSearch] = useState("");
      const [highlightSet, setHighlightSet] = useState(new Set());

      useEffect(() => {
        const treeRef = ref(database, "/tree");
        const unsub = onValue(treeRef, (snap) => {
          const data = snap.val();
          if (data) {
            setTreeData(data);
          }
        });
        return () => unsub();
      }, []);

      useEffect(() => {
        if (!treeData || !search.trim()) {
          setHighlightSet(new Set());
          return;
        }
        const set = collectAncestorIds(treeData, search.trim());
        setHighlightSet(set);
      }, [search, treeData]);

      if (!treeData) return <div>Loading...</div>;

      return (
        <div>
          <input
            className="mb-4 border px-2 py-1 rounded w-full"
            placeholder="Search name..."
            value={search}
            onChange={e => setSearch(e.target.value)}
          />
          <div id="tree-scroll-container">
            <TreeNode node={treeData} search={search} highlightSet={highlightSet} />
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
