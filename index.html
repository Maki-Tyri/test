<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Tree App with Firebase Realtime DB</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin:0; padding:0; height: 100%;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f4f8;
    display: flex; flex-direction: column;
  }
  #app {
    flex: 1;
    display: flex;
    flex-direction: row;
    overflow: hidden;
    min-height: 0;
  }

  /* Sidebar with family tree nodes */
  #family-tree-container {
    flex: 1 1 auto;
    overflow-y: auto;
    background: #fff;
    border-right: 1px solid #ccc;
    padding: 10px 8px;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  /* Connections container on left side fixed width */
  #connections-container {
    width: 200px;
    background: #e9f0ff;
    border-right: 1px solid #bbb;
    overflow-y: auto;
    padding: 10px;
    font-size: 0.9rem;
  }
  #connections-container h2 {
    font-weight: 600;
    margin-top: 0;
    margin-bottom: 10px;
    color: #007bff;
  }
  #connections-list {
    list-style: none;
    padding-left: 0;
    max-height: calc(100vh - 60px);
    overflow-y: auto;
  }
  #connections-list li {
    margin-bottom: 8px;
    cursor: pointer;
    padding: 6px 8px;
    border-radius: 5px;
    transition: background-color 0.15s ease;
  }
  #connections-list li:hover {
    background-color: #d0e0ff;
  }

  /* Node styles */
  .tree-node {
    border: 1px solid #007bff;
    border-radius: 6px;
    padding: 8px;
    margin-bottom: 12px;
    background: #f9fcff;
    display: flex;
    flex-direction: column;
    gap: 6px;
    box-shadow: 0 2px 4px rgb(0 123 255 / 0.2);
  }
  .node-header {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
  }
  .node-header input[type="text"] {
    font-weight: 700;
    border: none;
    border-bottom: 2px solid transparent;
    background: transparent;
    width: 130px;
    padding: 4px 6px;
    transition: border-color 0.2s ease;
  }
  .node-header input[type="text"]:focus {
    outline: none;
    border-color: #007bff;
  }
  .node-header input[type="date"] {
    border: 1px solid #bbb;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 0.9rem;
    min-width: 130px;
  }
  .node-header input[type="checkbox"] {
    transform: scale(1.2);
    cursor: pointer;
  }
  .node-buttons {
    margin-left: auto;
    display: flex;
    gap: 6px;
  }
  .node-buttons button {
    background: #007bff;
    border: none;
    color: white;
    padding: 4px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.2s ease;
  }
  .node-buttons button:hover {
    background: #0056b3;
  }
  .delete-btn {
    background: #dc3545 !important;
  }
  .delete-btn:hover {
    background: #a71d2a !important;
  }

  /* Spouses container */
  .spouses-container {
    display: flex;
    gap: 10px;
    margin-top: 6px;
  }
  .spouse-node {
    border-color: #28a745;
    background: #e8f5e9;
  }
  .spouse-node .node-header input[type="text"] {
    width: 120px;
  }

  /* Children container */
  .children-container {
    margin-top: 12px;
    border-left: 3px solid #007bff;
    padding-left: 12px;
  }

  /* SVG connectors */
  svg.connector-svg {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
  }

  /* Add forms */
  form.add-child-form, form.add-spouse-form {
    display: flex;
    gap: 6px;
    margin-top: 8px;
  }
  form.add-child-form input,
  form.add-spouse-form input {
    font-size: 0.9rem;
    padding: 4px 6px;
    border: 1px solid #bbb;
    border-radius: 4px;
  }
  form.add-child-form button,
  form.add-spouse-form button {
    background: #007bff;
    border: none;
    color: white;
    font-weight: 600;
    border-radius: 4px;
    cursor: pointer;
    padding: 4px 10px;
  }

  /* Footer */
  footer {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 45px;
    background: rgba(255 255 255 / 0.2);
    backdrop-filter: blur(10px);
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: 600;
    color: #007bff;
    border-top: 1px solid rgba(0 123 255 / 0.4);
    user-select: none;
    z-index: 9999;
  }

  /* Login page */
  #login-page {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #4a90e2, #003d99);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  }
  #login-box {
    background: rgba(255 255 255 / 0.9);
    border-radius: 12px;
    padding: 30px 36px;
    width: 320px;
    box-shadow: 0 4px 15px rgb(0 0 0 / 0.2);
    display: flex;
    flex-direction: column;
    gap: 18px;
  }
  #login-box h1 {
    margin: 0 0 16px;
    color: #003d99;
    font-weight: 700;
    text-align: center;
    letter-spacing: 1.1px;
  }
  #login-box input {
    padding: 10px 14px;
    border-radius: 6px;
    border: 1px solid #aaa;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }
  #login-box input:focus {
    outline: none;
    border-color: #007bff;
  }
  #login-box button {
    background: #007bff;
    color: white;
    font-weight: 700;
    padding: 10px 0;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }
  #login-box button:hover {
    background: #0056b3;
  }
  #login-error {
    color: #dc3545;
    font-weight: 600;
    font-size: 0.9rem;
    text-align: center;
  }

  /* Responsive for small devices */
  @media (max-width: 768px) {
    #app {
      flex-direction: column;
    }
    #connections-container {
      width: 100%;
      max-height: 150px;
      border-right: none;
      border-bottom: 1px solid #bbb;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      padding: 8px 6px;
      font-size: 0.85rem;
    }
    #connections-list li {
      display: inline-block;
      margin-right: 12px;
    }
    #family-tree-container {
      flex: none;
      height: calc(100vh - 210px);
      overflow-y: auto;
      padding: 8px;
    }
  }
</style>
</head>
<body>

<div id="login-page">
  <div id="login-box">
    <h1>Family Tree Login</h1>
    <input type="email" id="email" placeholder="Email" autocomplete="username" />
    <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
    <button id="login-btn">Log In</button>
    <div id="login-error"></div>
  </div>
</div>

<div id="app" style="display:none;">
  <div id="connections-container">
    <h2>Connections</h2>
    <ul id="connections-list"></ul>
  </div>
  <div id="family-tree-container"></div>
</div>

<footer>&copy; 2025 Maki Web. All rights reserved</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
    authDomain: "project-955237504610034331.firebaseapp.com",
    databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
    projectId: "project-955237504610034331",
    storageBucket: "project-955237504610034331.firebasestorage.app",
    messagingSenderId: "76212939677",
    appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
    measurementId: "G-RCJ4P82PVM"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  // DOM elements
  const loginPage = document.getElementById('login-page');
  const appDiv = document.getElementById('app');
  const loginBtn = document.getElementById('login-btn');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const loginErrorDiv = document.getElementById('login-error');
  const familyTreeContainer = document.getElementById('family-tree-container');
  const connectionsList = document.getElementById('connections-list');

  // Current user and data
  let currentUser = null;
  let familyData = {}; // entire family tree data loaded from DB

  // Login handler
  loginBtn.addEventListener('click', () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    loginErrorDiv.textContent = '';
    if (!email || !password) {
      loginErrorDiv.textContent = 'Please enter email and password';
      return;
    }
    auth.signInWithEmailAndPassword(email, password)
      .then(userCred => {
        currentUser = userCred.user;
        loginPage.style.display = 'none';
        appDiv.style.display = 'flex';
        loadFamilyData();
      })
      .catch(err => {
        loginErrorDiv.textContent = 'Login failed: ' + err.message;
      });
  });

  // Listen for auth state changes (auto login/logout)
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      loginPage.style.display = 'none';
      appDiv.style.display = 'flex';
      loadFamilyData();
    } else {
      currentUser = null;
      loginPage.style.display = 'flex';
      appDiv.style.display = 'none';
    }
  });

  // Load family data from Firebase Realtime DB
  function loadFamilyData() {
    if (!currentUser) return;
    const userId = currentUser.uid;
    db.ref('families/' + userId).on('value', snapshot => {
      familyData = snapshot.val() || {};
      renderFamilyTree();
      renderConnections();
    });
  }

  // Save family data back to Firebase
  function saveFamilyData() {
    if (!currentUser) return;
    const userId = currentUser.uid;
    db.ref('families/' + userId).set(familyData);
  }

  // Create a unique ID (simple)
  function generateId() {
    return 'id-' + Math.random().toString(36).substr(2, 9);
  }

  // Render the family tree inside #family-tree-container
  function renderFamilyTree() {
    familyTreeContainer.innerHTML = '';
    if (!familyData || Object.keys(familyData).length === 0) {
      familyTreeContainer.innerHTML = '<p style="color:#666;">No family members yet. Add some below.</p>';
      return;
    }
    // Build nodes sorted by name for consistency
    const nodes = Object.entries(familyData).sort((a,b) => a[1].name.localeCompare(b[1].name));
    for (const [id, member] of nodes) {
      const nodeEl = createFamilyMemberNode(id, member);
      familyTreeContainer.appendChild(nodeEl);
    }
  }

  // Create one family member node with spouses and children
  function createFamilyMemberNode(id, member) {
    const container = document.createElement('div');
    container.classList.add('tree-node');
    container.dataset.id = id;

    // Header: Name, Born, Died
    const header = document.createElement('div');
    header.className = 'node-header';

    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = member.name || '';
    nameInput.placeholder = 'Name';
    nameInput.addEventListener('input', e => {
      familyData[id].name = e.target.value;
      saveFamilyData();
      renderConnections();
    });
    header.appendChild(nameInput);

    const bornInput = document.createElement('input');
    bornInput.type = 'date';
    bornInput.value = member.born || '';
    bornInput.title = "Date of Birth";
    bornInput.addEventListener('change', e => {
      familyData[id].born = e.target.value;
      saveFamilyData();
    });
    header.appendChild(bornInput);

    const diedInput = document.createElement('input');
    diedInput.type = 'date';
    diedInput.value = member.died || '';
    diedInput.title = "Date of Death";
    diedInput.addEventListener('change', e => {
      familyData[id].died = e.target.value;
      saveFamilyData();
    });
    header.appendChild(diedInput);

    // Alive checkbox
    const aliveCheckbox = document.createElement('input');
    aliveCheckbox.type = 'checkbox';
    aliveCheckbox.checked = !member.died;
    aliveCheckbox.title = "Alive";
    aliveCheckbox.addEventListener('change', e => {
      if (e.target.checked) {
        delete familyData[id].died;
        diedInput.value = '';
      } else {
        // if unchecked, must pick died date
        if (!familyData[id].died) {
          familyData[id].died = new Date().toISOString().slice(0,10);
          diedInput.value = familyData[id].died;
        }
      }
      saveFamilyData();
    });
    header.appendChild(aliveCheckbox);

    // Buttons: Add spouse, delete
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'node-buttons';

    const addSpouseBtn = document.createElement('button');
    addSpouseBtn.textContent = '+ Spouse';
    addSpouseBtn.title = "Add spouse";
    addSpouseBtn.addEventListener('click', () => {
      const spouseId = generateId();
      if (!familyData[id].spouses) familyData[id].spouses = {};
      familyData[id].spouses[spouseId] = { name: '', born: '', died: '' };
      saveFamilyData();
    });
    buttonsDiv.appendChild(addSpouseBtn);

    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Delete';
    deleteBtn.title = "Delete member";
    deleteBtn.classList.add('delete-btn');
    deleteBtn.addEventListener('click', () => {
      if (confirm(`Delete member "${member.name || ''}" and all their relationships?`)) {
        delete familyData[id];
        // Also remove references from spouses or children
        for (const key in familyData) {
          const fam = familyData[key];
          if (fam.spouses) {
            for (const sId in fam.spouses) {
              if (sId === id) delete fam.spouses[sId];
            }
          }
          if (fam.children) {
            for (const cId in fam.children) {
              if (cId === id) delete fam.children[cId];
            }
          }
        }
        saveFamilyData();
      }
    });
    buttonsDiv.appendChild(deleteBtn);

    header.appendChild(buttonsDiv);

    container.appendChild(header);

    // Spouses container
    if (member.spouses && Object.keys(member.spouses).length > 0) {
      const spousesDiv = document.createElement('div');
      spousesDiv.className = 'spouses-container';

      // Sort spouses by name
      const spouseEntries = Object.entries(member.spouses).sort((a,b) => (a[1].name||'').localeCompare(b[1].name||''));
      spouseEntries.forEach(([spId, spouse]) => {
        const spouseDiv = document.createElement('div');
        spouseDiv.className = 'tree-node spouse-node';

        // Spouse header
        const spouseHeader = document.createElement('div');
        spouseHeader.className = 'node-header';

        const spouseNameInput = document.createElement('input');
        spouseNameInput.type = 'text';
        spouseNameInput.value = spouse.name || '';
        spouseNameInput.placeholder = 'Spouse Name';
        spouseNameInput.addEventListener('input', e => {
          familyData[id].spouses[spId].name = e.target.value;
          saveFamilyData();
          renderConnections();
        });
        spouseHeader.appendChild(spouseNameInput);

        const spouseBornInput = document.createElement('input');
        spouseBornInput.type = 'date';
        spouseBornInput.value = spouse.born || '';
        spouseBornInput.title = "Date of Birth";
        spouseBornInput.addEventListener('change', e => {
          familyData[id].spouses[spId].born = e.target.value;
          saveFamilyData();
        });
        spouseHeader.appendChild(spouseBornInput);

        const spouseDiedInput = document.createElement('input');
        spouseDiedInput.type = 'date';
        spouseDiedInput.value = spouse.died || '';
        spouseDiedInput.title = "Date of Death";
        spouseDiedInput.addEventListener('change', e => {
          familyData[id].spouses[spId].died = e.target.value;
          saveFamilyData();
        });
        spouseHeader.appendChild(spouseDiedInput);

        // Alive checkbox spouse
        const spouseAliveCheckbox = document.createElement('input');
        spouseAliveCheckbox.type = 'checkbox';
        spouseAliveCheckbox.checked = !spouse.died;
        spouseAliveCheckbox.title = "Alive";
        spouseAliveCheckbox.addEventListener('change', e => {
          if (e.target.checked) {
            delete familyData[id].spouses[spId].died;
            spouseDiedInput.value = '';
          } else {
            if (!familyData[id].spouses[spId].died) {
              familyData[id].spouses[spId].died = new Date().toISOString().slice(0,10);
              spouseDiedInput.value = familyData[id].spouses[spId].died;
            }
          }
          saveFamilyData();
        });
        spouseHeader.appendChild(spouseAliveCheckbox);

        // Buttons for spouse: add child, delete spouse
        const spouseButtons = document.createElement('div');
        spouseButtons.className = 'node-buttons';

        const addChildBtn = document.createElement('button');
        addChildBtn.textContent = '+ Child';
        addChildBtn.title = "Add child to this spouse";
        addChildBtn.addEventListener('click', () => {
          const childId = generateId();
          if (!familyData[id].children) familyData[id].children = {};
          familyData[id].children[childId] = { name: '', born: '', died: '' };
          saveFamilyData();
        });
        spouseButtons.appendChild(addChildBtn);

        const deleteSpouseBtn = document.createElement('button');
        deleteSpouseBtn.textContent = 'Del Spouse';
        deleteSpouseBtn.title = "Delete this spouse";
        deleteSpouseBtn.classList.add('delete-btn');
        deleteSpouseBtn.addEventListener('click', () => {
          if (confirm(`Delete spouse "${spouse.name || ''}"?`)) {
            delete familyData[id].spouses[spId];
            saveFamilyData();
          }
        });
        spouseButtons.appendChild(deleteSpouseBtn);

        spouseHeader.appendChild(spouseButtons);
        spouseDiv.appendChild(spouseHeader);
        spousesDiv.appendChild(spouseDiv);
      });
      container.appendChild(spousesDiv);
    }

    // Children container (list children nodes under member)
    if (member.children && Object.keys(member.children).length > 0) {
      const childrenDiv = document.createElement('div');
      childrenDiv.className = 'children-container';

      // Sort children by name
      const childrenEntries = Object.entries(member.children).sort((a,b) => (a[1].name||'').localeCompare(b[1].name||''));
      childrenEntries.forEach(([childId, child]) => {
        const childDiv = document.createElement('div');
        childDiv.className = 'tree-node';

        // Child header
        const childHeader = document.createElement('div');
        childHeader.className = 'node-header';

        const childNameInput = document.createElement('input');
        childNameInput.type = 'text';
        childNameInput.value = child.name || '';
        childNameInput.placeholder = 'Child Name';
        childNameInput.addEventListener('input', e => {
          familyData[id].children[childId].name = e.target.value;
          saveFamilyData();
          renderConnections();
        });
        childHeader.appendChild(childNameInput);

        const childBornInput = document.createElement('input');
        childBornInput.type = 'date';
        childBornInput.value = child.born || '';
        childBornInput.title = "Date of Birth";
        childBornInput.addEventListener('change', e => {
          familyData[id].children[childId].born = e.target.value;
          saveFamilyData();
        });
        childHeader.appendChild(childBornInput);

        const childDiedInput = document.createElement('input');
        childDiedInput.type = 'date';
        childDiedInput.value = child.died || '';
        childDiedInput.title = "Date of Death";
        childDiedInput.addEventListener('change', e => {
          familyData[id].children[childId].died = e.target.value;
          saveFamilyData();
        });
        childHeader.appendChild(childDiedInput);

        // Alive checkbox child
        const childAliveCheckbox = document.createElement('input');
        childAliveCheckbox.type = 'checkbox';
        childAliveCheckbox.checked = !child.died;
        childAliveCheckbox.title = "Alive";
        childAliveCheckbox.addEventListener('change', e => {
          if (e.target.checked) {
            delete familyData[id].children[childId].died;
            childDiedInput.value = '';
          } else {
            if (!familyData[id].children[childId].died) {
              familyData[id].children[childId].died = new Date().toISOString().slice(0,10);
              childDiedInput.value = familyData[id].children[childId].died;
            }
          }
          saveFamilyData();
        });
        childHeader.appendChild(childAliveCheckbox);

        // Delete child button
        const childDeleteBtn = document.createElement('button');
        childDeleteBtn.textContent = 'Delete';
        childDeleteBtn.title = "Delete child";
        childDeleteBtn.classList.add('delete-btn');
        childDeleteBtn.style.marginLeft = 'auto';
        childDeleteBtn.addEventListener('click', () => {
          if (confirm(`Delete child "${child.name || ''}"?`)) {
            delete familyData[id].children[childId];
            saveFamilyData();
          }
        });
        childHeader.appendChild(childDeleteBtn);

        childDiv.appendChild(childHeader);
        childrenDiv.appendChild(childDiv);
      });

      container.appendChild(childrenDiv);
    }

    return container;
  }

  // Render connections list on left side
  function renderConnections() {
    connectionsList.innerHTML = '';
    if (!familyData || Object.keys(familyData).length === 0) {
      const li = document.createElement('li');
      li.textContent = 'No connections yet.';
      connectionsList.appendChild(li);
      return;
    }
    for (const [id, member] of Object.entries(familyData)) {
      const li = document.createElement('li');
      li.textContent = member.name || '(Unnamed)';
      li.title = `Born: ${member.born || 'N/A'} Died: ${member.died || 'Alive'}`;
      li.onclick = () => {
        // Scroll to node
        const node = familyTreeContainer.querySelector(`[data-id="${id}"]`);
        if (node) node.scrollIntoView({behavior:'smooth', block:'center'});
      };
      connectionsList.appendChild(li);
    }
  }
</script>

</body>
</html>
