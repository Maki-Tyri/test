<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Family Tree App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div id="root" class="p-4"></div>

  <script type="text/babel">

    const { useState, useEffect, useRef } = React;

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function App() {
      const [people, setPeople] = useState([]);
      const [search, setSearch] = useState('');
      const [highlightId, setHighlightId] = useState(null);
      const [ancestorIds, setAncestorIds] = useState(new Set());

      useEffect(() => {
        const unsub = db.collection('people').onSnapshot(snapshot => {
          const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setPeople(data);
        });
        return () => unsub();
      }, []);

      const findAncestors = (id, acc = new Set()) => {
        people.forEach(p => {
          if (p.children?.includes(id)) {
            acc.add(p.id);
            findAncestors(p.id, acc);
          }
        });
        return acc;
      };

      const handleSearch = () => {
        const person = people.find(p => p.name.toLowerCase().includes(search.toLowerCase()));
        if (person) {
          setHighlightId(person.id);
          const ancestorSet = findAncestors(person.id);
          setAncestorIds(ancestorSet);
          document.getElementById(person.id)?.scrollIntoView({ behavior: "smooth", block: "center" });
        } else {
          alert("Person not found.");
        }
      };

      const rootPeople = people.filter(p =>
        !people.some(other => other.children?.includes(p.id))
      );

      return (
        <div className="space-y-4">
          <h1 className="text-2xl font-bold">Family Tree</h1>
          <div className="flex gap-2">
            <input
              value={search}
              onChange={e => setSearch(e.target.value)}
              placeholder="Search by name"
              className="border p-1 rounded"
            />
            <button onClick={handleSearch} className="bg-blue-500 text-white px-2 py-1 rounded">Search</button>
          </div>
          <div className="space-y-6">
            {rootPeople.map(p => (
              <TreeNode
                key={p.id}
                person={p}
                people={people}
                db={db}
                highlightId={highlightId}
                ancestorIds={ancestorIds}
              />
            ))}
          </div>
        </div>
      );
    }

    function TreeNode({ person, people, db, highlightId, ancestorIds }) {
      const [editing, setEditing] = useState(false);
      const [name, setName] = useState(person.name);
      const [birthday, setBirthday] = useState(person.birthday || '');
      const [deathday, setDeathday] = useState(person.deathday || '');
      const [showChildren, setShowChildren] = useState(true);

      const isHighlighted = person.id === highlightId;
      const isAncestor = ancestorIds.has(person.id);

      const children = people.filter(p => person.children?.includes(p.id));
      const spouses = people.filter(p => person.spouses?.includes(p.id));

      const updatePerson = () => {
        db.collection('people').doc(person.id).update({
          name, birthday, deathday
        });
        setEditing(false);
      };

      const addSpouse = () => {
        const spouseName = prompt("Enter spouse's name:");
        if (spouseName) {
          const newRef = db.collection('people').doc();
          newRef.set({ name: spouseName, spouses: [person.id] });
          db.collection('people').doc(person.id).update({
            spouses: firebase.firestore.FieldValue.arrayUnion(newRef.id)
          });
        }
      };

      const addChild = () => {
        const childName = prompt("Enter child's name:");
        if (childName) {
          const newRef = db.collection('people').doc();
          newRef.set({ name: childName });
          db.collection('people').doc(person.id).update({
            children: firebase.firestore.FieldValue.arrayUnion(newRef.id)
          });
        }
      };

      const remove = () => {
        if (confirm("Delete this person?")) {
          db.collection('people').doc(person.id).delete();
        }
      };

      return (
        <div className={`ml-4 border-l-2 pl-4 relative ${isHighlighted ? "bg-yellow-200" : isAncestor ? "bg-green-100" : ""}`} id={person.id}>
          <div className="flex items-center gap-2">
            <button onClick={() => setShowChildren(!showChildren)} className="text-xs">
              {showChildren ? 'â–¼' : 'â–¶'}
            </button>

            {editing ? (
              <>
                <input value={name} onChange={e => setName(e.target.value)} className="border rounded px-1 text-sm" />
                <input value={birthday} onChange={e => setBirthday(e.target.value)} className="border rounded px-1 text-sm" placeholder="Birthday"/>
                <input value={deathday} onChange={e => setDeathday(e.target.value)} className="border rounded px-1 text-sm" placeholder="Deathday"/>
                <button onClick={updatePerson} className="text-green-500">âœ”</button>
                <button onClick={() => setEditing(false)} className="text-red-500">âœ–</button>
              </>
            ) : (
              <>
                <span className="font-semibold">{person.name}</span>
                {person.birthday && <span className="text-xs text-gray-600">({person.birthday}{person.deathday ? ` â€“ ${person.deathday}` : ""})</span>}
                <button onClick={() => setEditing(true)} className="text-blue-500 text-xs">âœŽ</button>
                <button onClick={addSpouse} className="text-indigo-500 text-xs">âž• Spouse</button>
                <button onClick={addChild} className="text-green-500 text-xs">âž• Child</button>
                <button onClick={remove} className="text-red-500 text-xs">ðŸ—‘</button>
              </>
            )}
          </div>

          {/* Spouses */}
          {spouses.length > 0 && (
            <div className="ml-4 mt-1 text-sm italic text-gray-700">
              Spouses: {spouses.map(s => s.name).join(", ")}
            </div>
          )}

          {/* Children */}
          {showChildren && children.length > 0 && (
            <div className="ml-4 mt-2 space-y-2">
              {children.map(child => (
                <TreeNode
                  key={child.id}
                  person={child}
                  people={people}
                  db={db}
                  highlightId={highlightId}
                  ancestorIds={ancestorIds}
                />
              ))}
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
