<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree with Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

    window.firebaseImports = { initializeApp, getDatabase, ref, onValue, set, update };
  </script>
  <style>
    .highlight {
      background-color: #ffe58f;
      border-radius: 0.25rem;
      box-shadow: 0 0 8px 2px #ffd666aa;
      animation: none;
    }

    .blink-highlight {
      animation: blink 1s infinite;
      background-color: #ffd666;
      border-radius: 0.25rem;
      box-shadow: 0 0 8px 2px #ffb700cc;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .children-container {
      transition: max-height 0.3s ease, opacity 0.3s ease;
      overflow: hidden;
    }

    .node-box {
      display: inline-block;
      border: 2px solid #93c5fd;
      border-radius: 0.5rem;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.5rem;
      background: white;
      box-shadow: 0 2px 6px rgb(147 197 253 / 0.5);
      position: relative;
      white-space: nowrap;
    }

    .tree-node-container {
      border-left: 2px solid #93c5fd;
      margin-left: 1rem;
      padding-left: 1rem;
    }

    #tree-scroll-container {
      width: 100%;
      max-width: 100vw;
      height: 70vh;
      overflow: auto;
      border: 1px solid #cbd5e1;
      border-radius: 0.5rem;
      padding: 1rem;
      background: #f9fafb;
      box-sizing: border-box;
      user-select: none;
    }

    .toggle-expand-btn {
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      background-color: #3b82f6;
      color: white;
      font-weight: 600;
      border-radius: 0.375rem;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    .toggle-expand-btn:hover {
      background-color: #2563eb;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">
  <div class="w-full max-w-4xl flex justify-between items-center mb-4">
    <input id="search" type="text" placeholder="Search name..."
           class="px-3 py-1 border border-gray-300 rounded w-64 shadow-sm"
           oninput="window.dispatchEvent(new Event('search-input'))" />
  </div>
  <div id="root" class="w-full max-w-6xl bg-white p-6 rounded shadow"></div>

  <script type="text/babel">

    const { useState, useEffect, useRef } = React;

    // Firebase config...
    const firebaseConfig = { /*... unchanged ...*/ };
    const { initializeApp, getDatabase, ref, onValue, set } = window.firebaseImports;
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    let nextId = 1000;

    function TreeNode({ node, onUpdate, onDelete, highlightIds = new Set(), blinkId = null }) {
      const ref = useRef(null);
      useEffect(() => {
        if (blinkId === node.id && ref.current) {
          ref.current.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      }, [blinkId]);

      return (
        <div className="mb-2" ref={ref}>
          <div className={`node-box ${highlightIds.has(node.id) ? 'highlight' : ''} ${blinkId === node.id ? 'blink-highlight' : ''}`}>
            {node.name}
          </div>
          <div className="tree-node-container">
            {(node.children || []).map(child => (
              <TreeNode key={child.id} node={child} onUpdate={onUpdate} onDelete={onDelete}
                        highlightIds={highlightIds} blinkId={blinkId} />
            ))}
          </div>
        </div>
      );
    }

    function FamilyTreeApp() {
      const [treeData, setTreeData] = useState(null);
      const [highlightIds, setHighlightIds] = useState(new Set());
      const [blinkId, setBlinkId] = useState(null);
      const [search, setSearch] = useState("");

      useEffect(() => {
        const dbRef = ref(database, "/tree");
        return onValue(dbRef, (snapshot) => {
          const val = snapshot.val();
          if (val) {
            setTreeData(val);
          } else {
            const rootNode = { id: 1, name: "Root", children: [] };
            setTreeData(rootNode);
            set(ref(database, "/tree"), rootNode);
          }
        });
      }, []);

      useEffect(() => {
        const input = document.getElementById("search");
        const handler = () => setSearch(input.value.toLowerCase());
        window.addEventListener("search-input", handler);
        return () => window.removeEventListener("search-input", handler);
      }, []);

      function findMatchingIdsAndAncestors(node, matchFn, ancestors = []) {
        let result = [];
        const matched = matchFn(node);
        if (matched) {
          result.push(node.id, ...ancestors.map(a => a.id));
        }
        (node.children || []).forEach(child => {
          result.push(...findMatchingIdsAndAncestors(child, matchFn, matched ? [node, ...ancestors] : ancestors));
        });
        return result;
      }

      useEffect(() => {
        if (!treeData || !search.trim()) {
          setHighlightIds(new Set());
          setBlinkId(null);
          return;
        }
        const matches = findMatchingIdsAndAncestors(treeData, n => n.name?.toLowerCase().includes(search));
        setHighlightIds(new Set(matches));
        const matchedOnly = findMatchingIdsAndAncestors(treeData, n => n.name?.toLowerCase().includes(search) && !n.children?.length);
        setBlinkId(matchedOnly[0] || null);
      }, [search, treeData]);

      if (!treeData) return <div>Loading...</div>;

      return (
        <div id="tree-scroll-container">
          <TreeNode node={treeData} onUpdate={() => {}} onDelete={() => {}} highlightIds={highlightIds} blinkId={blinkId} />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<FamilyTreeApp />);
  </script>
</body>
</html>
