<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Tree with Death Date</title>
<style>
  body {
    font-family: Arial, sans-serif;
  }
  .tree-node {
    margin-left: 20px;
    margin-top: 5px;
  }
  .node-header {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .arrow {
    cursor: pointer;
    user-select: none;
    transition: transform 0.2s ease;
  }
  .name-input {
    width: 150px;
  }
  .birthday-input {
    width: 130px;
  }
  .node-buttons button {
    margin-left: 6px;
  }
  .tree-children {
    margin-left: 20px;
    border-left: 1px dotted #ccc;
    padding-left: 10px;
  }
  .delete-btn {
    background-color: #f88;
    border: none;
    padding: 3px 8px;
    cursor: pointer;
  }
  .add-child-btn, .add-spouse-btn {
    background-color: #8f8;
    border: none;
    padding: 3px 8px;
    cursor: pointer;
  }
</style>
</head>
<body>

<div id="familyTreeContainer"></div>

<script>
  // Example initial family data if nothing saved
  let familyTree = {
    name: "Root Person",
    birthday: "",
    children: [],
    spouses: []
  };

  // Keep track of expanded nodes by id
  const expandedNodes = new Set();

  // Save family tree to localStorage
  function saveFamilyTree() {
    localStorage.setItem('familyTreeData', JSON.stringify(familyTree));
  }

  // Load family tree from localStorage
  function loadFamilyTree() {
    const data = localStorage.getItem('familyTreeData');
    if (data) {
      try {
        familyTree = JSON.parse(data);
      } catch {
        familyTree = {
          name: "Root Person",
          birthday: "",
          children: [],
          spouses: []
        };
      }
    }
  }

  // Delete node by id helper - id format like "c0-c1" etc.
  function deleteNodeById(nodeId) {
    // Split path by '-c' for children indexes
    const path = nodeId.split('-c').map(part => part.replace('c', '')).filter(x => x !== '');
    if (path.length === 0) return; // root can't be deleted

    let current = familyTree;
    for (let i = 0; i < path.length - 1; i++) {
      current = current.children[parseInt(path[i])];
    }
    current.children.splice(parseInt(path[path.length - 1]), 1);
  }

  // Render entire family tree
  function renderFamilyTrees() {
    const container = document.getElementById('familyTreeContainer');
    container.innerHTML = '';
    renderNode(container, familyTree, '', 0);
  }

  // Create DOM for a single node and recursively its children and spouses
  function renderNode(container, node, nodeId, depth) {
    const nodeDiv = document.createElement('div');
    nodeDiv.className = 'tree-node';

    const headerDiv = document.createElement('div');
    headerDiv.className = 'node-header';

    const hasChildren = node.children && node.children.length > 0;
    const arrowSpan = document.createElement('span');
    arrowSpan.className = 'arrow';
    arrowSpan.textContent = 'â–¶';
    if (!hasChildren) {
      arrowSpan.style.visibility = 'hidden';
    } else if (expandedNodes.has(nodeId)) {
      arrowSpan.style.transform = 'rotate(90deg)';
    }
    arrowSpan.addEventListener('click', () => {
      if (expandedNodes.has(nodeId)) {
        expandedNodes.delete(nodeId);
      } else {
        expandedNodes.add(nodeId);
      }
      renderFamilyTrees();
    });
    headerDiv.appendChild(arrowSpan);

    // Name input
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = node.name || '';
    nameInput.className = 'name-input';
    nameInput.addEventListener('change', () => {
      node.name = nameInput.value.trim();
      saveFamilyTree();
    });
    headerDiv.appendChild(nameInput);

    // Died label if deathDate exists
    if (node.deathDate) {
      const diedLabel = document.createElement('span');
      diedLabel.style.color = 'red';
      diedLabel.style.fontWeight = 'bold';
      diedLabel.style.marginLeft = '8px';
      diedLabel.textContent = `Died: ${node.deathDate}`;
      headerDiv.appendChild(diedLabel);
    }

    // Birthday input
    const birthdayInput = document.createElement('input');
    birthdayInput.type = 'date';
    birthdayInput.value = node.birthday || '';
    birthdayInput.className = 'birthday-input';
    birthdayInput.addEventListener('change', () => {
      node.birthday = birthdayInput.value;
      saveFamilyTree();
      // Optional: checkBirthdaysToday();
    });
    headerDiv.appendChild(birthdayInput);

    // Died checkbox
    const diedCheckbox = document.createElement('input');
    diedCheckbox.type = 'checkbox';
    diedCheckbox.id = nodeId + '-died-checkbox';
    diedCheckbox.checked = !!node.died;
    diedCheckbox.title = 'Mark as deceased';
    headerDiv.appendChild(diedCheckbox);

    const diedCheckboxLabel = document.createElement('label');
    diedCheckboxLabel.htmlFor = diedCheckbox.id;
    diedCheckboxLabel.textContent = 'Died';
    diedCheckboxLabel.style.marginLeft = '4px';
    headerDiv.appendChild(diedCheckboxLabel);

    // Death date input
    const deathDateInput = document.createElement('input');
    deathDateInput.type = 'date';
    deathDateInput.value = node.deathDate || '';
    deathDateInput.className = 'birthday-input';
    deathDateInput.style.marginLeft = '8px';
    deathDateInput.style.display = node.died ? 'inline-block' : 'none';
    deathDateInput.title = 'Date of death';
    headerDiv.appendChild(deathDateInput);

    diedCheckbox.addEventListener('change', () => {
      node.died = diedCheckbox.checked;
      if (!diedCheckbox.checked) {
        node.deathDate = '';
        deathDateInput.value = '';
        deathDateInput.style.display = 'none';
      } else {
        deathDateInput.style.display = 'inline-block';
        if (!node.deathDate) {
          node.deathDate = '';
        }
      }
      saveFamilyTree();
      renderFamilyTrees();
    });

    deathDateInput.addEventListener('change', () => {
      node.deathDate = deathDateInput.value;
      saveFamilyTree();
      renderFamilyTrees();
    });

    // Buttons container
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'node-buttons';

    // Add Child button
    const addChildBtn = document.createElement('button');
    addChildBtn.textContent = '+ Child';
    addChildBtn.className = 'add-child-btn';
    addChildBtn.title = "Add child";
    buttonsDiv.appendChild(addChildBtn);

    // Add Spouse button
    const addSpouseBtn = document.createElement('button');
    addSpouseBtn.textContent = '+ Spouse';
    addSpouseBtn.className = 'add-spouse-btn';
    addSpouseBtn.title = "Add spouse";
    buttonsDiv.appendChild(addSpouseBtn);

    // Delete button (only if depth > 0)
    if (depth > 0) {
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete';
      deleteBtn.className = 'delete-btn';
      deleteBtn.title = "Delete this person and all descendants";
      buttonsDiv.appendChild(deleteBtn);
      deleteBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to delete this person and all their descendants?')) {
          deleteNodeById(nodeId);
          saveFamilyTree();
          renderFamilyTrees();
        }
      });
    }

    headerDiv.appendChild(buttonsDiv);
    nodeDiv.appendChild(headerDiv);

    // Spouses
    if (node.spouses && node.spouses.length > 0) {
      node.spouses.forEach((spouse, i) => {
        const spouseDiv = document.createElement('div');
        spouseDiv.className = 'tree-node';
        spouseDiv.style.marginLeft = '30px';
        spouseDiv.style.borderLeft = '1px dotted #aaa';

        // Spouse name input
        const spouseNameInput = document.createElement('input');
        spouseNameInput.type = 'text';
        spouseNameInput.value = spouse.name || '';
        spouseNameInput.className = 'name-input';
        spouseNameInput.style.marginRight = '12px';
        spouseNameInput.title = "Spouse's Name";
        spouseNameInput.addEventListener('change', () => {
          spouse.name = spouseNameInput.value.trim();
          saveFamilyTree();
        });
        spouseDiv.appendChild(spouseNameInput);

        // Spouse died label if applicable
        if (spouse.deathDate) {
          const spouseDiedLabel = document.createElement('span');
          spouseDiedLabel.style.color = 'red';
          spouseDiedLabel.style.fontWeight = 'bold';
          spouseDiedLabel.style.marginLeft = '8px';
          spouseDiedLabel.textContent = `Died: ${spouse.deathDate}`;
          spouseDiv.appendChild(spouseDiedLabel);
        }

        // Spouse birthday input
        const spouseBirthdayInput = document.createElement('input');
        spouseBirthdayInput.type = 'date';
        spouseBirthdayInput.value = spouse.birthday || '';
        spouseBirthdayInput.className = 'birthday-input';
        spouseBirthdayInput.title = "Spouse's Birthday";
        spouseBirthdayInput.addEventListener('change', () => {
          spouse.birthday = spouseBirthdayInput.value;
          saveFamilyTree();
          // Optional: checkBirthdaysToday();
        });
        spouseDiv.appendChild(spouseBirthdayInput);

        // Spouse died checkbox
        const spouseDiedCheckbox = document.createElement('input');
        spouseDiedCheckbox.type = 'checkbox';
        spouseDiedCheckbox.id = nodeId + '-spouse-' + i + '-died-checkbox';
        spouseDiedCheckbox.checked = !!spouse.died;
        spouseDiedCheckbox.title = 'Mark spouse as deceased';
        spouseDiv.appendChild(spouseDiedCheckbox);

        const spouseDiedCheckboxLabel = document.createElement('label');
        spouseDiedCheckboxLabel.htmlFor = spouseDiedCheckbox.id;
        spouseDiedCheckboxLabel.textContent = 'Died';
        spouseDiedCheckboxLabel.style.marginLeft = '4px';
        spouseDiv.appendChild(spouseDiedCheckboxLabel);

        // Spouse death date input
        const spouseDeathDateInput = document.createElement('input');
        spouseDeathDateInput.type = 'date';
        spouseDeathDateInput.value = spouse.deathDate || '';
        spouseDeathDateInput.className = 'birthday-input';
        spouseDeathDateInput.style.marginLeft = '8px';
        spouseDeathDateInput.style.display = spouse.died ? 'inline-block' : 'none';
        spouseDeathDateInput.title = 'Date of death';
        spouseDiv.appendChild(spouseDeathDateInput);

        spouseDiedCheckbox.addEventListener('change', () => {
          spouse.died = spouseDiedCheckbox.checked;
          if (!spouseDiedCheckbox.checked) {
            spouse.deathDate = '';
            spouseDeathDateInput.value = '';
            spouseDeathDateInput.style.display = 'none';
          } else {
            spouseDeathDateInput.style.display = 'inline-block';
            if (!spouse.deathDate) {
              spouse.deathDate = '';
            }
          }
          saveFamilyTree();
          renderFamilyTrees();
        });

        spouseDeathDateInput.addEventListener('change', () => {
          spouse.deathDate = spouseDeathDateInput.value;
          saveFamilyTree();
          renderFamilyTrees();
        });

        nodeDiv.appendChild(spouseDiv);
      });
    }

    // Children recursively
    if (hasChildren && expandedNodes.has(nodeId)) {
      const childrenDiv = document.createElement('div');
      childrenDiv.className = 'tree-children';
      node.children.forEach((child, i) => {
        renderNode(childrenDiv, child, nodeId + '-c' + i, depth + 1);
      });
      nodeDiv.appendChild(childrenDiv);
    }

    container.appendChild(nodeDiv);

    // Add child and spouse button listeners
    addChildBtn.addEventListener('click', () => {
      if (!node.children) node.children = [];
      node.children.push({ name: '', birthday: '', children: [], spouses: [] });
      expandedNodes.add(nodeId);
      saveFamilyTree();
      renderFamilyTrees();
    });

    addSpouseBtn.addEventListener('click', () => {
      if (!node.spouses) node.spouses = [];
      node.spouses.push({ name: '', birthday: '', died: false, deathDate: '' });
      saveFamilyTree();
      renderFamilyTrees();
    });
  }

  // Initialize
  loadFamilyTree();
  renderFamilyTrees();
</script>

</body>
</html>
