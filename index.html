<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree</title>
  <style>
    /* Your existing styles remain unchanged */
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
    }
    #login-container, #app-container {
      max-width: 700px;
      margin: 40px auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
      padding: 20px;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      box-sizing: border-box;
    }
    input[type="text"], input[type="date"], input[type="email"], input[type="password"] {
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      cursor: pointer;
      border-radius: 4px;
      border: none;
      background-color: #2563eb;
      color: white;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #1e40af;
    }
    #login-btn, #logout-btn {
      width: 100%;
    }
    #birthday-notifications {
      background: #d1fae5;
      color: #065f46;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 6px;
      font-weight: bold;
    }
    .tree-node {
      margin-left: 20px;
      position: relative;
      border-left: 1px dashed #ccc;
      padding-left: 12px;
      margin-bottom: 8px;
    }
    .node-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }
    .arrow {
      display: inline-block;
      width: 16px;
      user-select: none;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .arrow.collapsed {
      transform: rotate(-90deg);
    }
    input[type="text"].name-input {
      width: 140px;
    }
    input[type="date"].birthday-input,
    input[type="date"].died-input {
      width: 130px;
    }
    .node-buttons {
      display: flex;
      gap: 8px;
      margin-left: auto;
      flex-wrap: nowrap;
    }
    .node-buttons button {
      font-size: 0.85rem;
      padding: 4px 10px;
      width: auto;
    }
    .node-buttons button.add-child-btn {
      background-color: #10b981;
    }
    .node-buttons button.add-spouse-btn {
      background-color: #3b82f6;
    }
    .node-buttons button.delete-btn {
      background-color: #ef4444;
    }
    .node-buttons button:hover {
      filter: brightness(85%);
    }
    .add-child-form, .add-spouse-form {
      margin-left: 36px;
      margin-bottom: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .add-child-form input[type="text"], .add-spouse-form input[type="text"],
    .add-child-form input[type="date"], .add-spouse-form input[type="date"] {
      font-size: 0.9rem;
      padding: 5px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .add-child-form input[type="text"], .add-spouse-form input[type="text"] {
      width: 140px;
    }
    .add-child-form input[type="date"], .add-spouse-form input[type="date"] {
      width: 130px;
    }
    .add-child-form button, .add-spouse-form button {
      background-color: #10b981;
      padding: 6px 12px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      color: white;
    }
    .add-child-form button:hover, .add-spouse-form button:hover {
      filter: brightness(90%);
    }
    #add-root-container {
      margin-bottom: 20px;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 6px;
      background: #f3f4f6;
    }
    #add-root-container h3 {
      margin-top: 0;
    }
    #add-root-form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    #add-root-form input[type="text"], #add-root-form input[type="date"] {
      flex: 1 1 180px;
      padding: 8px;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #add-root-form button {
      flex: 0 0 auto;
      background-color: #2563eb;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      color: white;
    }

    /* --- Improved Login Page Styles --- */
    #login-container {
      max-width: 400px;
      padding: 30px 40px;
      box-shadow: 0 8px 24px rgb(0 0 0 / 0.2);
      border-radius: 12px;
      background: white;
    }
    #login-container h2 {
      text-align: center;
      margin-bottom: 25px;
      font-weight: 700;
      color: #2563eb;
    }
    #login-container input {
      width: 100%;
      margin-bottom: 15px;
      font-size: 1.1rem;
      padding: 12px;
      border: 2px solid #ccc;
      border-radius: 8px;
      transition: border-color 0.3s;
    }
    #login-container input:focus {
      border-color: #2563eb;
      outline: none;
    }
    #login-btn {
      font-size: 1.1rem;
      padding: 12px;
      border-radius: 8px;
    }

    /* Horizontal scrolling container for family tree */
    #family-trees-container {
      overflow-x: auto;
      overflow-y: auto;
      white-space: nowrap;
      padding-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fefefe;
      max-height: 600px;
    }
    #family-trees-container > div {
      display: inline-block;
      vertical-align: top;
      white-space: normal;
      min-width: 400px;
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script> <!-- For OAuth -->

</head>
<body>

<div id="login-container">
  <h2>Login to Family Tree</h2>
  <input id="email" type="email" placeholder="Email" autocomplete="username" />
  <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
  <button id="login-btn">Login</button>
</div>

<div id="app-container" style="display:none;">
  <div id="birthday-notifications"></div>
  <button id="logout-btn">Logout</button>

  <div id="add-root-container">
    <h3>Add Root Person</h3>
    <form id="add-root-form">
      <input type="text" id="root-name" placeholder="Name" required />
      <input type="date" id="root-birthday" required />
      <input type="date" id="root-died" placeholder="Died (optional)" />
      <button type="submit">Add Root Person</button>
    </form>
  </div>

  <div id="family-trees-container"></div>
</div>

<script>
  // Firebase config - replace with your own config here
  const firebaseConfig = {
    apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
    authDomain: "families-8d64d.firebaseapp.com",
    databaseURL: "https://families-8d64d-default-rtdb.firebaseio.com",
    projectId: "families-8d64d",
    storageBucket: "families-8d64d.appspot.com",
    messagingSenderId: "40679604897",
    appId: "1:40679604897:web:bde06a4d0f4f5ae9c3745d"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();

  // Elements
  const loginContainer = document.getElementById("login-container");
  const appContainer = document.getElementById("app-container");
  const loginBtn = document.getElementById("login-btn");
  const logoutBtn = document.getElementById("logout-btn");
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const birthdayNotifications = document.getElementById("birthday-notifications");
  const familyTreesContainer = document.getElementById("family-trees-container");
  const addRootForm = document.getElementById("add-root-form");

  // Show/hide containers on auth state change
  auth.onAuthStateChanged(user => {
    if (user) {
      loginContainer.style.display = "none";
      appContainer.style.display = "block";
      loadFamilyTrees(user.uid);
    } else {
      loginContainer.style.display = "block";
      appContainer.style.display = "none";
      familyTreesContainer.innerHTML = "";
      birthdayNotifications.textContent = "";
    }
  });

  // Login
  loginBtn.addEventListener("click", () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) {
      alert("Please enter email and password");
      return;
    }
    auth.signInWithEmailAndPassword(email, password)
      .catch(err => alert("Login error: " + err.message));
  });

  // Logout
  logoutBtn.addEventListener("click", () => auth.signOut());

  // Add root person
  addRootForm.addEventListener("submit", e => {
    e.preventDefault();
    const name = document.getElementById("root-name").value.trim();
    const birthday = document.getElementById("root-birthday").value;
    const died = document.getElementById("root-died").value || null;

    if (!name || !birthday) {
      alert("Please enter name and birthday");
      return;
    }
    const uid = auth.currentUser.uid;

    // Create a new root person under user
    const newPersonRef = database.ref(`users/${uid}/people`).push();
    const personId = newPersonRef.key;
    const newPersonData = {
      id: personId,
      name,
      birthday,
      died,
      parents: [],
      spouses: [],
      children: []
    };

    newPersonRef.set(newPersonData)
      .then(() => {
        addRootForm.reset();
        loadFamilyTrees(uid);
      })
      .catch(err => alert("Error adding root person: " + err.message));
  });

  // Load family trees
  function loadFamilyTrees(uid) {
    database.ref(`users/${uid}/people`).once("value").then(snapshot => {
      const peopleObj = snapshot.val() || {};
      // Clear existing
      familyTreesContainer.innerHTML = "";

      // Convert to array for easier traversal
      const people = Object.values(peopleObj);

      // Find root people (no parents)
      const roots = people.filter(p => !p.parents || p.parents.length === 0);

      // Show birthday notifications
      showBirthdayNotifications(people);

      // Render each root family tree
      roots.forEach(root => {
        const treeDiv = document.createElement("div");
        treeDiv.classList.add("family-tree");
        const title = document.createElement("h3");
        title.textContent = root.name + "'s Family Tree";
        treeDiv.appendChild(title);
        const treeUl = document.createElement("div");
        treeDiv.appendChild(treeUl);

        renderPersonNode(root, treeUl, peopleObj, uid);
        familyTreesContainer.appendChild(treeDiv);
      });

      if(roots.length === 0){
        familyTreesContainer.textContent = "No family trees found. Add a root person to start.";
      }
    });
  }

  // Show birthday notifications
  function showBirthdayNotifications(people) {
    const today = new Date();
    const todayStr = today.toISOString().slice(5, 10); // MM-DD

    const birthdayPeople = people.filter(p => {
      if (!p.birthday) return false;
      const bday = p.birthday.slice(5, 10);
      return bday === todayStr;
    });

    if (birthdayPeople.length > 0) {
      const names = birthdayPeople.map(p => p.name).join(", ");
      birthdayNotifications.textContent = `ðŸŽ‰ Today's birthdays: ${names}`;
    } else {
      birthdayNotifications.textContent = "";
    }
  }

  // Render a person node recursively
  function renderPersonNode(person, container, peopleObj, uid) {
    const nodeDiv = document.createElement("div");
    nodeDiv.classList.add("tree-node");

    // Header container with arrow and inputs
    const headerDiv = document.createElement("div");
    headerDiv.classList.add("node-header");

    // Arrow for collapsing children
    const arrowSpan = document.createElement("span");
    arrowSpan.classList.add("arrow");
    arrowSpan.textContent = "â–¶";
    headerDiv.appendChild(arrowSpan);

    // Editable name input
    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.value = person.name || "";
    nameInput.classList.add("name-input");
    nameInput.title = "Name";
    headerDiv.appendChild(nameInput);

    // Birthday input
    const birthdayInput = document.createElement("input");
    birthdayInput.type = "date";
    birthdayInput.value = person.birthday || "";
    birthdayInput.classList.add("birthday-input");
    birthdayInput.title = "Birthday";
    headerDiv.appendChild(birthdayInput);

    // Died input - NEW FIELD
    const diedInput = document.createElement("input");
    diedInput.type = "date";
    diedInput.value = person.died || "";
    diedInput.classList.add("died-input");
    diedInput.title = "Died (optional)";
    headerDiv.appendChild(diedInput);

    // Node buttons container
    const buttonsDiv = document.createElement("div");
    buttonsDiv.classList.add("node-buttons");

    // Add child button
    const addChildBtn = document.createElement("button");
    addChildBtn.textContent = "+ Child";
    addChildBtn.classList.add("add-child-btn");
    buttonsDiv.appendChild(addChildBtn);

    // Add spouse button
    const addSpouseBtn = document.createElement("button");
    addSpouseBtn.textContent = "+ Spouse";
    addSpouseBtn.classList.add("add-spouse-btn");
    buttonsDiv.appendChild(addSpouseBtn);

    // Delete button
    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Delete";
    deleteBtn.classList.add("delete-btn");
    buttonsDiv.appendChild(deleteBtn);

    headerDiv.appendChild(buttonsDiv);
    nodeDiv.appendChild(headerDiv);

    // Children container (initially visible)
    const childrenContainer = document.createElement("div");
    nodeDiv.appendChild(childrenContainer);

    container.appendChild(nodeDiv);

    // Manage arrow toggle for children
    arrowSpan.addEventListener("click", () => {
      if (childrenContainer.style.display === "none") {
        childrenContainer.style.display = "block";
        arrowSpan.classList.remove("collapsed");
      } else {
        childrenContainer.style.display = "none";
        arrowSpan.classList.add("collapsed");
      }
    });

    // Initially expanded
    childrenContainer.style.display = "block";
    arrowSpan.classList.remove("collapsed");

    // Save changes on blur for name, birthday, died
    nameInput.addEventListener("blur", () => {
      const newName = nameInput.value.trim();
      if (newName && newName !== person.name) {
        updatePersonField(uid, person.id, "name", newName);
        person.name = newName;
      }
    });

    birthdayInput.addEventListener("blur", () => {
      const newBday = birthdayInput.value;
      if (newBday !== person.birthday) {
        updatePersonField(uid, person.id, "birthday", newBday);
        person.birthday = newBday;
      }
    });

    diedInput.addEventListener("blur", () => {
      const newDied = diedInput.value || null;
      if (newDied !== person.died) {
        updatePersonField(uid, person.id, "died", newDied);
        person.died = newDied;
      }
    });

    // Add child form toggling and submission
    let addChildForm = null;
    addChildBtn.addEventListener("click", () => {
      if (addChildForm) {
        addChildForm.remove();
        addChildForm = null;
        return;
      }

      addChildForm = createAddPersonForm("child");
      nodeDiv.appendChild(addChildForm);

      addChildForm.querySelector("form").onsubmit = e => {
        e.preventDefault();
        const form = e.target;
        const childName = form.querySelector(".name-input").value.trim();
        const childBday = form.querySelector(".birthday-input").value;
        const childDied = form.querySelector(".died-input").value || null;

        if (!childName || !childBday) {
          alert("Please enter name and birthday for child");
          return;
        }

        // Add child person
        const newChildRef = database.ref(`users/${uid}/people`).push();
        const childId = newChildRef.key;

        const childData = {
          id: childId,
          name: childName,
          birthday: childBday,
          died: childDied,
          parents: [person.id],
          spouses: [],
          children: []
        };

        // Update new child data
        newChildRef.set(childData).then(() => {
          // Update parent's children array
          const parentChildrenRef = database.ref(`users/${uid}/people/${person.id}/children`);
          parentChildrenRef.once("value").then(snap => {
            const children = snap.val() || [];
            children.push(childId);
            parentChildrenRef.set(children).then(() => {
              addChildForm.remove();
              addChildForm = null;
              loadFamilyTrees(uid);
            });
          });
        }).catch(err => alert("Error adding child: " + err.message));
      };
    });

    // Add spouse form toggling and submission
    let addSpouseForm = null;
    addSpouseBtn.addEventListener("click", () => {
      if (addSpouseForm) {
        addSpouseForm.remove();
        addSpouseForm = null;
        return;
      }

      addSpouseForm = createAddPersonForm("spouse");
      nodeDiv.appendChild(addSpouseForm);

      addSpouseForm.querySelector("form").onsubmit = e => {
        e.preventDefault();
        const form = e.target;
        const spouseName = form.querySelector(".name-input").value.trim();
        const spouseBday = form.querySelector(".birthday-input").value;
        const spouseDied = form.querySelector(".died-input").value || null;

        if (!spouseName || !spouseBday) {
          alert("Please enter name and birthday for spouse");
          return;
        }

        // Add spouse person
        const newSpouseRef = database.ref(`users/${uid}/people`).push();
        const spouseId = newSpouseRef.key;

        const spouseData = {
          id: spouseId,
          name: spouseName,
          birthday: spouseBday,
          died: spouseDied,
          parents: [],
          spouses: [person.id],
          children: []
        };

        // Update new spouse data and link spouse
        newSpouseRef.set(spouseData).then(() => {
          // Update this person's spouses array
          const thisSpousesRef = database.ref(`users/${uid}/people/${person.id}/spouses`);
          thisSpousesRef.once("value").then(snap => {
            const spouses = snap.val() || [];
            spouses.push(spouseId);
            thisSpousesRef.set(spouses).then(() => {
              addSpouseForm.remove();
              addSpouseForm = null;
              loadFamilyTrees(uid);
            });
          });
        }).catch(err => alert("Error adding spouse: " + err.message));
      };
    });

    // Delete person
    deleteBtn.addEventListener("click", () => {
      if (!confirm(`Are you sure you want to delete ${person.name}? This cannot be undone.`)) return;

      // Remove person from all relations: parents, spouses, children
      const personRef = database.ref(`users/${uid}/people/${person.id}`);

      // Remove references to this person in others
      const updates = {};

      // Remove this person from parents' children arrays
      if (person.parents && person.parents.length > 0) {
        person.parents.forEach(parentId => {
          const parentChildrenRef = `users/${uid}/people/${parentId}/children`;
          updates[`${parentChildrenRef}`] = null;
          // We'll fix this below after reading current children
        });
      }

      // Remove this person from spouses' spouses arrays
      if (person.spouses && person.spouses.length > 0) {
        person.spouses.forEach(spouseId => {
          const spouseSpousesRef = `users/${uid}/people/${spouseId}/spouses`;
          updates[`${spouseSpousesRef}`] = null;
        });
      }

      // Remove this person from children's parents arrays
      if (person.children && person.children.length > 0) {
        person.children.forEach(childId => {
          const childParentsRef = `users/${uid}/people/${childId}/parents`;
          updates[`${childParentsRef}`] = null;
        });
      }

      // First, remove person from parents' children
      Promise.all((person.parents || []).map(parentId => {
        return database.ref(`users/${uid}/people/${parentId}/children`).once("value").then(snap => {
          const arr = snap.val() || [];
          const filtered = arr.filter(id => id !== person.id);
          return database.ref(`users/${uid}/people/${parentId}/children`).set(filtered);
        });
      }))
      // Remove from spouses' spouses
      .then(() => {
        return Promise.all((person.spouses || []).map(spouseId => {
          return database.ref(`users/${uid}/people/${spouseId}/spouses`).once("value").then(snap => {
            const arr = snap.val() || [];
            const filtered = arr.filter(id => id !== person.id);
            return database.ref(`users/${uid}/people/${spouseId}/spouses`).set(filtered);
          });
        }));
      })
      // Remove from children's parents
      .then(() => {
        return Promise.all((person.children || []).map(childId => {
          return database.ref(`users/${uid}/people/${childId}/parents`).once("value").then(snap => {
            const arr = snap.val() || [];
            const filtered = arr.filter(id => id !== person.id);
            return database.ref(`users/${uid}/people/${childId}/parents`).set(filtered);
          });
        }));
      })
      // Finally, remove the person node
      .then(() => personRef.remove())
      .then(() => loadFamilyTrees(uid))
      .catch(err => alert("Error deleting person: " + err.message));
    });

    // Render spouses under this person
    if (person.spouses && person.spouses.length > 0) {
      const spousesContainer = document.createElement("div");
      spousesContainer.style.marginLeft = "20px";
      spousesContainer.style.marginTop = "8px";

      const spousesLabel = document.createElement("strong");
      spousesLabel.textContent = "Spouse(s):";
      spousesContainer.appendChild(spousesLabel);

      person.spouses.forEach(spouseId => {
        const spouse = peopleObj[spouseId];
        if (spouse) {
          const spouseDiv = document.createElement("div");
          spouseDiv.style.marginLeft = "16px";

          // Show spouse name and dates (non-editable here)
          spouseDiv.textContent = `${spouse.name} (b. ${spouse.birthday}${spouse.died ? ", d. " + spouse.died : ""})`;

          spousesContainer.appendChild(spouseDiv);
        }
      });

      nodeDiv.appendChild(spousesContainer);
    }

    // Render children recursively
    if (person.children && person.children.length > 0) {
      person.children.forEach(childId => {
        const child = peopleObj[childId];
        if (child) {
          renderPersonNode(child, childrenContainer, peopleObj, uid);
        }
      });
    }
  }

  // Create form to add child or spouse
  function createAddPersonForm(type) {
    const wrapper = document.createElement("div");
    wrapper.classList.add(type === "child" ? "add-child-form" : "add-spouse-form");

    const form = document.createElement("form");

    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.placeholder = "Name";
    nameInput.classList.add("name-input");
    nameInput.required = true;

    const birthdayInput = document.createElement("input");
    birthdayInput.type = "date";
    birthdayInput.placeholder = "Birthday";
    birthdayInput.classList.add("birthday-input");
    birthdayInput.required = true;

    // Died input field (new)
    const diedInput = document.createElement("input");
    diedInput.type = "date";
    diedInput.placeholder = "Died (optional)";
    diedInput.classList.add("died-input");

    const submitBtn = document.createElement("button");
    submitBtn.type = "submit";
    submitBtn.textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;

    form.appendChild(nameInput);
    form.appendChild(birthdayInput);
    form.appendChild(diedInput);
    form.appendChild(submitBtn);

    wrapper.appendChild(form);
    return wrapper;
  }
</script>
</body>
</html>
