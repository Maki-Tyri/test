<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Family Tree</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    .tree {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .node {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 5px;
      border-radius: 8px;
      display: inline-block;
      background-color: #f9f9f9;
    }
    .children {
      display: flex;
      justify-content: center;
    }
    button {
      margin: 2px;
    }
    .birthday-notification {
      color: green;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .add-spouse-form {
      display: flex;
      flex-direction: column;
      margin-top: 5px;
    }
    .add-spouse-form input {
      margin-bottom: 5px;
      padding: 5px;
    }
  </style>
</head>
<body>

<h1>Family Tree</h1>
<div class="birthday-notification" id="birthdayNotifications"></div>
<div class="tree" id="tree"></div>

<script>
  const firebaseConfig = {
  apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
  authDomain: "project-955237504610034331.firebaseapp.com",
  databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
  projectId: "project-955237504610034331",
  storageBucket: "project-955237504610034331.firebasestorage.app",
  messagingSenderId: "76212939677",
  appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
  measurementId: "G-RCJ4P82PVM"
};

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  let currentUser = null;
  let nodesById = {};

  auth.signInAnonymously().then(() => {
    currentUser = auth.currentUser;
    loadFamilyTree();
  });

  function loadFamilyTree() {
    db.ref('familyTree').once('value', snapshot => {
      nodesById = snapshot.val() || {};
      document.getElementById('tree').innerHTML = '';
      const rootNodes = Object.entries(nodesById).filter(([id, node]) => !node.parentId && !node.spouseOf);
      rootNodes.forEach(([id, node]) => {
        const rootElement = createTreeElement(id);
        document.getElementById('tree').appendChild(rootElement);
      });
      checkBirthdaysToday();
    });
  }

  function createTreeElement(nodeId) {
    const node = nodesById[nodeId];
    const container = document.createElement('div');
    container.classList.add('node');
    container.innerHTML = `<strong>${node.name}</strong><br>${node.birthday || ''}`;

    const addChildBtn = document.createElement('button');
    addChildBtn.textContent = '+Child';
    addChildBtn.addEventListener('click', () => {
      const name = prompt('Enter child name:');
      if (!name) return;
      const birthday = prompt('Enter birthday (YYYY-MM-DD):');
      const newId = db.ref('familyTree').push().key;
      db.ref(`familyTree/${newId}`).set({
        name,
        birthday,
        parentId: nodeId
      }).then(() => loadFamilyTree());
    });
    container.appendChild(addChildBtn);

    const addSpouseBtn = document.createElement('button');
    addSpouseBtn.textContent = '+Spouse';
    addSpouseBtn.disabled = hasSpouse(nodeId);
    container.appendChild(addSpouseBtn);

    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Delete';
    deleteBtn.addEventListener('click', () => {
      if (confirm('Delete this person and all descendants?')) {
        deleteNodeAndDescendants(nodeId);
      }
    });
    container.appendChild(deleteBtn);

    // Add Spouse Form
    const addSpouseForm = document.createElement('form');
    addSpouseForm.classList.add('add-spouse-form');
    addSpouseForm.style.display = 'none';

    const spouseNameInput = document.createElement('input');
    spouseNameInput.type = 'text';
    spouseNameInput.placeholder = 'Spouse name';
    spouseNameInput.required = true;

    const spouseBirthdayInput = document.createElement('input');
    spouseBirthdayInput.type = 'date';
    spouseBirthdayInput.required = true;

    const addSpouseSubmit = document.createElement('button');
    addSpouseSubmit.type = 'submit';
    addSpouseSubmit.textContent = 'Add';

    addSpouseForm.appendChild(spouseNameInput);
    addSpouseForm.appendChild(spouseBirthdayInput);
    addSpouseForm.appendChild(addSpouseSubmit);
    container.appendChild(addSpouseForm);

    addSpouseBtn.addEventListener('click', () => {
      addSpouseForm.style.display = addSpouseForm.style.display === 'none' ? 'flex' : 'none';
      spouseNameInput.focus();
    });

    addSpouseForm.addEventListener('submit', e => {
      e.preventDefault();
      const spouseName = spouseNameInput.value.trim();
      const spouseBirthday = spouseBirthdayInput.value;
      if (!spouseName || !spouseBirthday) {
        alert('Please enter spouse name and birthday.');
        return;
      }
      const newSpouseRef = db.ref('familyTree').push();
      newSpouseRef.set({
        name: spouseName,
        birthday: spouseBirthday,
        spouseOf: nodeId
      }).then(() => {
        addSpouseForm.style.display = 'none';
        loadFamilyTree();
      });
    });

    // Show spouse if exists
    const spouseId = findSpouseId(nodeId);
    if (spouseId) {
      const spouseNode = createTreeElement(spouseId);
      const spouseWrapper = document.createElement('div');
      spouseWrapper.style.marginTop = '5px';
      spouseWrapper.innerHTML = `<em>Spouse:</em>`;
      spouseWrapper.appendChild(spouseNode);
      container.appendChild(spouseWrapper);
    }

    // Children
    const children = Object.entries(nodesById).filter(([id, child]) => child.parentId === nodeId);
    if (children.length > 0) {
      const childrenContainer = document.createElement('div');
      childrenContainer.classList.add('children');
      children.forEach(([id, child]) => {
        const childElement = createTreeElement(id);
        childrenContainer.appendChild(childElement);
      });
      container.appendChild(childrenContainer);
    }

    return container;
  }

  function deleteNodeAndDescendants(nodeId) {
    const toDelete = [nodeId];
    for (const id in nodesById) {
      if (nodesById[id].parentId && toDelete.includes(nodesById[id].parentId)) {
        toDelete.push(id);
      }
    }
    const updates = {};
    toDelete.forEach(id => updates[`familyTree/${id}`] = null);
    db.ref().update(updates).then(() => loadFamilyTree());
  }

  function findSpouseId(nodeId) {
    for (const id in nodesById) {
      if (nodesById[id].spouseOf === nodeId) return id;
    }
    return null;
  }

  function hasSpouse(nodeId) {
    return !!findSpouseId(nodeId);
  }

  function checkBirthdaysToday() {
    const today = new Date().toISOString().slice(5, 10);
    const birthdayList = [];
    for (const id in nodesById) {
      const bday = nodesById[id].birthday;
      if (bday && bday.slice(5, 10) === today) {
        birthdayList.push(nodesById[id].name);
      }
    }
    if (birthdayList.length > 0) {
      document.getElementById('birthdayNotifications').textContent = `ðŸŽ‰ Birthday Today: ${birthdayList.join(', ')}`;
    } else {
      document.getElementById('birthdayNotifications').textContent = '';
    }
  }
</script>

</body>
</html>
