<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree with Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

    window.firebaseImports = { initializeApp, getDatabase, ref, onValue, set, update };
  </script>
  <style>
    .highlight {
      background-color: #ffe58f;
      border-radius: 0.25rem;
      box-shadow: 0 0 8px 2px #ffd666aa;
      animation: none;
    }

    .blink-highlight {
      animation: blink 1s infinite;
      background-color: #ffd666;
      border-radius: 0.25rem;
      box-shadow: 0 0 8px 2px #ffb700cc;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .children-container {
      transition: max-height 0.3s ease, opacity 0.3s ease;
      overflow: hidden;
    }

    /* Box style for nodes and spouses */
    .node-box {
      border: 2px solid #93c5fd; /* Tailwind blue-400 */
      border-radius: 0.5rem;
      padding: 0.25rem 0.5rem;
      margin-bottom: 0.5rem;
      background: white;
      display: inline-block;
      box-shadow: 0 2px 6px rgb(147 197 253 / 0.5);
      position: relative;
      max-width: max-content;
      white-space: nowrap;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      user-select: none;
    }

    /* Lines connecting nodes */
    .tree-node-container {
      border-left: 2px solid #93c5fd;
      margin-left: 1rem;
      padding-left: 1rem;
    }

    /* Scroll container */
    #tree-scroll-container {
      width: 100%;
      max-width: 100vw;
      height: 70vh;
      overflow: auto;
      border: 1px solid #cbd5e1; /* Tailwind gray-300 */
      border-radius: 0.5rem;
      padding: 1rem;
      background: #f9fafb;
      box-sizing: border-box;
      user-select: none;
    }

    /* Buttons */
    .toggle-expand-btn {
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      background-color: #3b82f6; /* blue-500 */
      color: white;
      font-weight: 600;
      border-radius: 0.375rem;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    .toggle-expand-btn:hover {
      background-color: #2563eb; /* blue-600 */
    }

    /* Spouse box tweaks */
    .spouse-box {
      border: 2px solid #93c5fd;
      border-radius: 0.5rem;
      padding: 0.25rem 0.5rem;
      background: white;
      display: inline-block;
      font-style: italic;
      font-size: 0.9rem;
      max-width: max-content;
      white-space: nowrap;
      box-shadow: 0 2px 6px rgb(147 197 253 / 0.5);
      user-select: none;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">
  <div id="root" class="w-full max-w-6xl bg-white p-6 rounded shadow"></div>

  <script type="text/babel">

    const { useState, useEffect, useRef } = React;

    // Firebase config - replace with your own or use this one
    const firebaseConfig = {
      apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
      authDomain: "project-955237504610034331.firebaseapp.com",
      databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
      projectId: "project-955237504610034331",
      storageBucket: "project-955237504610034331.firebasestorage.app",
      messagingSenderId: "76212939677",
      appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
      measurementId: "G-RCJ4P82PVM"
    };

    const {
      initializeApp,
      getDatabase,
      ref,
      onValue,
      set,
      update,
    } = window.firebaseImports;

    // Init Firebase app and database
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let nextId = 1000; // For new ids

    // EditableField component - for editing birthdays etc
    function EditableField({ label, value, type = "text", onChange }) {
      const [editing, setEditing] = useState(false);
      const [tempValue, setTempValue] = useState(value || "");

      function save() {
        onChange(tempValue);
        setEditing(false);
      }

      return (
        <div className="flex items-center space-x-1 text-sm text-gray-700">
          <span className="font-semibold">{label}:</span>
          {editing ? (
            type === "date" ? (
              <input
                type="date"
                value={tempValue}
                onChange={e => setTempValue(e.target.value)}
                onBlur={save}
                onKeyDown={e => { if (e.key === "Enter") save(); }}
                autoFocus
                className="border border-gray-300 rounded px-1 py-0.5 w-32"
              />
            ) : (
              <input
                type="text"
                value={tempValue}
                onChange={e => setTempValue(e.target.value)}
                onBlur={save}
                onKeyDown={e => { if (e.key === "Enter") save(); }}
                autoFocus
                className="border border-gray-300 rounded px-1 py-0.5 w-32"
              />
            )
          ) : (
            <span
              className="cursor-pointer hover:text-blue-600"
              onClick={() => setEditing(true)}
              title={`Click to edit ${label.toLowerCase()}`}
            >
              {value || <em className="text-gray-400">(none)</em>}
            </span>
          )}
        </div>
      );
    }

    function SpouseItem({ spouse, onUpdate, onDelete, highlight, blink }) {
      const [editName, setEditName] = useState(false);
      const [tempName, setTempName] = useState(spouse.name);
      const [showDates, setShowDates] = useState(false);

      function saveName() {
        onUpdate({ ...spouse, name: tempName });
        setEditName(false);
      }

      function updateField(field, val) {
        onUpdate({ ...spouse, [field]: val });
      }

      return (
        <div
          className={`spouse-box ${
            highlight ? "highlight" : ""
          } ${blink ? "blink-highlight" : ""}`}
          style={{ minWidth: "auto", marginBottom: "0.4rem" }}
        >
          {editName ? (
            <input
              type="text"
              value={tempName}
              onChange={e => setTempName(e.target.value)}
              onBlur={saveName}
              onKeyDown={e => { if (e.key === "Enter") saveName(); }}
              autoFocus
              className="border border-gray-400 rounded px-1 py-0.5 w-full"
              style={{ minWidth: "100px" }}
            />
          ) : (
            <span
              className="cursor-pointer"
              onClick={() => setShowDates(!showDates)}
              title="Click to toggle spouse details"
              onDoubleClick={() => setEditName(true)}
            >
              {spouse.name || <em>(unnamed)</em>}
            </span>
          )}

          {showDates && (
            <div className="mt-1 flex flex-wrap gap-2 text-xs text-gray-600">
              <EditableField
                label="Bday"
                type="date"
                value={spouse.birthday}
                onChange={val => updateField("birthday", val)}
              />
              <EditableField
                label="Dday"
                type="date"
                value={spouse.deathday}
                onChange={val => updateField("deathday", val)}
              />
              <button
                onClick={() => onDelete(spouse.id)}
                className="ml-2 px-1 rounded bg-red-600 text-white text-xs font-semibold hover:bg-red-700"
                title="Delete spouse"
              >
                &times;
              </button>
            </div>
          )}
        </div>
      );
    }

    // Recursive Tree Node
    function TreeNode({
      nodeId,
      data,
      highlightSet,
      blinkSet,
      onAddChild,
      onAddSpouse,
      onUpdateNode,
      onDeleteNode,
      onUpdateSpouse,
      onDeleteSpouse,
      collapsedNodes,
      setCollapsedNodes,
      level = 0,
    }) {
      const node = data[nodeId];
      if (!node) return null;

      const isCollapsed = collapsedNodes.has(nodeId);

      const highlight = highlightSet.has(nodeId);
      const blink = blinkSet.has(nodeId);

      function toggleCollapse() {
        setCollapsedNodes(prev => {
          const newSet = new Set(prev);
          if (newSet.has(nodeId)) newSet.delete(nodeId);
          else newSet.add(nodeId);
          return newSet;
        });
      }

      function updateField(field, val) {
        onUpdateNode(nodeId, { ...node, [field]: val });
      }

      return (
        <div className="mb-4" style={{ marginLeft: level * 16 }}>
          <div
            className={`node-box ${highlight ? "highlight" : ""} ${
              blink ? "blink-highlight" : ""
            }`}
            title="Click to toggle children"
            onClick={toggleCollapse}
          >
            <EditableField
              label="Name"
              value={node.name}
              onChange={val => updateField("name", val)}
            />
            <EditableField
              label="Bday"
              type="date"
              value={node.birthday}
              onChange={val => updateField("birthday", val)}
            />
            <EditableField
              label="Dday"
              type="date"
              value={node.deathday}
              onChange={val => updateField("deathday", val)}
            />
            <button
              onClick={e => {
                e.stopPropagation();
                onDeleteNode(nodeId);
              }}
              className="ml-2 px-2 py-0.5 rounded bg-red-600 text-white text-xs font-semibold hover:bg-red-700"
              title="Delete this person"
            >
              Delete
            </button>
          </div>

          {/* Spouses */}
          <div className="ml-6 mt-1 flex flex-wrap gap-1">
            {(node.spouses || []).map(spouse => (
              <SpouseItem
                key={spouse.id}
                spouse={spouse}
                onUpdate={updatedSpouse => {
                  const updatedSpouses = (node.spouses || []).map(s =>
                    s.id === updatedSpouse.id ? updatedSpouse : s
                  );
                  onUpdateNode(nodeId, { ...node, spouses: updatedSpouses });
                }}
                onDelete={spouseId => {
                  const filtered = (node.spouses || []).filter(s => s.id !== spouseId);
                  onUpdateNode(nodeId, { ...node, spouses: filtered });
                }}
                highlight={highlightSet.has(spouse.id)}
                blink={blinkSet.has(spouse.id)}
              />
            ))}

            <button
              onClick={e => {
                e.stopPropagation();
                const newSpouse = {
                  id: `sp${nextId++}`,
                  name: "New Spouse",
                  birthday: "",
                  deathday: "",
                };
                const updatedSpouses = [...(node.spouses || []), newSpouse];
                onUpdateNode(nodeId, { ...node, spouses: updatedSpouses });
              }}
              className="px-2 py-0.5 rounded bg-green-600 text-white text-xs font-semibold hover:bg-green-700 cursor-pointer"
              title="Add spouse"
            >
              + Spouse
            </button>
          </div>

          {/* Children */}
          {!isCollapsed && node.children && node.children.length > 0 && (
            <div className="tree-node-container mt-2 border-l border-blue-300 pl-4">
              {node.children.map(childId => (
                <TreeNode
                  key={childId}
                  nodeId={childId}
                  data={data}
                  highlightSet={highlightSet}
                  blinkSet={blinkSet}
                  onAddChild={onAddChild}
                  onAddSpouse={onAddSpouse}
                  onUpdateNode={onUpdateNode}
                  onDeleteNode={onDeleteNode}
                  onUpdateSpouse={onUpdateSpouse}
                  onDeleteSpouse={onDeleteSpouse}
                  collapsedNodes={collapsedNodes}
                  setCollapsedNodes={setCollapsedNodes}
                  level={level + 1}
                />
              ))}
              <button
                onClick={() => onAddChild(nodeId)}
                className="mt-1 px-2 py-0.5 rounded bg-green-600 text-white text-xs font-semibold hover:bg-green-700"
                title="Add child"
              >
                + Child
              </button>
            </div>
          )}

          {isCollapsed && (
            <div
              className="mt-1 text-xs text-blue-600 cursor-pointer"
              onClick={toggleCollapse}
            >
              + Show children ({node.children.length})
            </div>
          )}
        </div>
      );
    }

    function FamilyTreeApp() {
      const [data, setData] = useState({});
      const [collapsedNodes, setCollapsedNodes] = useState(new Set());
      const [highlightSet, setHighlightSet] = useState(new Set());
      const [blinkSet, setBlinkSet] = useState(new Set());
      const [search, setSearch] = useState("");
      const scrollContainerRef = useRef();

      // Read from Firebase
      useEffect(() => {
        const dbRef = ref(database, "familyTree");
        const unsubscribe = onValue(dbRef, snapshot => {
          const val = snapshot.val() || {};
          setData(val);
          // Update nextId to avoid collisions
          let maxId = 0;
          Object.keys(val).forEach(k => {
            if (k.startsWith("sp")) return;
            const idNum = parseInt(k, 10);
            if (!isNaN(idNum) && idNum > maxId) maxId = idNum;
            // Also check spouses IDs
            (val[k].spouses || []).forEach(s => {
              const sidNum = parseInt(s.id.replace("sp", ""), 10);
              if (!isNaN(sidNum) && sidNum > maxId) maxId = sidNum;
            });
          });
          nextId = maxId + 1;
        });
        return () => unsubscribe();
      }, []);

      // Save to Firebase helper
      function saveData(newData) {
        set(ref(database, "familyTree"), newData);
      }

      // Add child
      function onAddChild(parentId) {
        const newId = `${nextId++}`;
        const newPerson = {
          id: newId,
          name: "New Child",
          birthday: "",
          deathday: "",
          spouses: [],
          children: [],
        };
        const updatedParent = {
          ...data[parentId],
          children: [...(data[parentId].children || []), newId],
        };
        const newData = {
          ...data,
          [parentId]: updatedParent,
          [newId]: newPerson,
        };
        setData(newData);
        saveData(newData);
      }

      // Add spouse - handled inside TreeNode (simpler to keep code DRY)

      // Update a node
      function onUpdateNode(id, updatedNode) {
        const newData = {
          ...data,
          [id]: updatedNode,
        };
        setData(newData);
        saveData(newData);
      }

      // Delete a node and all descendants recursively
      function onDeleteNode(id) {
        const toDelete = new Set();
        function markForDelete(nodeId) {
          toDelete.add(nodeId);
          (data[nodeId].children || []).forEach(cId => markForDelete(cId));
        }
        markForDelete(id);

        // Remove from parents' children arrays
        let newData = { ...data };
        Object.entries(newData).forEach(([key, node]) => {
          if (node.children && node.children.includes(id)) {
            newData[key] = {
              ...node,
              children: node.children.filter(c => c !== id),
            };
          }
        });

        // Remove all marked nodes
        toDelete.forEach(delId => delete newData[delId]);

        setData(newData);
        saveData(newData);
      }

      // Clear all highlights
      function clearHighlights() {
        setHighlightSet(new Set());
        setBlinkSet(new Set());
      }

      // Expand/collapse all
      function expandCollapseAll(expand) {
        if (expand) {
          setCollapsedNodes(new Set());
        } else {
          setCollapsedNodes(new Set(Object.keys(data)));
        }
      }

      // Search logic: highlight all parents, grandparents, spouses, etc. of the searched person
      useEffect(() => {
        clearHighlights();
        if (!search.trim()) return;

        // Find all nodes whose name (or spouse name) matches search (case insensitive)
        const matches = new Set();
        const searchLower = search.toLowerCase();

        // Find matching nodes (person or spouse)
        Object.entries(data).forEach(([id, node]) => {
          if (node.name.toLowerCase().includes(searchLower)) {
            matches.add(id);
          }
          (node.spouses || []).forEach(spouse => {
            if (spouse.name.toLowerCase().includes(searchLower)) {
              matches.add(spouse.id);
            }
          });
        });

        if (matches.size === 0) {
          clearHighlights();
          return;
        }

        // For each matched person/spouse, find ancestors and spouses and highlight
        const highlightIds = new Set();
        const blinkIds = new Set();

        // To find parents, we need to traverse the tree and find who has them as child
        // We'll build a parent map for quick lookup
        const parentMap = {};
        Object.entries(data).forEach(([id, node]) => {
          (node.children || []).forEach(cId => {
            parentMap[cId] = id;
          });
        });

        // Recursive function to get all ancestors
        function getAncestors(nodeId) {
          if (!nodeId) return;
          const p = parentMap[nodeId];
          if (p) {
            highlightIds.add(p);
            getAncestors(p);
          }
        }

        matches.forEach(mId => {
          // If this is a spouse id (starts with sp), find who owns the spouse
          if (typeof mId === "string" && mId.startsWith("sp")) {
            // Find owner node
            Object.entries(data).forEach(([id, node]) => {
              if ((node.spouses || []).some(s => s.id === mId)) {
                highlightIds.add(id);
                highlightIds.add(mId);
                getAncestors(id);
              }
            });
          } else {
            highlightIds.add(mId);
            getAncestors(mId);

            // Also highlight their spouses
            const node = data[mId];
            if (node && node.spouses) {
              node.spouses.forEach(s => highlightIds.add(s.id));
            }
          }
          blinkIds.add(mId);
        });

        setHighlightSet(highlightIds);
        setBlinkSet(blinkIds);

        // Scroll to first matched node after a short delay
        setTimeout(() => {
          const container = scrollContainerRef.current;
          if (!container) return;
          // Try to find DOM node with data-id = first blink id
          const firstId = [...blinkIds][0];
          const el = container.querySelector(`[data-id="${firstId}"]`);
          if (el) {
            const offsetTop = el.offsetTop;
            container.scrollTo({ top: offsetTop - 20, behavior: "smooth" });
          }
        }, 300);

      }, [search, data]);

      // Render Tree roots - those without parents
      function getRoots() {
        const childrenIds = new Set();
        Object.values(data).forEach(n => {
          (n.children || []).forEach(c => childrenIds.add(c));
        });
        return Object.keys(data).filter(id => !childrenIds.has(id));
      }

      // Render TreeNode wrapper with data-id for scrolling/highlighting
      function RenderTreeNodeWrapper(props) {
        const node = data[props.nodeId];
        if (!node) return null;
        return (
          <div data-id={props.nodeId}>
            <TreeNode {...props} />
          </div>
        );
      }

      return (
        <>
          <h1 className="text-3xl font-bold mb-4 text-center">Family Tree</h1>
          <div className="flex items-center space-x-4 mb-4">
            <input
              type="text"
              placeholder="Search by name..."
              className="border border-gray-300 rounded px-3 py-1 w-full max-w-md"
              value={search}
              onChange={e => setSearch(e.target.value)}
            />
            <button
              className="toggle-expand-btn"
              onClick={() => expandCollapseAll(true)}
              title="Expand all nodes"
            >
              Expand All
            </button>
            <button
              className="toggle-expand-btn bg-red-600 hover:bg-red-700"
              onClick={() => expandCollapseAll(false)}
              title="Collapse all nodes"
            >
              Collapse All
            </button>
          </div>

          <div
            id="tree-scroll-container"
            ref={scrollContainerRef}
            tabIndex={0}
          >
            {getRoots().length === 0 && (
              <div className="text-center text-gray-500 italic">No data available</div>
            )}

            {getRoots().map(rootId => (
              <RenderTreeNodeWrapper
                key={rootId}
                nodeId={rootId}
                data={data}
                highlightSet={highlightSet}
                blinkSet={blinkSet}
                onAddChild={onAddChild}
                onAddSpouse={() => {}} // handled inside TreeNode
                onUpdateNode={onUpdateNode}
                onDeleteNode={onDeleteNode}
                onUpdateSpouse={() => {}} // handled inside TreeNode
                onDeleteSpouse={() => {}} // handled inside TreeNode
                collapsedNodes={collapsedNodes}
                setCollapsedNodes={setCollapsedNodes}
              />
            ))}
          </div>
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<FamilyTreeApp />);

  </script>
</body>
</html>
