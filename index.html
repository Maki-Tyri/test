<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree</title>
  <style>
    /* Base styles */
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    #login-container, #app-container {
      max-width: 700px;
      margin: 40px auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
      padding: 20px;
    }
    input, select, button {
      padding: 10px;
      margin: 5px 0;
      box-sizing: border-box;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    input[type="text"], input[type="date"], input[type="email"], input[type="password"], select {
      width: 100%;
      max-width: 300px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    button {
      cursor: pointer;
      border: none;
      background-color: #2563eb;
      color: white;
      font-weight: bold;
      transition: background-color 0.2s;
      border-radius: 4px;
    }
    button:hover:not(:disabled) {
      background-color: #1e40af;
    }
    button:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }
    #login-btn, #logout-btn, #signup-btn {
      width: 100%;
      max-width: none;
    }
    #birthday-notifications {
      background: #d1fae5;
      color: #065f46;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 6px;
      font-weight: bold;
    }
    /* Tree Node */
    .tree-node {
      margin-left: 20px;
      position: relative;
      border-left: 1px dashed #ccc;
      padding-left: 12px;
      margin-bottom: 8px;
    }
    .node-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      flex-wrap: wrap;
      min-width: 0; /* for overflow */
    }
    .arrow {
      display: inline-block;
      width: 16px;
      user-select: none;
      cursor: pointer;
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }
    .arrow.collapsed {
      transform: rotate(-90deg);
    }
    input.name-input, select.gender-select {
      width: 180px;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-shrink: 1;
    }
    input.birthday-input, input.date-input {
      width: 140px;
      max-width: 100%;
    }
    .deceased-label {
      color: #ef4444;
      font-weight: bold;
      margin-left: 6px;
      user-select: none;
      flex-shrink: 0;
    }
    .gender-label {
      font-size: 0.85rem;
      color: #555;
      margin-left: 6px;
      user-select: none;
      flex-shrink: 0;
    }
    .node-buttons {
      display: flex;
      gap: 8px;
      margin-left: auto;
      flex-wrap: nowrap;
      flex-shrink: 0;
    }
    .node-buttons button {
      font-size: 0.85rem;
      padding: 4px 10px;
      width: auto;
      border-radius: 4px;
    }
    .node-buttons button.add-child-btn {
      background-color: #10b981;
    }
    .node-buttons button.add-spouse-btn {
      background-color: #3b82f6;
    }
    .node-buttons button.delete-btn {
      background-color: #ef4444;
    }
    .node-buttons button:hover:not(:disabled) {
      filter: brightness(85%);
    }
    .add-child-form, .add-spouse-form {
      margin-left: 36px;
      margin-bottom: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      max-width: 100%;
    }
    .add-child-form input[type="text"], .add-spouse-form input[type="text"],
    .add-child-form input[type="date"], .add-spouse-form input[type="date"],
    .add-child-form select, .add-spouse-form select {
      font-size: 0.9rem;
      padding: 5px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .add-child-form button, .add-spouse-form button {
      background-color: #10b981;
      padding: 6px 12px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      color: white;
      flex-shrink: 0;
      max-width: 100px;
    }
    .add-child-form button:hover, .add-spouse-form button:hover {
      filter: brightness(90%);
    }
    #add-root-container {
      margin-bottom: 20px;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 6px;
      background: #f3f4f6;
    }
    #add-root-container h3 {
      margin-top: 0;
    }
    #add-root-form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    #add-root-form input[type="text"], #add-root-form input[type="date"], #add-root-form select {
      flex: 1 1 180px;
      padding: 8px;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #add-root-form button {
      flex: 0 0 auto;
      background-color: #2563eb;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      color: white;
    }
    /* Marriages section */
    .marriages-container {
      margin-left: 36px;
      margin-bottom: 10px;
      border-left: 2px solid #3b82f6;
      padding-left: 10px;
    }
    .marriages-header {
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      color: #2563eb;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .marriages-arrow {
      transition: transform 0.2s ease;
    }
    .marriages-arrow.collapsed {
      transform: rotate(-90deg);
    }
    .marriage-item {
      margin-left: 20px;
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .marriage-item input.name-input,
    .marriage-item input.birthday-input,
    .marriage-item select.gender-select {
      width: 160px;
      max-width: 100%;
    }
    .marriage-item .deceased-label {
      margin-left: 0;
    }
    .marriage-item button.delete-btn {
      padding: 3px 8px;
      font-size: 0.75rem;
    }
    /* Responsive for mobile */
    @media (max-width: 600px) {
      #login-container, #app-container {
        margin: 20px 10px;
        padding: 15px;
      }
      input.name-input, select.gender-select {
        width: 100%;
        max-width: none;
      }
      input.birthday-input, input.date-input {
        width: 100%;
        max-width: none;
      }
      .node-buttons {
        margin-top: 8px;
        margin-left: 0;
        flex-wrap: wrap;
      }
      .node-buttons button {
        flex: 1 1 45%;
        margin-bottom: 6px;
      }
      .add-child-form, .add-spouse-form {
        flex-direction: column;
        align-items: stretch;
      }
      .add-child-form input, .add-spouse-form input,
      .add-child-form select, .add-spouse-form select {
        width: 100%;
        max-width: none;
      }
      .add-child-form button, .add-spouse-form button {
        width: 100%;
        max-width: none;
      }
      #add-root-form {
        flex-direction: column;
        align-items: stretch;
      }
      #add-root-form input, #add-root-form select, #add-root-form button {
        width: 100%;
        max-width: none;
        margin-bottom: 10px;
      }
      .marriage-item input, .marriage-item select {
        width: 100%;
        max-width: none;
      }
    }
    /* Login form */
    #login-container h2 {
      margin-top: 0;
      text-align: center;
    }
    #login-form, #signup-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    #login-form input, #signup-form input {
      font-size: 1rem;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #signup-form {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 20px;
    }
    #signup-form h3 {
      margin: 0 0 10px 0;
      text-align: center;
      color: #2563eb;
    }
    #error-msg {
      color: #ef4444;
      text-align: center;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>

<div id="login-container" style="display:none;">
  <h2>Login</h2>
  <div id="error-msg"></div>
  <form id="login-form">
    <input type="email" id="login-email" placeholder="Email" required autocomplete="username" />
    <input type="password" id="login-password" placeholder="Password" required autocomplete="current-password" />
    <button type="submit" id="login-btn">Login</button>
  </form>

  <form id="signup-form">
    <h3>Create an Account</h3>
    <input type="email" id="signup-email" placeholder="Email" required autocomplete="email" />
    <input type="password" id="signup-password" placeholder="Password (min 6 chars)" required autocomplete="new-password" minlength="6" />
    <input type="password" id="signup-password-confirm" placeholder="Confirm Password" required autocomplete="new-password" minlength="6" />
    <button type="submit" id="signup-btn">Sign Up</button>
  </form>
</div>

<div id="app-container" style="display:none;">
  <button id="logout-btn" style="margin-bottom: 20px;">Logout</button>
  <div id="birthday-notifications"></div>

  <div id="add-root-container">
    <h3>Add Root Family Member</h3>
    <form id="add-root-form">
      <input type="text" id="root-name" placeholder="Full Name" required />
      <select id="root-gender" required>
        <option value="" disabled selected>Select Gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
      </select>
      <input type="date" id="root-birthday" placeholder="Birthday" required />
      <label style="display:flex; align-items:center; gap:5px;">
        <input type="checkbox" id="root-deceased" />
        Deceased
      </label>
      <button type="submit">Add Root Member</button>
    </form>
  </div>

  <div id="family-tree"></div>
</div>

<script>
  // Firebase config + initialization
  // Replace with your Firebase config
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };
  // Initialize Firebase
  // Since we can't import Firebase libraries here, user must include Firebase scripts in HTML or this won't run.
  // This example will keep UI logic ready, you should add Firebase SDK scripts and initialize as needed.

  // -- MOCK AUTH AND STORAGE for demo purposes (since no Firebase scripts loaded) --
  // Replace this with actual Firebase auth and Firestore code for real app

  let loggedInUser = null;

  // Simple mock login/signup/logout:
  function mockLogin(email, password) {
    return new Promise((resolve, reject) => {
      if(email && password) {
        loggedInUser = { email };
        resolve(loggedInUser);
      } else {
        reject(new Error("Invalid credentials"));
      }
    });
  }
  function mockSignup(email, password) {
    return new Promise((resolve, reject) => {
      if(email && password.length >= 6) {
        loggedInUser = { email };
        resolve(loggedInUser);
      } else {
        reject(new Error("Signup failed"));
      }
    });
  }
  function mockLogout() {
    loggedInUser = null;
    return Promise.resolve();
  }

  // --- App State ---
  let familyData = [];
  // familyData is array of members:
  // Each member: { id, name, birthday (YYYY-MM-DD), gender, deceased (bool), spouses: [], children: [] }
  // spouses: array of members with same structure (except children usually empty)
  // children: array of members

  // ID generation
  function generateId() {
    return 'id-' + Math.random().toString(36).slice(2, 10);
  }

  // --- Load/save from localStorage for demo ---
  function loadFamilyData() {
    const saved = localStorage.getItem('familyData');
    if(saved) {
      familyData = JSON.parse(saved);
    } else {
      familyData = [];
    }
  }
  function saveFamilyData() {
    localStorage.setItem('familyData', JSON.stringify(familyData));
  }

  // --- Birthday notifications ---
  function checkTodaysBirthdays() {
    const todayStr = new Date().toISOString().slice(5,10); // MM-DD
    let bdays = [];
    function checkMember(member) {
      if(member.birthday && !member.deceased) {
        let m = member.birthday.slice(5,10);
        if(m === todayStr) {
          bdays.push(member.name);
        }
      }
      if(member.spouses) member.spouses.forEach(checkMember);
      if(member.children) member.children.forEach(checkMember);
    }
    familyData.forEach(checkMember);
    return bdays;
  }

  // --- UI Rendering ---
  const familyTreeEl = document.getElementById('family-tree');
  const birthdayNotificationEl = document.getElementById('birthday-notifications');

  function render() {
    familyTreeEl.innerHTML = '';
    if(familyData.length === 0) {
      familyTreeEl.textContent = "No family members added yet.";
      birthdayNotificationEl.textContent = "";
      return;
    }
    // Show birthday notifications
    const birthdays = checkTodaysBirthdays();
    if(birthdays.length > 0) {
      birthdayNotificationEl.textContent = `🎉 Happy Birthday to: ${birthdays.join(', ')}`;
    } else {
      birthdayNotificationEl.textContent = "";
    }

    familyData.forEach(member => {
      const nodeEl = createMemberNode(member);
      familyTreeEl.appendChild(nodeEl);
    });
  }

  // Helper: create DOM elements for members recursively
  function createMemberNode(member) {
    const node = document.createElement('div');
    node.className = 'tree-node';

    // Header row
    const header = document.createElement('div');
    header.className = 'node-header';

    // Collapse arrow for children
    const arrow = document.createElement('span');
    arrow.className = 'arrow';
    arrow.textContent = '▼';
    arrow.style.userSelect = 'none';

    // Collapsible state stored on element
    arrow.collapsed = false;

    // Toggle children visibility
    arrow.addEventListener('click', () => {
      arrow.collapsed = !arrow.collapsed;
      arrow.classList.toggle('collapsed', arrow.collapsed);
      if(childrenContainer.style.display === 'none') {
        childrenContainer.style.display = 'block';
      } else {
        childrenContainer.style.display = 'none';
      }
    });

    header.appendChild(arrow);

    // Name input
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.className = 'name-input';
    nameInput.value = member.name;
    nameInput.title = member.name;
    nameInput.disabled = member.deceased;
    nameInput.addEventListener('change', () => {
      member.name = nameInput.value.trim();
      saveFamilyData();
      render();
    });
    header.appendChild(nameInput);

    // Gender select
    const genderSelect = document.createElement('select');
    genderSelect.className = 'gender-select';
    ['Male', 'Female', 'Other'].forEach(g => {
      const opt = document.createElement('option');
      opt.value = g;
      opt.textContent = g;
      if(member.gender === g) opt.selected = true;
      genderSelect.appendChild(opt);
    });
    genderSelect.disabled = member.deceased;
    genderSelect.addEventListener('change', () => {
      member.gender = genderSelect.value;
      saveFamilyData();
      render();
    });
    header.appendChild(genderSelect);

    // Birthday input
    const birthdayInput = document.createElement('input');
    birthdayInput.type = 'date';
    birthdayInput.className = 'birthday-input';
    birthdayInput.value = member.birthday || '';
    birthdayInput.disabled = member.deceased;
    birthdayInput.addEventListener('change', () => {
      member.birthday = birthdayInput.value;
      saveFamilyData();
      render();
    });
    header.appendChild(birthdayInput);

    // Deceased checkbox label
    if(member.deceased) {
      const deadLabel = document.createElement('span');
      deadLabel.className = 'deceased-label';
      deadLabel.textContent = '💀 Deceased';
      header.appendChild(deadLabel);
    }

    // Node buttons container
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'node-buttons';

    // Add child button
    const addChildBtn = document.createElement('button');
    addChildBtn.textContent = 'Add Child';
    addChildBtn.className = 'add-child-btn';
    addChildBtn.disabled = member.deceased;
    buttonsDiv.appendChild(addChildBtn);

    // Add spouse button
    const addSpouseBtn = document.createElement('button');
    addSpouseBtn.textContent = 'Add Spouse';
    addSpouseBtn.className = 'add-spouse-btn';
    addSpouseBtn.disabled = member.deceased;
    buttonsDiv.appendChild(addSpouseBtn);

    // Delete button
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Delete';
    deleteBtn.className = 'delete-btn';
    deleteBtn.disabled = false;
    buttonsDiv.appendChild(deleteBtn);

    header.appendChild(buttonsDiv);

    node.appendChild(header);

    // Children container
    const childrenContainer = document.createElement('div');
    childrenContainer.style.marginLeft = '24px';

    // Add child form container (hidden initially)
    let addChildFormEl = null;
    addChildBtn.addEventListener('click', () => {
      if(addChildFormEl) {
        addChildFormEl.remove();
        addChildFormEl = null;
        return;
      }
      addChildFormEl = createAddMemberForm('child', (newMember) => {
        if(!member.children) member.children = [];
        member.children.push(newMember);
        saveFamilyData();
        render();
      });
      childrenContainer.appendChild(addChildFormEl);
    });

    // Add spouse form container (hidden initially)
    let addSpouseFormEl = null;
    addSpouseBtn.addEventListener('click', () => {
      if(addSpouseFormEl) {
        addSpouseFormEl.remove();
        addSpouseFormEl = null;
        return;
      }
      addSpouseFormEl = createAddMemberForm('spouse', (newMember) => {
        if(!member.spouses) member.spouses = [];
        member.spouses.push(newMember);
        saveFamilyData();
        render();
      });
      childrenContainer.appendChild(addSpouseFormEl);
    });

    // Delete logic
    deleteBtn.addEventListener('click', () => {
      if(confirm(`Delete member "${member.name}" and all descendants?`)) {
        // Remove from familyData or parent's children or spouse list
        const removed = removeMemberById(member.id);
        if(removed) {
          saveFamilyData();
          render();
        }
      }
    });

    // Show children
    if(member.children && member.children.length > 0) {
      member.children.forEach(child => {
        const childNode = createMemberNode(child);
        childrenContainer.appendChild(childNode);
      });
    }

    node.appendChild(childrenContainer);

    // Marriages section (if spouses exist)
    if(member.spouses && member.spouses.length > 0) {
      const marriagesContainer = document.createElement('div');
      marriagesContainer.className = 'marriages-container';

      const marriagesHeader = document.createElement('div');
      marriagesHeader.className = 'marriages-header';

      const marriagesArrow = document.createElement('span');
      marriagesArrow.className = 'marriages-arrow';
      marriagesArrow.textContent = '▼';
      marriagesArrow.collapsed = false;
      marriagesHeader.appendChild(marriagesArrow);

      const headerText = document.createElement('span');
      headerText.textContent = `Marriages (${member.spouses.length})`;
      marriagesHeader.appendChild(headerText);

      marriagesContainer.appendChild(marriagesHeader);

      const spousesList = document.createElement('div');
      spousesList.style.marginLeft = '20px';

      // Toggle spouses visibility
      marriagesHeader.addEventListener('click', () => {
        marriagesArrow.collapsed = !marriagesArrow.collapsed;
        marriagesArrow.classList.toggle('collapsed', marriagesArrow.collapsed);
        spousesList.style.display = marriagesArrow.collapsed ? 'none' : 'block';
      });

      member.spouses.forEach((spouse, idx) => {
        const spouseDiv = document.createElement('div');
        spouseDiv.className = 'marriage-item';

        // Spouse name input
        const spouseNameInput = document.createElement('input');
        spouseNameInput.type = 'text';
        spouseNameInput.className = 'name-input';
        spouseNameInput.value = spouse.name;
        spouseNameInput.title = spouse.name;
        spouseNameInput.disabled = spouse.deceased;
        spouseNameInput.addEventListener('change', () => {
          spouse.name = spouseNameInput.value.trim();
          saveFamilyData();
          render();
        });
        spouseDiv.appendChild(spouseNameInput);

        // Spouse gender select
        const spouseGenderSelect = document.createElement('select');
        spouseGenderSelect.className = 'gender-select';
        ['Male', 'Female', 'Other'].forEach(g => {
          const opt = document.createElement('option');
          opt.value = g;
          opt.textContent = g;
          if(spouse.gender === g) opt.selected = true;
          spouseGenderSelect.appendChild(opt);
        });
        spouseGenderSelect.disabled = spouse.deceased;
        spouseGenderSelect.addEventListener('change', () => {
          spouse.gender = spouseGenderSelect.value;
          saveFamilyData();
          render();
        });
        spouseDiv.appendChild(spouseGenderSelect);

        // Spouse birthday input
        const spouseBirthdayInput = document.createElement('input');
        spouseBirthdayInput.type = 'date';
        spouseBirthdayInput.className = 'birthday-input';
        spouseBirthdayInput.value = spouse.birthday || '';
        spouseBirthdayInput.disabled = spouse.deceased;
        spouseBirthdayInput.addEventListener('change', () => {
          spouse.birthday = spouseBirthdayInput.value;
          saveFamilyData();
          render();
        });
        spouseDiv.appendChild(spouseBirthdayInput);

        // Deceased label
        if(spouse.deceased) {
          const deadLabel = document.createElement('span');
          deadLabel.className = 'deceased-label';
          deadLabel.textContent = '💀 Deceased';
          spouseDiv.appendChild(deadLabel);
        }

        // Delete spouse button
        const delSpouseBtn = document.createElement('button');
        delSpouseBtn.className = 'delete-btn';
        delSpouseBtn.textContent = 'Delete Spouse';
        delSpouseBtn.addEventListener('click', () => {
          if(confirm(`Remove spouse "${spouse.name}"?`)) {
            member.spouses.splice(idx,1);
            saveFamilyData();
            render();
          }
        });
        spouseDiv.appendChild(delSpouseBtn);

        spousesList.appendChild(spouseDiv);
      });

      marriagesContainer.appendChild(spousesList);
      node.appendChild(marriagesContainer);
    }

    return node;
  }

  // Create form for adding child or spouse
  function createAddMemberForm(type, onAdd) {
    const form = document.createElement('form');
    form.className = type === 'child' ? 'add-child-form' : 'add-spouse-form';

    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.placeholder = `New ${type} full name`;
    nameInput.required = true;
    form.appendChild(nameInput);

    const genderSelect = document.createElement('select');
    genderSelect.required = true;
    ['Male', 'Female', 'Other'].forEach(g => {
      const opt = document.createElement('option');
      opt.value = g;
      opt.textContent = g;
      genderSelect.appendChild(opt);
    });
    form.appendChild(genderSelect);

    const birthdayInput = document.createElement('input');
    birthdayInput.type = 'date';
    birthdayInput.placeholder = 'Birthday';
    birthdayInput.required = true;
    form.appendChild(birthdayInput);

    const deceasedLabel = document.createElement('label');
    deceasedLabel.style.display = 'flex';
    deceasedLabel.style.alignItems = 'center';
    deceasedLabel.style.gap = '4px';
    const deceasedCheckbox = document.createElement('input');
    deceasedCheckbox.type = 'checkbox';
    deceasedLabel.appendChild(deceasedCheckbox);
    deceasedLabel.appendChild(document.createTextNode('Deceased'));
    form.appendChild(deceasedLabel);

    const addBtn = document.createElement('button');
    addBtn.type = 'submit';
    addBtn.textContent = `Add ${type}`;
    form.appendChild(addBtn);

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const newMember = {
        id: generateId(),
        name: nameInput.value.trim(),
        gender: genderSelect.value,
        birthday: birthdayInput.value,
        deceased: deceasedCheckbox.checked,
        spouses: [],
        children: []
      };
      onAdd(newMember);
      form.remove();
    });

    return form;
  }

  // Remove member by ID from familyData or recursively from children or spouses
  function removeMemberById(id) {
    // Try remove from top level
    for(let i = 0; i < familyData.length; i++) {
      if(familyData[i].id === id) {
        familyData.splice(i,1);
        return true;
      }
      // Try remove from children recursively
      if(removeMemberFromChildren(familyData[i], id)) return true;
      // Try remove from spouses
      if(removeMemberFromSpouses(familyData[i], id)) return true;
    }
    return false;
  }
  function removeMemberFromChildren(member, id) {
    if(!member.children) return false;
    for(let i = 0; i < member.children.length; i++) {
      if(member.children[i].id === id) {
        member.children.splice(i,1);
        return true;
      }
      if(removeMemberFromChildren(member.children[i], id)) return true;
      if(removeMemberFromSpouses(member.children[i], id)) return true;
    }
    return false;
  }
  function removeMemberFromSpouses(member, id) {
    if(!member.spouses) return false;
    for(let i = 0; i < member.spouses.length; i++) {
      if(member.spouses[i].id === id) {
        member.spouses.splice(i,1);
        return true;
      }
    }
    return false;
  }

  // --- Login/Signup handlers ---
  const loginContainer = document.getElementById('login-container');
  const appContainer = document.getElementById('app-container');
  const loginForm = document.getElementById('login-form');
  const signupForm = document.getElementById('signup-form');
  const errorMsg = document.getElementById('error-msg');
  const logoutBtn = document.getElementById('logout-btn');

  loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    errorMsg.textContent = '';
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    mockLogin(email, password).then(user => {
      loggedInUser = user;
      loginContainer.style.display = 'none';
      appContainer.style.display = 'block';
      loadFamilyData();
      render();
    }).catch(err => {
      errorMsg.textContent = 'Login failed: ' + err.message;
    });
  });

  signupForm.addEventListener('submit', (e) => {
    e.preventDefault();
    errorMsg.textContent = '';
    const email = document.getElementById('signup-email').value.trim();
    const password = document.getElementById('signup-password').value;
    const passwordConfirm = document.getElementById('signup-password-confirm').value;
    if(password !== passwordConfirm) {
      errorMsg.textContent = "Passwords do not match";
      return;
    }
    mockSignup(email, password).then(user => {
      loggedInUser = user;
      loginContainer.style.display = 'none';
      appContainer.style.display = 'block';
      loadFamilyData();
      render();
    }).catch(err => {
      errorMsg.textContent = 'Signup failed: ' + err.message;
    });
  });

  logoutBtn.addEventListener('click', () => {
    mockLogout().then(() => {
      loggedInUser = null;
      loginContainer.style.display = 'block';
      appContainer.style.display = 'none';
    });
  });

  // Add root member form
  const addRootForm = document.getElementById('add-root-form');
  addRootForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const name = document.getElementById('root-name').value.trim();
    const gender = document.getElementById('root-gender').value;
    const birthday = document.getElementById('root-birthday').value;
    const deceased = document.getElementById('root-deceased').checked;
    if(!name || !gender || !birthday) return;
    const newMember = {
      id: generateId(),
      name,
      gender,
      birthday,
      deceased,
      spouses: [],
      children: []
    };
    familyData.push(newMember);
    saveFamilyData();
    render();
    addRootForm.reset();
  });

  // Show login form initially
  loginContainer.style.display = 'block';

</script>

</body>
</html>
