<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Family Tree</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
    }

    /* Login container */
    #login-container, #app-container {
      max-width: 700px;
      width: 100%;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      padding: 30px 25px 35px;
      box-sizing: border-box;
    }

    /* Login styling */
    #login-container h2 {
      margin-bottom: 25px;
      font-weight: 700;
      font-size: 1.8rem;
      color: #1e293b;
      text-align: center;
    }
    #login-container input {
      width: 100%;
      padding: 14px 12px;
      margin-bottom: 16px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1.8px solid #94a3b8;
      outline-offset: 2px;
      outline-color: transparent;
      transition: border-color 0.25s ease;
      box-sizing: border-box;
      font-weight: 500;
    }
    #login-container input:focus {
      border-color: #2563eb;
      outline-color: #2563eb;
      outline-offset: 2px;
    }
    #login-btn {
      width: 100%;
      padding: 14px;
      font-size: 1.1rem;
      font-weight: 700;
      border-radius: 8px;
      border: none;
      background: linear-gradient(90deg, #2563eb 0%, #1e40af 100%);
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 8px rgb(37 99 235 / 0.3);
      transition: background 0.3s ease;
    }
    #login-btn:hover {
      background: linear-gradient(90deg, #1e40af 0%, #2563eb 100%);
      box-shadow: 0 6px 15px rgb(30 64 175 / 0.4);
    }
    #login-error {
      margin-top: 6px;
      font-weight: 600;
      font-size: 0.95rem;
      color: #ef4444;
      text-align: center;
      min-height: 22px;
    }

    /* App container */
    #app-container h2 {
      text-align: center;
      margin-top: 0;
      font-weight: 700;
      font-size: 2rem;
      color: #334155;
      margin-bottom: 20px;
    }

    #birthday-notifications {
      background: #d1fae5;
      color: #065f46;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1rem;
      text-align: center;
    }

    #add-root-container {
      margin-bottom: 25px;
      border: 1px solid #cbd5e1;
      padding: 18px;
      border-radius: 10px;
      background: #f3f4f6;
    }
    #add-root-container h3 {
      margin-top: 0;
      font-weight: 700;
      color: #334155;
      font-size: 1.4rem;
      margin-bottom: 12px;
    }
    #add-root-form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    #add-root-form input[type="text"], #add-root-form input[type="date"], #add-root-form select {
      flex: 1 1 180px;
      padding: 10px 12px;
      font-size: 1rem;
      border-radius: 6px;
      border: 1.5px solid #94a3b8;
      font-weight: 500;
      box-sizing: border-box;
    }
    #add-root-form button {
      flex: 0 0 auto;
      background-color: #2563eb;
      padding: 12px 25px;
      font-size: 1.05rem;
      font-weight: 700;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      color: white;
      transition: background-color 0.25s ease;
    }
    #add-root-form button:hover {
      background-color: #1e40af;
    }

    /* Tree node styling */
    .tree-node {
      margin-left: 20px;
      position: relative;
      border-left: 1px dashed #cbd5e1;
      padding-left: 12px;
      margin-bottom: 14px;
      word-wrap: break-word;
      max-width: 100%;
    }
    .node-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .arrow {
      display: inline-block;
      width: 16px;
      user-select: none;
      cursor: pointer;
      transition: transform 0.2s ease;
      color: #475569;
      font-weight: 700;
      flex-shrink: 0;
    }
    .arrow.collapsed {
      transform: rotate(-90deg);
    }
    input[type="text"].name-input,
    select.gender-select {
      min-width: 150px;
      max-width: 260px;
      font-size: 1rem;
      border-radius: 6px;
      border: 1.5px solid #cbd5e1;
      padding: 6px 8px;
      font-weight: 600;
      box-sizing: border-box;
      flex-shrink: 1;
    }
    input[type="text"].name-input {
      /* full name visible */
      width: 220px;
    }
    input[type="date"].birthday-input,
    input[type="date"].deceased-input {
      width: 135px;
      padding: 6px 8px;
      font-size: 0.9rem;
      border-radius: 6px;
      border: 1.5px solid #cbd5e1;
      box-sizing: border-box;
      font-weight: 500;
    }

    .node-buttons {
      display: flex;
      gap: 8px;
      margin-left: auto;
      flex-wrap: nowrap;
    }
    .node-buttons button {
      font-size: 0.85rem;
      padding: 5px 12px;
      width: auto;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      color: white;
      transition: filter 0.2s ease;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.15);
    }
    .node-buttons button.add-child-btn {
      background-color: #10b981;
    }
    .node-buttons button.add-spouse-btn {
      background-color: #3b82f6;
    }
    .node-buttons button.delete-btn {
      background-color: #ef4444;
    }
    .node-buttons button:hover {
      filter: brightness(85%);
    }

    .add-child-form, .add-spouse-form {
      margin-left: 36px;
      margin-bottom: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .add-child-form input[type="text"], .add-spouse-form input[type="text"] {
      flex: 1 1 180px;
      padding: 6px 10px;
      font-size: 1rem;
      border-radius: 6px;
      border: 1.5px solid #cbd5e1;
      font-weight: 600;
      box-sizing: border-box;
    }
    .add-child-form button, .add-spouse-form button {
      background-color: #2563eb;
      padding: 7px 18px;
      font-size: 0.9rem;
      font-weight: 700;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      color: white;
      transition: background-color 0.25s ease;
    }
    .add-child-form button:hover, .add-spouse-form button:hover {
      background-color: #1e40af;
    }

    /* Collapsible spouse and marriages */
    .spouse-section {
      margin-left: 36px;
      margin-top: 8px;
      margin-bottom: 10px;
      font-weight: 600;
    }
    .marriages-toggle {
      background: none;
      border: none;
      color: #2563eb;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      user-select: none;
      margin-bottom: 6px;
      padding: 0;
    }
    .marriages-content {
      margin-left: 12px;
      border-left: 2px solid #e0e7ff;
      padding-left: 12px;
      margin-bottom: 12px;
    }

    .spouse-entry {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }
    .spouse-entry input[type="text"], .spouse-entry select {
      width: 190px;
    }
    .spouse-entry input[type="date"] {
      width: 130px;
    }
    .spouse-entry button.delete-spouse-btn {
      background-color: #ef4444;
      font-weight: 700;
      font-size: 0.85rem;
      padding: 5px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      color: white;
      box-shadow: 0 1px 4px rgb(0 0 0 / 0.15);
      transition: filter 0.15s ease;
    }
    .spouse-entry button.delete-spouse-btn:hover {
      filter: brightness(85%);
    }

    /* If deceased - strikethrough and red */
    .deceased .name-input {
      color: #b91c1c;
      text-decoration: line-through;
    }
    .deceased .deceased-label {
      color: #b91c1c;
      font-weight: 700;
      font-size: 0.9rem;
      margin-left: 6px;
    }

    /* Birthday notification styling */
    .birthday-highlight {
      background-color: #fef3c7;
      font-weight: 700;
      border-radius: 6px;
      padding: 2px 6px;
      color: #92400e;
    }

    /* Responsive */
    @media (max-width: 600px) {
      body {
        padding: 15px 10px;
      }
      #login-container, #app-container {
        padding: 20px 16px 24px;
      }
      .tree-node {
        margin-left: 12px;
        padding-left: 10px;
        margin-bottom: 14px;
      }
      input[type="text"].name-input {
        width: 140px;
        font-size: 0.95rem;
      }
      input[type="date"].birthday-input,
      input[type="date"].deceased-input {
        width: 110px;
      }
      select.gender-select {
        min-width: 90px;
      }
      .node-header {
        gap: 6px;
      }
      .node-buttons {
        flex-wrap: wrap;
        margin-left: 0;
        gap: 6px;
        margin-top: 6px;
      }
      .node-buttons button {
        flex: 1 1 48%;
      }
      .add-child-form, .add-spouse-form {
        margin-left: 20px;
        gap: 6px;
      }
      #add-root-form {
        flex-direction: column;
        gap: 12px;
      }
      #add-root-form input[type="text"], #add-root-form select, #add-root-form input[type="date"], #add-root-form button {
        width: 100%;
      }
      .spouse-entry {
        flex-direction: column;
        gap: 6px;
      }
      .spouse-entry input[type="text"], .spouse-entry select, .spouse-entry input[type="date"] {
        width: 100%;
      }
      .spouse-entry button.delete-spouse-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-container" aria-label="Login form">
  <h2>Login to Family Tree</h2>
  <input type="text" id="username" placeholder="Enter username" aria-label="Username" autocomplete="username" />
  <input type="password" id="password" placeholder="Enter password" aria-label="Password" autocomplete="current-password" />
  <button id="login-btn" aria-label="Login">Login</button>
  <div id="login-error" role="alert" aria-live="assertive"></div>
</div>

<!-- APP -->
<div id="app-container" style="display:none;">
  <h2>Your Family Tree</h2>
  <div id="birthday-notifications" aria-live="polite"></div>
  <div id="add-root-container" aria-label="Add root family member">
    <h3>Add Root Family Member</h3>
    <form id="add-root-form" autocomplete="off">
      <input type="text" id="root-name" placeholder="Full Name" required aria-label="Full Name" />
      <select id="root-gender" aria-label="Gender" required>
        <option value="" disabled selected>Select gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
      </select>
      <input type="date" id="root-birthday" placeholder="Birthday" aria-label="Birthday" />
      <button type="submit" aria-label="Add root family member">Add</button>
    </form>
  </div>
  <div id="family-tree" aria-label="Family tree"></div>
</div>

<script>
  // Simulated user authentication for demo purposes
  const usersDB = [
    { username: "user1", password: "password1" },
    { username: "user2", password: "password2" }
  ];

  // Initial family data: empty
  let familyTreeData = [];

  // Currently logged in username (if needed)
  let currentUser = null;

  // Helper: save family tree to localStorage per user
  function saveFamilyTree() {
    if (!currentUser) return;
    localStorage.setItem(`familyTree_${currentUser}`, JSON.stringify(familyTreeData));
  }

  // Helper: load family tree from localStorage per user
  function loadFamilyTree() {
    if (!currentUser) return;
    const saved = localStorage.getItem(`familyTree_${currentUser}`);
    if (saved) {
      try {
        familyTreeData = JSON.parse(saved);
      } catch {
        familyTreeData = [];
      }
    } else {
      familyTreeData = [];
    }
  }

  // Unique ID generator for nodes
  function generateId() {
    return 'id-' + Math.random().toString(36).substr(2, 9);
  }

  // LOGIN HANDLING
  const loginContainer = document.getElementById('login-container');
  const appContainer = document.getElementById('app-container');
  const loginBtn = document.getElementById('login-btn');
  const loginError = document.getElementById('login-error');

  loginBtn.addEventListener('click', () => {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    loginError.textContent = '';

    if (!username || !password) {
      loginError.textContent = 'Please enter username and password.';
      return;
    }

    const user = usersDB.find(u => u.username === username && u.password === password);
    if (!user) {
      loginError.textContent = 'Invalid username or password.';
      return;
    }

    // Login success
    currentUser = username;
    loadFamilyTree();
    renderFamilyTree();
    loginContainer.style.display = 'none';
    appContainer.style.display = 'block';
    updateBirthdayNotifications();
  });

  // LOGOUT (optional)
  // TODO: add logout button if desired

  // FAMILY TREE LOGIC

  // Add root family member form
  const addRootForm = document.getElementById('add-root-form');
  addRootForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const name = document.getElementById('root-name').value.trim();
    const gender = document.getElementById('root-gender').value;
    const birthday = document.getElementById('root-birthday').value;

    if (!name || !gender) return;

    const newRoot = {
      id: generateId(),
      name,
      gender,
      birthday: birthday || null,
      dateOfDeath: null,
      spouseOf: [], // array of spouse ids this member is spouse of
      spouses: [], // list of spouse objects { id, name, gender, birthday, dateOfDeath }
      children: []
    };
    familyTreeData.push(newRoot);
    saveFamilyTree();
    renderFamilyTree();

    // reset form
    addRootForm.reset();
  });

  // Add spouse form for a member
  function createAddSpouseForm(member) {
    const form = document.createElement('form');
    form.className = 'add-spouse-form';
    form.autocomplete = "off";

    const inputName = document.createElement('input');
    inputName.type = 'text';
    inputName.placeholder = 'Spouse Full Name';
    inputName.required = true;
    inputName.setAttribute('aria-label', `Add spouse name for ${member.name}`);

    const selectGender = document.createElement('select');
    selectGender.required = true;
    selectGender.setAttribute('aria-label', `Add spouse gender for ${member.name}`);
    selectGender.innerHTML = `
      <option value="" disabled selected>Select gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Other">Other</option>
    `;

    const inputBirthday = document.createElement('input');
    inputBirthday.type = 'date';
    inputBirthday.placeholder = 'Birthday';
    inputBirthday.setAttribute('aria-label', `Add spouse birthday for ${member.name}`);

    const inputDateOfDeath = document.createElement('input');
    inputDateOfDeath.type = 'date';
    inputDateOfDeath.placeholder = 'Date of Death (optional)';
    inputDateOfDeath.setAttribute('aria-label', `Add spouse date of death for ${member.name}`);

    const addBtn = document.createElement('button');
    addBtn.type = 'submit';
    addBtn.textContent = 'Add Spouse';

    form.appendChild(inputName);
    form.appendChild(selectGender);
    form.appendChild(inputBirthday);
    form.appendChild(inputDateOfDeath);
    form.appendChild(addBtn);

    form.addEventListener('submit', e => {
      e.preventDefault();
      const spouseName = inputName.value.trim();
      const spouseGender = selectGender.value;
      const spouseBirthday = inputBirthday.value || null;
      const spouseDateOfDeath = inputDateOfDeath.value || null;
      if (!spouseName || !spouseGender) return;

      // Create spouse object with unique id
      const spouseId = generateId();
      const spouse = {
        id: spouseId,
        name: spouseName,
        gender: spouseGender,
        birthday: spouseBirthday,
        dateOfDeath: spouseDateOfDeath,
        spouseOf: [member.id],
        spouses: [],
        children: []
      };

      // Add spouse to familyTreeData
      familyTreeData.push(spouse);

      // Add spouse reference to member.spouses
      member.spouses.push({
        id: spouseId,
        name: spouseName,
        gender: spouseGender,
        birthday: spouseBirthday,
        dateOfDeath: spouseDateOfDeath
      });

      saveFamilyTree();
      renderFamilyTree();
    });

    return form;
  }

  // Add child form for a member
  function createAddChildForm(member) {
    const form = document.createElement('form');
    form.className = 'add-child-form';
    form.autocomplete = "off";

    const inputName = document.createElement('input');
    inputName.type = 'text';
    inputName.placeholder = 'Child Full Name';
    inputName.required = true;
    inputName.setAttribute('aria-label', `Add child name for ${member.name}`);

    const selectGender = document.createElement('select');
    selectGender.required = true;
    selectGender.setAttribute('aria-label', `Add child gender for ${member.name}`);
    selectGender.innerHTML = `
      <option value="" disabled selected>Select gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Other">Other</option>
    `;

    const inputBirthday = document.createElement('input');
    inputBirthday.type = 'date';
    inputBirthday.placeholder = 'Birthday';
    inputBirthday.setAttribute('aria-label', `Add child birthday for ${member.name}`);

    const inputDateOfDeath = document.createElement('input');
    inputDateOfDeath.type = 'date';
    inputDateOfDeath.placeholder = 'Date of Death (optional)';
    inputDateOfDeath.setAttribute('aria-label', `Add child date of death for ${member.name}`);

    const addBtn = document.createElement('button');
    addBtn.type = 'submit';
    addBtn.textContent = 'Add Child';

    form.appendChild(inputName);
    form.appendChild(selectGender);
    form.appendChild(inputBirthday);
    form.appendChild(inputDateOfDeath);
    form.appendChild(addBtn);

    form.addEventListener('submit', e => {
      e.preventDefault();
      const childName = inputName.value.trim();
      const childGender = selectGender.value;
      const childBirthday = inputBirthday.value || null;
      const childDateOfDeath = inputDateOfDeath.value || null;
      if (!childName || !childGender) return;

      // Create child object with unique id
      const childId = generateId();
      const child = {
        id: childId,
        name: childName,
        gender: childGender,
        birthday: childBirthday,
        dateOfDeath: childDateOfDeath,
        spouseOf: [],
        spouses: [],
        children: []
      };

      member.children.push(child);
      saveFamilyTree();
      renderFamilyTree();
    });

    return form;
  }

  // Render the entire family tree container
  function renderFamilyTree() {
    const container = document.getElementById('family-tree');
    container.innerHTML = '';

    if (familyTreeData.length === 0) {
      container.textContent = 'No family members yet. Add a root member to start your tree.';
      return;
    }

    familyTreeData.forEach(member => {
      // Only render root nodes (nodes not spouse of anyone)
      if (!member.spouseOf || member.spouseOf.length === 0) {
        const node = createMemberNode(member);
        container.appendChild(node);
      }
    });
  }

  // Create single member node element (recursive for children)
  function createMemberNode(member) {
    const nodeDiv = document.createElement('div');
    nodeDiv.className = 'tree-node';
    if (member.dateOfDeath) {
      nodeDiv.classList.add('deceased');
    }

    // Header line with arrow (if children), name input, gender select, birthday input, deceased input, buttons
    const header = document.createElement('div');
    header.className = 'node-header';

    // Arrow toggle for children
    const hasChildren = member.children && member.children.length > 0;
    const arrow = document.createElement('span');
    arrow.className = 'arrow';
    arrow.setAttribute('aria-label', hasChildren ? `Toggle children for ${member.name}` : `No children for ${member.name}`);
    arrow.setAttribute('role', 'button');
    arrow.setAttribute('tabindex', hasChildren ? '0' : '-1');
    arrow.textContent = 'â–¾';
    if (!hasChildren) {
      arrow.style.visibility = 'hidden';
    }
    header.appendChild(arrow);

    // Name input
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = member.name;
    nameInput.className = 'name-input';
    nameInput.setAttribute('aria-label', `Full name of ${member.name}`);
    header.appendChild(nameInput);

    // Gender select
    const genderSelect = document.createElement('select');
    genderSelect.className = 'gender-select';
    genderSelect.setAttribute('aria-label', `Gender of ${member.name}`);
    genderSelect.innerHTML = `
      <option value="Male"${member.gender === 'Male' ? ' selected' : ''}>Male</option>
      <option value="Female"${member.gender === 'Female' ? ' selected' : ''}>Female</option>
      <option value="Other"${member.gender === 'Other' ? ' selected' : ''}>Other</option>
    `;
    header.appendChild(genderSelect);

    // Birthday input
    const birthdayInput = document.createElement('input');
    birthdayInput.type = 'date';
    birthdayInput.value = member.birthday || '';
    birthdayInput.className = 'birthday-input';
    birthdayInput.setAttribute('aria-label', `Birthday of ${member.name}`);
    header.appendChild(birthdayInput);

    // Date of Death input
    const deathInput = document.createElement('input');
    deathInput.type = 'date';
    deathInput.value = member.dateOfDeath || '';
    deathInput.className = 'deceased-input';
    deathInput.setAttribute('aria-label', `Date of death of ${member.name} (leave empty if alive)`);
    header.appendChild(deathInput);

    // If deceased, show label next to name input
    if (member.dateOfDeath) {
      const deceasedLabel = document.createElement('span');
      deceasedLabel.className = 'deceased-label';
      const deathDateDisplay = new Date(member.dateOfDeath).toLocaleDateString();
      deceasedLabel.textContent = `Deceased: ${deathDateDisplay}`;
      header.appendChild(deceasedLabel);
    }

    // Buttons container
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'node-buttons';

    // Add Child button
    const addChildBtn = document.createElement('button');
    addChildBtn.textContent = 'Add Child';
    addChildBtn.setAttribute('aria-label', `Add child to ${member.name}`);
    buttonsDiv.appendChild(addChildBtn);

    // Add Spouse button
    const addSpouseBtn = document.createElement('button');
    addSpouseBtn.textContent = 'Add Spouse';
    addSpouseBtn.setAttribute('aria-label', `Add spouse to ${member.name}`);
    buttonsDiv.appendChild(addSpouseBtn);

    header.appendChild(buttonsDiv);

    nodeDiv.appendChild(header);

    // Container for children nodes (collapsible)
    const childrenContainer = document.createElement('div');
    childrenContainer.className = 'children-container';
    childrenContainer.style.marginLeft = '24px';

    if (hasChildren) {
      member.children.forEach(child => {
        const childNode = createMemberNode(child);
        childrenContainer.appendChild(childNode);
      });
    }
    nodeDiv.appendChild(childrenContainer);

    // Spouses section with toggle
    if (member.spouses && member.spouses.length > 0) {
      const spousesSection = document.createElement('div');
      spousesSection.className = 'spouse-section';

      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'marriages-toggle';
      toggleBtn.setAttribute('aria-expanded', 'false');
      toggleBtn.textContent = `Show Spouses (${member.spouses.length})`;
      spousesSection.appendChild(toggleBtn);

      const spousesContent = document.createElement('div');
      spousesContent.className = 'marriages-content';
      spousesContent.style.display = 'none';

      member.spouses.forEach(spouse => {
        const spouseDiv = document.createElement('div');
        spouseDiv.className = 'spouse-entry';

        const spouseName = document.createElement('input');
        spouseName.type = 'text';
        spouseName.value = spouse.name;
        spouseName.disabled = true;
        spouseName.setAttribute('aria-label', `Spouse name of ${member.name}`);
        spouseDiv.appendChild(spouseName);

        const spouseGender = document.createElement('select');
        spouseGender.disabled = true;
        spouseGender.setAttribute('aria-label', `Spouse gender of ${member.name}`);
        spouseGender.innerHTML = `
          <option value="Male"${spouse.gender === 'Male' ? ' selected' : ''}>Male</option>
          <option value="Female"${spouse.gender === 'Female' ? ' selected' : ''}>Female</option>
          <option value="Other"${spouse.gender === 'Other' ? ' selected' : ''}>Other</option>
        `;
        spouseDiv.appendChild(spouseGender);

        const spouseBirthday = document.createElement('input');
        spouseBirthday.type = 'date';
        spouseBirthday.value = spouse.birthday || '';
        spouseBirthday.disabled = true;
        spouseBirthday.setAttribute('aria-label', `Spouse birthday of ${member.name}`);
        spouseDiv.appendChild(spouseBirthday);

        const spouseDeath = document.createElement('input');
        spouseDeath.type = 'date';
        spouseDeath.value = spouse.dateOfDeath || '';
        spouseDeath.disabled = true;
        spouseDeath.setAttribute('aria-label', `Spouse date of death of ${member.name}`);
        spouseDiv.appendChild(spouseDeath);

        spousesContent.appendChild(spouseDiv);
      });

      spousesSection.appendChild(spousesContent);
      nodeDiv.appendChild(spousesSection);

      // Toggle handler
      toggleBtn.addEventListener('click', () => {
        const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
        if (expanded) {
          spousesContent.style.display = 'none';
          toggleBtn.textContent = `Show Spouses (${member.spouses.length})`;
          toggleBtn.setAttribute('aria-expanded', 'false');
        } else {
          spousesContent.style.display = 'block';
          toggleBtn.textContent = `Hide Spouses (${member.spouses.length})`;
          toggleBtn.setAttribute('aria-expanded', 'true');
        }
      });
    }

    // Arrow toggle children
    arrow.addEventListener('click', () => {
      if (childrenContainer.style.display === 'none' || childrenContainer.style.display === '') {
        childrenContainer.style.display = 'block';
        arrow.textContent = 'â–¾';
      } else {
        childrenContainer.style.display = 'none';
        arrow.textContent = 'â–¸';
      }
    });

    // Also allow keyboard toggle on arrow
    arrow.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        arrow.click();
      }
    });

    // Add Child button event: show/hide add child form below this member
    addChildBtn.addEventListener('click', () => {
      // Check if form already exists
      if (nodeDiv.querySelector('.add-child-form')) {
        // Remove it
        const form = nodeDiv.querySelector('.add-child-form');
        form.remove();
      } else {
        const form = createAddChildForm(member);
        nodeDiv.appendChild(form);
      }
    });

    // Add Spouse button event: show/hide add spouse form below this member
    addSpouseBtn.addEventListener('click', () => {
      if (nodeDiv.querySelector('.add-spouse-form')) {
        const form = nodeDiv.querySelector('.add-spouse-form');
        form.remove();
      } else {
        const form = createAddSpouseForm(member);
        nodeDiv.appendChild(form);
      }
    });

    // Update member name on input change
    nameInput.addEventListener('input', () => {
      member.name = nameInput.value.trim();
      saveFamilyTree();
      renderFamilyTree();
    });

    // Update gender on change
    genderSelect.addEventListener('change', () => {
      member.gender = genderSelect.value;
      saveFamilyTree();
      renderFamilyTree();
    });

    // Update birthday on change
    birthdayInput.addEventListener('change', () => {
      member.birthday = birthdayInput.value || null;
      saveFamilyTree();
      renderFamilyTree();
      updateBirthdayNotifications();
    });

    // Update date of death on change
    deathInput.addEventListener('change', () => {
      member.dateOfDeath = deathInput.value || null;
      saveFamilyTree();
      renderFamilyTree();
      updateBirthdayNotifications();
    });

    return nodeDiv;
  }

  // Birthday notifications: show list of family members with birthdays today
  function updateBirthdayNotifications() {
    const container = document.getElementById('birthday-notifications');
    container.innerHTML = '';
    if (familyTreeData.length === 0) return;

    // Flatten all members (root + children + spouses)
    const allMembers = [];

    function traverse(member) {
      allMembers.push(member);
      member.children.forEach(c => traverse(c));
      // spouses are separate nodes in familyTreeData and handled elsewhere
    }

    familyTreeData.forEach(rootMember => {
      traverse(rootMember);
    });

    const today = new Date();
    const todayMonthDay = `${today.getMonth()+1}-${today.getDate()}`;

    const birthdayMembers = allMembers.filter(m => {
      if (!m.birthday) return false;
      const bd = new Date(m.birthday);
      return (bd.getMonth()+1) === (today.getMonth()+1) && bd.getDate() === today.getDate();
    });

    if (birthdayMembers.length > 0) {
      const title = document.createElement('strong');
      title.textContent = `ðŸŽ‰ Birthdays Today (${birthdayMembers.length}):`;
      container.appendChild(title);

      const list = document.createElement('ul');
      birthdayMembers.forEach(m => {
        const li = document.createElement('li');
        li.textContent = `${m.name} (${m.birthday})`;
        li.className = 'birthday-highlight';
        list.appendChild(li);
      });
      container.appendChild(list);
    }
  }
</script>

</body>
</html>
