<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Tree App</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f9f9f9;
  }

  #login-container, #app-container {
    max-width: 900px;
    margin: auto;
  }

  input[type="text"], input[type="date"], button {
    padding: 6px 10px;
    margin: 2px;
    font-size: 14px;
  }

  button {
    cursor: pointer;
  }

  .tree-node {
    border: 1px solid #ccc;
    background: #fff;
    margin: 10px 0;
    padding: 8px;
    border-radius: 6px;
    position: relative;
    min-width: 250px;
  }

  .node-header {
    display: flex;
    align-items: center;
  }

  .name-input {
    flex: 1;
    margin-right: 6px;
  }

  .birthday-input, .died-input {
    margin-right: 6px;
  }

  .node-buttons button {
    margin-left: 6px;
    font-size: 13px;
    padding: 4px 8px;
  }

  /* Arrow container and lines */
  .arrow {
    display: inline-block;
    width: 18px;
    height: 18px;
    margin-right: 8px;
    user-select: none;
    cursor: pointer;
    position: relative;
  }

  /* Using SVG inside arrow for a clean arrow icon */
  .arrow svg {
    width: 18px;
    height: 18px;
    fill: #444;
    transition: transform 0.25s ease;
  }

  .arrow.collapsed svg {
    transform: rotate(0deg);
  }

  .arrow.expanded svg {
    transform: rotate(90deg);
  }

  /* Children & spouses container with connectors */
  .children-container {
    margin-left: 40px;
    border-left: 2px solid #777;
    padding-left: 15px;
    position: relative;
  }

  .children-container::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 15px;
    height: 2px;
    background: #777;
  }

  .spouses-container {
    display: flex;
    gap: 15px;
    margin-top: 8px;
    border-top: 2px solid #aaa;
    padding-top: 8px;
    position: relative;
  }

  .spouses-container::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: #aaa;
  }

  .tree-node.spouse-node {
    border-color: #aaa;
    background: #f0f0f0;
    min-width: 220px;
  }

  /* Connect spouses vertically */
  .spouses-container > .tree-node:not(:last-child) {
    border-right: 2px solid #aaa;
    padding-right: 10px;
    margin-right: 10px;
  }

  /* Footer */
  footer {
    text-align: center;
    margin-top: 40px;
    color: #666;
    font-size: 14px;
  }

  /* Forms for adding children/spouse */
  form.add-child-form,
  form.add-spouse-form {
    margin-top: 8px;
  }

  form.add-child-form input,
  form.add-spouse-form input {
    font-size: 13px;
  }
</style>
</head>
<body>

<div id="login-container">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Password" />
  <button id="login-btn">Login</button>
</div>

<div id="app-container" style="display:none;">
  <h1>Family Tree</h1>
  <form id="add-root-form" style="margin-bottom: 20px;">
    <input type="text" id="root-name" placeholder="Root Person Name" required />
    <input type="date" id="root-birthday" required />
    <input type="date" id="root-died" placeholder="Date of Death (optional)" />
    <button type="submit">Add Root Person</button>
  </form>

  <div id="birthday-notifications" style="margin-bottom: 20px; font-weight: bold; color: #a33;"></div>
  <div id="family-trees-container" style="display:flex; gap: 40px; flex-wrap: wrap;"></div>
  <button id="logout-btn" style="margin-top: 20px;">Logout</button>
</div>

<footer>&copy; 2025 Maki Web. All rights reserved</footer>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  // Initialize Firebase
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "project-955237504610034331.firebaseapp.com",
    databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
    projectId: "project-955237504610034331",
    storageBucket: "project-955237504610034331.appspot.com",
    messagingSenderId: "955237504610034331",
    appId: "1:955237504610034331:web:929cfe1b2a298c6904ae91"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();

  // --- UI Elements ---
  const loginContainer = document.getElementById('login-container');
  const appContainer = document.getElementById('app-container');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const birthdayNotifications = document.getElementById('birthday-notifications');
  const familyTreesContainer = document.getElementById('family-trees-container');

  // --- Authentication ---
  loginBtn.addEventListener('click', () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) {
      alert('Please enter email and password.');
      return;
    }
    auth.signInWithEmailAndPassword(email, password)
      .catch(err => alert(err.message));
  });

  logoutBtn.addEventListener('click', () => {
    auth.signOut();
  });

  auth.onAuthStateChanged(user => {
    if (user) {
      loginContainer.style.display = 'none';
      appContainer.style.display = 'block';
      loadFamilyTrees();
    } else {
      loginContainer.style.display = 'block';
      appContainer.style.display = 'none';
      birthdayNotifications.textContent = '';
      familyTreesContainer.innerHTML = '';
    }
  });

  // --- Family Trees Data ---
  let familyTrees = {};

  // --- Load Family Trees ---
  function loadFamilyTrees() {
    const userId = auth.currentUser.uid;
    const userTreesRef = database.ref(`familyTrees/${userId}`);
    userTreesRef.off();

    userTreesRef.on('value', snapshot => {
      familyTrees = snapshot.val() || {};
      renderFamilyTrees();
      showTodayBirthdays();
    });
  }

  // --- Save Family Trees ---
  function saveFamilyTrees() {
    const userId = auth.currentUser.uid;
    database.ref(`familyTrees/${userId}`).set(familyTrees);
  }

  // --- Add Root Person ---
  const addRootForm = document.getElementById('add-root-form');
  addRootForm.addEventListener('submit', e => {
    e.preventDefault();
    const name = document.getElementById('root-name').value.trim();
    const birthday = document.getElementById('root-birthday').value;
    const diedDate = document.getElementById('root-died').value || '';
    if (!name || !birthday) {
      alert('Please fill in the name and birthday.');
      return;
    }
    // Add new root person as a new tree
    const treeId = Date.now().toString();
    familyTrees[treeId] = {
      id: treeId,
      name,
      birthday,
      died: diedDate ? true : false,
      diedDate: diedDate || '',
      children: {},
      spouses: {}
    };
    saveFamilyTrees();
    addRootForm.reset();
  });

  // --- Show Today's Birthdays ---
  function showTodayBirthdays() {
    birthdayNotifications.textContent = '';
    const today = new Date();
    const monthDay = today.toISOString().slice(5,10);

    let notifications = [];

    for (const treeId in familyTrees) {
      const tree = familyTrees[treeId];
      // Check root person
      if (tree.birthday && tree.birthday.slice(5,10) === monthDay) {
        notifications.push(`${tree.name} (Root) has birthday today!`);
      }
      if (tree.died && tree.diedDate && tree.diedDate.slice(5,10) === monthDay) {
        notifications.push(`Remembering ${tree.name} (Root), who passed away today.`);
      }
      // Check children recursively
      function checkDescendants(node) {
        for (const childId in node.children) {
          const child = node.children[childId];
          if (child.birthday && child.birthday.slice(5,10) === monthDay) {
            notifications.push(`${child.name} has birthday today!`);
          }
          if (child.died && child.diedDate && child.diedDate.slice(5,10) === monthDay) {
            notifications.push(`Remembering ${child.name}, who passed away today.`);
          }
          checkDescendants(child);
        }
        for (const spouseId in node.spouses) {
          const spouse = node.spouses[spouseId];
          if (spouse.birthday && spouse.birthday.slice(5,10) === monthDay) {
            notifications.push(`${spouse.name} (spouse) has birthday today!`);
          }
          if (spouse.died && spouse.diedDate && spouse.diedDate.slice(5,10) === monthDay) {
            notifications.push(`Remembering ${spouse.name} (spouse), who passed away today.`);
          }
        }
      }
      checkDescendants(tree);
    }

    if (notifications.length > 0) {
      birthdayNotifications.innerHTML = notifications.join('<br>');
    }
  }

  // --- Render Family Trees ---
  function renderFamilyTrees() {
    familyTreesContainer.innerHTML = '';
    for (const treeId in familyTrees) {
      const tree = familyTrees[treeId];
      const treeDiv = document.createElement('div');
      treeDiv.style.marginRight = '40px';
      renderNode(tree, treeDiv, treeId, null);
      familyTreesContainer.appendChild(treeDiv);
    }
  }

  // --- Helper: Create arrow SVG ---
  function createArrowSvg() {
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("viewBox", "0 0 24 24");
    svg.setAttribute("width", "18");
    svg.setAttribute("height", "18");
    const path = document.createElementNS(svgNS, "path");
    path.setAttribute("d", "M8 5v14l11-7z"); // Right arrow
    svg.appendChild(path);
    return svg;
  }

  // --- Render Node ---
  function renderNode(node, container, nodeId, parentNode, isSpouse = false) {
    container.innerHTML = '';

    const nodeDiv = document.createElement('div');
    nodeDiv.className = 'tree-node' + (isSpouse ? ' spouse-node' : '');

    // Header Div (collapsible arrow + inputs + buttons)
    const headerDiv = document.createElement('div');
    headerDiv.className = 'node-header';

    // Collapsible arrow for children and spouses
    const hasChildren = Object.keys(node.children || {}).length > 0;
    const hasSpouses = Object.keys(node.spouses || {}).length > 0;

    // Arrow to collapse children and spouses
    const arrow = document.createElement('span');
    arrow.className = 'arrow collapsed';
    arrow.appendChild(createArrowSvg());

    headerDiv.appendChild(arrow);

    arrow.addEventListener('click', () => {
      if (arrow.classList.contains('collapsed')) {
        arrow.classList.remove('collapsed');
        arrow.classList.add('expanded');
        if (childrenContainer) childrenContainer.style.display = 'flex';
        if (spousesContainer) spousesContainer.style.display = 'flex';
      } else {
        arrow.classList.remove('expanded');
        arrow.classList.add('collapsed');
        if (childrenContainer) childrenContainer.style.display = 'none';
        if (spousesContainer) spousesContainer.style.display = 'none';
      }
    });

    // Name input
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.className = 'name-input';
    nameInput.value = node.name || '';
    nameInput.placeholder = 'Name';
    headerDiv.appendChild(nameInput);

    // Birthday input
    const birthdayInput = document.createElement('input');
    birthdayInput.type = 'date';
    birthdayInput.className = 'birthday-input';
    birthdayInput.value = node.birthday || '';
    birthdayInput.title = 'Birthday';
    headerDiv.appendChild(birthdayInput);

    // Died input (date) with placeholder
    const diedInput = document.createElement('input');
    diedInput.type = 'date';
    diedInput.className = 'died-input';
    diedInput.value = node.diedDate || '';
    diedInput.title = 'Date of Death (optional)';
    headerDiv.appendChild(diedInput);

    // Buttons: Add Child, Add Spouse, Delete Node
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'node-buttons';

    // Add Child button
    if (!isSpouse) {
      const addChildBtn = document.createElement('button');
      addChildBtn.textContent = '+Child';
      addChildBtn.title = 'Add Child';
      buttonsDiv.appendChild(addChildBtn);
      addChildBtn.addEventListener('click', () => {
        const childId = Date.now().toString();
        if (!node.children) node.children = {};
        node.children[childId] = {
          id: childId,
          name: '',
          birthday: '',
          died: false,
          diedDate: '',
          children: {},
          spouses: {}
        };
        saveFamilyTrees();
      });
    }

    // Add Spouse button
    if (!isSpouse) {
      const addSpouseBtn = document.createElement('button');
      addSpouseBtn.textContent = '+Spouse';
      addSpouseBtn.title = 'Add Spouse';
      buttonsDiv.appendChild(addSpouseBtn);
      addSpouseBtn.addEventListener('click', () => {
        const spouseId = Date.now().toString();
        if (!node.spouses) node.spouses = {};
        node.spouses[spouseId] = {
          id: spouseId,
          name: '',
          birthday: '',
          died: false,
          diedDate: '',
          children: {},
          spouses: {}
        };
        saveFamilyTrees();
      });
    }

    // Delete button
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Delete';
    deleteBtn.title = 'Delete this person';
    buttonsDiv.appendChild(deleteBtn);

    deleteBtn.addEventListener('click', () => {
      if (!confirm('Are you sure you want to delete this person and their descendants?')) return;
      if (!parentNode) {
        // Root node: delete whole tree
        delete familyTrees[nodeId];
      } else {
        // Find and delete from parent children or spouses
        for (const key in parentNode.children) {
          if (parentNode.children[key].id === nodeId) {
            delete parentNode.children[key];
            break;
          }
        }
        for (const key in parentNode.spouses) {
          if (parentNode.spouses[key].id === nodeId) {
            delete parentNode.spouses[key];
            break;
          }
        }
      }
      saveFamilyTrees();
    });

    headerDiv.appendChild(buttonsDiv);
    nodeDiv.appendChild(headerDiv);

    // Children container
    const childrenContainer = document.createElement('div');
    childrenContainer.className = 'children-container';
    childrenContainer.style.display = 'none'; // collapsed by default

    // Render children horizontally stacked
    for (const childId in node.children || {}) {
      const child = node.children[childId];
      const childDiv = document.createElement('div');
      childDiv.style.display = 'inline-block';
      childDiv.style.verticalAlign = 'top';
      renderNode(child, childDiv, childId, node);
      childrenContainer.appendChild(childDiv);
    }
    nodeDiv.appendChild(childrenContainer);

    // Spouses container: horizontal, aligned next to each other with line on top
    const spousesContainer = document.createElement('div');
    spousesContainer.className = 'spouses-container';
    spousesContainer.style.display = 'none'; // collapsed by default

    // To keep spouses aligned horizontally and connected with a line on top,
    // and to visually connect spouses nodes, they are flex with gap and border lines.

    for (const spouseId in node.spouses || {}) {
      const spouse = node.spouses[spouseId];
      const spouseDiv = document.createElement('div');
      spouseDiv.style.display = 'inline-block';
      spouseDiv.style.verticalAlign = 'top';
      renderNode(spouse, spouseDiv, spouseId, node, true);
      spousesContainer.appendChild(spouseDiv);
    }
    nodeDiv.appendChild(spousesContainer);

    // Update node data on input change
    nameInput.addEventListener('input', () => {
      node.name = nameInput.value;
      saveFamilyTrees();
    });
    birthdayInput.addEventListener('change', () => {
      node.birthday = birthdayInput.value;
      saveFamilyTrees();
    });
    diedInput.addEventListener('change', () => {
      node.diedDate = diedInput.value;
      node.died = !!diedInput.value;
      saveFamilyTrees();
    });

    container.appendChild(nodeDiv);
  }
</script>
</body>
</html>
