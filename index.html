<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree with Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

    window.firebaseImports = { initializeApp, getDatabase, ref, onValue, set, update };
  </script>
  <style>
    .highlight {
      background-color: #ffe58f;
      border-radius: 0.25rem;
      box-shadow: 0 0 8px 2px #ffd666aa;
      animation: none;
    }

    .blink-highlight {
      animation: blink 1s infinite;
      background-color: #ffd666;
      border-radius: 0.25rem;
      box-shadow: 0 0 8px 2px #ffb700cc;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .children-container {
      transition: max-height 0.3s ease, opacity 0.3s ease;
      overflow: hidden;
    }

    /* Box style for nodes and spouses */
    .node-box {
      border: 2px solid #93c5fd; /* Tailwind blue-400 */
      border-radius: 0.5rem;
      padding: 0.25rem 0.5rem;
      margin-bottom: 0.5rem;
      background: white;
      /* Adjust width to fit text exactly */
      display: inline-block;
      max-width: 100%;
      box-shadow: 0 2px 6px rgb(147 197 253 / 0.5);
      position: relative;
      white-space: nowrap;
    }

    /* Lines connecting nodes */
    .tree-node-container {
      border-left: 2px solid #93c5fd;
      margin-left: 1rem;
      padding-left: 1rem;
    }

    /* Scroll container */
    #tree-scroll-container {
      width: 100%;
      max-width: 100vw;
      height: 70vh;
      overflow: auto;
      border: 1px solid #cbd5e1; /* Tailwind gray-300 */
      border-radius: 0.5rem;
      padding: 1rem;
      background: #f9fafb;
      box-sizing: border-box;
      user-select: none;
    }

    /* Buttons */
    .toggle-expand-btn {
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      background-color: #3b82f6; /* blue-500 */
      color: white;
      font-weight: 600;
      border-radius: 0.375rem;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    .toggle-expand-btn:hover {
      background-color: #2563eb; /* blue-600 */
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">
  <div id="root" class="w-full max-w-6xl bg-white p-6 rounded shadow"></div>

  <script type="text/babel">

    const { useState, useEffect, useRef } = React;

    // Firebase config - replace with your own or use this one
    const firebaseConfig = {
      apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
      authDomain: "project-955237504610034331.firebaseapp.com",
      databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
      projectId: "project-955237504610034331",
      storageBucket: "project-955237504610034331.firebasestorage.app",
      messagingSenderId: "76212939677",
      appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
      measurementId: "G-RCJ4P82PVM"
    };

    const {
      initializeApp,
      getDatabase,
      ref,
      onValue,
      set,
      update,
    } = window.firebaseImports;

    // Init Firebase app and database
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let nextId = 1000; // For new ids

    // EditableField component - for editing birthdays etc
    function EditableField({ label, value, type = "text", onChange }) {
      const [editing, setEditing] = useState(false);
      const [tempValue, setTempValue] = useState(value || "");

      function save() {
        onChange(tempValue);
        setEditing(false);
      }

      return (
        <div className="flex items-center space-x-1 text-sm text-gray-700">
          <span className="font-semibold">{label}:</span>
          {editing ? (
            type === "date" ? (
              <input
                type="date"
                value={tempValue}
                onChange={e => setTempValue(e.target.value)}
                onBlur={save}
                onKeyDown={e => { if (e.key === "Enter") save(); }}
                autoFocus
                className="border border-gray-300 rounded px-1 py-0.5 w-32"
              />
            ) : (
              <input
                type="text"
                value={tempValue}
                onChange={e => setTempValue(e.target.value)}
                onBlur={save}
                onKeyDown={e => { if (e.key === "Enter") save(); }}
                autoFocus
                className="border border-gray-300 rounded px-1 py-0.5 w-32"
              />
            )
          ) : (
            <span
              className="cursor-pointer hover:text-blue-600"
              onClick={() => setEditing(true)}
              title={`Click to edit ${label.toLowerCase()}`}
            >
              {value || <em className="text-gray-400">(none)</em>}
            </span>
          )}
        </div>
      );
    }

    function SpouseItem({ spouse, onUpdate, onDelete, highlight, blink }) {
      const [editName, setEditName] = useState(false);
      const [tempName, setTempName] = useState(spouse.name);
      const [showDates, setShowDates] = useState(false);

      function saveName() {
        onUpdate({ ...spouse, name: tempName });
        setEditName(false);
      }

      function updateField(field, val) {
        onUpdate({ ...spouse, [field]: val });
      }

      return (
        <div
          className={`flex items-center space-x-2 text-sm italic ${
            highlight ? "highlight" : ""
          } ${blink ? "blink-highlight" : ""} node-box`}
          style={{ minWidth: "auto" }}
        >
          {editName ? (
            <input
              type="text"
              value={tempName}
              onChange={e => setTempName(e.target.value)}
              onBlur={saveName}
              onKeyDown={e => { if (e.key === "Enter") saveName(); }}
              autoFocus
              className="border border-gray-400 rounded px-1 py-0.5 w-full"
              style={{ minWidth: "auto" }}
            />
          ) : (
            <span
              className="cursor-pointer hover:text-blue-600 flex-grow whitespace-nowrap"
              onClick={() => setShowDates(!showDates)}
              title="Click to toggle spouse details"
              onDoubleClick={() => setEditName(true)}
            >
              {spouse.name || <em>(unnamed)</em>}
            </span>
          )}

          {showDates && (
            <>
              <EditableField
                label="Bday"
                type="date"
                value={spouse.birthday}
                onChange={val => updateField("birthday", val)}
              />
              <EditableField
                label="Dday"
                type="date"
                value={spouse.deathday}
                onChange={val => updateField("deathday", val)}
              />
              <button
                onClick={() => onDelete(spouse.id)}
                className="text-red-600 hover:text-red-800 font-bold select-none"
                title="Delete spouse"
              >
                Ã—
              </button>
            </>
          )}
        </div>
      );
    }

    function TreeNode({
      node,
      onUpdate,
      onDelete,
      highlightIds = new Set(),
      blinkId = null,
      openIds = new Set(),
      scrollToId = null,
      onScrollHandled,
    }) {
      const [open, setOpen] = useState(openIds.has(node.id));
      const [editName, setEditName] = useState(false);
      const [tempName, setTempName] = useState(node.name || "");
      const nodeRef = useRef();
        const isHighlighted = highlightIds.has(node.id);
  const isBlinking = node.id === blinkId;

  useEffect(() => {
    if (scrollToId === node.id && nodeRef.current) {
      nodeRef.current.scrollIntoView({ behavior: "smooth", block: "center" });
      onScrollHandled?.();
    }
  }, [scrollToId]);

  function updateNode(changes) {
    onUpdate({ ...node, ...changes });
  }

  function toggleOpen() {
    setOpen(prev => !prev);
  }

  function addChild() {
    const newId = nextId++;
    const newChild = { id: newId, name: "New Child", spouses: [], children: [] };
    updateNode({ children: [...(node.children || []), newChild] });
  }

  function addSpouse() {
    const newId = nextId++;
    const newSpouse = { id: newId, name: "Spouse" };
    updateNode({ spouses: [...(node.spouses || []), newSpouse] });
  }

  function deleteSpouse(id) {
    updateNode({ spouses: node.spouses.filter(s => s.id !== id) });
  }

  function updateSpouse(updatedSpouse) {
    updateNode({
      spouses: node.spouses.map(s =>
        s.id === updatedSpouse.id ? updatedSpouse : s
      )
    });
  }

  function saveName() {
    updateNode({ name: tempName });
    setEditName(false);
  }

  return (
    <div className="tree-node-container" ref={nodeRef}>
      <div
        className={`node-box flex items-center justify-between gap-2 ${
          isHighlighted ? "highlight" : ""
        } ${isBlinking ? "blink-highlight" : ""}`}
      >
        {editName ? (
          <input
            type="text"
            value={tempName}
            onChange={e => setTempName(e.target.value)}
            onBlur={saveName}
            onKeyDown={e => { if (e.key === "Enter") saveName(); }}
            autoFocus
            className="border border-gray-400 rounded px-1 py-0.5 w-full"
          />
        ) : (
          <span
            className="font-semibold cursor-pointer"
            onDoubleClick={() => setEditName(true)}
          >
            {node.name || <em>(unnamed)</em>}
          </span>
        )}

        <div className="flex gap-1">
          <button onClick={toggleOpen} title={open ? "Collapse" : "Expand"} className="text-blue-600 font-bold text-xs">â®Ÿ</button>
          <button onClick={addSpouse} title="Add Spouse" className="text-green-600 font-bold text-xs">+S</button>
          <button onClick={addChild} title="Add Child" className="text-green-600 font-bold text-xs">+C</button>
          <button onClick={() => onDelete(node.id)} title="Delete" className="text-red-600 font-bold text-xs">Ã—</button>
        </div>
      </div>

      <div className="ml-4 flex flex-col gap-1">
        {node.spouses?.map(spouse => (
          <SpouseItem
            key={spouse.id}
            spouse={spouse}
            onUpdate={updateSpouse}
            onDelete={deleteSpouse}
            highlight={highlightIds.has(spouse.id)}
            blink={blinkId === spouse.id}
          />
        ))}

        {open && (
          <div className="ml-4 mt-2 children-container">
            {node.children?.map(child => (
              <TreeNode
                key={child.id}
                node={child}
                onUpdate={updated => {
                  const newChildren = node.children.map(c =>
                    c.id === updated.id ? updated : c
                  );
                  updateNode({ children: newChildren });
                }}
                onDelete={id => {
                  updateNode({ children: node.children.filter(c => c.id !== id) });
                }}
                highlightIds={highlightIds}
                blinkId={blinkId}
                openIds={openIds}
                scrollToId={scrollToId}
                onScrollHandled={onScrollHandled}
              />
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

function App() {
  const [tree, setTree] = useState(null);
  const [searchTerm, setSearchTerm] = useState("");
  const [highlightIds, setHighlightIds] = useState(new Set());
  const [blinkId, setBlinkId] = useState(null);
  const [scrollToId, setScrollToId] = useState(null);
  const [openAll, setOpenAll] = useState(true);

  useEffect(() => {
    const dbRef = ref(database, "familyTree");
    onValue(dbRef, (snapshot) => {
      const data = snapshot.val();
      if (data) {
        setTree(data);
      } else {
        const defaultTree = {
          id: 1,
          name: "Root Person",
          spouses: [],
          children: []
        };
        set(dbRef, defaultTree);
      }
    });
  }, []);

  function updateTree(newTree) {
    setTree(newTree);
    set(ref(database, "familyTree"), newTree);
  }

  function updateNode(updatedNode) {
    updateTree(updatedNode);
  }

  function deleteNode(idToDelete, node = tree) {
    if (node.id === idToDelete) {
      if (confirm("Are you sure you want to delete the root node?")) {
        setTree(null);
        set(ref(database, "familyTree"), null);
      }
      return null;
    }

    const recurse = (current) => {
      if (!current.children) return current;
      current.children = current.children
        .map(child => recurse(child))
        .filter(Boolean);
      return current;
    };

    updateTree(recurse(structuredClone(tree)));
  }

  function handleSearch() {
    const matches = [];
    const stack = [tree];

    while (stack.length) {
      const node = stack.pop();
      if (!node) continue;

      if (
        node.name?.toLowerCase().includes(searchTerm.toLowerCase())
      ) {
        matches.push(node.id);
      }

      if (node.spouses) {
        for (const spouse of node.spouses) {
          if (spouse.name?.toLowerCase().includes(searchTerm.toLowerCase())) {
            matches.push(spouse.id);
          }
        }
      }

      if (node.children) {
        stack.push(...node.children);
      }
    }

    if (matches.length) {
      setHighlightIds(new Set(matches));
      setBlinkId(matches[0]);
      setScrollToId(matches[0]);
      setTimeout(() => setBlinkId(null), 4000);
    } else {
      setHighlightIds(new Set());
    }
  }

  return (
    <div className="flex flex-col gap-4">
      <div className="flex items-center gap-4">
        <input
          type="text"
          placeholder="Search name..."
          value={searchTerm}
          onChange={e => setSearchTerm(e.target.value)}
          className="border border-gray-300 px-3 py-2 rounded w-60"
          onKeyDown={e => { if (e.key === "Enter") handleSearch(); }}
        />
        <button
          onClick={handleSearch}
          className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        >
          Search
        </button>
        <button
          className="toggle-expand-btn"
          onClick={() => setOpenAll(prev => !prev)}
        >
          {openAll ? "Collapse All" : "Expand All"}
        </button>
      </div>

      <div id="tree-scroll-container">
        {tree ? (
          <TreeNode
            node={tree}
            onUpdate={updateNode}
            onDelete={id => deleteNode(id)}
            highlightIds={highlightIds}
            blinkId={blinkId}
            openIds={openAll ? new Set(["all"]) : new Set()}
            scrollToId={scrollToId}
            onScrollHandled={() => setScrollToId(null)}
          />
        ) : (
          <p>No data yet...</p>
        )}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
