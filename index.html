<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
      overflow-y: scroll;
    }
    #login-container, #app-container {
      max-width: 700px;
      margin: 40px auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
      padding: 20px;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      box-sizing: border-box;
    }
    input[type="text"], input[type="date"], input[type="email"], input[type="password"] {
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      cursor: pointer;
      border-radius: 4px;
      border: none;
      background-color: #2563eb;
      color: white;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #1e40af;
    }
    #login-btn, #logout-btn {
      width: 100%;
    }
    #birthday-notifications {
      background: #d1fae5;
      color: #065f46;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 6px;
      font-weight: bold;
    }

    /* --- Horizontal Family Tree Styles --- */
    #family-trees-container {
      display: flex;
      overflow-x: auto;
      padding-bottom: 20px;
      gap: 30px;
    }
    .family-tree-root {
      border: 2px solid #2563eb;
      border-radius: 8px;
      padding: 10px 15px;
      background: #e0e7ff;
      display: flex;
      flex-direction: row;
      gap: 20px;
      align-items: flex-start;
    }
    .tree-node {
      position: relative;
      border-top: 1px dashed #ccc;
      padding-top: 12px;
      margin-right: 20px;
      min-width: 180px;
    }
    /* Remove left dashed border, replace with top dashed border for horizontal */
    .tree-node > .children-container {
      display: flex;
      gap: 20px;
      margin-top: 12px;
    }
    .node-header {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 4px;
      max-width: 180px;
    }
    .arrow {
      display: inline-block;
      width: 16px;
      user-select: none;
      cursor: pointer;
      transition: transform 0.2s ease;
      align-self: flex-start;
    }
    .arrow.collapsed {
      transform: rotate(-90deg);
    }
    input[type="text"].name-input {
      width: 100%;
    }
    input[type="date"].birthday-input {
      width: 100%;
    }
    .node-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
      margin-top: 4px;
    }
    .node-buttons button {
      font-size: 0.85rem;
      padding: 4px 10px;
      width: auto;
    }
    .node-buttons button.add-child-btn {
      background-color: #10b981;
    }
    .node-buttons button.add-spouse-btn {
      background-color: #3b82f6;
    }
    .node-buttons button.delete-btn {
      background-color: #ef4444;
    }
    .node-buttons button:hover {
      filter: brightness(85%);
    }
    .add-child-form, .add-spouse-form {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      max-width: 180px;
    }
    .add-child-form input[type="text"], .add-spouse-form input[type="text"],
    .add-child-form input[type="date"], .add-spouse-form input[type="date"] {
      font-size: 0.9rem;
      padding: 5px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
    }
    .add-child-form button, .add-spouse-form button {
      background-color: #10b981;
      padding: 6px 12px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      color: white;
      flex-shrink: 0;
    }
    .add-child-form button:hover, .add-spouse-form button:hover {
      filter: brightness(90%);
    }
    #add-root-container {
      margin-bottom: 20px;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 6px;
      background: #f3f4f6;
    }
    #add-root-container h3 {
      margin-top: 0;
    }
    #add-root-form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    #add-root-form input[type="text"], #add-root-form input[type="date"] {
      flex: 1 1 180px;
      padding: 8px;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #add-root-form button {
      flex: 0 0 auto;
      background-color: #2563eb;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      color: white;
    }

    /* --- Improved Login Page Styles --- */
    #login-container {
      max-width: 400px;
      padding: 30px 40px;
      box-shadow: 0 8px 24px rgb(0 0 0 / 0.2);
      border-radius: 12px;
      background: white;
    }
    #login-container h2 {
      text-align: center;
      margin-bottom: 25px;
      font-weight: 700;
      color: #2563eb;
    }
    #login-container input {
      width: 100%;
      margin-bottom: 15px;
      font-size: 1.1rem;
      padding: 12px;
      border: 2px solid #ccc;
      border-radius: 8px;
      transition: border-color 0.3s;
    }
    #login-container input:focus {
      border-color: #2563eb;
      outline: none;
    }
    #login-btn {
      font-size: 1.1rem;
      padding: 12px;
      border-radius: 8px;
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>

</head>
<body>

<div id="login-container">
  <h2>Login to Family Tree</h2>
  <input id="email" type="email" placeholder="Email" autocomplete="username" />
  <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
  <button id="login-btn">Login</button>
  <!-- Facebook login button removed as requested -->
</div>

<div id="app-container" style="display:none; max-height: 80vh; overflow-y: auto;">
  <div id="birthday-notifications"></div>
  
  <div id="add-root-container">
    <h3>Add New Root Family Tree</h3>
    <form id="add-root-form">
      <input type="text" id="root-name" placeholder="Root Member Name" required />
      <input type="date" id="root-birthday" />
      <button type="submit">Add Root Member</button>
    </form>
  </div>

  <div id="family-trees-container"></div>
  <button id="logout-btn">Logout</button>
</div>

<script>
  // Initialize Firebase (replace config with your own)
  const firebaseConfig = {
    apiKey: "AIzaSyCy9CKJ6CELheBhw7HUErwKWVcz5A3JzPA",
    authDomain: "family-tree-demo-c2863.firebaseapp.com",
    databaseURL: "https://family-tree-demo-c2863-default-rtdb.firebaseio.com",
    projectId: "family-tree-demo-c2863",
    storageBucket: "family-tree-demo-c2863.appspot.com",
    messagingSenderId: "345251676939",
    appId: "1:345251676939:web:fe5456c5f5e42f0e7bda36",
    measurementId: "G-9XQHVKX4HP"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();

  const loginContainer = document.getElementById("login-container");
  const appContainer = document.getElementById("app-container");
  const loginBtn = document.getElementById("login-btn");
  const logoutBtn = document.getElementById("logout-btn");

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");

  const birthdayNotificationsDiv = document.getElementById("birthday-notifications");

  const addRootForm = document.getElementById("add-root-form");
  const rootNameInput = document.getElementById("root-name");
  const rootBirthdayInput = document.getElementById("root-birthday");

  const familyTreesContainer = document.getElementById("family-trees-container");

  let userId = null;

  loginBtn.onclick = async () => {
    try {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        alert("Please enter both email and password");
        return;
      }
      await auth.signInWithEmailAndPassword(email, password);
      emailInput.value = "";
      passwordInput.value = "";
    } catch (err) {
      alert("Login failed: " + err.message);
    }
  };

  logoutBtn.onclick = () => {
    auth.signOut();
  };

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      userId = user.uid;
      loginContainer.style.display = "none";
      appContainer.style.display = "block";
      loadFamilyTrees();
      checkBirthdays();
    } else {
      userId = null;
      loginContainer.style.display = "block";
      appContainer.style.display = "none";
      familyTreesContainer.innerHTML = "";
      birthdayNotificationsDiv.innerHTML = "";
    }
  });

  // Add new root member
  addRootForm.onsubmit = async (e) => {
    e.preventDefault();
    if (!userId) return;
    const name = rootNameInput.value.trim();
    const birthday = rootBirthdayInput.value;
    if (!name) {
      alert("Please enter a name for the root member");
      return;
    }
    const newRootRef = database.ref(`familyTrees/${userId}`).push();
    await newRootRef.set({
      name,
      birthday: birthday || null,
      children: {},
      spouses: []
    });
    rootNameInput.value = "";
    rootBirthdayInput.value = "";
    loadFamilyTrees();
  };

  async function loadFamilyTrees() {
    familyTreesContainer.innerHTML = "";
    if (!userId) return;
    const snapshot = await database.ref(`familyTrees/${userId}`).once("value");
    const data = snapshot.val();
    if (!data) return;
    // For each root family tree, render horizontally
    for (const rootId in data) {
      const rootData = data[rootId];
      const rootElem = createTreeNode(rootId, rootData);
      const wrapper = document.createElement("div");
      wrapper.classList.add("family-tree-root");
      wrapper.appendChild(rootElem);
      familyTreesContainer.appendChild(wrapper);
    }
  }

  // Create a tree node element recursively for horizontal display
  function createTreeNode(id, nodeData) {
    const container = document.createElement("div");
    container.classList.add("tree-node");

    const header = document.createElement("div");
    header.classList.add("node-header");

    // Arrow for collapse/expand children
    const arrow = document.createElement("span");
    arrow.classList.add("arrow");
    arrow.textContent = "â–¶";
    arrow.title = "Toggle children";
    arrow.onclick = () => {
      arrow.classList.toggle("collapsed");
      if (childrenContainer.style.display === "none") {
        childrenContainer.style.display = "flex";
      } else {
        childrenContainer.style.display = "none";
      }
    };

    // Editable Name input
    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.classList.add("name-input");
    nameInput.value = nodeData.name || "";
    nameInput.placeholder = "Name";
    nameInput.onchange = () => {
      updateNodeField(id, "name", nameInput.value);
    };

    // Editable Birthday input
    const birthdayInput = document.createElement("input");
    birthdayInput.type = "date";
    birthdayInput.classList.add("birthday-input");
    birthdayInput.value = nodeData.birthday || "";
    birthdayInput.placeholder = "Birthday";
    birthdayInput.onchange = () => {
      updateNodeField(id, "birthday", birthdayInput.value);
    };

    header.appendChild(arrow);
    header.appendChild(nameInput);
    header.appendChild(birthdayInput);

    // Editable spouses list (each spouse name + birthday editable)
    const spousesContainer = document.createElement("div");
    spousesContainer.style.marginTop = "8px";
    spousesContainer.style.display = "flex";
    spousesContainer.style.flexDirection = "column";
    spousesContainer.style.gap = "6px";

    if (nodeData.spouses && Array.isArray(nodeData.spouses)) {
      nodeData.spouses.forEach((spouse, index) => {
        const spouseDiv = document.createElement("div");
        spouseDiv.style.display = "flex";
        spouseDiv.style.gap = "6px";
        spouseDiv.style.alignItems = "center";

        const spouseNameInput = document.createElement("input");
        spouseNameInput.type = "text";
        spouseNameInput.placeholder = "Spouse Name";
        spouseNameInput.value = spouse.name || "";
        spouseNameInput.style.flex = "1";
        spouseNameInput.onchange = () => {
          updateSpouseField(id, index, "name", spouseNameInput.value);
        };

        const spouseBirthdayInput = document.createElement("input");
        spouseBirthdayInput.type = "date";
        spouseBirthdayInput.value = spouse.birthday || "";
        spouseBirthdayInput.style.width = "140px";
        spouseBirthdayInput.onchange = () => {
          updateSpouseField(id, index, "birthday", spouseBirthdayInput.value);
        };

        const removeSpouseBtn = document.createElement("button");
        removeSpouseBtn.textContent = "Remove";
        removeSpouseBtn.style.backgroundColor = "#ef4444";
        removeSpouseBtn.style.color = "white";
        removeSpouseBtn.style.fontSize = "0.75rem";
        removeSpouseBtn.style.padding = "2px 6px";
        removeSpouseBtn.style.border = "none";
        removeSpouseBtn.style.borderRadius = "4px";
        removeSpouseBtn.style.cursor = "pointer";
        removeSpouseBtn.onclick = () => {
          removeSpouse(id, index);
        };

        spouseDiv.appendChild(spouseNameInput);
        spouseDiv.appendChild(spouseBirthdayInput);
        spouseDiv.appendChild(removeSpouseBtn);

        spousesContainer.appendChild(spouseDiv);
      });
    }

    header.appendChild(spousesContainer);

    // Buttons for add child, add spouse, delete node
    const buttonsDiv = document.createElement("div");
    buttonsDiv.classList.add("node-buttons");

    const addChildBtn = document.createElement("button");
    addChildBtn.textContent = "Add Child";
    addChildBtn.classList.add("add-child-btn");
    addChildBtn.onclick = () => {
      toggleAddChildForm(container, id);
    };

    const addSpouseBtn = document.createElement("button");
    addSpouseBtn.textContent = "Add Spouse";
    addSpouseBtn.classList.add("add-spouse-btn");
    addSpouseBtn.onclick = () => {
      toggleAddSpouseForm(container, id);
    };

    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Delete";
    deleteBtn.classList.add("delete-btn");
    deleteBtn.onclick = () => {
      if (confirm(`Delete member "${nodeData.name}" and all descendants?`)) {
        deleteNode(id);
      }
    };

    buttonsDiv.appendChild(addChildBtn);
    buttonsDiv.appendChild(addSpouseBtn);
    buttonsDiv.appendChild(deleteBtn);

    header.appendChild(buttonsDiv);

    container.appendChild(header);

    // Children container: horizontal layout
    const childrenContainer = document.createElement("div");
    childrenContainer.classList.add("children-container");

    if (nodeData.children) {
      for (const childId in nodeData.children) {
        const childNode = nodeData.children[childId];
        const childElem = createTreeNode(childId, childNode);
        childrenContainer.appendChild(childElem);
      }
    }

    container.appendChild(childrenContainer);

    return container;
  }

  // Update a node field (name or birthday)
  async function updateNodeField(nodeId, field, value) {
    if (!userId) return;
    await database.ref(`familyTrees/${userId}/${nodeId}/${field}`).set(value);
    loadFamilyTrees();
  }

  // Update spouse data
  async function updateSpouseField(nodeId, spouseIndex, field, value) {
    if (!userId) return;
    const spousePath = `familyTrees/${userId}/${nodeId}/spouses/${spouseIndex}/${field}`;
    await database.ref(spousePath).set(value);
    loadFamilyTrees();
  }

  // Remove spouse from a node
  async function removeSpouse(nodeId, spouseIndex) {
    if (!userId) return;
    const spousesRef = database.ref(`familyTrees/${userId}/${nodeId}/spouses`);
    const snapshot = await spousesRef.once("value");
    let spouses = snapshot.val() || [];
    spouses.splice(spouseIndex, 1);
    await spousesRef.set(spouses);
    loadFamilyTrees();
  }

  // Toggle add child form
  function toggleAddChildForm(container, nodeId) {
    let form = container.querySelector(".add-child-form");
    if (form) {
      form.remove();
      return;
    }
    form = document.createElement("form");
    form.classList.add("add-child-form");

    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.placeholder = "Child Name";
    nameInput.required = true;

    const birthdayInput = document.createElement("input");
    birthdayInput.type = "date";

    const submitBtn = document.createElement("button");
    submitBtn.type = "submit";
    submitBtn.textContent = "Add";

    form.appendChild(nameInput);
    form.appendChild(birthdayInput);
    form.appendChild(submitBtn);

    form.onsubmit = async (e) => {
      e.preventDefault();
      const childName = nameInput.value.trim();
      const childBirthday = birthdayInput.value;
      if (!childName) {
        alert("Please enter child name");
        return;
      }
      await addChild(nodeId, { name: childName, birthday: childBirthday || null, children: {}, spouses: [] });
      form.remove();
    };

    container.appendChild(form);
  }

  // Toggle add spouse form
  function toggleAddSpouseForm(container, nodeId) {
    let form = container.querySelector(".add-spouse-form");
    if (form) {
      form.remove();
      return;
    }
    form = document.createElement("form");
    form.classList.add("add-spouse-form");

    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.placeholder = "Spouse Name";
    nameInput.required = true;

    const birthdayInput = document.createElement("input");
    birthdayInput.type = "date";

    const submitBtn = document.createElement("button");
    submitBtn.type = "submit";
    submitBtn.textContent = "Add";

    form.appendChild(nameInput);
    form.appendChild(birthdayInput);
    form.appendChild(submitBtn);

    form.onsubmit = async (e) => {
      e.preventDefault();
      const spouseName = nameInput.value.trim();
      const spouseBirthday = birthdayInput.value;
      if (!spouseName) {
        alert("Please enter spouse name");
        return;
      }
      await addSpouse(nodeId, { name: spouseName, birthday: spouseBirthday || null });
      form.remove();
    };

    container.appendChild(form);
  }

  // Add a child node
  async function addChild(parentId, childData) {
    if (!userId) return;
    const childRef = database.ref(`familyTrees/${userId}/${parentId}/children`).push();
    await childRef.set(childData);
    loadFamilyTrees();
  }

  // Add a spouse entry
  async function addSpouse(nodeId, spouseData) {
    if (!userId) return;
    const spousesRef = database.ref(`familyTrees/${userId}/${nodeId}/spouses`);
    const snapshot = await spousesRef.once("value");
    let spouses = snapshot.val() || [];
    spouses.push(spouseData);
    await spousesRef.set(spouses);
    loadFamilyTrees();
  }

  // Delete node and all descendants
  async function deleteNode(nodeId) {
    if (!userId) return;
    // Remove from root if root member
    await database.ref(`familyTrees/${userId}/${nodeId}`).remove();
    // We rely on database structure, children are removed automatically as children are nested under this node.
    loadFamilyTrees();
  }

  // Check for birthdays today or upcoming in 7 days
  async function checkBirthdays() {
    if (!userId) return;
    birthdayNotificationsDiv.innerHTML = "";
    const snapshot = await database.ref(`familyTrees/${userId}`).once("value");
    const data = snapshot.val();
    if (!data) return;

    const today = new Date();
    const upcomingDate = new Date();
    upcomingDate.setDate(today.getDate() + 7);

    // Helper to get MM-DD from YYYY-MM-DD
    function extractMonthDay(dateStr) {
      if (!dateStr) return null;
      const d = new Date(dateStr);
      if (isNaN(d)) return null;
      return (d.getMonth() + 1).toString().padStart(2, "0") + "-" + d.getDate().toString().padStart(2, "0");
    }

    // Flatten all members including children recursively
    function flattenMembers(node) {
      let members = [];
      if (!node) return members;
      members.push({ name: node.name, birthday: node.birthday });
      if (node.spouses) {
        node.spouses.forEach(s => members.push({ name: s.name, birthday: s.birthday }));
      }
      if (node.children) {
        for (const childId in node.children) {
          members = members.concat(flattenMembers(node.children[childId]));
        }
      }
      return members;
    }

    let allMembers = [];
    for (const rootId in data) {
      allMembers = allMembers.concat(flattenMembers(data[rootId]));
    }

    let notifications = [];

    for (const member of allMembers) {
      const md = extractMonthDay(member.birthday);
      if (!md) continue;
      const [mm, dd] = md.split("-");
      const birthDateThisYear = new Date(today.getFullYear(), parseInt(mm)-1, parseInt(dd));
      if (birthDateThisYear.toDateString() === today.toDateString()) {
        notifications.push(`ðŸŽ‰ Today is ${member.name}'s birthday!`);
      } else if (birthDateThisYear > today && birthDateThisYear <= upcomingDate) {
        const diffDays = Math.ceil((birthDateThisYear - today) / (1000 * 3600 * 24));
        notifications.push(`ðŸŽ‚ ${member.name}'s birthday is in ${diffDays} day${diffDays > 1 ? "s" : ""}`);
      }
    }

    if (notifications.length > 0) {
      birthdayNotificationsDiv.innerHTML = notifications.join("<br/>");
    }
  }
</script>
</body>
</html>
