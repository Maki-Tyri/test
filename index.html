<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Family Tree App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div id="root"></div>

  <script type="text/babel">

    const { useState, useEffect } = React;

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const initialTree = {
      id: "root",
      name: "Root Person",
      spouse: "",
      children: [],
      collapsed: false
    };

    const TreeNode = ({ node, onUpdate, searchTerm, highlightIds }) => {
      const [localName, setLocalName] = useState(node.name);
      const [localSpouse, setLocalSpouse] = useState(node.spouse);

      const handleChange = () => {
        onUpdate({ ...node, name: localName, spouse: localSpouse });
      };

      const handleAddChild = () => {
        const newChild = {
          id: Date.now().toString(),
          name: "New Child",
          spouse: "",
          children: [],
          collapsed: false
        };
        const updated = {
          ...node,
          children: [...(node.children || []), newChild]
        };
        onUpdate(updated);
      };

      const handleAddSpouse = () => {
        onUpdate({ ...node, spouse: "New Spouse" });
      };

      const handleToggleCollapse = () => {
        onUpdate({ ...node, collapsed: !node.collapsed });
      };

      const isHighlighted = highlightIds.includes(node.id);

      return (
        <div className={`ml-4 mt-2 p-2 rounded border ${isHighlighted ? "border-red-500 bg-yellow-100 animate-pulse" : "border-gray-300"} transition-all`}>
          <div className="flex items-center gap-2">
            <input
              className="border p-1 rounded"
              value={localName}
              onChange={(e) => setLocalName(e.target.value)}
              onBlur={handleChange}
            />
            <span className="font-bold">❤️</span>
            <input
              className="border p-1 rounded"
              value={localSpouse}
              onChange={(e) => setLocalSpouse(e.target.value)}
              onBlur={handleChange}
            />
            <button className="bg-green-200 px-2 py-1 rounded" onClick={handleAddChild}>+Child</button>
            {!node.spouse && <button className="bg-blue-200 px-2 py-1 rounded" onClick={handleAddSpouse}>+Spouse</button>}
            {node.children?.length > 0 && (
              <button className="bg-gray-300 px-2 py-1 rounded" onClick={handleToggleCollapse}>
                {node.collapsed ? "Expand" : "Collapse"}
              </button>
            )}
          </div>
          {!node.collapsed && (
            <div className="ml-4">
              {node.children?.map(child => (
                <TreeNode
                  key={child.id}
                  node={child}
                  onUpdate={updatedChild => {
                    const updatedChildren = node.children.map(c => c.id === updatedChild.id ? updatedChild : c);
                    onUpdate({ ...node, children: updatedChildren });
                  }}
                  searchTerm={searchTerm}
                  highlightIds={highlightIds}
                />
              ))}
            </div>
          )}
        </div>
      );
    };

    const App = () => {
      const [tree, setTree] = useState(null);
      const [searchTerm, setSearchTerm] = useState("");
      const [highlightIds, setHighlightIds] = useState([]);

      useEffect(() => {
        const ref = db.ref("familyTree");
        ref.on("value", snapshot => {
          setTree(snapshot.val() || initialTree);
        });
        return () => ref.off();
      }, []);

      const saveTree = updated => {
        setTree(updated);
        db.ref("familyTree").set(updated);
      };

      const findAndHighlight = (node, term, path = []) => {
        if (!node) return [];
        const matches = node.name?.toLowerCase().includes(term.toLowerCase()) || node.spouse?.toLowerCase().includes(term.toLowerCase());
        let result = [];
        const currentPath = [...path, node.id];
        if (matches) result = currentPath;

        for (let child of node.children || []) {
          const childResult = findAndHighlight(child, term, currentPath);
          if (childResult.length) return childResult;
        }

        return result;
      };

      const handleSearch = () => {
        const ids = findAndHighlight(tree, searchTerm);
        setHighlightIds(ids);
        setTimeout(() => setHighlightIds([]), 3000);
      };

      if (!tree) return <div>Loading...</div>;

      return (
        <div>
          <div className="mb-4 flex items-center gap-2">
            <input
              className="border px-2 py-1 rounded w-64"
              placeholder="Search a name..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
            <button className="bg-yellow-400 px-3 py-1 rounded" onClick={handleSearch}>Search</button>
          </div>
          <TreeNode node={tree} onUpdate={saveTree} searchTerm={searchTerm} highlightIds={highlightIds} />
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
