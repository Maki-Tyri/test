<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree with Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
    window.firebaseImports = { initializeApp, getDatabase, ref, onValue, set, update };
  </script>
  <style>
    .highlight {
      background-color: #ffe58f;
      border-radius: 0.25rem;
      box-shadow: 0 0 8px 2px #ffd666aa;
    }
    .blink-highlight {
      animation: blink 1s infinite;
      background-color: #ffd666;
      box-shadow: 0 0 8px 2px #ffb700cc;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .node-box {
      border: 2px solid #93c5fd;
      border-radius: 0.5rem;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.5rem;
      background: white;
      box-shadow: 0 2px 6px rgb(147 197 253 / 0.5);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">
  <div id="root"></div>

  <script type="text/babel">

    const { useState, useEffect } = React;
    const {
      initializeApp,
      getDatabase,
      ref,
      onValue,
      set,
      update,
    } = window.firebaseImports;

    const firebaseConfig = {
      apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
      authDomain: "project-955237504610034331.firebaseapp.com",
      databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
      projectId: "project-955237504610034331",
      storageBucket: "project-955237504610034331.appspot.com",
      messagingSenderId: "76212939677",
      appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
      measurementId: "G-RCJ4P82PVM"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    function FamilyTreeApp() {
      const [treeData, setTreeData] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [highlightIds, setHighlightIds] = useState(new Set());
      const [blinkIds, setBlinkIds] = useState(new Set());
      const [openIds, setOpenIds] = useState(new Set());

      useEffect(() => {
        const dbRef = ref(database, "/tree");
        return onValue(dbRef, (snapshot) => {
          const val = snapshot.val();
          if (val) {
            setTreeData(val);
          } else {
            const rootNode = { id: 1, name: "Root", children: [], spouses: [] };
            setTreeData(rootNode);
            set(ref(database, "/tree"), rootNode);
          }
        });
      }, []);

      const flattenTree = (node) => {
        let arr = [node];
        (node.children || []).forEach(child => {
          arr = arr.concat(flattenTree(child));
        });
        (node.spouses || []).forEach(spouse => {
          arr.push(spouse);
        });
        return arr;
      };

      const findAncestors = (targetId, node, path = []) => {
        if (!node) return null;
        if (node.id === targetId) return path;
        for (let child of node.children || []) {
          const found = findAncestors(targetId, child, [...path, node]);
          if (found) return found;
        }
        return null;
      };

      const handleSearch = () => {
        if (!treeData) return;
        const search = searchTerm.trim().toLowerCase();
        if (!search) {
          setHighlightIds(new Set());
          setBlinkIds(new Set());
          return;
        }

        const matches = flattenTree(treeData).filter(n => n.name?.toLowerCase().includes(search));
        if (matches.length === 0) {
          setHighlightIds(new Set());
          setBlinkIds(new Set());
          return;
        }

        const blinkSet = new Set();
        const highlightSet = new Set();
        const openSet = new Set();

        matches.forEach(match => {
          highlightSet.add(match.id);
          blinkSet.add(match.id);
          const path = findAncestors(match.id, treeData);
          if (path) {
            path.forEach(p => {
              openSet.add(p.id);
              blinkSet.add(p.id);
            });
          }
        });

        setHighlightIds(highlightSet);
        setBlinkIds(blinkSet);
        setOpenIds(openSet);
      };

      const TreeNode = ({ node }) => {
        const isHighlighted = highlightIds.has(node.id);
        const isBlinking = blinkIds.has(node.id);
        const isOpen = openIds.has(node.id);

        return (
          <div className="ml-4 mt-2">
            <div className={`node-box ${isHighlighted ? 'highlight' : ''} ${isBlinking ? 'blink-highlight' : ''}`}>
              {node.name}
            </div>
            {isOpen && node.children?.map(child => (
              <TreeNode key={child.id} node={child} />
            ))}
          </div>
        );
      };

      return (
        <div>
          <div className="mb-4 flex gap-2">
            <input
              type="text"
              className="border px-3 py-2 rounded w-full max-w-md"
              placeholder="Search name..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
            />
            <button
              onClick={handleSearch}
              className="bg-blue-500 text-white font-semibold px-4 py-2 rounded"
            >
              Search
            </button>
          </div>
          {treeData ? <TreeNode node={treeData} /> : <div>Loading...</div>}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<FamilyTreeApp />);
  </script>
</body>
</html>
