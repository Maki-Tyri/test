<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree with Spouse Lines & Contextual Relation Dropdown</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <style>
    /* Spouse connection line container */
    .spouse-line-container {
      position: relative;
      display: flex;
      align-items: center;
      margin-left: 1.5rem; /* match indent */
      margin-bottom: 0.5rem;
    }
    .spouse-line {
      position: absolute;
      height: 3px;
      background: #ec4899; /* pink-500 */
      top: 50%;
      left: 0;
      right: 0;
      border-radius: 2px;
      z-index: 0;
      box-shadow: 0 0 6px #db2777aa;
    }
    .spouse-name {
      background: white;
      padding: 0 0.5rem;
      position: relative;
      z-index: 1;
      font-style: italic;
      color: #db2777; /* pink-600 */
      font-weight: 700;
      font-size: 0.95rem;
      user-select: none;
      border-radius: 2px;
      box-shadow: 0 0 8px #f472b6aa;
      cursor: default;
      white-space: nowrap;
    }

    /* Member container improvements */
    .member-container {
      margin-left: 1.5rem;
      padding-left: 1rem;
      border-left: 3px solid #a78bfa; /* indigo-400 */
      margin-bottom: 0.5rem;
      position: relative;
    }

    /* Member header flex alignment */
    .member-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* Buttons styling */
    button.small-btn {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    button.edit-btn {
      background-color: #6366f1; /* indigo-500 */
      color: white;
    }
    button.edit-btn:hover {
      background-color: #4f46e5; /* indigo-600 */
    }
    button.add-child-btn {
      background-color: #10b981; /* green-500 */
      color: white;
    }
    button.add-child-btn:hover {
      background-color: #059669; /* green-600 */
    }
    button.add-spouse-btn {
      background-color: #ec4899; /* pink-500 */
      color: white;
    }
    button.add-spouse-btn:hover {
      background-color: #db2777; /* pink-600 */
    }
    button.delete-btn {
      background-color: #ef4444; /* red-500 */
      color: white;
    }
    button.delete-btn:hover {
      background-color: #b91c1c; /* red-700 */
    }

    /* Date and deceased icon styles */
    .member-dates {
      font-size: 0.75rem;
      color: #6b7280; /* gray-500 */
    }
    .deceased-icon {
      color: #db2777;
      font-weight: 900;
      font-size: 1.1rem;
      user-select: none;
    }

    /* Form container styling */
    .member-form {
      margin-left: 1.5rem;
      margin-top: 0.5rem;
      border-left: 3px solid #a78bfa;
      padding-left: 1rem;
      background-color: #eef2ff; /* indigo-100 */
      border-radius: 6px;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 min-h-screen text-gray-900">

<div id="root" class="p-4 max-w-5xl mx-auto"></div>

<footer class="fixed bottom-0 w-full text-center py-2 bg-white bg-opacity-10 text-white backdrop-blur-md text-sm">
  &copy; 2025 Maki Web. All rights reserved
</footer>

<script type="text/javascript">
const { useState, useEffect } = React;

const firebaseConfig = {
  apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
  authDomain: "project-955237504610034331.firebaseapp.com",
  databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
  projectId: "project-955237504610034331",
  storageBucket: "project-955237504610034331.firebasestorage.app",
  messagingSenderId: "76212939677",
  appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
  measurementId: "G-RCJ4P82PVM"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

function Login({ onLogin }) {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [isRegister, setIsRegister] = useState(false);
  const [error, setError] = useState(null);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError(null);
    try {
      if (isRegister) {
        await auth.createUserWithEmailAndPassword(email, password);
      } else {
        await auth.signInWithEmailAndPassword(email, password);
      }
      onLogin();
    } catch (err) {
      setError(err.message);
    }
  };

  return React.createElement("div", { className: "max-w-md mx-auto mt-24 p-8 bg-white bg-opacity-70 rounded-lg shadow-lg backdrop-blur-md" },
    React.createElement("h2", { className: "text-3xl font-bold mb-6 text-center" }, isRegister ? "Register" : "Login"),
    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-4" },
      React.createElement("input", {
        type: "email",
        placeholder: "Email",
        required: true,
        value: email,
        onChange: e => setEmail(e.target.value),
        className: "w-full px-4 py-2 border rounded-md"
      }),
      React.createElement("input", {
        type: "password",
        placeholder: "Password",
        required: true,
        value: password,
        onChange: e => setPassword(e.target.value),
        className: "w-full px-4 py-2 border rounded-md"
      }),
      React.createElement("button", {
        type: "submit",
        className: "w-full bg-indigo-600 text-white py-2 rounded-md"
      }, isRegister ? "Register" : "Login")
    ),
    error && React.createElement("p", { className: "text-red-600 text-center mt-4" }, error),
    React.createElement("p", {
      className: "mt-6 text-center text-indigo-600 cursor-pointer hover:underline",
      onClick: () => setIsRegister(!isRegister)
    }, isRegister ? "Already have an account? Login" : "No account? Register")
  );
}

const relationOptionsByContext = {
  child: ["Son", "Daughter"],
  spouse: ["Spouse"],
  edit: ["Father", "Mother", "Son", "Daughter", "Spouse", "Brother", "Sister"]
};

function MemberForm({ initialData = {}, onCancel, onSave, members, parentId, formType }) {
  const [form, setForm] = useState({
    name: initialData.name || "",
    relation: initialData.relation || (formType === "spouse" ? "Spouse" : ""),
    birthDate: initialData.birthDate || "",
    deathDate: initialData.deathDate || "",
    deceased: initialData.deceased || false,
  });

  // Determine context for relation dropdown options
  const context = formType === "child" ? "child" : formType === "spouse" ? "spouse" : "edit";
  const options = relationOptionsByContext[context] || [];

  const handleChange = (e) => {
    const { name, value, type, checked } = e.target;
    setForm((f) => ({
      ...f,
      [name]: type === "checkbox" ? checked : value,
    }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!form.name.trim()) return alert("Name is required");
    onSave(form);
  };

  return React.createElement("form", { onSubmit: handleSubmit, className: "member-form space-y-3" },
    React.createElement("div", { className: "flex flex-col" },
      React.createElement("label", null, "Name"),
      React.createElement("input", {
        type: "text",
        name: "name",
        value: form.name,
        onChange: handleChange,
        className: "px-3 py-1 rounded border"
      })
    ),
    React.createElement("div", { className: "flex flex-col" },
      React.createElement("label", null, "Relation"),
      React.createElement("select", {
        name: "relation",
        value: form.relation,
        onChange: handleChange,
        className: "px-3 py-1 rounded border"
      },
        options.map((opt) => React.createElement("option", { key: opt, value: opt }, opt))
      )
    ),
    React.createElement("div", { className: "flex flex-col" },
      React.createElement("label", null, "Birth Date"),
      React.createElement("input", {
        type: "date",
        name: "birthDate",
        value: form.birthDate,
        onChange: handleChange,
        className: "px-3 py-1 rounded border"
      })
    ),
    React.createElement("div", { className: "flex flex-col" },
      React.createElement("label", null, "Death Date"),
      React.createElement("input", {
        type: "date",
        name: "deathDate",
        value: form.deathDate,
        onChange: handleChange,
        className: "px-3 py-1 rounded border"
      })
    ),
    React.createElement("label", { className: "flex items-center space-x-2" },
      React.createElement("input", {
        type: "checkbox",
        name: "deceased",
        checked: form.deceased,
        onChange: handleChange
      }),
      React.createElement("span", null, "Deceased")
    ),
    React.createElement("div", { className: "flex gap-4" },
      React.createElement("button", { type: "submit", className: "small-btn edit-btn" }, "Save"),
      React.createElement("button", {
        type: "button",
        onClick: onCancel,
        className: "small-btn delete-btn"
      }, "Cancel")
    )
  );
}

function Member({
  member,
  members,
  onAddChild,
  onAddSpouse,
  onEditMember,
  onDeleteMember,
  level = 0,
  parentId = null
}) {
  const [showChildren, setShowChildren] = useState(true);
  const [showAddChildForm, setShowAddChildForm] = useState(false);
  const [showAddSpouseForm, setShowAddSpouseForm] = useState(false);
  const [showEditForm, setShowEditForm] = useState(false);

  const children = members.filter((m) => m.parentId === member.id);
  const spouse = member.spouseId ? members.find((m) => m.id === member.spouseId) : null;

  // Handle add child save
  const handleAddChildSave = (data) => {
    onAddChild(member.id, data);
    setShowAddChildForm(false);
    setShowChildren(true);
  };

  // Handle add spouse save
  const handleAddSpouseSave = (data) => {
    onAddSpouse(member.id, data);
    setShowAddSpouseForm(false);
  };

  // Handle edit save
  const handleEditSave = (data) => {
    onEditMember(member.id, data);
    setShowEditForm(false);
  };

  // Toggle children visibility
  const toggleChildren = () => {
    setShowChildren(!showChildren);
  };

  return React.createElement("div", { className: "member-container" },
    React.createElement("div", { className: "member-header" },
      React.createElement("button", {
        className: "small-btn add-child-btn",
        onClick: () => setShowAddChildForm(!showAddChildForm),
        title: "Add Child"
      }, "+ Child"),
      !showChildren && children.length > 0 &&
      React.createElement("button", {
        className: "small-btn add-child-btn",
        onClick: toggleChildren,
        title: "Show Children"
      }, `Show ${children.length} child${children.length > 1 ? "ren" : ""}`),
      showChildren && children.length > 0 &&
      React.createElement("button", {
        className: "small-btn delete-btn",
        onClick: toggleChildren,
        title: "Hide Children"
      }, `Hide ${children.length} child${children.length > 1 ? "ren" : ""}`),
      React.createElement("button", {
        className: "small-btn add-spouse-btn",
        onClick: () => setShowAddSpouseForm(!showAddSpouseForm),
        disabled={!!spouse},
        title={spouse ? "Already has a spouse" : "Add Spouse"}
      }, "+ Spouse"),
      React.createElement("button", {
        className: "small-btn edit-btn",
        onClick: () => setShowEditForm(!showEditForm),
        title: "Edit Member"
      }, "Edit"),
      React.createElement("button", {
        className: "small-btn delete-btn",
        onClick={() => onDeleteMember(member.id)},
        title: "Delete Member"
      }, "Delete")
    ),
    React.createElement("div", { className: "mt-1" },
      React.createElement("strong", { className: "text-lg" }, member.name),
      React.createElement("span", { className: "member-dates ml-2" },
        member.birthDate ? `(${member.birthDate}` : "",
        member.deathDate ? ` - ${member.deathDate})` : (member.birthDate ? ")" : ""),
        member.deceased && React.createElement("span", { className: "deceased-icon", title: "Deceased" }, "†")
      )
    ),
    spouse && React.createElement("div", { className: "spouse-line-container" },
      React.createElement("div", { className: "spouse-line" }),
      React.createElement("span", { className: "spouse-name" }, spouse.name)
    ),
    showAddChildForm && React.createElement(MemberForm, {
      onCancel: () => setShowAddChildForm(false),
      onSave: handleAddChildSave,
      formType: "child"
    }),
    showAddSpouseForm && React.createElement(MemberForm, {
      onCancel: () => setShowAddSpouseForm(false),
      onSave: handleAddSpouseSave,
      formType: "spouse"
    }),
    showEditForm && React.createElement(MemberForm, {
      initialData: member,
      onCancel: () => setShowEditForm(false),
      onSave: handleEditSave,
      formType: "edit"
    }),
    showChildren && children.length > 0 && React.createElement("div", { className: "mt-2 ml-6 border-l-2 border-indigo-300" },
      children.map((child) =>
        React.createElement(Member, {
          key: child.id,
          member: child,
          members: members,
          onAddChild,
          onAddSpouse,
          onEditMember,
          onDeleteMember,
          level: level + 1,
          parentId: member.id
        })
      )
    )
  );
}

function FamilyTreeApp() {
  const [members, setMembers] = useState([]);
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged(async (u) => {
      if (u) {
        setUser(u);
        // Listen to database changes
        const membersRef = db.ref(`familyTree/${u.uid}/members`);
        membersRef.on("value", (snapshot) => {
          const data = snapshot.val();
          if (data) {
            setMembers(Object.values(data));
          } else {
            setMembers([]);
          }
          setLoading(false);
        });
      } else {
        setUser(null);
        setMembers([]);
        setLoading(false);
      }
    });
    return () => unsubscribe();
  }, []);

  const saveMembersToDB = (newMembers) => {
    if (!user) return;
    const membersRef = db.ref(`familyTree/${user.uid}/members`);
    const membersById = {};
    newMembers.forEach((m) => {
      membersById[m.id] = m;
    });
    membersRef.set(membersById);
  };

  // Utility to generate unique IDs
  const generateId = () => Math.random().toString(36).substr(2, 9);

  // Add child to a parent
  const addChild = (parentId, childData) => {
    const newChild = {
      id: generateId(),
      parentId,
      ...childData
    };
    const updated = [...members, newChild];
    setMembers(updated);
    saveMembersToDB(updated);
  };

  // Add spouse to a member
  const addSpouse = (memberId, spouseData) => {
    const newSpouse = {
      id: generateId(),
      spouseId: memberId,
      ...spouseData
    };
    // Update original member with spouseId
    const updated = members.map((m) => {
      if (m.id === memberId) return { ...m, spouseId: newSpouse.id };
      return m;
    });
    updated.push(newSpouse);
    setMembers(updated);
    saveMembersToDB(updated);
  };

  // Edit member
  const editMember = (memberId, newData) => {
    const updated = members.map((m) => (m.id === memberId ? { ...m, ...newData } : m));
    setMembers(updated);
    saveMembersToDB(updated);
  };

  // Delete member and their descendants + spouse links
  const deleteMember = (memberId) => {
    // Remove member and their descendants recursively
    const idsToRemove = new Set();
    const gatherDescendants = (id) => {
      idsToRemove.add(id);
      members.forEach((m) => {
        if (m.parentId === id) gatherDescendants(m.id);
      });
      // Also remove spouse
      const member = members.find((m) => m.id === id);
      if (member?.spouseId) idsToRemove.add(member.spouseId);
    };
    gatherDescendants(memberId);

    const updated = members.filter((m) => !idsToRemove.has(m.id));

    // Also remove spouseId reference from others
    const cleaned = updated.map((m) => {
      if (m.spouseId && idsToRemove.has(m.spouseId)) {
        return { ...m, spouseId: null };
      }
      return m;
    });

    setMembers(cleaned);
    saveMembersToDB(cleaned);
  };

  if (!user) {
    return React.createElement(Login, { onLogin: () => setLoading(true) });
  }

  if (loading) {
    return React.createElement("div", { className: "text-center mt-24 text-white font-bold text-xl" }, "Loading...");
  }

  // Find top-level members (no parent)
  const topMembers = members.filter((m) => !m.parentId);

  return React.createElement("div", { className: "text-white" },
    React.createElement("h1", { className: "text-4xl font-extrabold mb-6 text-center drop-shadow-lg" }, "Family Tree"),
    topMembers.length === 0 && React.createElement("p", { className: "text-center" }, "No members yet. Add your first member."),
    topMembers.map((m) =>
      React.createElement(Member, {
        key: m.id,
        member: m,
        members,
        onAddChild: addChild,
        onAddSpouse: addSpouse,
        onEditMember: editMember,
        onDeleteMember: deleteMember
      })
    ),
    React.createElement("button", {
      className: "mt-8 block mx-auto px-6 py-3 bg-indigo-600 rounded-md font-semibold hover:bg-indigo-700",
      onClick: () => {
        const newId = generateId();
        const newMember = {
          id: newId,
          name: `Member ${members.length + 1}`,
          birthDate: "",
          deathDate: "",
          deceased: false
        };
        const updated = [...members, newMember];
        setMembers(updated);
        saveMembersToDB(updated);
      }
    }, "+ Add Top-level Member"),
    React.createElement("button", {
      className: "mt-4 block mx-auto px-6 py-3 bg-red-600 rounded-md font-semibold hover:bg-red-700",
      onClick: async () => {
        await auth.signOut();
        setUser(null);
        setMembers([]);
      }
    }, "Logout")
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(FamilyTreeApp));
</script>

</body>
</html>
