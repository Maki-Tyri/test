<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
    }
    #login-container, #app-container {
      max-width: 700px;
      margin: 40px auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
      padding: 20px;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      box-sizing: border-box;
    }
    input[type="text"], input[type="date"], input[type="email"], input[type="password"] {
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      cursor: pointer;
      border-radius: 4px;
      border: none;
      background-color: #2563eb;
      color: white;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #1e40af;
    }
    #login-btn, #logout-btn {
      width: 100%;
    }
    #birthday-notifications {
      background: #d1fae5;
      color: #065f46;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 6px;
      font-weight: bold;
    }

    /* --- New styles for sideways family tree and scrolling --- */
    #family-trees-container {
      overflow: auto;
      white-space: nowrap;
      padding-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #e0e7ff;
      max-height: 600px; /* max height for vertical scroll */
    }
    .family-tree-root {
      display: inline-flex; /* horizontal layout */
      flex-direction: row;
      align-items: flex-start;
      white-space: normal;
      margin-right: 40px;
      vertical-align: top;
    }
    .tree-node {
      margin-left: 0;
      margin-bottom: 20px;
      position: relative;
      border-top: 1px dashed #ccc;
      padding-top: 12px;
      padding-left: 12px;
      border-left: none;
      min-width: 200px;
      /* align nodes vertically */
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .tree-node:not(:first-child) {
      margin-left: 40px; /* spacing between sibling nodes horizontally */
    }
    .node-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      flex-wrap: nowrap;
      white-space: nowrap;
    }
    .arrow {
      display: inline-block;
      width: 16px;
      user-select: none;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .arrow.collapsed {
      transform: rotate(-90deg);
    }
    input[type="text"].name-input {
      width: 140px;
    }
    input[type="date"].birthday-input {
      width: 130px;
    }
    .node-buttons {
      display: flex;
      gap: 8px;
      margin-left: auto;
      flex-wrap: nowrap;
    }
    .node-buttons button {
      font-size: 0.85rem;
      padding: 4px 10px;
      width: auto;
    }
    .node-buttons button.add-child-btn {
      background-color: #10b981;
    }
    .node-buttons button.add-spouse-btn {
      background-color: #3b82f6;
    }
    .node-buttons button.delete-btn {
      background-color: #ef4444;
    }
    .node-buttons button:hover {
      filter: brightness(85%);
    }
    .add-child-form, .add-spouse-form {
      margin-left: 0;
      margin-bottom: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .add-child-form input[type="text"], .add-spouse-form input[type="text"],
    .add-child-form input[type="date"], .add-spouse-form input[type="date"] {
      font-size: 0.9rem;
      padding: 5px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .add-child-form input[type="text"], .add-spouse-form input[type="text"] {
      width: 140px;
    }
    .add-child-form input[type="date"], .add-spouse-form input[type="date"] {
      width: 130px;
    }
    .add-child-form button, .add-spouse-form button {
      background-color: #10b981;
      padding: 6px 12px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      color: white;
    }
    .add-child-form button:hover, .add-spouse-form button:hover {
      filter: brightness(90%);
    }
    #add-root-container {
      margin-bottom: 20px;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 6px;
      background: #f3f4f6;
    }
    #add-root-container h3 {
      margin-top: 0;
    }
    #add-root-form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    #add-root-form input[type="text"], #add-root-form input[type="date"] {
      flex: 1 1 180px;
      padding: 8px;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #add-root-form button {
      flex: 0 0 auto;
      background-color: #2563eb;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      color: white;
    }

    /* --- Improved Login Page Styles --- */
    #login-container {
      max-width: 400px;
      padding: 30px 40px;
      box-shadow: 0 8px 24px rgb(0 0 0 / 0.2);
      border-radius: 12px;
      background: white;
    }
    #login-container h2 {
      text-align: center;
      margin-bottom: 25px;
      font-weight: 700;
      color: #2563eb;
    }
    #login-container input {
      width: 100%;
      margin-bottom: 15px;
      font-size: 1.1rem;
      padding: 12px;
      border: 2px solid #ccc;
      border-radius: 8px;
      transition: border-color 0.3s;
    }
    #login-container input:focus {
      border-color: #2563eb;
      outline: none;
    }
    #login-btn {
      font-size: 1.1rem;
      padding: 12px;
      border-radius: 8px;
    }
    /* Removed Facebook login button completely, so no style for it */

  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script> <!-- For OAuth -->

</head>
<body>

<div id="login-container">
  <h2>Login to Family Tree</h2>
  <input id="email" type="email" placeholder="Email" autocomplete="username" />
  <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
  <button id="login-btn">Sign In</button>
  <!-- Removed Facebook login button -->
</div>

<div id="app-container" style="display:none;">
  <div id="birthday-notifications"></div>
  
  <div id="add-root-container">
    <h3>Add New Root Family Tree</h3>
    <form id="add-root-form">
      <input type="text" id="root-name" placeholder="Root Member Name" required />
      <input type="date" id="root-birthday" placeholder="Birthday" required />
      <button type="submit">Add Root</button>
    </form>
  </div>

  <div id="family-trees-container"></div>

  <button id="logout-btn">Logout</button>
</div>

<script>
  // Firebase config (replace with your own)
  const firebaseConfig = {
  apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
  authDomain: "project-955237504610034331.firebaseapp.com",
  databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
  projectId: "project-955237504610034331",
  storageBucket: "project-955237504610034331.firebasestorage.app",
  messagingSenderId: "76212939677",
  appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
  measurementId: "G-RCJ4P82PVM"
};

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  const loginContainer = document.getElementById('login-container');
  const appContainer = document.getElementById('app-container');
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const birthdayNotifications = document.getElementById('birthday-notifications');
  const familyTreesContainer = document.getElementById('family-trees-container');

  // On auth state change
  auth.onAuthStateChanged(user => {
    if(user) {
      loginContainer.style.display = 'none';
      appContainer.style.display = 'block';
      loadFamilyTrees(user.uid);
      listenForBirthdays(user.uid);
    } else {
      loginContainer.style.display = 'block';
      appContainer.style.display = 'none';
      clearFamilyTrees();
      birthdayNotifications.innerHTML = '';
    }
  });

  loginBtn.addEventListener('click', () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if(!email || !password) {
      alert('Please enter email and password.');
      return;
    }

    auth.signInWithEmailAndPassword(email, password)
      .catch(e => alert('Login failed: ' + e.message));
  });

  logoutBtn.addEventListener('click', () => {
    auth.signOut();
  });

  // Add root family tree
  const addRootForm = document.getElementById('add-root-form');
  addRootForm.addEventListener('submit', e => {
    e.preventDefault();
    const user = auth.currentUser;
    if(!user) return;

    const name = document.getElementById('root-name').value.trim();
    const birthday = document.getElementById('root-birthday').value;

    if(!name || !birthday) {
      alert('Please fill in all fields');
      return;
    }

    const rootRef = db.ref('familyTrees/' + user.uid).push();
    const rootKey = rootRef.key;
    const rootData = {
      id: rootKey,
      name: name,
      birthday: birthday,
      spouses: [],
      children: []
    };

    rootRef.set(rootData)
      .then(() => {
        addRootForm.reset();
      })
      .catch(e => alert('Failed to add root family tree: ' + e.message));
  });

  function clearFamilyTrees() {
    familyTreesContainer.innerHTML = '';
  }

  function loadFamilyTrees(uid) {
    clearFamilyTrees();
    const treesRef = db.ref('familyTrees/' + uid);
    treesRef.on('value', snapshot => {
      const data = snapshot.val();
      familyTreesContainer.innerHTML = '';
      if(data) {
        Object.values(data).forEach(tree => {
          const treeEl = createFamilyTreeElement(tree, uid, tree.id);
          familyTreesContainer.appendChild(treeEl);
        });
      }
    });
  }

  // Listen birthdays for notifications
  function listenForBirthdays(uid) {
    birthdayNotifications.innerHTML = '';
    const today = new Date();
    const todayMonthDay = (today.getMonth() + 1) + '-' + today.getDate();

    const treesRef = db.ref('familyTrees/' + uid);
    treesRef.on('value', snapshot => {
      birthdayNotifications.innerHTML = '';
      const data = snapshot.val();
      if(!data) return;

      let messages = [];
      Object.values(data).forEach(tree => {
        // Check root
        if (checkBirthday(tree, todayMonthDay)) {
          messages.push(`Today is ${tree.name}'s birthday! 🎉`);
        }
        // Check spouses
        if(tree.spouses) {
          tree.spouses.forEach(sp => {
            if (checkBirthday(sp, todayMonthDay)) {
              messages.push(`Today is ${sp.name}'s birthday! 🎉`);
            }
          });
        }
        // Check children recursively
        if(tree.children) {
          collectBirthdays(tree.children, todayMonthDay, messages);
        }
      });
      if(messages.length) {
        birthdayNotifications.innerHTML = messages.join('<br>');
      }
    });
  }
  function collectBirthdays(children, todayMonthDay, messages) {
    children.forEach(child => {
      if (checkBirthday(child, todayMonthDay)) {
        messages.push(`Today is ${child.name}'s birthday! 🎉`);
      }
      if(child.spouses) {
        child.spouses.forEach(sp => {
          if (checkBirthday(sp, todayMonthDay)) {
            messages.push(`Today is ${sp.name}'s birthday! 🎉`);
          }
        });
      }
      if(child.children) {
        collectBirthdays(child.children, todayMonthDay, messages);
      }
    });
  }
  function checkBirthday(person, todayMonthDay) {
    if(!person.birthday) return false;
    const bd = new Date(person.birthday);
    if (isNaN(bd)) return false;
    const bdMonthDay = (bd.getMonth() + 1) + '-' + bd.getDate();
    return bdMonthDay === todayMonthDay;
  }

  // Create family tree element (recursive)
  function createFamilyTreeElement(node, uid, rootId, isChild=false) {
    const nodeEl = document.createElement('div');
    nodeEl.classList.add('family-tree-root');
    if(isChild) nodeEl.classList.add('tree-node');

    // Structure: root has children nodes, each child is recursive

    // The main node container
    const container = document.createElement('div');
    container.classList.add('tree-node');

    // Header with arrow toggle for children and editable name and birthday
    const header = document.createElement('div');
    header.classList.add('node-header');

    // Arrow for collapse/expand children
    const arrow = document.createElement('span');
    arrow.classList.add('arrow');
    arrow.innerHTML = node.children && node.children.length > 0 ? '▶' : '';
    arrow.style.visibility = arrow.innerHTML ? 'visible' : 'hidden';

    header.appendChild(arrow);

    // Editable name input
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = node.name;
    nameInput.classList.add('name-input');
    nameInput.title = 'Click to edit name';

    // Save on blur
    nameInput.addEventListener('blur', () => {
      const newName = nameInput.value.trim();
      if(newName && newName !== node.name) {
        updateNodeField(uid, rootId, node.id, 'name', newName);
        node.name = newName;
      } else {
        nameInput.value = node.name; // revert
      }
    });

    header.appendChild(nameInput);

    // Editable birthday input
    const birthdayInput = document.createElement('input');
    birthdayInput.type = 'date';
    birthdayInput.value = node.birthday || '';
    birthdayInput.classList.add('birthday-input');
    birthdayInput.title = 'Click to edit birthday';

    birthdayInput.addEventListener('blur', () => {
      const newBday = birthdayInput.value;
      if(newBday !== node.birthday) {
        updateNodeField(uid, rootId, node.id, 'birthday', newBday);
        node.birthday = newBday;
      }
    });

    header.appendChild(birthdayInput);

    // Buttons container
    const buttonsDiv = document.createElement('div');
    buttonsDiv.classList.add('node-buttons');

    // Add child button
    const addChildBtn = document.createElement('button');
    addChildBtn.textContent = '+ Child';
    addChildBtn.classList.add('add-child-btn');
    addChildBtn.title = 'Add child';
    buttonsDiv.appendChild(addChildBtn);

    // Add spouse button
    const addSpouseBtn = document.createElement('button');
    addSpouseBtn.textContent = '+ Spouse';
    addSpouseBtn.classList.add('add-spouse-btn');
    addSpouseBtn.title = 'Add spouse';
    buttonsDiv.appendChild(addSpouseBtn);

    // Delete node button (only show for non-root nodes)
    if (isChild || (rootId !== node.id)) {
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete';
      deleteBtn.classList.add('delete-btn');
      deleteBtn.title = 'Delete this node and its descendants';
      buttonsDiv.appendChild(deleteBtn);

      deleteBtn.addEventListener('click', () => {
        if(confirm('Delete this member and all their descendants?')) {
          deleteNode(uid, rootId, node.id);
        }
      });
    }

    header.appendChild(buttonsDiv);

    container.appendChild(header);

    // Spouses container (editable)
    if(node.spouses && node.spouses.length > 0) {
      const spousesContainer = document.createElement('div');
      spousesContainer.style.marginLeft = '32px';
      spousesContainer.style.marginBottom = '10px';
      spousesContainer.style.borderLeft = '2px solid #94a3b8';
      spousesContainer.style.paddingLeft = '8px';

      node.spouses.forEach((spouse, idx) => {
        const spouseDiv = document.createElement('div');
        spouseDiv.style.display = 'flex';
        spouseDiv.style.alignItems = 'center';
        spouseDiv.style.gap = '10px';
        spouseDiv.style.marginBottom = '6px';

        // Editable spouse name
        const spouseNameInput = document.createElement('input');
        spouseNameInput.type = 'text';
        spouseNameInput.value = spouse.name;
        spouseNameInput.classList.add('name-input');
        spouseNameInput.style.width = '140px';

        spouseNameInput.addEventListener('blur', () => {
          const newSpName = spouseNameInput.value.trim();
          if(newSpName && newSpName !== spouse.name) {
            updateSpouseField(uid, rootId, node.id, idx, 'name', newSpName);
            spouse.name = newSpName;
          } else {
            spouseNameInput.value = spouse.name; // revert
          }
        });

        // Editable spouse birthday
        const spouseBdayInput = document.createElement('input');
        spouseBdayInput.type = 'date';
        spouseBdayInput.value = spouse.birthday || '';
        spouseBdayInput.classList.add('birthday-input');
        spouseBdayInput.style.width = '130px';

        spouseBdayInput.addEventListener('blur', () => {
          const newBday = spouseBdayInput.value;
          if(newBday !== spouse.birthday) {
            updateSpouseField(uid, rootId, node.id, idx, 'birthday', newBday);
            spouse.birthday = newBday;
          }
        });

        // Remove spouse button
        const removeSpouseBtn = document.createElement('button');
        removeSpouseBtn.textContent = 'Remove';
        removeSpouseBtn.classList.add('delete-btn');
        removeSpouseBtn.style.width = 'auto';
        removeSpouseBtn.style.fontSize = '0.75rem';
        removeSpouseBtn.addEventListener('click', () => {
          if(confirm('Remove this spouse?')) {
            removeSpouse(uid, rootId, node.id, idx);
          }
        });

        spouseDiv.appendChild(spouseNameInput);
        spouseDiv.appendChild(spouseBdayInput);
        spouseDiv.appendChild(removeSpouseBtn);
        spousesContainer.appendChild(spouseDiv);
      });
      container.appendChild(spousesContainer);
    }

    // Children container
    const childrenContainer = document.createElement('div');
    childrenContainer.style.display = 'flex';
    childrenContainer.style.flexDirection = 'row';
    childrenContainer.style.marginLeft = '24px';

    if(node.children && node.children.length > 0) {
      node.children.forEach(child => {
        const childEl = createFamilyTreeElement(child, uid, rootId, true);
        childrenContainer.appendChild(childEl);
      });
    }

    container.appendChild(childrenContainer);

    // Toggle children visibility on arrow click
    arrow.addEventListener('click', () => {
      const isCollapsed = arrow.classList.toggle('collapsed');
      childrenContainer.style.display = isCollapsed ? 'none' : 'flex';
    });

    // Add child form
    let addChildForm = null;
    addChildBtn.addEventListener('click', () => {
      if(addChildForm) return; // only one at a time
      addChildForm = document.createElement('form');
      addChildForm.classList.add('add-child-form');

      const childNameInput = document.createElement('input');
      childNameInput.type = 'text';
      childNameInput.placeholder = 'Child Name';
      childNameInput.required = true;

      const childBdayInput = document.createElement('input');
      childBdayInput.type = 'date';
      childBdayInput.required = true;

      const submitBtn = document.createElement('button');
      submitBtn.type = 'submit';
      submitBtn.textContent = 'Add';

      addChildForm.appendChild(childNameInput);
      addChildForm.appendChild(childBdayInput);
      addChildForm.appendChild(submitBtn);

      container.insertBefore(addChildForm, childrenContainer);

      addChildForm.addEventListener('submit', e => {
        e.preventDefault();
        const childName = childNameInput.value.trim();
        const childBday = childBdayInput.value;
        if(childName && childBday) {
          addChild(uid, rootId, node.id, { name: childName, birthday: childBday });
          addChildForm.remove();
          addChildForm = null;
        } else {
          alert('Please fill all fields');
        }
      });
    });

    // Add spouse form
    let addSpouseForm = null;
    addSpouseBtn.addEventListener('click', () => {
      if(addSpouseForm) return; // only one at a time
      addSpouseForm = document.createElement('form');
      addSpouseForm.classList.add('add-spouse-form');

      const spouseNameInput = document.createElement('input');
      spouseNameInput.type = 'text';
      spouseNameInput.placeholder = 'Spouse Name';
      spouseNameInput.required = true;

      const spouseBdayInput = document.createElement('input');
      spouseBdayInput.type = 'date';
      spouseBdayInput.required = true;

      const submitBtn = document.createElement('button');
      submitBtn.type = 'submit';
      submitBtn.textContent = 'Add';

      addSpouseForm.appendChild(spouseNameInput);
      addSpouseForm.appendChild(spouseBdayInput);
      addSpouseForm.appendChild(submitBtn);

      container.insertBefore(addSpouseForm, childrenContainer);

      addSpouseForm.addEventListener('submit', e => {
        e.preventDefault();
        const spouseName = spouseNameInput.value.trim();
        const spouseBday = spouseBdayInput.value;
        if(spouseName && spouseBday) {
          addSpouse(uid, rootId, node.id, { name: spouseName, birthday: spouseBday });
          addSpouseForm.remove();
          addSpouseForm = null;
        } else {
          alert('Please fill all fields');
        }
      });
    });

    return container;
  }

  // Helpers to update Firebase nodes

  // Update node field (name or birthday)
  function updateNodeField(uid, rootId, nodeId, field, value) {
    const path = `familyTrees/${uid}/${rootId}`;
    db.ref(path).once('value').then(snapshot => {
      const tree = snapshot.val();
      if(!tree) return;

      // Find node by id in tree (recursive)
      function findAndUpdate(node) {
        if(node.id === nodeId) {
          node[field] = value;
          return true;
        }
        if(node.children) {
          for(let c of node.children) {
            if(findAndUpdate(c)) return true;
          }
        }
        return false;
      }
      if(findAndUpdate(tree)) {
        db.ref(path).set(tree);
      }
    });
  }

  // Update spouse field
  function updateSpouseField(uid, rootId, nodeId, spouseIdx, field, value) {
    const path = `familyTrees/${uid}/${rootId}`;
    db.ref(path).once('value').then(snapshot => {
      const tree = snapshot.val();
      if(!tree) return;

      // Find node by id and update spouse field
      function findAndUpdate(node) {
        if(node.id === nodeId) {
          if(node.spouses && node.spouses[spouseIdx]) {
            node.spouses[spouseIdx][field] = value;
            return true;
          }
          return false;
        }
        if(node.children) {
          for(let c of node.children) {
            if(findAndUpdate(c)) return true;
          }
        }
        return false;
      }
      if(findAndUpdate(tree)) {
        db.ref(path).set(tree);
      }
    });
  }

  // Add child to node
  function addChild(uid, rootId, nodeId, childData) {
    const path = `familyTrees/${uid}/${rootId}`;
    db.ref(path).once('value').then(snapshot => {
      const tree = snapshot.val();
      if(!tree) return;

      function findAndAddChild(node) {
        if(node.id === nodeId) {
          if(!node.children) node.children = [];
          const newChild = {
            id: generateId(),
            name: childData.name,
            birthday: childData.birthday,
            spouses: [],
            children: []
          };
          node.children.push(newChild);
          return true;
        }
        if(node.children) {
          for(let c of node.children) {
            if(findAndAddChild(c)) return true;
          }
        }
        return false;
      }
      if(findAndAddChild(tree)) {
        db.ref(path).set(tree);
      }
    });
  }

  // Add spouse to node
  function addSpouse(uid, rootId, nodeId, spouseData) {
    const path = `familyTrees/${uid}/${rootId}`;
    db.ref(path).once('value').then(snapshot => {
      const tree = snapshot.val();
      if(!tree) return;

      function findAndAddSpouse(node) {
        if(node.id === nodeId) {
          if(!node.spouses) node.spouses = [];
          const newSpouse = {
            name: spouseData.name,
            birthday: spouseData.birthday
          };
          node.spouses.push(newSpouse);
          return true;
        }
        if(node.children) {
          for(let c of node.children) {
            if(findAndAddSpouse(c)) return true;
          }
        }
        return false;
      }
      if(findAndAddSpouse(tree)) {
        db.ref(path).set(tree);
      }
    });
  }

  // Remove spouse at index
  function removeSpouse(uid, rootId, nodeId, spouseIdx) {
    const path = `familyTrees/${uid}/${rootId}`;
    db.ref(path).once('value').then(snapshot => {
      const tree = snapshot.val();
      if(!tree) return;

      function findAndRemoveSpouse(node) {
        if(node.id === nodeId) {
          if(node.spouses && node.spouses.length > spouseIdx) {
            node.spouses.splice(spouseIdx, 1);
            return true;
          }
          return false;
        }
        if(node.children) {
          for(let c of node.children) {
            if(findAndRemoveSpouse(c)) return true;
          }
        }
        return false;
      }
      if(findAndRemoveSpouse(tree)) {
        db.ref(path).set(tree);
      }
    });
  }

  // Delete node and descendants
  function deleteNode(uid, rootId, nodeId) {
    const path = `familyTrees/${uid}/${rootId}`;
    db.ref(path).once('value').then(snapshot => {
      const tree = snapshot.val();
      if(!tree) return;

      // Special case: deleting root (not allowed)
      if(tree.id === nodeId) {
        alert('Cannot delete root node.');
        return;
      }

      // Recursive remove function
      function removeNode(node, idToRemove) {
        if(!node.children) return false;
        const idx = node.children.findIndex(c => c.id === idToRemove);
        if(idx >= 0) {
          node.children.splice(idx, 1);
          return true;
        }
        for(let c of node.children) {
          if(removeNode(c, idToRemove)) return true;
        }
        return false;
      }
      if(removeNode(tree, nodeId)) {
        db.ref(path).set(tree);
      }
    });
  }

  // Simple ID generator for new nodes
  function generateId() {
    return 'id-' + Math.random().toString(36).substr(2, 9);
  }

</script>

</body>
</html>
