<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree with Debounced Edit</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <style>
    .spouse-line-container {
      position: relative;
      display: flex;
      align-items: center;
      margin-left: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .spouse-line {
      position: absolute;
      height: 2px;
      background: #ec4899;
      top: 50%;
      left: 0;
      right: 0;
      z-index: 0;
    }
    .spouse-name {
      background: white;
      padding: 0 0.25rem;
      position: relative;
      z-index: 1;
      font-style: italic;
      color: #db2777;
      font-weight: 600;
    }
    /* Gender colors */
    .male {
      color: #2563eb; /* blue */
    }
    .female {
      color: #db2777; /* pink */
    }
    /* Collapsible toggle */
    .toggle-btn {
      cursor: pointer;
      font-weight: bold;
      user-select: none;
      color: #4f46e5;
      margin-right: 0.5rem;
    }
    /* Tree line styling */
    .tree-node {
      border-left: 2px solid #a5b4fc;
      padding-left: 1rem;
      margin-left: 1rem;
      position: relative;
    }
    .tree-node::before {
      content: "";
      position: absolute;
      left: -2px;
      top: 1.2rem;
      width: 10px;
      height: 2px;
      background: #a5b4fc;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 min-h-screen text-gray-900">

<div id="root" class="p-4 max-w-5xl mx-auto"></div>

<footer class="fixed bottom-0 w-full text-center py-2 bg-white bg-opacity-10 text-white backdrop-blur-md text-sm">
  &copy; 2025 Maki Web. All rights reserved
</footer>

<script type="text/javascript">
const { useState, useEffect, useRef } = React;

const firebaseConfig = {
  apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
  authDomain: "project-955237504610034331.firebaseapp.com",
  databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
  projectId: "project-955237504610034331",
  storageBucket: "project-955237504610034331.firebasestorage.app",
  messagingSenderId: "76212939677",
  appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
  measurementId: "G-RCJ4P82PVM"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

function Login({ onLogin }) {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [isRegister, setIsRegister] = useState(false);
  const [error, setError] = useState(null);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError(null);
    try {
      if (isRegister) {
        await auth.createUserWithEmailAndPassword(email, password);
      } else {
        await auth.signInWithEmailAndPassword(email, password);
      }
      onLogin();
    } catch (err) {
      setError(err.message);
    }
  };

  return React.createElement("div", { className: "max-w-md mx-auto mt-24 p-8 bg-white bg-opacity-70 rounded-lg shadow-lg backdrop-blur-md" },
    React.createElement("h2", { className: "text-3xl font-bold mb-6 text-center" }, isRegister ? "Register" : "Login"),
    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-4" },
      React.createElement("input", {
        type: "email",
        placeholder: "Email",
        required: true,
        value: email,
        onChange: e => setEmail(e.target.value),
        className: "w-full px-4 py-2 border rounded-md"
      }),
      React.createElement("input", {
        type: "password",
        placeholder: "Password",
        required: true,
        value: password,
        onChange: e => setPassword(e.target.value),
        className: "w-full px-4 py-2 border rounded-md"
      }),
      React.createElement("button", {
        type: "submit",
        className: "w-full bg-indigo-600 text-white py-2 rounded-md"
      }, isRegister ? "Register" : "Login")
    ),
    error && React.createElement("p", { className: "text-red-600 text-center mt-4" }, error),
    React.createElement("p", {
      className: "mt-6 text-center text-indigo-600 cursor-pointer hover:underline",
      onClick: () => setIsRegister(!isRegister)
    }, isRegister ? "Already have an account? Login" : "No account? Register")
  );
}

// Debounced input component for editing with auto-save after 500ms or onBlur
function DebouncedInput({ value: initialValue, onSave, className, type = "text", placeholder }) {
  const [value, setValue] = useState(initialValue);
  const timeoutRef = useRef(null);

  useEffect(() => {
    setValue(initialValue);
  }, [initialValue]);

  useEffect(() => {
    if (timeoutRef.current) clearTimeout(timeoutRef.current);
    timeoutRef.current = setTimeout(() => {
      if (value !== initialValue) {
        onSave(value);
      }
    }, 500);

    return () => clearTimeout(timeoutRef.current);
  }, [value]);

  return React.createElement("input", {
    type,
    value,
    placeholder,
    className,
    onChange: e => setValue(e.target.value),
    onBlur: () => {
      if (value !== initialValue) onSave(value);
    }
  });
}

const relationOptionsByContext = {
  child: ["Son", "Daughter"],
  spouse: ["Spouse"],
  edit: ["Father", "Mother", "Son", "Daughter", "Spouse", "Brother", "Sister"]
};

function MemberForm({ initialData = {}, onCancel, onSave, members, parentId, formType }) {
  const [form, setForm] = useState({
    name: initialData.name || "",
    relation: initialData.relation || (formType === "spouse" ? "Spouse" : ""),
    birthDate: initialData.birthDate || "",
    deathDate: initialData.deathDate || "",
    deceased: initialData.deceased || false,
    spouseId: initialData.spouseId || "",
  });

  const spouseOptions = members.filter(m => m.id !== initialData.id);

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!form.name.trim()) {
      alert("Name is required");
      return;
    }
    onSave({ ...initialData, ...form, parentId, id: initialData.id || Date.now().toString() });
  };

  const options = relationOptionsByContext[formType] || relationOptionsByContext.edit;

  return React.createElement("form", { onSubmit: handleSubmit, className: "ml-6 p-3 border-l-2 border-indigo-400 bg-indigo-50 rounded space-y-2" },
    React.createElement("input", {
      type: "text",
      placeholder: "Name",
      value: form.name,
      onChange: e => setForm({ ...form, name: e.target.value }),
      className: "w-full px-3 py-1 border rounded"
    }),
    formType === "spouse"
      ? React.createElement("input", {
          type: "text",
          value: "Spouse",
          disabled: true,
          className: "w-full px-3 py-1 border rounded bg-gray-100 cursor-not-allowed"
        })
      : React.createElement("select", {
          value: form.relation,
          onChange: e => setForm({ ...form, relation: e.target.value }),
          className: "w-full px-3 py-1 border rounded"
        },
        React.createElement("option", { value: "" }, "-- Relation --"),
        options.map(opt =>
          React.createElement("option", { key: opt, value: opt }, opt)
        )
      ),
    React.createElement("input", {
      type: "date",
      value: form.birthDate,
      onChange: e => setForm({ ...form, birthDate: e.target.value }),
      className: "w-full px-3 py-1 border rounded",
      placeholder: "Birth Date"
    }),
    React.createElement("input", {
      type: "date",
      value: form.deathDate,
      onChange: e => setForm({ ...form, deathDate: e.target.value }),
      className: "w-full px-3 py-1 border rounded",
      placeholder: "Death Date"
    }),
    React.createElement("label", { className: "inline-flex items-center space-x-2" },
      React.createElement("input", {
        type: "checkbox",
        checked: form.deceased,
        onChange: e => setForm({ ...form, deceased: e.target.checked })
      }),
      React.createElement("span", null, "Deceased")
    ),
    React.createElement("select", {
      value: form.spouseId,
      onChange: e => setForm({ ...form, spouseId: e.target.value }),
      className: "w-full px-3 py-1 border rounded"
    },
      React.createElement("option", { value: "" }, "-- Select Spouse --"),
      spouseOptions.map(m => React.createElement("option", { key: m.id, value: m.id }, m.name))
    ),
    React.createElement("div", { className: "space-x-2 mt-2" },
      React.createElement("button", { type: "submit", className: "bg-indigo-600 text-white px-3 py-1 rounded" }, "Save"),
      React.createElement("button", { type: "button", className: "bg-gray-400 text-white px-3 py-1 rounded", onClick: onCancel }, "Cancel")
    )
  );
}

function MemberNode({ member, members, updateMember, addMember, removeMember }) {
  const [collapsed, setCollapsed] = useState(false);
  const [editing, setEditing] = useState(false);

  const children = members.filter(m => m.parentId === member.id);
  const spouse = members.find(m => m.id === member.spouseId);

  const genderClass = member.relation.toLowerCase().includes("son") || member.relation.toLowerCase() === "father" || member.relation.toLowerCase() === "brother" ? "male" : 
                      member.relation.toLowerCase().includes("daughter") || member.relation.toLowerCase() === "mother" || member.relation.toLowerCase() === "sister" ? "female" : "";

  const saveName = (newName) => {
    updateMember(member.id, { name: newName });
  };
  const saveBirthDate = (newBD) => {
    updateMember(member.id, { birthDate: newBD });
  };
  const saveDeathDate = (newDD) => {
    updateMember(member.id, { deathDate: newDD });
  };

  return React.createElement("div", { className: "tree-node mb-3" },
    React.createElement("div", { className: "flex items-center space-x-2" },
      React.createElement("span", {
        className: "toggle-btn select-none",
        onClick: () => setCollapsed(!collapsed)
      }, collapsed ? "▶" : "▼"),
      editing
        ? React.createElement(DebouncedInput, {
            value: member.name,
            onSave: saveName,
            className: `font-semibold ${genderClass} border-b border-indigo-400 outline-none w-48`
          })
        : React.createElement("span", { className: `font-semibold cursor-pointer ${genderClass}`, onDoubleClick: () => setEditing(true) }, member.name),
      editing
        ? React.createElement("button", {
            onClick: () => setEditing(false),
            className: "ml-2 text-sm text-gray-600 hover:text-indigo-700"
          }, "Done")
        : React.createElement("button", {
            onClick: () => setEditing(true),
            className: "ml-2 text-sm text-indigo-700 hover:text-indigo-900"
          }, "Edit"),
      React.createElement("button", {
        onClick: () => addMember(member.id),
        className: "ml-4 text-sm bg-green-400 hover:bg-green-500 text-white px-2 rounded"
      }, "+Child"),
      React.createElement("button", {
        onClick: () => removeMember(member.id),
        className: "ml-2 text-sm bg-red-500 hover:bg-red-600 text-white px-2 rounded"
      }, "Delete")
    ),
    React.createElement("div", { className: "flex items-center space-x-4 mt-1" },
      React.createElement("div", null,
        React.createElement("span", { className: "text-xs font-semibold text-gray-700" }, "Relation: "),
        React.createElement("span", null, member.relation)
      ),
      React.createElement("div", null,
        React.createElement("span", { className: "text-xs font-semibold text-gray-700" }, "Birth: "),
        editing
          ? React.createElement(DebouncedInput, {
              value: member.birthDate,
              onSave: saveBirthDate,
              className: "border-b border-indigo-400 outline-none w-28 text-xs",
              type: "date"
            })
          : React.createElement("span", null, member.birthDate || "-")
      ),
      React.createElement("div", null,
        React.createElement("span", { className: "text-xs font-semibold text-gray-700" }, "Death: "),
        editing
          ? React.createElement(DebouncedInput, {
              value: member.deathDate,
              onSave: saveDeathDate,
              className: "border-b border-indigo-400 outline-none w-28 text-xs",
              type: "date"
            })
          : React.createElement("span", null, member.deathDate || "-")
      )
    ),
    spouse && React.createElement("div", { className: "spouse-line-container mt-2" },
      React.createElement("div", { className: "spouse-line" }),
      React.createElement("div", { className: "spouse-name" }, `Spouse: ${spouse.name}`)
    ),
    !collapsed && children.length > 0 && React.createElement("div", { className: "ml-6 mt-3 border-l-2 border-indigo-300 pl-4" },
      children.map(child => React.createElement(MemberNode, {
        key: child.id,
        member: child,
        members,
        updateMember,
        addMember,
        removeMember
      }))
    )
  );
}

function FamilyTree() {
  const [members, setMembers] = useState([]);
  const [addingChildFor, setAddingChildFor] = useState(null);
  const [user, setUser] = useState(null);

  useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged(u => {
      setUser(u);
      if (u) {
        const membersRef = db.ref(`members/${u.uid}`);
        membersRef.on("value", (snapshot) => {
          const val = snapshot.val() || {};
          const list = Object.entries(val).map(([id, data]) => ({ id, ...data }));
          setMembers(list);
        });
        return () => membersRef.off();
      } else {
        setMembers([]);
      }
    });
    return () => unsubscribe();
  }, []);

  const saveMembersToDB = (newMembers) => {
    if (!user) return;
    const membersRef = db.ref(`members/${user.uid}`);
    const dataObj = {};
    newMembers.forEach(m => { dataObj[m.id] = m; });
    membersRef.set(dataObj);
  };

  const updateMember = (id, changes) => {
    const updated = members.map(m => m.id === id ? { ...m, ...changes } : m);
    setMembers(updated);
    saveMembersToDB(updated);
  };

  const addMember = (parentId) => {
    setAddingChildFor(parentId);
  };

  const removeMember = (id) => {
    if (!confirm("Delete this member and all descendants?")) return;
    // Remove member and descendants recursively
    const idsToRemove = new Set();
    function gatherDescendants(mid) {
      idsToRemove.add(mid);
      members.filter(m => m.parentId === mid).forEach(m => gatherDescendants(m.id));
    }
    gatherDescendants(id);
    const updated = members.filter(m => !idsToRemove.has(m.id));
    setMembers(updated);
    saveMembersToDB(updated);
  };

  const saveNewMember = (data) => {
    setMembers(prev => {
      const updated = [...prev, data];
      saveMembersToDB(updated);
      return updated;
    });
    setAddingChildFor(null);
  };

  if (!user) {
    return React.createElement(Login, { onLogin: () => {} });
  }

  const roots = members.filter(m => !m.parentId);

  return React.createElement("div", { className: "bg-white bg-opacity-90 p-6 rounded-lg shadow-lg max-w-4xl mx-auto my-6" },
    React.createElement("h1", { className: "text-4xl font-bold mb-6 text-indigo-700" }, "Family Tree"),
    React.createElement("button", {
      className: "mb-4 px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700",
      onClick: () => addMember(null)
    }, "+ Add Root Member"),
    addingChildFor !== null && React.createElement(MemberForm, {
      onCancel: () => setAddingChildFor(null),
      onSave: saveNewMember,
      parentId: addingChildFor,
      members,
      formType: "child"
    }),
    roots.length === 0 && React.createElement("p", { className: "text-center text-gray-600 mt-6" }, "No members yet. Add one!"),
    roots.map(root => React.createElement(MemberNode, {
      key: root.id,
      member: root,
      members,
      updateMember,
      addMember,
      removeMember
    })),
    React.createElement("button", {
      className: "mt-8 px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600",
      onClick: () => auth.signOut()
    }, "Logout")
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(FamilyTree));
</script>

</body>
</html>
