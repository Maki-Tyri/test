<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Family Tree</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
      .blink {
        animation: blink-animation 1s steps(2, start) 4;
      }
      @keyframes blink-animation {
        to {
          visibility: hidden;
        }
      }
    </style>
  </head>
  <body class="p-4 bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        databaseURL: "YOUR_DATABASE_URL",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      function TreeNode({ person, people, onEdit, onAddChild, onAddSpouse, collapsed, toggleCollapse, highlightedIds, blinkingId }) {
        if (!person) return null;

        const children = Object.values(people).filter(p => p.parentId === person.id);
        const spouse = Object.values(people).find(p => p.spouseId === person.id);

        const isHighlighted = highlightedIds.has(person.id);
        const isBlinking = blinkingId === person.id;

        return (
          <div className="ml-4 border-l pl-4">
            <div
              className={`p-2 rounded cursor-pointer mb-2 ${isHighlighted ? "bg-yellow-200" : "bg-white"} ${isBlinking ? "blink" : ""}`}
              onClick={() => toggleCollapse(person.id)}
            >
              <input
                className="font-bold text-lg bg-transparent border-b border-gray-300 focus:outline-none"
                value={person.name}
                onChange={e => onEdit(person.id, { name: e.target.value })}
              />
              <button onClick={() => onAddChild(person.id)} className="ml-2 text-blue-500 text-sm">Add Child</button>
              <button onClick={() => onAddSpouse(person.id)} className="ml-2 text-green-500 text-sm">Add Spouse</button>
            </div>
            {!collapsed[person.id] && (
              <div>
                {spouse && (
                  <TreeNode
                    person={spouse}
                    people={people}
                    onEdit={onEdit}
                    onAddChild={onAddChild}
                    onAddSpouse={onAddSpouse}
                    collapsed={collapsed}
                    toggleCollapse={toggleCollapse}
                    highlightedIds={highlightedIds}
                    blinkingId={blinkingId}
                  />
                )}
                {children.map(child => (
                  <TreeNode
                    key={child.id}
                    person={child}
                    people={people}
                    onEdit={onEdit}
                    onAddChild={onAddChild}
                    onAddSpouse={onAddSpouse}
                    collapsed={collapsed}
                    toggleCollapse={toggleCollapse}
                    highlightedIds={highlightedIds}
                    blinkingId={blinkingId}
                  />
                ))}
              </div>
            )}
          </div>
        );
      }

      function FamilyTree() {
        const [people, setPeople] = useState({});
        const [collapsed, setCollapsed] = useState({});
        const [searchTerm, setSearchTerm] = useState('');
        const [highlightedIds, setHighlightedIds] = useState(new Set());
        const [blinkingId, setBlinkingId] = useState(null);

        useEffect(() => {
          const peopleRef = db.ref('people');
          peopleRef.on('value', snapshot => {
            setPeople(snapshot.val() || {});
          });
          return () => peopleRef.off();
        }, []);

        const addPerson = (data) => {
          const id = Date.now().toString();
          db.ref(`people/${id}`).set({ id, name: "New Person", ...data });
        };

        const handleEdit = (id, updates) => {
          db.ref(`people/${id}`).update(updates);
        };

        const handleAddChild = (parentId) => {
          addPerson({ parentId });
        };

        const handleAddSpouse = (personId) => {
          const spouseId = Date.now().toString();
          db.ref(`people/${spouseId}`).set({
            id: spouseId,
            name: "New Spouse",
            spouseId: personId,
          });
          db.ref(`people/${personId}`).update({ spouseId });
        };

        const toggleCollapse = (id) => {
          setCollapsed(prev => ({ ...prev, [id]: !prev[id] }));
        };

        const findAncestors = (personId, allPeople, ancestors = new Set()) => {
          const person = allPeople[personId];
          if (!person || !person.parentId) return ancestors;
          const parent = allPeople[person.parentId];
          if (parent) {
            ancestors.add(parent.id);
            findAncestors(parent.id, allPeople, ancestors);
          }
          return ancestors;
        };

        const handleSearch = () => {
          const found = Object.values(people).find(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
          if (found) {
            const ancestorIds = findAncestors(found.id, people);
            setHighlightedIds(new Set([...ancestorIds, found.id]));
            setBlinkingId(found.id);
            setTimeout(() => setBlinkingId(null), 2000);
          } else {
            setHighlightedIds(new Set());
            setBlinkingId(null);
          }
        };

        const roots = Object.values(people).filter(p => !p.parentId);

        return (
          <div>
            <h1 className="text-3xl font-bold mb-4">Family Tree</h1>

            <div className="mb-4">
              <input
                type="text"
                className="border px-2 py-1 mr-2"
                placeholder="Search name"
                value={searchTerm}
                onChange={e => setSearchTerm(e.target.value)}
              />
              <button className="bg-blue-500 text-white px-3 py-1 rounded" onClick={handleSearch}>
                Search
              </button>
              <button className="ml-2 text-sm text-gray-600" onClick={() => addPerson({})}>Add Root Person</button>
            </div>

            {roots.map(person => (
              <TreeNode
                key={person.id}
                person={person}
                people={people}
                onEdit={handleEdit}
                onAddChild={handleAddChild}
                onAddSpouse={handleAddSpouse}
                collapsed={collapsed}
                toggleCollapse={toggleCollapse}
                highlightedIds={highlightedIds}
                blinkingId={blinkingId}
              />
            ))}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<FamilyTree />);
    </script>
  </body>
</html>
