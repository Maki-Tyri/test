<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
    }
    #login-container, #app-container {
      max-width: 700px;
      margin: 40px auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
      padding: 20px;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      box-sizing: border-box;
    }
    input[type="text"], input[type="date"], input[type="email"], input[type="password"] {
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      cursor: pointer;
      border-radius: 4px;
      border: none;
      background-color: #2563eb;
      color: white;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #1e40af;
    }
    #login-btn, #logout-btn {
      width: 100%;
    }
    #birthday-notifications {
      background: #d1fae5;
      color: #065f46;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 6px;
      font-weight: bold;
    }
    .tree-node {
      margin-left: 20px;
      position: relative;
      border-left: 1px dashed #ccc;
      padding-left: 12px;
      margin-bottom: 8px;
    }
    .node-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }
    .arrow {
      display: inline-block;
      width: 16px;
      user-select: none;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .arrow.collapsed {
      transform: rotate(-90deg);
    }
    input[type="text"].name-input {
      width: 140px;
    }
    input[type="date"].birthday-input {
      width: 130px;
    }
    .node-buttons {
      display: flex;
      gap: 8px;
      margin-left: auto;
      flex-wrap: nowrap;
    }
    .node-buttons button {
      font-size: 0.85rem;
      padding: 4px 10px;
      width: auto;
    }
    .node-buttons button.add-child-btn {
      background-color: #10b981;
    }
    .node-buttons button.add-spouse-btn {
      background-color: #3b82f6;
    }
    .node-buttons button.delete-btn {
      background-color: #ef4444;
    }
    .node-buttons button:hover {
      filter: brightness(85%);
    }
    .add-child-form, .add-spouse-form {
      margin-left: 36px;
      margin-bottom: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .add-child-form input[type="text"], .add-spouse-form input[type="text"],
    .add-child-form input[type="date"], .add-spouse-form input[type="date"] {
      font-size: 0.9rem;
      padding: 5px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .add-child-form input[type="text"], .add-spouse-form input[type="text"] {
      width: 140px;
    }
    .add-child-form input[type="date"], .add-spouse-form input[type="date"] {
      width: 130px;
    }
    .add-child-form button, .add-spouse-form button {
      background-color: #10b981;
      padding: 6px 12px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      color: white;
    }
    .add-child-form button:hover, .add-spouse-form button:hover {
      filter: brightness(90%);
    }
    #add-root-container {
      margin-bottom: 20px;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 6px;
      background: #f3f4f6;
    }
    #add-root-container h3 {
      margin-top: 0;
    }
    #add-root-form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    #add-root-form input[type="text"], #add-root-form input[type="date"] {
      flex: 1 1 180px;
      padding: 8px;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #add-root-form button {
      flex: 0 0 auto;
      background-color: #2563eb;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      color: white;
    }

    /* --- Improved Login Page Styles --- */
    #login-container {
      max-width: 400px;
      padding: 30px 40px;
      box-shadow: 0 8px 24px rgb(0 0 0 / 0.2);
      border-radius: 12px;
      background: white;
    }
    #login-container h2 {
      text-align: center;
      margin-bottom: 25px;
      font-weight: 700;
      color: #2563eb;
    }
    #login-container input {
      width: 100%;
      margin-bottom: 15px;
      font-size: 1.1rem;
      padding: 12px;
      border: 2px solid #ccc;
      border-radius: 8px;
      transition: border-color 0.3s;
    }
    #login-container input:focus {
      border-color: #2563eb;
      outline: none;
    }
    #login-btn {
      font-size: 1.1rem;
      padding: 12px;
      border-radius: 8px;
    }
    #facebook-login-btn {
      width: 100%;
      background-color: #1877f2;
      color: white;
      margin-top: 15px;
      padding: 12px;
      font-size: 1.1rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: background-color 0.3s;
    }
    #facebook-login-btn:hover {
      background-color: #145dbf;
    }
    #facebook-login-btn svg {
      width: 20px;
      height: 20px;
      fill: white;
    }

    /* New scroll styling for app container */
    #app-container {
      max-width: 100vw;
      max-height: 80vh;
      overflow: auto;
      white-space: nowrap; /* allow horizontal scrolling */
      padding-bottom: 20px;
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script> <!-- For OAuth -->

</head>
<body>

<div id="login-container">
  <h2>Login to Family Tree</h2>
  <input id="email" type="email" placeholder="Email" autocomplete="username" />
  <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
  <button id="login-btn">Sign In</button>

  <button id="facebook-login-btn" title="Login with Facebook">
    <!-- Facebook SVG Icon -->
    <svg viewBox="0 0 24 24"><path d="M22 12c0-5.5-4.5-10-10-10S2 6.5 2 12c0 5 3.7 9.1 8.5 9.9v-7h-2.5v-3h2.5V9.5c0-2.5 1.5-3.9 3.7-3.9 1.1 0 2.2.2 2.2.2v2.5h-1.3c-1.3 0-1.7.8-1.7 1.6v1.9h2.9l-.5 3h-2.4v7C18.3 21.1 22 17 22 12z"/></svg>
    Sign in with Facebook
  </button>
</div>

<div id="app-container" style="display:none;">
  <div id="birthday-notifications"></div>
  <div id="family-trees"></div>

  <div id="add-root-container">
    <h3>Add New Root Person</h3>
    <form id="add-root-form">
      <input type="text" id="root-name" placeholder="Name" required />
      <input type="date" id="root-birthday" />
      <button type="submit">Add Root</button>
    </form>
  </div>

  <button id="logout-btn" style="background:#ef4444; margin-top: 20px;">Logout</button>
</div>

<script>
  // Firebase config & initialization (use your own config here)
  const firebaseConfig = {
  apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
  authDomain: "project-955237504610034331.firebaseapp.com",
  databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
  projectId: "project-955237504610034331",
  storageBucket: "project-955237504610034331.firebasestorage.app",
  messagingSenderId: "76212939677",
  appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
  measurementId: "G-RCJ4P82PVM"
};

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();

  // Global state
  let familyTrees = {};
  let currentUser = null;

  // Utility for updating nested data at path like "root/spouses/spouseKey"
  function updateNodeData(path, updateObj) {
    if (!currentUser) return;
    const userRef = database.ref(`familyTrees/${currentUser.uid}/${path}`);
    userRef.update(updateObj);
  }

  // Helper to create an element with classes, attributes
  function createElement(tag, options = {}) {
    const el = document.createElement(tag);
    if (options.classList) el.classList.add(...options.classList);
    if (options.attrs) {
      for (const [k,v] of Object.entries(options.attrs)) {
        el.setAttribute(k,v);
      }
    }
    if (options.text) el.textContent = options.text;
    return el;
  }

  // Render the entire family trees UI
  function renderAllTrees() {
    const container = document.getElementById("family-trees");
    container.innerHTML = "";
    for (const [rootKey, rootData] of Object.entries(familyTrees)) {
      const rootDiv = renderNode(rootData, rootKey);
      container.appendChild(rootDiv);
    }
  }

  // Recursive render a node (person), including children & spouses
  // path: string path to this node (like "root1/children/childKey")
  function renderNode(nodeData, path) {
    const nodeDiv = createElement("div", {classList: ["tree-node"]});

    // Node header with collapsible arrow and inputs
    const header = createElement("div", {classList: ["node-header"]});
    nodeDiv.appendChild(header);

    // Collapse arrow for children
    let hasChildren = nodeData.children && Object.keys(nodeData.children).length > 0;
    const arrow = createElement("span", {classList: ["arrow", "collapsed"]});
    arrow.textContent = "â–¶";
    if (!hasChildren) {
      arrow.style.visibility = "hidden";
    }
    header.appendChild(arrow);

    // Editable name input
    const nameInput = createElement("input", {attrs: {type: "text"}, classList: ["name-input"]});
    nameInput.value = nodeData.name || "";
    header.appendChild(nameInput);

    // Editable birthday input
    const birthdayInput = createElement("input", {attrs: {type: "date"}, classList: ["birthday-input"]});
    birthdayInput.value = nodeData.birthday || "";
    header.appendChild(birthdayInput);

    // Buttons: Add Child, Add Spouse, Delete
    const btnContainer = createElement("div", {classList: ["node-buttons"]});
    header.appendChild(btnContainer);

    // Add Child button
    const addChildBtn = createElement("button", {text: "Add Child", classList: ["add-child-btn"]});
    btnContainer.appendChild(addChildBtn);

    // Add Spouse button
    const addSpouseBtn = createElement("button", {text: "Add Spouse", classList: ["add-spouse-btn"]});
    btnContainer.appendChild(addSpouseBtn);

    // Delete button (hide for root)
    const deleteBtn = createElement("button", {text: "Delete", classList: ["delete-btn"]});
    if (path.split("/").length === 1) {
      deleteBtn.style.display = "none"; // cannot delete root node directly here
    }
    btnContainer.appendChild(deleteBtn);

    // Children container (initially hidden)
    const childrenContainer = createElement("div");
    childrenContainer.style.display = "none";
    childrenContainer.style.marginLeft = "28px";
    nodeDiv.appendChild(childrenContainer);

    // Toggle children on arrow click
    arrow.addEventListener("click", () => {
      if (childrenContainer.style.display === "none") {
        childrenContainer.style.display = "block";
        arrow.classList.remove("collapsed");
      } else {
        childrenContainer.style.display = "none";
        arrow.classList.add("collapsed");
      }
    });

    // Render children recursively
    if (hasChildren) {
      for (const [childKey, childData] of Object.entries(nodeData.children)) {
        const childDiv = renderNode(childData, path + "/children/" + childKey);
        childrenContainer.appendChild(childDiv);
      }
    }

    // --- SPOUSES SECTION ---
    if (nodeData.spouses && Object.keys(nodeData.spouses).length > 0) {
      const spousesContainer = createElement("div");
      spousesContainer.style.marginLeft = "28px";
      spousesContainer.style.marginBottom = "8px";

      // Spouse arrow for expand/collapse
      const spouseArrow = createElement("span", {classList: ["arrow", "collapsed"]});
      spouseArrow.textContent = "â–¶";
      spousesContainer.appendChild(spouseArrow);

      // Spouse content container (hidden initially)
      const spouseContent = createElement("div");
      spouseContent.style.display = "none";
      spouseContent.style.marginLeft = "20px";
      spousesContainer.appendChild(spouseContent);

      // For each spouse, render editable fields
      Object.entries(nodeData.spouses).forEach(([spouseKey, spouseData]) => {
        const spouseDiv = createElement("div", {classList: ["tree-node"]});
        spouseDiv.style.borderLeft = "1px dashed #a3bffa";
        spouseDiv.style.paddingLeft = "10px";
        spouseDiv.style.marginBottom = "6px";

        // Spouse name input
        const spouseNameInput = createElement("input", {attrs: {type: "text"}, classList: ["name-input"]});
        spouseNameInput.value = spouseData.name || "";
        spouseNameInput.title = "Edit spouse name";
        spouseDiv.appendChild(spouseNameInput);

        // Spouse birthday input
        const spouseBirthdayInput = createElement("input", {attrs: {type: "date"}, classList: ["birthday-input"]});
        spouseBirthdayInput.value = spouseData.birthday || "";
        spouseBirthdayInput.title = "Edit spouse birthday";
        spouseDiv.appendChild(spouseBirthdayInput);

        // Update spouse name on change
        spouseNameInput.addEventListener("change", () => {
          if (spouseNameInput.value.trim() === "") {
            alert("Spouse name cannot be empty.");
            spouseNameInput.value = spouseData.name;
            return;
          }
          updateNodeData(`${path}/spouses/${spouseKey}`, { name: spouseNameInput.value.trim() });
        });

        // Update spouse birthday on change
        spouseBirthdayInput.addEventListener("change", () => {
          updateNodeData(`${path}/spouses/${spouseKey}`, { birthday: spouseBirthdayInput.value || null });
          fetchAndRenderAllTrees();
        });

        spouseContent.appendChild(spouseDiv);
      });

      // Toggle spouses container on arrow click
      spouseArrow.addEventListener("click", () => {
        if (spouseContent.style.display === "none") {
          spouseContent.style.display = "block";
          spouseArrow.classList.remove("collapsed");
        } else {
          spouseContent.style.display = "none";
          spouseArrow.classList.add("collapsed");
        }
      });

      nodeDiv.appendChild(spousesContainer);
    }

    // --- Editable field updates ---

    nameInput.addEventListener("change", () => {
      if (nameInput.value.trim() === "") {
        alert("Name cannot be empty.");
        nameInput.value = nodeData.name;
        return;
      }
      updateNodeData(path, { name: nameInput.value.trim() });
    });

    birthdayInput.addEventListener("change", () => {
      updateNodeData(path, { birthday: birthdayInput.value || null });
      fetchAndRenderAllTrees();
    });

    // --- Add Child Form ---
    addChildBtn.addEventListener("click", () => {
      // Prevent multiple forms
      if (nodeDiv.querySelector(".add-child-form")) return;

      const form = createElement("form", {classList: ["add-child-form"]});
      const nameInput = createElement("input", {attrs: {type: "text", placeholder: "Child Name", required: true}});
      const birthdayInput = createElement("input", {attrs: {type: "date"}});
      const addBtn = createElement("button", {text: "Add"});

      form.appendChild(nameInput);
      form.appendChild(birthdayInput);
      form.appendChild(addBtn);
      nodeDiv.appendChild(form);

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (nameInput.value.trim() === "") {
          alert("Child name cannot be empty.");
          return;
        }
        const newChildRef = database.ref(`familyTrees/${currentUser.uid}/${path}/children`).push();
        newChildRef.set({
          name: nameInput.value.trim(),
          birthday: birthdayInput.value || null,
          children: {},
          spouses: {}
        }).then(() => {
          fetchAndRenderAllTrees();
        });
        form.remove();
      });
    });

    // --- Add Spouse Form ---
    addSpouseBtn.addEventListener("click", () => {
      if (nodeDiv.querySelector(".add-spouse-form")) return;

      const form = createElement("form", {classList: ["add-spouse-form"]});
      const nameInput = createElement("input", {attrs: {type: "text", placeholder: "Spouse Name", required: true}});
      const birthdayInput = createElement("input", {attrs: {type: "date"}});
      const addBtn = createElement("button", {text: "Add"});

      form.appendChild(nameInput);
      form.appendChild(birthdayInput);
      form.appendChild(addBtn);
      nodeDiv.appendChild(form);

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (nameInput.value.trim() === "") {
          alert("Spouse name cannot be empty.");
          return;
        }
        const newSpouseRef = database.ref(`familyTrees/${currentUser.uid}/${path}/spouses`).push();
        newSpouseRef.set({
          name: nameInput.value.trim(),
          birthday: birthdayInput.value || null
        }).then(() => {
          fetchAndRenderAllTrees();
        });
        form.remove();
      });
    });

    // --- Delete Node ---
    deleteBtn.addEventListener("click", () => {
      if (confirm(`Delete "${nodeData.name}" and all descendants? This cannot be undone.`)) {
        // Deletion depends on path depth:
        // If this is child of a parent, remove child key from parent's children
        // If spouse, remove from spouses
        // If root (path has no slashes), cannot delete here.

        const pathParts = path.split("/");
        if (pathParts.length === 1) {
          alert("Cannot delete root node from here.");
          return;
        }

        // Identify parent path and key
        const keyToDelete = pathParts.pop();
        const parentPath = pathParts.join("/");

        // Remove child or spouse based on path segment
        if (parentPath.endsWith("children")) {
          // Delete child node key
          const parentParentPath = pathParts.slice(0, -1).join("/");
          const ref = database.ref(`familyTrees/${currentUser.uid}/${parentParentPath}/children/${keyToDelete}`);
          ref.remove().then(() => fetchAndRenderAllTrees());
        } else if (parentPath.endsWith("spouses")) {
          const parentParentPath = pathParts.slice(0, -1).join("/");
          const ref = database.ref(`familyTrees/${currentUser.uid}/${parentParentPath}/spouses/${keyToDelete}`);
          ref.remove().then(() => fetchAndRenderAllTrees());
        } else {
          alert("Unknown deletion path.");
        }
      }
    });

    return nodeDiv;
  }

  // Fetch family trees from Firebase and render
  function fetchAndRenderAllTrees() {
    if (!currentUser) return;
    const treesRef = database.ref(`familyTrees/${currentUser.uid}`);
    treesRef.once("value", snapshot => {
      familyTrees = snapshot.val() || {};
      renderAllTrees();
      updateBirthdayNotifications();
    });
  }

  // Birthday notifications for today or soon (simple check)
  function updateBirthdayNotifications() {
    const notifDiv = document.getElementById("birthday-notifications");
    notifDiv.textContent = "";
    if (!familyTrees) return;

    const today = new Date();
    const upcoming = [];

    function checkBirthdays(node, path) {
      if (!node) return;
      if (node.birthday) {
        const bday = new Date(node.birthday);
        bday.setFullYear(today.getFullYear());
        const diffDays = Math.floor((bday - today) / (1000 * 60 * 60 * 24));
        if (diffDays >= 0 && diffDays <= 7) {
          upcoming.push(`${node.name} (in ${diffDays} day${diffDays !== 1 ? "s" : ""})`);
        }
      }
      if (node.children) {
        Object.values(node.children).forEach(c => checkBirthdays(c));
      }
      if (node.spouses) {
        Object.values(node.spouses).forEach(s => checkBirthdays(s));
      }
    }

    Object.values(familyTrees).forEach(rootNode => checkBirthdays(rootNode));

    if (upcoming.length > 0) {
      notifDiv.textContent = `Upcoming birthdays: ${upcoming.join(", ")}`;
    }
  }

  // Login functionality
  const loginContainer = document.getElementById("login-container");
  const appContainer = document.getElementById("app-container");
  const loginBtn = document.getElementById("login-btn");
  const facebookLoginBtn = document.getElementById("facebook-login-btn");
  const logoutBtn = document.getElementById("logout-btn");

  loginBtn.addEventListener("click", () => {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    if (!email || !password) {
      alert("Please enter email and password.");
      return;
    }
    auth.signInWithEmailAndPassword(email, password)
      .catch(err => alert(err.message));
  });

  facebookLoginBtn.addEventListener("click", () => {
    const provider = new firebase.auth.FacebookAuthProvider();
    auth.signInWithPopup(provider).catch(err => alert(err.message));
  });

  logoutBtn.addEventListener("click", () => {
    auth.signOut();
  });

  // Add new root person form
  document.getElementById("add-root-form").addEventListener("submit", e => {
    e.preventDefault();
    const name = document.getElementById("root-name").value.trim();
    const birthday = document.getElementById("root-birthday").value || null;
    if (!name) {
      alert("Root person name is required.");
      return;
    }
    const newRootRef = database.ref(`familyTrees/${currentUser.uid}`).push();
    newRootRef.set({
      name,
      birthday,
      children: {},
      spouses: {}
    }).then(() => {
      fetchAndRenderAllTrees();
      e.target.reset();
    });
  });

  // Monitor auth state
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      loginContainer.style.display = "none";
      appContainer.style.display = "block";
      fetchAndRenderAllTrees();
    } else {
      loginContainer.style.display = "block";
      appContainer.style.display = "none";
      familyTrees = {};
    }
  });
</script>

</body>
</html>
