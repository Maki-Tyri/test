<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Firebase Messenger App</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f1f1f1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header, footer {
      padding: 1em;
      background: #007BFF;
      color: white;
      text-align: center;
    }
    #main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    #sidebar {
      width: 250px;
      background: #fff;
      border-right: 1px solid #ddd;
      overflow-y: auto;
    }
    #chatArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #eee;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 1em;
    }
    .message {
      margin-bottom: 1em;
    }
    .message .media {
      max-width: 100%;
      display: block;
    }
    #inputArea {
      padding: 1em;
      background: white;
      display: flex;
      gap: 0.5em;
      align-items: center;
    }
    #inputArea textarea {
      flex: 1;
      resize: none;
    }
    #inputArea input[type="file"] {
      flex: none;
    }
    select, input[type="text"] {
      width: 100%;
      margin: 0.5em 0;
    }
    #typingIndicator {
      padding: 0.5em;
      font-size: 0.9em;
      color: gray;
    }
  </style>
</head>
<body>
  <header>
    <h2>Firebase Messenger</h2>
    <div>
      <input type="text" id="displayNameInput" placeholder="Set Display Name" />
      <button onclick="updateDisplayName()">Update</button>
    </div>
  </header>
  <div id="main">
    <div id="sidebar">
      <h4>Users</h4>
      <select id="userSelect"></select>
      <h4>Groups</h4>
      <select id="groupSelect"></select>
      <button onclick="createGroup()">Create Group</button>
    </div>
    <div id="chatArea">
      <div id="messages"></div>
      <div id="typingIndicator"></div>
      <div id="inputArea">
        <textarea id="messageInput" rows="2" placeholder="Type a message..."></textarea>
        <input type="file" id="mediaInput" />
        <button id="sendBtn" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>
  <footer>
    <button onclick="signInWithGoogle()">Login with Google</button>
  </footer>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
      authDomain: "project-955237504610034331.firebaseapp.com",
      projectId: "project-955237504610034331",
      storageBucket: "project-955237504610034331.appspot.com",
      messagingSenderId: "76212939677",
      appId: "1:76212939677:web:ef498bc1e4e480ab6e5d74",
      measurementId: "G-WXBEP1LXTX"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();
    const messaging = firebase.messaging();

    const messageInput = document.getElementById("messageInput");
    const mediaInput = document.getElementById("mediaInput");
    const messages = document.getElementById("messages");
    const sendBtn = document.getElementById("sendBtn");
    const userSelect = document.getElementById("userSelect");
    const groupSelect = document.getElementById("groupSelect");
    const typingIndicator = document.getElementById("typingIndicator");
    let currentChatType = null;
    let currentChatId = null;
    let displayNameInput = document.getElementById("displayNameInput");

    auth.onAuthStateChanged(user => {
      if (user) {
        db.ref("users/" + user.uid).set({
          email: user.email,
          displayName: user.displayName || user.email
        });
        loadUsers();
        loadGroups();
        requestNotificationPermission();
      }
    });

    function signInWithGoogle() {
      auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    }

    function updateDisplayName() {
      const name = displayNameInput.value.trim();
      if (name && auth.currentUser) {
        db.ref("users/" + auth.currentUser.uid + "/displayName").set(name);
      }
    }

    function loadUsers() {
      db.ref("users").on("value", snapshot => {
        userSelect.innerHTML = '<option value="">Select user</option>';
        snapshot.forEach(child => {
          if (child.key !== auth.currentUser.uid) {
            const opt = document.createElement("option");
            opt.value = child.key;
            opt.textContent = child.val().displayName || child.val().email;
            userSelect.appendChild(opt);
          }
        });
      });
    }

    function loadGroups() {
      db.ref("groups").on("value", snapshot => {
        groupSelect.innerHTML = '<option value="">Select group</option>';
        snapshot.forEach(child => {
          const opt = document.createElement("option");
          opt.value = child.key;
          opt.textContent = child.val().name;
          groupSelect.appendChild(opt);
        });
      });
    }

    userSelect.addEventListener("change", () => {
      currentChatType = "user";
      currentChatId = userSelect.value;
      loadMessages();
    });

    groupSelect.addEventListener("change", () => {
      currentChatType = "group";
      currentChatId = groupSelect.value;
      loadMessages();
    });

    function createGroup() {
      const name = prompt("Group name:");
      if (name) {
        const newGroup = db.ref("groups").push({
          name,
          members: { [auth.currentUser.uid]: true }
        });
      }
    }

    function chatPath() {
      return currentChatType === "user"
        ? `privateMessages/${chatId(auth.currentUser.uid, currentChatId)}`
        : `groupMessages/${currentChatId}`;
    }

    function chatId(uid1, uid2) {
      return uid1 < uid2 ? uid1 + "_" + uid2 : uid2 + "_" + uid1;
    }

    function loadMessages() {
      db.ref(chatPath()).off();
      db.ref(chatPath()).on("value", snapshot => {
        messages.innerHTML = "";
        snapshot.forEach(child => {
          const msg = child.val();
          const div = document.createElement("div");
          div.className = "message";
          div.innerHTML = `<strong>${msg.senderName || "Unknown"}</strong>: ${msg.text || ""}`;
          if (msg.media) {
            div.innerHTML += `<br><a href="${msg.media}" target="_blank">Media</a>`;
          }
          messages.appendChild(div);
        });
        messages.scrollTop = messages.scrollHeight;
      });
    }

    function sendMessage() {
      if (!currentChatId) return alert("Please select a chat.");

      const text = messageInput.value.trim();
      const file = mediaInput.files[0];
      if (!text && !file) return;

      sendBtn.disabled = true;

      if (file) {
        const ref = storage.ref("chatMedia/" + Date.now() + "_" + file.name);
        ref.put(file).then(snap => snap.ref.getDownloadURL()).then(url => {
          pushMessage(text, url);
        }).catch(e => alert(e.message));
      } else {
        pushMessage(text, null);
      }
    }

    function pushMessage(text, mediaUrl) {
      const msg = {
        sender: auth.currentUser.uid,
        senderName: displayNameInput.value || auth.currentUser.email,
        text: text || null,
        media: mediaUrl || null,
        timestamp: Date.now()
      };
      db.ref(chatPath()).push(msg).then(() => {
        messageInput.value = "";
        mediaInput.value = "";
        sendBtn.disabled = false;
      });
    }

    messageInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    async function requestNotificationPermission() {
      try {
        await messaging.requestPermission();
        const token = await messaging.getToken({
          vapidKey: "BElIT7exXMYvtZcKIk0MwBrh36uij6kr4iMKP_TJ4JJK0kr8t_V7VkHnektRYCJixraRFci2uNqZm_SXdsc9RXI"
        });
        db.ref("fcmTokens/" + auth.currentUser.uid).set(token);
      } catch (e) {
        console.warn("Notification permission error:", e);
      }
    }

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("firebase-messaging-sw.js")
        .then(reg => {
          console.log("Service Worker registered", reg);
          messaging.useServiceWorker(reg);
        }).catch(console.error);
    }
  </script>
</body>
</html>
