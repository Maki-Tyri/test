<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Family Tree</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    .tree-container {
      display: flex;
      justify-content: center;
      position: relative;
      margin-top: 50px;
    }
    .person-node {
      border: 1px solid #aaa;
      padding: 10px;
      border-radius: 10px;
      background: #f9f9f9;
      margin: 10px;
      text-align: center;
      position: relative;
      min-width: 120px;
    }
    .person-node .name {
      font-weight: bold;
    }
    .generation {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 40px 0;
      position: relative;
    }
    .spouse-pair {
      display: flex;
      align-items: center;
      margin: 0 20px;
      position: relative;
    }
    .svg-line {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 0;
    }
  </style>
</head>
<body>
  <h2 style="text-align: center;">Family Tree</h2>
  <div class="tree-container">
    <svg class="svg-line" width="100%" height="100%"></svg>
    <div id="familyTree"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <script>
    // Firebase setup
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Helper: Draw line between two HTML elements using SVG
    function drawLine(fromElem, toElem) {
      const svg = document.querySelector(".svg-line");
      const rect1 = fromElem.getBoundingClientRect();
      const rect2 = toElem.getBoundingClientRect();

      const x1 = rect1.left + rect1.width / 2 + window.scrollX;
      const y1 = rect1.bottom + window.scrollY;
      const x2 = rect2.left + rect2.width / 2 + window.scrollX;
      const y2 = rect2.top + window.scrollY;

      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", x1);
      line.setAttribute("y1", y1);
      line.setAttribute("x2", x2);
      line.setAttribute("y2", y2);
      line.setAttribute("stroke", "black");
      line.setAttribute("stroke-width", "2");

      svg.appendChild(line);
    }

    // Render person box
    function createPersonBox(person) {
      const div = document.createElement("div");
      div.className = "person-node";
      div.setAttribute("data-id", person.id);
      div.innerHTML = `
        <div class="name">${person.name}</div>
        <div>Born: ${person.birthDate || '-'}</div>
        <div>Died: ${person.died || '-'}</div>
      `;
      return div;
    }

    // Render tree
    function renderTree(data) {
      const container = document.getElementById("familyTree");
      container.innerHTML = '';
      const svg = document.querySelector(".svg-line");
      svg.innerHTML = '';

      const peopleById = {};
      const childrenByParent = {};

      Object.values(data).forEach(p => {
        peopleById[p.id] = p;
        if (p.parentId) {
          if (!childrenByParent[p.parentId]) childrenByParent[p.parentId] = [];
          childrenByParent[p.parentId].push(p);
        }
      });

      function buildGeneration(parentId, containerDiv) {
        const children = childrenByParent[parentId] || [];
        const generationDiv = document.createElement("div");
        generationDiv.className = "generation";

        children.forEach(person => {
          const pairDiv = document.createElement("div");
          pairDiv.className = "spouse-pair";

          const personBox = createPersonBox(person);
          pairDiv.appendChild(personBox);

          if (person.spouseId && peopleById[person.spouseId]) {
            const spouse = peopleById[person.spouseId];
            const spouseBox = createPersonBox(spouse);
            pairDiv.appendChild(spouseBox);

            // Draw line between spouses
            setTimeout(() => drawLine(personBox, spouseBox), 100);
          }

          generationDiv.appendChild(pairDiv);

          // Draw line to parent
          if (parentId && peopleById[parentId]) {
            const parentBox = document.querySelector(`[data-id="${parentId}"]`);
            if (parentBox) {
              setTimeout(() => drawLine(parentBox, personBox), 100);
            }
          }

          buildGeneration(person.id, containerDiv);
        });

        if (children.length) containerDiv.appendChild(generationDiv);
      }

      // Find root (no parentId)
      const root = Object.values(data).find(p => !p.parentId);
      if (!root) return;

      const rootPair = document.createElement("div");
      rootPair.className = "spouse-pair";

      const rootBox = createPersonBox(root);
      rootPair.appendChild(rootBox);

      if (root.spouseId && peopleById[root.spouseId]) {
        const spouseBox = createPersonBox(peopleById[root.spouseId]);
        rootPair.appendChild(spouseBox);

        setTimeout(() => drawLine(rootBox, spouseBox), 100);
      }

      const rootGen = document.createElement("div");
      rootGen.className = "generation";
      rootGen.appendChild(rootPair);
      container.appendChild(rootGen);

      buildGeneration(root.id, container);
    }

    db.ref("family").on("value", snapshot => {
      const data = snapshot.val();
      if (data) renderTree(data);
    });
  </script>
</body>
</html>

