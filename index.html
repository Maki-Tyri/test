<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Family Tree</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    .highlight {
      background-color: #fffacc;
    }
  </style>
</head>
<body class="p-4 bg-gray-100">
  <div id="root" class="max-w-5xl mx-auto"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { initializeApp } = firebase;
    const { getDatabase, ref, onValue, set } = firebase.database;

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
      authDomain: "project-955237504610034331.firebaseapp.com",
      databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
      projectId: "project-955237504610034331",
      storageBucket: "project-955237504610034331.appspot.com",
      messagingSenderId: "76212939677",
      appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
      measurementId: "G-RCJ4P82PVM"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let nextId = 1;

    function EditableField({ label, value, onChange, type }) {
      return (
        <div className="flex items-center space-x-2 text-sm">
          <span>{label}:</span>
          <input
            type={type}
            value={value}
            onChange={(e) => onChange(e.target.value)}
            className="border px-2 py-0.5 rounded"
          />
        </div>
      );
    }

    function SpouseItem({ spouse, onUpdate, onDelete, highlight }) {
      const [showDates, setShowDates] = useState(false);
      const [editing, setEditing] = useState(false);
      const [tempName, setTempName] = useState(spouse.name);

      function saveName() {
        setEditing(false);
        onUpdate({ ...spouse, name: tempName });
      }

      return (
        <div className={`ml-2 border px-2 py-1 rounded ${highlight ? "highlight" : ""}`}>
          {editing ? (
            <input
              type="text"
              value={tempName}
              onChange={(e) => setTempName(e.target.value)}
              onBlur={saveName}
              onKeyDown={(e) => e.key === "Enter" && saveName()}
              className="border rounded px-1"
              autoFocus
            />
          ) : (
            <span
              onClick={() => setShowDates(!showDates)}
              onDoubleClick={() => setEditing(true)}
              className="cursor-pointer"
            >
              {spouse.name}
            </span>
          )}
          <button className="text-red-600 ml-2" onClick={() => onDelete(spouse.id)}>×</button>
          {showDates && (
            <div className="mt-1 flex space-x-2 text-sm">
              <EditableField label="Bday" value={spouse.birthday || ""} onChange={(val) => onUpdate({ ...spouse, birthday: val })} type="date" />
              <EditableField label="Dday" value={spouse.deathday || ""} onChange={(val) => onUpdate({ ...spouse, deathday: val })} type="date" />
            </div>
          )}
        </div>
      );
    }

    function TreeNode({ node, onUpdate, onDelete, highlightIds, openIds, toggleOpen }) {
      const [showDates, setShowDates] = useState(false);
      const [editing, setEditing] = useState(false);
      const [tempName, setTempName] = useState(node.name);

      function saveName() {
        setEditing(false);
        onUpdate({ ...node, name: tempName });
      }

      function updateChild(updatedChild) {
        const newChildren = (node.children || []).map(c => c.id === updatedChild.id ? updatedChild : c);
        onUpdate({ ...node, children: newChildren });
      }

      function addChild() {
        const newChild = {
          id: ++nextId,
          name: "New Child",
          birthday: "",
          deathday: "",
          spouses: [],
          children: [],
        };
        onUpdate({ ...node, children: [...(node.children || []), newChild] });
      }

      function deleteChild(id) {
        const newChildren = (node.children || []).filter(c => c.id !== id);
        onUpdate({ ...node, children: newChildren });
      }

      function addSpouse() {
        const newSpouse = {
          id: ++nextId,
          name: "New Spouse",
          birthday: "",
          deathday: "",
        };
        onUpdate({ ...node, spouses: [...(node.spouses || []), newSpouse] });
      }

      function updateSpouse(sp) {
        onUpdate({ ...node, spouses: node.spouses.map(s => s.id === sp.id ? sp : s) });
      }

      function deleteSpouse(id) {
        onUpdate({ ...node, spouses: node.spouses.filter(s => s.id !== id) });
      }

      const isOpen = openIds.has(node.id);
      const highlight = highlightIds.has(node.id);

      return (
        <div className={`ml-4 mt-2 ${highlight ? "highlight" : ""}`}>
          <div className="flex items-center space-x-2">
            {node.children?.length > 0 ? (
              <button onClick={() => toggleOpen(node.id)}>{isOpen ? "▼" : "▶"}</button>
            ) : <span className="w-4" />}

            {editing ? (
              <input
                value={tempName}
                onChange={(e) => setTempName(e.target.value)}
                onBlur={saveName}
                onKeyDown={(e) => e.key === "Enter" && saveName()}
                autoFocus
                className="border px-1 py-0.5 rounded"
              />
            ) : (
              <span
                onClick={() => setShowDates(!showDates)}
                onDoubleClick={() => setEditing(true)}
                className="cursor-pointer font-semibold"
              >
                {node.name}
              </span>
            )}

            {node.id !== 1 && (
              <button onClick={() => onDelete(node.id)} className="text-red-600">×</button>
            )}
            <button onClick={addChild} className="text-green-600">+Child</button>
            {(!node.spouses || node.spouses.length < 2) && (
              <button onClick={addSpouse} className="text-blue-600">+Spouse</button>
            )}
          </div>

          {showDates && (
            <div className="ml-6 mt-1 flex space-x-3">
              <EditableField label="Bday" type="date" value={node.birthday} onChange={(val) => onUpdate({ ...node, birthday: val })} />
              <EditableField label="Dday" type="date" value={node.deathday} onChange={(val) => onUpdate({ ...node, deathday: val })} />
            </div>
          )}

          {/* Spouses */}
          {node.spouses?.map(spouse => (
            <SpouseItem
              key={spouse.id}
              spouse={spouse}
              onUpdate={updateSpouse}
              onDelete={deleteSpouse}
              highlight={highlightIds.has(spouse.id)}
            />
          ))}

          {/* Children */}
          {isOpen && node.children?.map(child => (
            <TreeNode
              key={child.id}
              node={child}
              onUpdate={updateChild}
              onDelete={deleteChild}
              highlightIds={highlightIds}
              openIds={openIds}
              toggleOpen={toggleOpen}
            />
          ))}
        </div>
      );
    }

    function findAncestors(node, targetId, path = []) {
      if (node.id === targetId) return new Set(path);
      for (const child of node.children || []) {
        const res = findAncestors(child, targetId, [...path, node.id]);
        if (res) return res;
      }
      return null;
    }

    function findPersonByName(node, name, found = []) {
      if (node.name.toLowerCase().includes(name.toLowerCase())) found.push(node);
      (node.spouses || []).forEach(s => {
        if (s.name.toLowerCase().includes(name.toLowerCase())) found.push({ ...s, isSpouse: true, parentId: node.id });
      });
      (node.children || []).forEach(child => findPersonByName(child, name, found));
      return found;
    }

    function FamilyTree() {
      const [family, setFamily] = useState(null);
      const [highlightIds, setHighlightIds] = useState(new Set());
      const [openIds, setOpenIds] = useState(new Set());
      const [search, setSearch] = useState("");
      const [results, setResults] = useState([]);

      useEffect(() => {
        const refDB = ref(database, "family");
        return onValue(refDB, snap => {
          const data = snap.val();
          if (data) {
            const max = (n) => {
              if (n.id > nextId) nextId = n.id;
              (n.spouses || []).forEach(s => { if (s.id > nextId) nextId = s.id; });
              (n.children || []).forEach(max);
            };
            max(data);
            setFamily(data);
            const allOpen = new Set();
            const walk = n => {
              allOpen.add(n.id);
              (n.children || []).forEach(walk);
            };
            walk(data);
            setOpenIds(allOpen);
          } else {
            const root = { id: 1, name: "Root", children: [], spouses: [] };
            set(refDB, root);
            setFamily(root);
          }
        });
      }, []);

      const updateNode = (updated) => {
        const update = (node) => {
          if (node.id === updated.id) return updated;
          return { ...node, children: (node.children || []).map(update) };
        };
        setFamily(prev => {
          const newTree = update(prev);
          set(ref(database, "family"), newTree);
          return newTree;
        });
      };

      const deleteNode = (id) => {
        if (id === 1) return alert("Can't delete root");
        const filter = (node) => ({
          ...node,
          children: (node.children || []).filter(c => c.id !== id).map(filter)
        });
        setFamily(prev => {
          const newTree = filter(prev);
          set(ref(database, "family"), newTree);
          return newTree;
        });
      };

      const toggleOpen = (id) => {
        setOpenIds(prev => {
          const newSet = new Set(prev);
          if (newSet.has(id)) newSet.delete(id);
          else newSet.add(id);
          return newSet;
        });
      };

      useEffect(() => {
        if (!family || !search.trim()) {
          setHighlightIds(new Set());
          setResults([]);
          return;
        }
        const found = findPersonByName(family, search.trim());
        setResults(found);
      }, [search, family]);

      const handleSelect = (person) => {
        if (person.isSpouse) {
          setHighlightIds(new Set([person.id, person.parentId]));
        } else {
          const ancestors = findAncestors(family, person.id);
          if (ancestors) ancestors.add(person.id);
          setHighlightIds(ancestors || new Set([person.id]));
        }
      };

      if (!family) return <div>Loading tree...</div>;

      return (
        <div>
          <input
            type="text"
            value={search}
            onChange={e => setSearch(e.target.value)}
            placeholder="Search..."
            className="mb-4 p-2 w-full border rounded"
          />
          {results.length > 0 && (
            <div className="mb-4">
              <div className="font-semibold">Search Results:</div>
              {results.map(p => (
                <div key={p.id} className="cursor-pointer hover:bg-blue-100 px-1" onClick={() => handleSelect(p)}>
                  {p.name} {p.isSpouse ? "(spouse)" : ""}
                </div>
              ))}
            </div>
          )}
          <TreeNode
            node={family}
            onUpdate={updateNode}
            onDelete={deleteNode}
            highlightIds={highlightIds}
            openIds={openIds}
            toggleOpen={toggleOpen}
          />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<FamilyTree />);
  </script>
</body>
</html>
