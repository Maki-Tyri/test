<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Tree with Add Member Interface</title>
<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<style>
  .member-card {
    position: relative;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
    background: white;
    cursor: pointer;
    transition: box-shadow 0.3s;
  }
  .member-card:hover {
    box-shadow: 0 4px 14px rgb(0 0 0 / 0.3);
  }
  .male {
    border-left: 6px solid #2563eb;
  }
  .female {
    border-left: 6px solid #db2777;
  }
  .unspecified {
    border-left: 6px solid #6b7280;
  }
  svg.connector {
    position: absolute;
    pointer-events: none;
    overflow: visible;
  }
  .toggle-btn {
    background: none;
    border: none;
    color: #4f46e5;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    padding: 0 4px;
    font-size: 14px;
  }
  @media (max-width: 640px) {
    .tree-container {
      padding-left: 8px !important;
      padding-right: 8px !important;
    }
  }
</style>
</head>
<body class="bg-gradient-to-br from-indigo-600 via-purple-700 to-pink-700 min-h-screen text-gray-900">

<div id="root" class="p-4 max-w-6xl mx-auto"></div>

<footer class="fixed bottom-0 w-full text-center py-2 bg-white bg-opacity-10 text-white backdrop-blur-md text-sm">
  &copy; 2025 Maki Web. All rights reserved.
</footer>

<script type="text/javascript">
const { useState, useEffect, useRef } = React;

const firebaseConfig = {
  apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
  authDomain: "project-955237504610034331.firebaseapp.com",
  databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
  projectId: "project-955237504610034331",
  storageBucket: "project-955237504610034331.appspot.com",
  messagingSenderId: "76212939677",
  appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

function Login({ onLogin }) {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [isRegister, setIsRegister] = useState(false);
  const [error, setError] = useState(null);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError(null);
    try {
      if (isRegister) {
        await auth.createUserWithEmailAndPassword(email, password);
      } else {
        await auth.signInWithEmailAndPassword(email, password);
      }
      onLogin();
    } catch (err) {
      setError(err.message);
    }
  };

  return React.createElement("div", { className: "max-w-md mx-auto mt-24 p-8 bg-white bg-opacity-90 rounded-lg shadow-lg backdrop-blur-md" },
    React.createElement("h2", { className: "text-3xl font-bold mb-6 text-center text-indigo-700" }, isRegister ? "Register" : "Login"),
    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-4" },
      React.createElement("input", {
        type: "email",
        placeholder: "Email",
        required: true,
        value: email,
        onChange: e => setEmail(e.target.value),
        className: "w-full px-4 py-2 border rounded-md"
      }),
      React.createElement("input", {
        type: "password",
        placeholder: "Password",
        required: true,
        value: password,
        onChange: e => setPassword(e.target.value),
        className: "w-full px-4 py-2 border rounded-md"
      }),
      React.createElement("button", {
        type: "submit",
        className: "w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 transition"
      }, isRegister ? "Register" : "Login")
    ),
    error && React.createElement("p", { className: "text-red-600 text-center mt-4" }, error),
    React.createElement("p", {
      className: "mt-6 text-center text-indigo-600 cursor-pointer hover:underline select-none",
      onClick: () => setIsRegister(!isRegister)
    }, isRegister ? "Already have an account? Login" : "No account? Register")
  );
}

function SvgLines({ members, containerRef }) {
  const [lines, setLines] = useState([]);

  useEffect(() => {
    if (!containerRef.current) return;
    const container = containerRef.current;

    setTimeout(() => {
      const newLines = [];
      function getCardCenter(id) {
        const el = container.querySelector(`[data-id="${id}"]`);
        if (!el) return null;
        const rect = el.getBoundingClientRect();
        const cRect = container.getBoundingClientRect();
        return {
          x: rect.left - cRect.left + rect.width / 2,
          y: rect.top - cRect.top + rect.height / 2,
          top: rect.top - cRect.top,
          left: rect.left - cRect.left,
          width: rect.width,
          height: rect.height
        };
      }

      members.forEach(m => {
        if (m.parentId) {
          const parentCenter = getCardCenter(m.parentId);
          const childCenter = getCardCenter(m.id);
          if (parentCenter && childCenter) {
            const startX = parentCenter.x;
            const startY = parentCenter.y + (getCardCenter(m.parentId).height / 2);
            const endX = childCenter.x;
            const endY = childCenter.y - (childCenter.height / 2);
            const midY = (startY + endY) / 2;
            newLines.push({
              key: `parent-child-${m.id}`,
              d: `M${startX},${startY} L${startX},${midY} L${endX},${midY} L${endX},${endY}`,
              stroke: "#4f46e5",
              strokeWidth: 2,
              fill: "none"
            });
          }
        }
        if (m.spouseId) {
          const memberCenter = getCardCenter(m.id);
          const spouseCenter = getCardCenter(m.spouseId);
          if (memberCenter && spouseCenter) {
            if (m.id < m.spouseId) {
              const y = Math.min(memberCenter.y, spouseCenter.y);
              const startX = memberCenter.x + memberCenter.width / 2;
              const endX = spouseCenter.x - spouseCenter.width / 2;
              newLines.push({
                key: `spouse-${m.id}-${m.spouseId}`,
                d: `M${startX},${y} L${endX},${y}`,
                stroke: "#db2777",
                strokeWidth: 3,
                fill: "none"
              });
            }
          }
        }
      });
      setLines(newLines);
    }, 50);
  }, [members, containerRef]);

  return React.createElement("svg", {
    className: "connector",
    style: { top: 0, left: 0, width: "100%", height: "100%", pointerEvents: "none", position: "absolute", zIndex: 0 },
  },
    lines.map(line =>
      React.createElement("path", {
        key: line.key,
        d: line.d,
        stroke: line.stroke,
        strokeWidth: line.strokeWidth,
        fill: line.fill,
        strokeLinecap: "round"
      })
    )
  );
}

function FamilyMember({ member, members, expanded, toggleExpand }) {
  const children = members.filter(m => m.parentId === member.id);
  const isOpen = expanded[member.id] ?? true;

  const genderClass = member.gender === "male" ? "male" : member.gender === "female" ? "female" : "unspecified";

  return React.createElement("div", { className: "relative mb-4" },
    React.createElement("div", {
      "data-id": member.id,
      className: `member-card ${genderClass} flex items-center gap-3 select-none`
    },
      React.createElement("div", { className: "flex-grow" },
        React.createElement("div", { className: "font-semibold text-lg text-gray-900" }, member.name),
        React.createElement("div", { className: "text-sm text-gray-600" }, member.relation || ""),
        member.deceased && React.createElement("div", { className: "text-red-600 font-bold" }, "☠ Deceased")
      ),
      React.createElement("button", {
        className: "toggle-btn",
        onClick: () => toggleExpand(member.id)
      }, isOpen ? "−" : "+")
    ),
    isOpen && children.length > 0 &&
    React.createElement("div", {
      className: "pl-10 mt-3 tree-container",
      style: { position: "relative" }
    },
      children.map(child => React.createElement(FamilyMember, { key: child.id, member: child, members, expanded, toggleExpand }))
    )
  );
}

function AddMemberForm({ members, onAdd }) {
  const [name, setName] = useState("");
  const [gender, setGender] = useState("");
  const [parentId, setParentId] = useState("");
  const [spouseId, setSpouseId] = useState("");
  const [relation, setRelation] = useState("");
  const [deceased, setDeceased] = useState(false);
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!name.trim()) {
      setError("Name is required");
      return;
    }
    setError(null);
    setLoading(true);
    try {
      const id = "m_" + Date.now();
      const newMember = {
        id,
        name: name.trim(),
        gender: gender || undefined,
        parentId: parentId || undefined,
        spouseId: spouseId || undefined,
        relation: relation.trim() || undefined,
        deceased,
      };
      await onAdd(newMember);
      setName("");
      setGender("");
      setParentId("");
      setSpouseId("");
      setRelation("");
      setDeceased(false);
    } catch (err) {
      setError(err.message || "Failed to add member");
    }
    setLoading(false);
  };

  return React.createElement("form", {
    onSubmit: handleSubmit,
    className: "bg-indigo-50 p-4 rounded-md shadow-md mb-8 max-w-md mx-auto"
  },
    React.createElement("h2", { className: "text-xl font-bold mb-4 text-indigo-700" }, "Add Family Member"),
    error && React.createElement("p", { className: "text-red-600 mb-2" }, error),
    React.createElement("input", {
      type: "text",
      placeholder: "Full Name",
      className: "w-full mb-2 px-3 py-2 border rounded",
      value: name,
      onChange: e => setName(e.target.value),
      required: true
    }),
    React.createElement("select", {
      className: "w-full mb-2 px-3 py-2 border rounded",
      value: gender,
      onChange: e => setGender(e.target.value)
    },
      React.createElement("option", { value: "" }, "Select Gender (optional)"),
      React.createElement("option", { value: "male" }, "Male"),
      React.createElement("option", { value: "female" }, "Female"),
      React.createElement("option", { value: "unspecified" }, "Unspecified")
    ),
    React.createElement("select", {
      className: "w-full mb-2 px-3 py-2 border rounded",
      value: parentId,
      onChange: e => setParentId(e.target.value)
    },
      React.createElement("option", { value: "" }, "Select Parent (optional)"),
      members.map(m => React.createElement("option", { key: m.id, value: m.id }, m.name))
    ),
    React.createElement("select", {
      className: "w-full mb-2 px-3 py-2 border rounded",
      value: spouseId,
      onChange: e => setSpouseId(e.target.value)
    },
      React.createElement("option", { value: "" }, "Select Spouse (optional)"),
      members.map(m => React.createElement("option", { key: m.id, value: m.id }, m.name))
    ),
    React.createElement("input", {
      type: "text",
      placeholder: "Relation/Description (optional)",
      className: "w-full mb-2 px-3 py-2 border rounded",
      value: relation,
      onChange: e => setRelation(e.target.value)
    }),
    React.createElement("label", { className: "inline-flex items-center mb-3" },
      React.createElement("input", {
        type: "checkbox",
        className: "mr-2",
        checked: deceased,
        onChange: e => setDeceased(e.target.checked)
      }),
      "Deceased"
    ),
    React.createElement("button", {
      type: "submit",
      disabled: loading,
      className: "bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition w-full"
    }, loading ? "Adding..." : "Add Member")
  );
}

function FamilyTreeApp() {
  const [user, setUser] = useState(null);
  const [members, setMembers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");
  const [expanded, setExpanded] = useState({});
  const containerRef = useRef(null);

  useEffect(() => {
    const unsubscribeAuth = auth.onAuthStateChanged(u => {
      setUser(u);
    });
    return () => unsubscribeAuth();
  }, []);

  useEffect(() => {
    if (!user) return;
    setLoading(true);
    const membersRef = db.ref(`users/${user.uid}/members`);
    membersRef.on("value", (snapshot) => {
      const data = snapshot.val() || {};
      const arr = Object.values(data);
      setMembers(arr);
      // expand all by default
      let exp = {};
      arr.forEach(m => exp[m.id] = true);
      setExpanded(exp);
      setLoading(false);
    });
    return () => membersRef.off();
  }, [user]);

  const handleAddMember = async (member) => {
    if (!user) throw new Error("Not logged in");
    await db.ref(`users/${user.uid}/members/${member.id}`).set(member);

    // If spouseId present, also update spouse's spouseId
    if (member.spouseId) {
      const spouseRef = db.ref(`users/${user.uid}/members/${member.spouseId}`);
      spouseRef.once("value").then(snap => {
        const spouse = snap.val();
        if (spouse && spouse.spouseId !== member.id) {
          spouseRef.update({ spouseId: member.id });
        }
      });
    }
  };

  const toggleExpand = (id) => {
    setExpanded(prev => ({ ...prev, [id]: !prev[id] }));
  };

  const filteredMembers = members.filter(m =>
    m.name.toLowerCase().includes(search.toLowerCase())
  );

  if (!user) {
    return React.createElement(Login, { onLogin: () => {} });
  }

  return React.createElement("div", { className: "relative" },
    React.createElement("div", { className: "flex justify-between items-center mb-6 max-w-6xl mx-auto" },
      React.createElement("input", {
        type: "search",
        placeholder: "Search family members...",
        className: "w-full max-w-md px-4 py-2 rounded border border-gray-300 focus:outline-indigo-600",
        value: search,
        onChange: e => setSearch(e.target.value)
      }),
      React.createElement("button", {
        className: "ml-4 bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700 transition",
        onClick: () => auth.signOut()
      }, "Logout")
    ),
    React.createElement(AddMemberForm, { members, onAdd: handleAddMember }),
    loading ? React.createElement("p", { className: "text-center text-white text-lg mt-16" }, "Loading...") :
      filteredMembers.length === 0 ? React.createElement("p", { className: "text-center text-white mt-12 text-lg" }, "No members found.") :
        React.createElement("div", {
          ref: containerRef,
          className: "relative tree-container p-4 bg-white bg-opacity-90 rounded shadow max-w-6xl mx-auto mb-24"
        },
          filteredMembers.filter(m => !m.parentId).map(rootMember =>
            React.createElement(FamilyMember, {
              key: rootMember.id,
              member: rootMember,
              members: filteredMembers,
              expanded,
              toggleExpand
            })
          ),
          React.createElement(SvgLines, { members: filteredMembers, containerRef })
        )
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(
  React.createElement(FamilyTreeApp)
);
</script>

</body>
</html>
