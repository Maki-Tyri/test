<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree App with Editing & Tree Graph</title>
  <style>
    body, html {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #eef2f5;
    }
    #login-page, #app {
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #login-page {
      flex-direction: column;
      background: rgba(255 255 255 / 0.3);
      backdrop-filter: blur(8px);
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      border-radius: 12px;
      padding: 40px;
      max-width: 320px;
      margin: auto;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      background-color: #1976d2;
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      border-radius: 8px;
      font-size: 16px;
      margin-top: 10px;
    }
    button#signup-btn {
      background-color: #28a745;
    }
    button.small-btn {
      width: auto;
      margin: 4px 4px 0 0;
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 6px;
    }
    button.delete-btn {
      background-color: #f44336;
    }
    #login-error {
      color: #f44336;
      margin-top: 10px;
      display: none;
      font-weight: 600;
    }
    #app {
      display: none;
      flex-direction: column;
      height: 100%;
    }
    #container {
      flex: 1;
      display: flex;
      overflow-y: auto;
      padding: 20px;
      gap: 20px;
    }
    #family-tree, #member-details {
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
      padding: 20px;
      flex-grow: 1;
      overflow-y: auto;
    }
    #family-tree {
      max-width: 480px;
      font-size: 14px;
    }
    ul.tree, ul.tree ul {
      list-style-type: none;
      padding-left: 20px;
    }
    ul.tree li {
      margin: 6px 0;
      position: relative;
      cursor: pointer;
    }
    ul.tree li:before {
      content: "";
      position: absolute;
      top: 10px;
      left: -12px;
      border-left: 1px solid #ccc;
      border-bottom: 1px solid #ccc;
      width: 12px;
      height: 12px;
    }
    ul.tree li:last-child:before {
      border-left: 1px solid transparent;
    }
    .member-label {
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
    }
    .member-label.selected {
      background-color: #1976d2;
      color: white;
    }
    #add-root-member-btn {
      margin: 20px auto;
      padding: 12px 24px;
      border-radius: 8px;
      max-width: 160px;
      display: block;
    }
    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(255 255 255 / 0.2);
      backdrop-filter: blur(6px);
      text-align: center;
      padding: 10px 0;
      font-size: 14px;
      color: #555;
      border-top: 1px solid rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<div id="login-page">
  <h2>Login to Family Tree</h2>
  <input id="username" type="email" placeholder="Email" autocomplete="username" />
  <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
  <button id="login-btn">Login</button>
  <button id="signup-btn">Sign Up</button>
  <div id="login-error"></div>
</div>

<div id="app">
  <button id="add-root-member-btn">+ Add Root Member</button>
  <div id="container">
    <div id="family-tree" tabindex="0"></div>
    <div id="member-details">
      <h3>Member Details</h3>
      <div id="details-content">Select a member to view details</div>
    </div>
  </div>
</div>

<footer>
  Family Tree App &copy; 2025
</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
  // Your Firebase config
  const firebaseConfig = {
  apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
  authDomain: "project-955237504610034331.firebaseapp.com",
  databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
  projectId: "project-955237504610034331",
  storageBucket: "project-955237504610034331.firebasestorage.app",
  messagingSenderId: "76212939677",
  appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
  measurementId: "G-RCJ4P82PVM"
};

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  const loginPage = document.getElementById('login-page');
  const app = document.getElementById('app');
  const loginBtn = document.getElementById('login-btn');
  const signupBtn = document.getElementById('signup-btn');
  const loginError = document.getElementById('login-error');
  const addRootBtn = document.getElementById('add-root-member-btn');

  const familyTreeDiv = document.getElementById('family-tree');
  const detailsContent = document.getElementById('details-content');

  let selectedMemberId = null;
  let familyTreeData = {};

  // AUTH LISTENER
  auth.onAuthStateChanged(user => {
    if (user) {
      loginPage.style.display = 'none';
      app.style.display = 'flex';
      startApp();
    } else {
      loginPage.style.display = 'flex';
      app.style.display = 'none';
      clearUI();
    }
  });

  // LOGIN
  loginBtn.addEventListener('click', () => {
    const email = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    loginError.style.display = 'none';

    auth.signInWithEmailAndPassword(email, password)
      .catch(error => {
        loginError.style.color = '#f44336';
        loginError.textContent = error.message;
        loginError.style.display = 'block';
      });
  });

  // SIGNUP
  signupBtn.addEventListener('click', () => {
    const email = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    loginError.style.display = 'none';

    auth.createUserWithEmailAndPassword(email, password)
      .then(() => {
        loginError.style.color = '#28a745';
        loginError.textContent = 'Account created! Please login.';
        loginError.style.display = 'block';
      })
      .catch(error => {
        loginError.style.color = '#f44336';
        loginError.textContent = error.message;
        loginError.style.display = 'block';
      });
  });

  // ADD ROOT MEMBER
  addRootBtn.addEventListener('click', () => {
    const newMemberRef = db.ref('familyTree').push();
    const newMember = {
      name: 'New Root Member',
      birthdate: '',
      alive: true,
      spouses: {},
      children: {}
    };
    newMemberRef.set(newMember);
  });

  // START APP & LISTEN FAMILY TREE CHANGES
  function startApp() {
    db.ref('familyTree').on('value', snapshot => {
      familyTreeData = snapshot.val() || {};
      renderFamilyTree();
      if (selectedMemberId && findMemberById(selectedMemberId)) {
        showMemberDetails(selectedMemberId);
      } else {
        selectedMemberId = null;
        detailsContent.innerHTML = 'Select a member to view details';
      }
    });
  }

  // CLEAR UI ON LOGOUT
  function clearUI() {
    familyTreeDiv.innerHTML = '';
    detailsContent.innerHTML = 'Select a member to view details';
    selectedMemberId = null;
    familyTreeData = {};
  }

  // FIND MEMBER BY ID IN THE TREE (since spouses/children are nested inside the member)
  // familyTreeData is a flat object at root level, but spouses and children are nested under each member
  // So we need to search recursively in spouses and children
  function findMemberById(id, tree = familyTreeData) {
    if (!tree) return null;
    if (tree[id]) return tree[id];
    // Search inside spouses and children of each member
    for (const mid in tree) {
      const member = tree[mid];
      // spouses
      if (member.spouses) {
        const found = findMemberById(id, member.spouses);
        if (found) return found;
      }
      // children
      if (member.children) {
        const found = findMemberById(id, member.children);
        if (found) return found;
      }
    }
    return null;
  }

  // FIND PARENT MEMBER AND RELATION TYPE (spouses or children) FOR A GIVEN MEMBER ID
  // Returns { parentId, relationType ('spouses' or 'children') } or null if root
  function findParentOfMember(id, tree = familyTreeData) {
    for (const mid in tree) {
      const member = tree[mid];
      if (member.spouses && member.spouses[id]) {
        return { parentId: mid, relationType: 'spouses' };
      }
      if (member.children && member.children[id]) {
        return { parentId: mid, relationType: 'children' };
      }
      // recursive search in spouses and children
      if (member.spouses) {
        const found = findParentOfMember(id, member.spouses);
        if (found) return found;
      }
      if (member.children) {
        const found = findParentOfMember(id, member.children);
        if (found) return found;
      }
    }
    return null;
  }

  // RENDER FAMILY TREE - recursive nested UL
  function renderFamilyTree() {
    familyTreeDiv.innerHTML = '';
    const treeUl = document.createElement('ul');
    treeUl.classList.add('tree');

    for (const id in familyTreeData) {
      const li = createMemberTreeNode(id, familyTreeData[id]);
      treeUl.appendChild(li);
    }

    familyTreeDiv.appendChild(treeUl);
  }

  // CREATE MEMBER NODE LI with recursive children and spouses
  function createMemberTreeNode(id, member) {
    const li = document.createElement('li');

    const label = document.createElement('span');
    label.textContent = member.name || '(No name)';
    label.className = 'member-label';
    if (id === selectedMemberId) label.classList.add('selected');
    label.onclick = (e) => {
      e.stopPropagation();
      selectedMemberId = id;
      renderFamilyTree();
      showMemberDetails(id);
    };
    li.appendChild(label);

    // Add spouse and children nested lists
    if ((member.spouses && Object.keys(member.spouses).length > 0) || (member.children && Object.keys(member.children).length > 0)) {
      const nestedUl = document.createElement('ul');

      // spouses
      if (member.spouses && Object.keys(member.spouses).length > 0) {
        const spousesLi = document.createElement('li');
        spousesLi.textContent = 'Spouses';
        spousesLi.style.fontWeight = 'bold';
        const spousesUl = document.createElement('ul');
        for (const spId in member.spouses) {
          spousesUl.appendChild(createMemberTreeNode(spId, member.spouses[spId]));
        }
        spousesLi.appendChild(spousesUl);
        nestedUl.appendChild(spousesLi);
      }

      // children
      if (member.children && Object.keys(member.children).length > 0) {
        const childrenLi = document.createElement('li');
        childrenLi.textContent = 'Children';
        childrenLi.style.fontWeight = 'bold';
        const childrenUl = document.createElement('ul');
        for (const chId in member.children) {
          childrenUl.appendChild(createMemberTreeNode(chId, member.children[chId]));
        }
        childrenLi.appendChild(childrenUl);
        nestedUl.appendChild(childrenLi);
      }

      li.appendChild(nestedUl);
    }

    return li;
  }

  // SHOW MEMBER DETAILS with editable form + Save & Delete buttons
  function showMemberDetails(memberId) {
    const member = findMemberById(memberId);
    if (!member) return;
    selectedMemberId = memberId;

    detailsContent.innerHTML = `
      <label>Name:<br><input type="text" id="edit-name" value="${member.name || ''}" /></label>
      <label>Birthdate:<br><input type="date" id="edit-birthdate" value="${member.birthdate || ''}" /></label>
      <label>Alive:<br>
        <select id="edit-alive">
          <option value="true" ${member.alive ? 'selected' : ''}>Yes</option>
          <option value="false" ${!member.alive ? 'selected' : ''}>No</option>
        </select>
      </label>
      <button id="save-member-btn" class="small-btn">Save</button>
      <button id="add-spouse-btn" class="small-btn">+ Add Spouse</button>
      <button id="add-child-btn" class="small-btn">+ Add Child</button>
      <button id="delete-member-btn" class="small-btn delete-btn">Delete Member</button>
    `;

    document.getElementById('save-member-btn').onclick = () => saveMember(memberId);
    document.getElementById('add-spouse-btn').onclick = () => addSpouse(memberId);
    document.getElementById('add-child-btn').onclick = () => addChild(memberId);
    document.getElementById('delete-member-btn').onclick = () => deleteMember(memberId);
  }

  // SAVE MEMBER info
  function saveMember(id) {
    const name = document.getElementById('edit-name').value.trim();
    const birthdate = document.getElementById('edit-birthdate').value;
    const alive = document.getElementById('edit-alive').value === 'true';

    if (!name) {
      alert('Name cannot be empty!');
      return;
    }

    // Find parent and update correct path in db
    const parent = findParentOfMember(id);
    let path = 'familyTree/' + id; // default for root members
    if (parent) {
      path = `familyTree/${parent.parentId}/${parent.relationType}/${id}`;
    }
    db.ref(path).update({ name, birthdate, alive })
      .then(() => {
        alert('Member saved!');
      })
      .catch(err => {
        alert('Error saving member: ' + err.message);
      });
  }

  // ADD SPOUSE
  function addSpouse(memberId) {
    const parentPath = findMemberPath(memberId);
    if (!parentPath) return alert('Cannot find member path');

    const spouseRef = db.ref(parentPath + '/spouses').push();
    const newSpouse = {
      name: 'New Spouse',
      birthdate: '',
      alive: true,
      spouses: {},
      children: {}
    };
    spouseRef.set(newSpouse);
  }

  // ADD CHILD
  function addChild(memberId) {
    const parentPath = findMemberPath(memberId);
    if (!parentPath) return alert('Cannot find member path');

    const childRef = db.ref(parentPath + '/children').push();
    const newChild = {
      name: 'New Child',
      birthdate: '',
      alive: true,
      spouses: {},
      children: {}
    };
    childRef.set(newChild);
  }

  // FIND member path string in db (like familyTree/xxxx, or familyTree/xxxx/spouses/yyy)
  function findMemberPath(id, tree = familyTreeData, currentPath = 'familyTree') {
    if (tree[id]) return currentPath + '/' + id;

    for (const mid in tree) {
      const member = tree[mid];
      if (member.spouses) {
        const found = findMemberPath(id, member.spouses, currentPath + '/' + mid + '/spouses');
        if (found) return found;
      }
      if (member.children) {
        const found = findMemberPath(id, member.children, currentPath + '/' + mid + '/children');
        if (found) return found;
      }
    }
    return null;
  }

  // DELETE MEMBER and all descendants recursively
  function deleteMember(id) {
    if (!confirm('Delete this member and all their spouses and children? This cannot be undone.')) return;

    const path = findMemberPath(id);
    if (!path) return alert('Member path not found!');

    // To delete a member including nested spouses & children we simply remove the node at path
    db.ref(path).remove()
      .then(() => {
        if (selectedMemberId === id) {
          selectedMemberId = null;
          detailsContent.innerHTML = 'Select a member to view details';
        }
      })
      .catch(err => {
        alert('Error deleting member: ' + err.message);
      });
  }

</script>

</body>
</html>
