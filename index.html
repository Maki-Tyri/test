<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Tree App</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
    color: #222;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* Container */
  #app-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: 1200px;
    margin: 20px auto;
    padding: 10px;
    background: rgba(255 255 255 / 0.85);
    border-radius: 12px;
    box-shadow: 0 8px 24px rgb(0 0 0 / 0.1);
    overflow-x: auto;
  }

  /* Login Page */
  #login-page {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  #login-page form {
    background: rgba(255 255 255 / 0.15);
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.25);
    width: 90%;
    max-width: 350px;
    backdrop-filter: blur(10px);
    color: white;
  }
  #login-page h2 {
    text-align: center;
    margin-bottom: 24px;
  }
  #login-page label {
    display: block;
    margin: 12px 0 6px;
    font-weight: 600;
  }
  #login-page input[type="email"],
  #login-page input[type="password"] {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: none;
    outline: none;
    font-size: 16px;
  }
  #login-page button {
    margin-top: 20px;
    width: 100%;
    padding: 14px;
    background: #6b5b95;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
    color: white;
    font-size: 16px;
    transition: background-color 0.3s ease;
  }
  #login-page button:hover {
    background: #8e79b7;
  }
  #login-page .error-msg {
    color: #ff6b6b;
    margin-top: 10px;
    text-align: center;
  }

  /* Family Tree */
  #family-tree {
    display: flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    padding-bottom: 60px; /* for footer space */
  }

  /* Members Container */
  #members-container {
    display: flex;
    gap: 40px;
    align-items: flex-start;
    padding: 20px;
  }

  /* Single Member Card */
  .member-card {
    background: #fff;
    border-radius: 12px;
    padding: 16px 20px;
    min-width: 250px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .member-card.spouse {
    background-color: #f4f6f8;
    margin-left: 20px;
  }
  .member-card.child {
    background-color: #e9f0f7;
    margin-left: 30px;
  }
  .member-card span.name {
    font-weight: 700;
    font-size: 1.2em;
  }
  .member-card span.detail {
    font-size: 0.9em;
    color: #555;
  }
  .member-card span.died {
    color: #d9534f;
    font-weight: 600;
  }

  /* Buttons */
  button.add-btn, button.edit-btn {
    margin-top: 6px;
    padding: 6px 10px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9em;
    font-weight: 600;
    color: white;
  }
  button.add-btn {
    background-color: #3498db;
  }
  button.add-btn:hover {
    background-color: #2980b9;
  }
  button.edit-btn {
    background-color: #27ae60;
    margin-left: 8px;
  }
  button.edit-btn:hover {
    background-color: #1e8449;
  }

  /* Connections Sidebar */
  #connections-sidebar {
    width: 250px;
    border-left: 2px solid #ccc;
    padding-left: 20px;
    overflow-y: auto;
  }
  #connections-sidebar h3 {
    margin-top: 0;
    font-size: 1.2em;
    font-weight: 700;
    border-bottom: 2px solid #3498db;
    padding-bottom: 6px;
  }
  #connections-list {
    list-style: none;
    padding-left: 0;
    font-size: 0.9em;
  }
  #connections-list li {
    margin-bottom: 12px;
  }
  #connections-list strong {
    color: #2980b9;
  }

  /* Footer */
  footer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    backdrop-filter: blur(15px);
    background: rgba(255 255 255 / 0.25);
    color: #333;
    text-align: center;
    padding: 10px 0;
    font-weight: 600;
    border-top: 1px solid rgba(0,0,0,0.1);
    user-select: none;
  }

  /* Responsive */
  @media (max-width: 900px) {
    #family-tree {
      flex-direction: column;
      overflow-x: visible;
    }
    #members-container {
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
    }
    #connections-sidebar {
      width: 100%;
      border-left: none;
      border-top: 2px solid #ccc;
      padding-left: 0;
      padding-top: 10px;
      margin-top: 20px;
    }
  }
</style>
</head>
<body>

<div id="login-page">
  <form id="login-form">
    <h2>Login to Family Tree</h2>
    <label for="email">Email</label>
    <input id="email" type="email" placeholder="Email" required />
    <label for="password">Password</label>
    <input id="password" type="password" placeholder="Password" required />
    <button type="submit">Login</button>
    <p class="error-msg" id="login-error"></p>
  </form>
</div>

<div id="app-container" style="display:none;">
  <div id="family-tree">
    <div id="members-container"></div>
    <div id="connections-sidebar">
      <h3>Connections</h3>
      <ul id="connections-list"></ul>
    </div>
  </div>
  <button id="logout-btn" style="margin-top:10px; padding:10px 16px; border:none; border-radius:8px; cursor:pointer; background:#d9534f; color:white; font-weight:600;">Logout</button>
</div>

<footer>&copy; 2025 Maki Web. All rights reserved</footer>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
    authDomain: "project-955237504610034331.firebaseapp.com",
    databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
    projectId: "project-955237504610034331",
    storageBucket: "project-955237504610034331.firebasestorage.app",
    messagingSenderId: "76212939677",
    appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
    measurementId: "G-RCJ4P82PVM"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // DOM Elements
  const loginPage = document.getElementById('login-page');
  const loginForm = document.getElementById('login-form');
  const loginError = document.getElementById('login-error');
  const appContainer = document.getElementById('app-container');
  const membersContainer = document.getElementById('members-container');
  const connectionsList = document.getElementById('connections-list');
  const logoutBtn = document.getElementById('logout-btn');

  // Keep track of members in memory
  let membersData = {};

  // --- AUTH HANDLERS ---
  auth.onAuthStateChanged(user => {
    if(user){
      loginPage.style.display = 'none';
      appContainer.style.display = 'flex';
      loadFamilyTree();
    } else {
      loginPage.style.display = 'flex';
      appContainer.style.display = 'none';
      membersContainer.innerHTML = '';
      connectionsList.innerHTML = '';
    }
  });

  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    loginError.textContent = '';
    const email = loginForm.email.value.trim();
    const password = loginForm.password.value.trim();
    auth.signInWithEmailAndPassword(email, password)
      .catch(err => {
        loginError.textContent = err.message;
      });
  });

  logoutBtn.onclick = () => {
    auth.signOut();
  };

  // --- FAMILY TREE HANDLERS ---

  // Load all members from DB once
  function loadFamilyTree(){
    db.ref('members').once('value').then(snapshot => {
      membersData = snapshot.val() || {};
      if(Object.keys(membersData).length === 0){
        // no data - prompt add root member
        membersContainer.innerHTML = `<button id="add-root-btn" style="padding:12px 20px; font-size:1.2em; cursor:pointer; border-radius:12px; background:#3498db; color:#fff; border:none;">Add Root Member</button>`;
        document.getElementById('add-root-btn').onclick = () => {
          openAddEditModal(null, null, 'member');
        };
        connectionsList.innerHTML = '';
        return;
      }
      renderMembers();
      buildConnectionsSidebar(membersData);
    });
  }

  // Recursive render function for members -> spouses -> children
  function renderMembers(){
    membersContainer.innerHTML = '';
    for(let memberId in membersData){
      const member = membersData[memberId];
      const memberCard = createMemberCard(memberId, member, 'member');
      membersContainer.appendChild(memberCard);
    }
  }

  // Create card for member/spouse/child
  // type = 'member'|'spouse'|'child'
  function createMemberCard(id, data, type){
    const card = document.createElement('div');
    card.classList.add('member-card');
    card.classList.add(type);

    // Name and dates
    const nameSpan = document.createElement('span');
    nameSpan.className = 'name';
    nameSpan.textContent = data.name || '(No name)';
    card.appendChild(nameSpan);

    const birthSpan = document.createElement('span');
    birthSpan.className = 'detail';
    birthSpan.textContent = `Born: ${data.birth || 'N/A'}`;
    card.appendChild(birthSpan);

    if(data.died){
      const diedSpan = document.createElement('span');
      diedSpan.className = 'detail died';
      diedSpan.textContent = `Died: ${data.died}`;
      card.appendChild(diedSpan);
    }

    // Buttons container
    const btnContainer = document.createElement('div');
    btnContainer.style.marginTop = '8px';

    // Edit button for all types
    const editBtn = document.createElement('button');
    editBtn.textContent = 'Edit';
    editBtn.className = 'edit-btn';
    editBtn.onclick = () => {
      openAddEditModal(id, type, 'edit');
    };
    btnContainer.appendChild(editBtn);

    // Add spouse button only for member (not for spouse or child)
    if(type === 'member'){
      const addSpouseBtn = document.createElement('button');
      addSpouseBtn.textContent = 'Add Spouse';
      addSpouseBtn.className = 'add-btn';
      addSpouseBtn.onclick = () => {
        openAddEditModal(id, 'spouse', 'add');
      };
      btnContainer.appendChild(addSpouseBtn);
    }

    // Add child button only for spouse (not for member or child)
    if(type === 'spouse'){
      const addChildBtn = document.createElement('button');
      addChildBtn.textContent = 'Add Child';
      addChildBtn.className = 'add-btn';
      addChildBtn.onclick = () => {
        openAddEditModal(id, 'child', 'add');
      };
      btnContainer.appendChild(addChildBtn);
    }

    card.appendChild(btnContainer);

    // Render spouses if member
    if(type === 'member' && data.spouses){
      for(let spouseId in data.spouses){
        const spouse = data.spouses[spouseId];
        const spouseCard = createMemberCard(spouseId, spouse, 'spouse');
        card.appendChild(spouseCard);

        // Render children if spouse has children
        if(spouse.children){
          for(let childId in spouse.children){
            const child = spouse.children[childId];
            const childCard = createMemberCard(childId, child, 'child');
            spouseCard.appendChild(childCard);
          }
        }
      }
    }

    return card;
  }

  // Build connections sidebar
  function buildConnectionsSidebar(members){
    connectionsList.innerHTML = '';
    for(let [id, data] of Object.entries(members)){
      const li = document.createElement('li');
      let text = `<strong>${data.name}</strong><br/>Born: ${data.birth || 'N/A'}`;
      if(data.died) text += `<br/>Died: ${data.died}`;

      // Spouses
      if(data.spouses){
        const spousesArr = Object.values(data.spouses);
        text += `<br/>Spouse${spousesArr.length > 1 ? 's' : ''}: `;
        text += spousesArr.map(s => s.name).join(', ');
        // Children count
        const totalChildren = spousesArr.reduce((sum,s) => sum + (s.children ? Object.keys(s.children).length : 0), 0);
        if(totalChildren) text += `<br/>Children: ${totalChildren}`;
      }

      li.innerHTML = text;
      connectionsList.appendChild(li);
    }
  }

  // --- MODAL for Add/Edit ---
  // We'll create a simple prompt-based modal for now for simplicity.
  // You can replace this with a custom modal later.

  function openAddEditModal(parentId, targetType, mode){
    // parentId = id of member or spouse we add spouse or child to or edit target's id if mode='edit'
    // targetType = 'member' | 'spouse' | 'child'
    // mode = 'add' or 'edit'

    let existingData = null;

    if(mode === 'edit'){
      // Find the target data to edit
      if(targetType === 'member'){
        existingData = membersData[parentId];
      } else if(targetType === 'spouse'){
        // Find spouse inside some member
        existingData = findSpouseById(parentId);
      } else if(targetType === 'child'){
        existingData = findChildById(parentId);
      }
    }

    const name = prompt(`Enter ${targetType} name:`, existingData ? existingData.name : '');
    if(name === null) return; // canceled

    const birth = prompt(`Enter ${targetType} birth year/date:`, existingData ? existingData.birth : '');
    if(birth === null) return;

    const died = prompt(`Enter ${targetType} died year/date (optional):`, existingData ? existingData.died || '' : '');
    if(died === null) return;

    if(mode === 'add'){
      if(targetType === 'member'){
        // Adding root member (rare)
        const newId = db.ref().child('members').push().key;
        const newMember = { name, birth, died: died || null, spouses: {} };
        db.ref(`members/${newId}`).set(newMember).then(() => {
          loadFamilyTree();
        });
      }
      else if(targetType === 'spouse'){
        // Add spouse to parentId member
        const newId = db.ref().child('members').push().key; // generate unique id
        const newSpouse = { name, birth, died: died || null, children: {} };
        // get current spouses object or empty
        const spousesRef = db.ref(`members/${parentId}/spouses`);
        spousesRef.once('value').then(snap => {
          const spouses = snap.val() || {};
          spouses[newId] = newSpouse;
          spousesRef.set(spouses).then(() => loadFamilyTree());
        });
      }
      else if(targetType === 'child'){
        // Add child to spouse with id=parentId
        // Find spouse path
        findSpouseParentAndPath(parentId).then(({ memberId, spouseKey }) => {
          if(!memberId) {
            alert('Spouse not found in DB');
            return;
          }
          const childrenRef = db.ref(`members/${memberId}/spouses/${spouseKey}/children`);
          childrenRef.once('value').then(csnap => {
            const children = csnap.val() || {};
            const newChildKey = db.ref().push().key;
            children[newChildKey] = { name, birth, died: died || null };
            childrenRef.set(children).then(() => loadFamilyTree());
          });
        });
      }
    } else if(mode === 'edit'){
      // Update existing entry
      if(targetType === 'member'){
        db.ref(`members/${parentId}`).update({ name, birth, died: died || null }).then(() => loadFamilyTree());
      } else if(targetType === 'spouse'){
        // find spouse parent and update spouse
        findSpouseParentAndPath(parentId).then(({ memberId, spouseKey }) => {
          if(!memberId) {
            alert('Spouse not found in DB');
            return;
          }
          db.ref(`members/${memberId}/spouses/${spouseKey}`).update({ name, birth, died: died || null }).then(() => loadFamilyTree());
        });
      } else if(targetType === 'child'){
        // find child parent path
        findChildParentAndPath(parentId).then(({ memberId, spouseKey, childKey }) => {
          if(!memberId) {
            alert('Child not found in DB');
            return;
          }
          db.ref(`members/${memberId}/spouses/${spouseKey}/children/${childKey}`).update({ name, birth, died: died || null }).then(() => loadFamilyTree());
        });
      }
    }
  }

  // Helpers to find spouse by id
  function findSpouseById(spouseId){
    for(let memberId in membersData){
      const member = membersData[memberId];
      if(member.spouses && member.spouses[spouseId]){
        return member.spouses[spouseId];
      }
    }
    return null;
  }

  // Helpers to find child by id
  function findChildById(childId){
    for(let memberId in membersData){
      const member = membersData[memberId];
      if(member.spouses){
        for(let spouseId in member.spouses){
          const spouse = member.spouses[spouseId];
          if(spouse.children && spouse.children[childId]){
            return spouse.children[childId];
          }
        }
      }
    }
    return null;
  }

  // Find spouse's parent memberId and key
  function findSpouseParentAndPath(spouseId){
    return new Promise(resolve => {
      for(let memberId in membersData){
        const member = membersData[memberId];
        if(member.spouses && member.spouses[spouseId]){
          resolve({ memberId, spouseKey: spouseId });
          return;
        }
      }
      resolve({ memberId: null, spouseKey: null });
    });
  }

  // Find child's parent memberId, spouseKey, and childKey
  function findChildParentAndPath(childId){
    return new Promise(resolve => {
      for(let memberId in membersData){
        const member = membersData[memberId];
        if(member.spouses){
          for(let spouseId in member.spouses){
            const spouse = member.spouses[spouseId];
            if(spouse.children && spouse.children[childId]){
              resolve({ memberId, spouseKey: spouseId, childKey: childId });
              return;
            }
          }
        }
      }
      resolve({ memberId: null, spouseKey: null, childKey: null });
    });
  }

</script>
</body>
</html>
