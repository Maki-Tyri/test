<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Tree Recursive Firebase</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; background: #f5f7fa; }
  #treeContainer { padding: 20px; display: flex; flex-wrap: wrap; gap: 16px; }
  .member-card {
    border: 1px solid #ccc; border-radius: 8px; padding: 12px; background: #fff;
    min-width: 220px; max-width: 320px; flex-grow: 1;
  }
  .member-card .name { font-weight: bold; font-size: 1.2em; }
  .member-card .detail { font-size: 0.9em; color: #555; }
  .children-container, .spouses-container { margin-left: 20px; border-left: 2px solid #ccc; padding-left: 12px; margin-top: 8px; }
  button { margin: 4px 4px 4px 0; cursor: pointer; }
  footer {
    position: fixed; bottom: 0; width: 100%; background: rgba(255 255 255 / 0.3);
    text-align: center; padding: 10px 0; backdrop-filter: blur(10px);
    font-size: 0.9em; color: #444;
  }
</style>
</head>
<body>

<div id="treeContainer">Loading family tree...</div>
<footer>&copy; 2025 Maki Web. All rights reserved</footer>

<!-- Modal for add/edit -->
<div id="modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; width:300px;">
    <h3 id="modalTitle"></h3>
    <form id="memberForm">
      <label>Name:<br><input type="text" name="name" required></label><br><br>
      <label>Birth Year:<br><input type="text" name="birth"></label><br><br>
      <label>Died Year:<br><input type="text" name="died"></label><br><br>
      <button type="submit">Save</button>
      <button type="button" id="cancelBtn">Cancel</button>
    </form>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getDatabase, ref, onValue, set, push, get, child, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
    authDomain: "project-955237504610034331.firebaseapp.com",
    databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
    projectId: "project-955237504610034331",
    storageBucket: "project-955237504610034331.firebasestorage.app",
    messagingSenderId: "76212939677",
    appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
    measurementId: "G-RCJ4P82PVM"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const treeContainer = document.getElementById('treeContainer');
  const modal = document.getElementById('modal');
  const memberForm = document.getElementById('memberForm');
  const modalTitle = document.getElementById('modalTitle');
  const cancelBtn = document.getElementById('cancelBtn');

  // State for modal
  let modalMode = 'add'; // or 'edit'
  let modalTargetPath = ''; // Firebase path to target parent or member to edit
  let modalTargetType = ''; // 'member', 'spouse', 'child'
  let modalEditId = null; // id to edit (for edit mode)

  // Recursive function to create cards
  function createMemberCard(id, data, path) {
    const card = document.createElement('div');
    card.classList.add('member-card');

    const nameSpan = document.createElement('div');
    nameSpan.className = 'name';
    nameSpan.textContent = data.name || '(No name)';
    card.appendChild(nameSpan);

    const birthSpan = document.createElement('div');
    birthSpan.className = 'detail';
    birthSpan.textContent = `Born: ${data.birth || 'N/A'}`;
    card.appendChild(birthSpan);

    if(data.died){
      const diedSpan = document.createElement('div');
      diedSpan.className = 'detail';
      diedSpan.textContent = `Died: ${data.died}`;
      card.appendChild(diedSpan);
    }

    // Buttons container
    const btnContainer = document.createElement('div');

    // Edit button
    const editBtn = document.createElement('button');
    editBtn.textContent = 'Edit';
    editBtn.onclick = () => openModal('edit', path + '/' + id, data);
    btnContainer.appendChild(editBtn);

    // Add spouse button
    const addSpouseBtn = document.createElement('button');
    addSpouseBtn.textContent = 'Add Spouse';
    addSpouseBtn.onclick = () => openModal('add', path + '/' + id + '/spouses', null);
    btnContainer.appendChild(addSpouseBtn);

    // Add child button
    const addChildBtn = document.createElement('button');
    addChildBtn.textContent = 'Add Child';
    addChildBtn.onclick = () => {
      // Children are always added under a spouse
      // So if path ends with spouses/<spouseId>, add children under that spouse
      // If path ends with memberId, no direct children allowed (children belong to spouse)
      // So we check and adjust path accordingly

      // Example path: members/memberId/spouses/spouseId
      let childPath = path + '/' + id;
      if(path.includes('/spouses/')){
        childPath += '/children';
      } else {
        alert("You can only add children under a spouse.");
        return;
      }
      openModal('add', childPath, null);
    };
    btnContainer.appendChild(addChildBtn);

    card.appendChild(btnContainer);

    // Render spouses container if any
    if(data.spouses){
      const spousesContainer = document.createElement('div');
      spousesContainer.className = 'spouses-container';
      spousesContainer.style.marginTop = '12px';

      for(const spouseId in data.spouses){
        const spouseData = data.spouses[spouseId];
        const spouseCard = createMemberCard(spouseId, spouseData, path + '/' + id + '/spouses');
        spousesContainer.appendChild(spouseCard);

        // Render children of spouse
        if(spouseData.children){
          const childrenContainer = document.createElement('div');
          childrenContainer.className = 'children-container';

          for(const childId in spouseData.children){
            const childData = spouseData.children[childId];
            // Children path is under spouses/spouseId/children
            const childCard = createMemberCard(childId, childData, path + '/' + id + '/spouses/' + spouseId + '/children');
            childrenContainer.appendChild(childCard);
          }
          spouseCard.appendChild(childrenContainer);
        }
      }
      card.appendChild(spousesContainer);
    }

    return card;
  }

  // Load whole family tree recursively
  function loadFamilyTree(){
    treeContainer.textContent = 'Loading family tree...';
    const membersRef = ref(db, 'members');
    onValue(membersRef, (snapshot) => {
      treeContainer.innerHTML = '';
      const members = snapshot.val();
      if(!members){
        treeContainer.textContent = 'No family data found.';
        return;
      }
      for(const memberId in members){
        const memberData = members[memberId];
        const card = createMemberCard(memberId, memberData, 'members');
        treeContainer.appendChild(card);
      }
    });
  }

  // Open modal for add or edit
  function openModal(mode, targetPath, data) {
    modalMode = mode;
    modalTargetPath = targetPath;

    if(mode === 'edit'){
      modalTitle.textContent = 'Edit Member';
      memberForm.name.value = data.name || '';
      memberForm.birth.value = data.birth || '';
      memberForm.died.value = data.died || '';
    } else {
      modalTitle.textContent = 'Add Member';
      memberForm.reset();
    }
    modal.style.display = 'flex';
  }

  cancelBtn.onclick = () => {
    modal.style.display = 'none';
  };

  memberForm.onsubmit = async (e) => {
    e.preventDefault();
    const name = memberForm.name.value.trim();
    if(!name) {
      alert('Name is required');
      return;
    }
    const birth = memberForm.birth.value.trim();
    const died = memberForm.died.value.trim();

    if(modalMode === 'add'){
      // push new data to target path
      const newRef = push(ref(db, modalTargetPath));
      await set(newRef, { name, birth, died });
    }
    else if(modalMode === 'edit'){
      // update data at target path
      const updateRef = ref(db, modalTargetPath);
      await update(updateRef, { name, birth, died });
    }

    modal.style.display = 'none';
  };

  loadFamilyTree();
</script>

</body>
</html>
