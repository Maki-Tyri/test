<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
    authDomain: "project-955237504610034331.firebaseapp.com",
    databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
    projectId: "project-955237504610034331",
    storageBucket: "project-955237504610034331.appspot.com",
    messagingSenderId: "76212939677",
    appId: "1:76212939677:web:ef498bc1e4e480ab6e5d74",
    measurementId: "G-WXBEP1LXTX"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  const loginSection = document.getElementById("login");
  const registerSection = document.getElementById("register");
  const chatSection = document.getElementById("chat");

  const loginBtn = document.getElementById("loginBtn");
  const registerBtn = document.getElementById("registerBtn");
  const toRegisterBtn = document.getElementById("toRegisterBtn");
  const toLoginBtn = document.getElementById("toLoginBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const loginEmail = document.getElementById("loginEmail");
  const loginPassword = document.getElementById("loginPassword");
  const registerEmail = document.getElementById("registerEmail");
  const registerPassword = document.getElementById("registerPassword");

  const displayNameInput = document.getElementById("displayNameInput");
  const saveDisplayNameBtn = document.getElementById("saveDisplayNameBtn");
  const sendBtn = document.getElementById("sendBtn");

  const messagesDiv = document.getElementById("messages");
  const chatSelect = document.getElementById("chatSelect");
  const userOptions = document.getElementById("userOptions");
  const groupOptions = document.getElementById("groupOptions");
  const messageInput = document.getElementById("messageInput");
  const mediaInput = document.getElementById("mediaInput");
  const typingIndicator = document.getElementById("typingIndicator");

  let currentUser = null;
  let selectedChatId = null;
  let isGroupChat = false;
  let messagesRef = null;
  let typingTimeout;

  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      showSection(chatSection);
      logoutBtn.style.display = "block";
      joinEveryoneGroup(user.uid);
      populateChatList();
    } else {
      showSection(loginSection);
      logoutBtn.style.display = "none";
    }
  });

  function showSection(section) {
    loginSection.classList.remove("active");
    registerSection.classList.remove("active");
    chatSection.classList.remove("active");
    section.classList.add("active");
  }

  loginBtn.onclick = () => {
    auth.signInWithEmailAndPassword(loginEmail.value, loginPassword.value)
      .catch(e => alert("Login failed: " + e.message));
  };

  registerBtn.onclick = () => {
    auth.createUserWithEmailAndPassword(registerEmail.value, registerPassword.value)
      .catch(e => alert("Registration failed: " + e.message));
  };

  logoutBtn.onclick = () => auth.signOut();

  toRegisterBtn.onclick = () => showSection(registerSection);
  toLoginBtn.onclick = () => showSection(loginSection);

  function joinEveryoneGroup(uid) {
    const everyoneRef = db.ref("groups/everyone");
    everyoneRef.once("value").then(snap => {
      let group = snap.val();
      if (!group) {
        everyoneRef.set({ name: "Everyone", members: [uid] });
      } else if (!group.members.includes(uid)) {
        group.members.push(uid);
        everyoneRef.child("members").set(group.members);
      }
    });
  }

  function populateChatList() {
    userOptions.innerHTML = "";
    groupOptions.innerHTML = "";

    db.ref("users").once("value", snap => {
      snap.forEach(child => {
        if (child.key !== currentUser.uid) {
          const opt = document.createElement("option");
          opt.value = child.key;
          opt.textContent = child.val().displayName || child.val().email || child.key;
          userOptions.appendChild(opt);
        }
      });
    });

    db.ref("groups").once("value", snap => {
      snap.forEach(child => {
        const group = child.val();
        if (group.members && group.members.includes(currentUser.uid)) {
          const opt = document.createElement("option");
          opt.value = "group:" + child.key;
          opt.textContent = group.name || child.key;
          groupOptions.appendChild(opt);
        }
      });
    });
  }

  chatSelect.onchange = () => {
    const val = chatSelect.value;
    if (!val) return;

    isGroupChat = val.startsWith("group:");
    selectedChatId = isGroupChat ? val.slice(6) : val;

    if (messagesRef) messagesRef.off();

    messagesDiv.innerHTML = "";

    messagesRef = db.ref((isGroupChat ? "groupMessages" : "messages") + "/" + selectedChatId);
    messagesRef.on("child_added", snap => {
      displayMessage(snap.val());
    });
  };

  sendBtn.onclick = async () => {
    if (!selectedChatId) return;
    const text = messageInput.value.trim();
    const file = mediaInput.files[0];

    if (!text && !file) return;

    const msg = {
      sender: currentUser.uid,
      senderName: currentUser.displayName || currentUser.email,
      timestamp: Date.now()
    };

    if (text) msg.text = text;

    if (file) {
      const fileRef = storage.ref().child("media/" + Date.now() + "_" + file.name);
      await fileRef.put(file);
      msg.mediaUrl = await fileRef.getDownloadURL();
    }

    db.ref((isGroupChat ? "groupMessages" : "messages") + "/" + selectedChatId).push(msg);
    messageInput.value = "";
    mediaInput.value = "";
  };

  messageInput.addEventListener("input", () => {
    if (!selectedChatId || isGroupChat) return;
    db.ref("typing/" + selectedChatId).set(currentUser.displayName || currentUser.email);
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
      db.ref("typing/" + selectedChatId).remove();
    }, 2000);
  });

  function displayMessage(msg) {
    const div = document.createElement("div");
    div.className = "message";
    if (msg.sender === currentUser.uid) div.classList.add("self");

    const senderName = document.createElement("div");
    senderName.className = "sender";
    senderName.textContent = msg.senderName || msg.sender;
    div.appendChild(senderName);

    if (msg.text) {
      const text = document.createElement("div");
      text.textContent = msg.text;
      div.appendChild(text);
    }

    if (msg.mediaUrl) {
      const link = document.createElement("a");
      link.href = msg.mediaUrl;
      link.target = "_blank";
      link.className = "media-link";
      link.textContent = "ðŸ“Ž Media file";
      div.appendChild(link);
    }

    if (msg.timestamp) {
      const ts = document.createElement("div");
      ts.className = "timestamp";
      const date = new Date(msg.timestamp);
      ts.textContent = date.toLocaleString();
      div.appendChild(ts);
    }

    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  saveDisplayNameBtn.onclick = () => {
    const name = displayNameInput.value.trim();
    if (name && currentUser) {
      currentUser.updateProfile({ displayName: name });
      db.ref("users/" + currentUser.uid).set({
        email: currentUser.email,
        displayName: name
      });
      alert("Display name updated!");
    }
  };
</script>
