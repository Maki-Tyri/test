<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Tree with Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

    window.firebaseImports = { initializeApp, getDatabase, ref, onValue, set, update };
  </script>
  <style>
    .highlight {
      background-color: #ffe58f;
      border-radius: 0.25rem;
      box-shadow: 0 0 8px 2px #ffd666aa;
      animation: none;
    }

    .blink-highlight {
      animation: blink 1s infinite;
      background-color: #ffd666;
      border-radius: 0.25rem;
      box-shadow: 0 0 8px 2px #ffb700cc;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .children-container {
      transition: max-height 0.3s ease, opacity 0.3s ease;
      overflow: hidden;
    }

    /* Box style for nodes and spouses */
    .node-box {
      border: 2px solid #93c5fd; /* Tailwind blue-400 */
      border-radius: 0.5rem;
      padding: 0.25rem 0.5rem;
      margin-bottom: 0.5rem;
      background: white;
      display: inline-block;
      box-shadow: 0 2px 6px rgb(147 197 253 / 0.5);
      position: relative;
      max-width: max-content;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
    }

    /* Lines connecting nodes */
    .tree-node-container {
      border-left: 2px solid #93c5fd;
      margin-left: 1rem;
      padding-left: 1rem;
    }

    /* Scroll container */
    #tree-scroll-container {
      width: 100%;
      max-width: 100vw;
      height: 70vh;
      overflow: auto;
      border: 1px solid #cbd5e1; /* Tailwind gray-300 */
      border-radius: 0.5rem;
      padding: 1rem;
      background: #f9fafb;
      box-sizing: border-box;
      user-select: none;
    }

    /* Buttons */
    .toggle-expand-btn {
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      background-color: #3b82f6; /* blue-500 */
      color: white;
      font-weight: 600;
      border-radius: 0.375rem;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    .toggle-expand-btn:hover {
      background-color: #2563eb; /* blue-600 */
    }

    /* Input fields for editing inside node box */
    .node-box input[type="text"] {
      border: 1px solid #60a5fa; /* blue-400 */
      border-radius: 0.25rem;
      padding: 0 0.25rem;
      font-weight: 600;
      width: auto;
      max-width: 100%;
    }

    /* Spouse box tweak */
    .spouse-box {
      border: 2px solid #34d399; /* Tailwind green-400 */
      border-radius: 0.5rem;
      padding: 0.25rem 0.5rem;
      margin-bottom: 0.5rem;
      background: white;
      display: inline-block;
      box-shadow: 0 2px 6px rgb(52 211 153 / 0.5);
      position: relative;
      max-width: max-content;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      font-style: italic;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
    }
    .spouse-box input[type="text"] {
      border: 1px solid #6ee7b7; /* green-300 */
      border-radius: 0.25rem;
      padding: 0 0.25rem;
      font-style: italic;
      font-weight: 600;
      width: auto;
      max-width: 100%;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">
  <div id="root" class="w-full max-w-6xl bg-white p-6 rounded shadow"></div>

  <script type="text/babel">

    const { useState, useEffect, useRef } = React;

    // Firebase config - replace with your own or use this one
    const firebaseConfig = {
      apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
      authDomain: "project-955237504610034331.firebaseapp.com",
      databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
      projectId: "project-955237504610034331",
      storageBucket: "project-955237504610034331.firebasestorage.app",
      messagingSenderId: "76212939677",
      appId: "1:76212939677:web:cc36cc1cadfd106b6e5d74",
      measurementId: "G-RCJ4P82PVM"
    };

    const {
      initializeApp,
      getDatabase,
      ref,
      onValue,
      set,
      update,
    } = window.firebaseImports;

    // Init Firebase app and database
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let nextId = 1000; // For new ids

    // EditableField component - for editing birthdays etc
    function EditableField({ label, value, type = "text", onChange }) {
      const [editing, setEditing] = useState(false);
      const [tempValue, setTempValue] = useState(value || "");

      function save() {
        onChange(tempValue);
        setEditing(false);
      }

      return (
        <div className="flex items-center space-x-1 text-sm text-gray-700">
          <span className="font-semibold">{label}:</span>
          {editing ? (
            type === "date" ? (
              <input
                type="date"
                value={tempValue}
                onChange={e => setTempValue(e.target.value)}
                onBlur={save}
                onKeyDown={e => { if (e.key === "Enter") save(); }}
                autoFocus
                className="border border-gray-300 rounded px-1 py-0.5 w-32"
              />
            ) : (
              <input
                type="text"
                value={tempValue}
                onChange={e => setTempValue(e.target.value)}
                onBlur={save}
                onKeyDown={e => { if (e.key === "Enter") save(); }}
                autoFocus
                className="border border-gray-300 rounded px-1 py-0.5 w-32"
              />
            )
          ) : (
            <span
              className="cursor-pointer hover:text-blue-600"
              onClick={() => setEditing(true)}
              title={`Click to edit ${label.toLowerCase()}`}
            >
              {value || <em className="text-gray-400">(none)</em>}
            </span>
          )}
        </div>
      );
    }

    function SpouseItem({ spouse, onUpdate, onDelete, highlight, blink }) {
      const [editName, setEditName] = useState(false);
      const [tempName, setTempName] = useState(spouse.name);
      const [showDates, setShowDates] = useState(false);

      function saveName() {
        onUpdate({ ...spouse, name: tempName });
        setEditName(false);
      }

      function updateField(field, val) {
        onUpdate({ ...spouse, [field]: val });
      }

      return (
        <div
          className={`spouse-box ${
            highlight ? "highlight" : ""
          } ${blink ? "blink-highlight" : ""}`}
          style={{ minWidth: "100px", maxWidth: "280px" }}
          title="Spouse - click to toggle details, double click to edit name"
        >
          {editName ? (
            <input
              type="text"
              value={tempName}
              onChange={e => setTempName(e.target.value)}
              onBlur={saveName}
              onKeyDown={e => {
                if (e.key === "Enter") saveName();
                if (e.key === "Escape") {
                  setTempName(spouse.name);
                  setEditName(false);
                }
              }}
              autoFocus
              className="bg-white border border-green-400 rounded px-1 py-0.5 font-semibold italic w-full"
            />
          ) : (
            <span
              onDoubleClick={() => setEditName(true)}
              onClick={() => setShowDates(!showDates)}
              className="select-none"
            >
              {spouse.name}
            </span>
          )}
          {showDates && (
            <div className="mt-1 space-y-0.5">
              <EditableField
                label="Born"
                value={spouse.born}
                onChange={val => updateField("born", val)}
                type="date"
              />
              <EditableField
                label="Died"
                value={spouse.died}
                onChange={val => updateField("died", val)}
                type="date"
              />
              <button
                onClick={() => onDelete(spouse.id)}
                className="text-red-600 text-xs font-semibold mt-1 hover:underline"
                title="Remove spouse"
              >
                Remove spouse
              </button>
            </div>
          )}
        </div>
      );
    }

    function FamilyMember({
      member,
      path,
      data,
      onUpdateMember,
      onAddChild,
      onAddSpouse,
      onDeleteSpouse,
      highlightAncestors,
      highlightSearched,
      blinkSearched,
      expandedMap,
      toggleExpand,
      searchId,
    }) {
      const [editName, setEditName] = useState(false);
      const [tempName, setTempName] = useState(member.name);
      const [showDates, setShowDates] = useState(false);

      // Highlight if this member is an ancestor or is searched
      const isHighlight = highlightAncestors || highlightSearched;
      const isBlink = blinkSearched;

      function saveName() {
        onUpdateMember(path, { ...member, name: tempName });
        setEditName(false);
      }

      function updateField(field, val) {
        onUpdateMember(path, { ...member, [field]: val });
      }

      function handleAddChild() {
        onAddChild(path);
      }

      function handleAddSpouse() {
        onAddSpouse(path);
      }

      function handleDeleteSpouse(spouseId) {
        onDeleteSpouse(path, spouseId);
      }

      // Toggle expanded state for children
      const expanded = expandedMap[path] ?? true;

      return (
        <div className="mb-3">
          <div
            className={`node-box ${
              isHighlight ? "highlight" : ""
            } ${isBlink ? "blink-highlight" : ""}`}
            onClick={() => toggleExpand(path)}
            title="Click to expand/collapse children, double click name to edit"
          >
            {editName ? (
              <input
                type="text"
                value={tempName}
                onChange={e => setTempName(e.target.value)}
                onBlur={saveName}
                onKeyDown={e => {
                  if (e.key === "Enter") saveName();
                  if (e.key === "Escape") {
                    setTempName(member.name);
                    setEditName(false);
                  }
                }}
                autoFocus
                className="bg-white border border-blue-400 rounded px-1 py-0.5 font-semibold w-full max-w-[200px]"
              />
            ) : (
              <span
                onDoubleClick={e => {
                  e.stopPropagation();
                  setEditName(true);
                }}
              >
                {member.name || <em className="text-gray-400">(Unnamed)</em>}
              </span>
            )}
            <button
              onClick={e => {
                e.stopPropagation();
                setShowDates(!showDates);
              }}
              className="ml-2 text-xs text-gray-500 hover:text-blue-500"
              title="Toggle birth/death dates"
            >
              ðŸ“…
            </button>
          </div>
          {showDates && (
            <div className="ml-1 mt-1 space-y-1 text-xs text-gray-700">
              <EditableField
                label="Born"
                value={member.born}
                onChange={val => updateField("born", val)}
                type="date"
              />
              <EditableField
                label="Died"
                value={member.died}
                onChange={val => updateField("died", val)}
                type="date"
              />
            </div>
          )}

          {/* Spouses */}
          <div className="ml-6 mt-2 space-x-2 flex flex-wrap">
            {(member.spouses || []).map(spouse => (
              <SpouseItem
                key={spouse.id}
                spouse={spouse}
                onUpdate={updatedSpouse => {
                  // Update spouse in member
                  const newSpouses = (member.spouses || []).map(s =>
                    s.id === updatedSpouse.id ? updatedSpouse : s
                  );
                  onUpdateMember(path, { ...member, spouses: newSpouses });
                }}
                onDelete={handleDeleteSpouse}
                highlight={false}
                blink={false}
              />
            ))}
            <button
              onClick={handleAddSpouse}
              className="text-green-600 font-semibold text-sm hover:underline"
              title="Add spouse"
            >
              + Spouse
            </button>
          </div>

          {/* Children */}
          <div
            className="tree-node-container children-container"
            style={{
              maxHeight: expanded ? "2000px" : "0",
              opacity: expanded ? 1 : 0,
            }}
          >
            {(member.children || []).map((child, idx) => (
              <FamilyMember
                key={child.id}
                member={child}
                path={`${path}.children.${idx}`}
                data={data}
                onUpdateMember={onUpdateMember}
                onAddChild={onAddChild}
                onAddSpouse={onAddSpouse}
                onDeleteSpouse={onDeleteSpouse}
                highlightAncestors={highlightAncestors || false}
                highlightSearched={searchId === child.id}
                blinkSearched={searchId === child.id}
                expandedMap={expandedMap}
                toggleExpand={toggleExpand}
                searchId={searchId}
              />
            ))}
            <button
              onClick={handleAddChild}
              className="mt-2 text-blue-600 font-semibold text-sm hover:underline"
              title="Add child"
            >
              + Child
            </button>
          </div>
        </div>
      );
    }

    // Helper: deep update nested object by path string "root.children.1.children.0"
    function updateNested(data, path, newMember) {
      if (!path) return newMember;
      const parts = path.split(".");
      const copy = Array.isArray(data) ? [...data] : { ...data };
      let current = copy;
      for (let i = 0; i < parts.length - 1; i++) {
        const key = parts[i];
        if (key.match(/^\d+$/)) {
          current[key] = Array.isArray(current[key]) ? [...current[key]] : { ...current[key] };
          current = current[key];
        } else {
          current[key] = current[key] ? (Array.isArray(current[key]) ? [...current[key]] : { ...current[key] }) : {};
          current = current[key];
        }
      }
      current[parts[parts.length - 1]] = newMember;
      return copy;
    }

    // Helper: get nested object by path string
    function getNested(data, path) {
      if (!path) return data;
      const parts = path.split(".");
      let current = data;
      for (let p of parts) {
        if (!current) return null;
        current = current[p];
      }
      return current;
    }

    // Find ancestors path of searchedId, returns set of ids
    function findAncestors(data, searchedId, ancestors = new Set()) {
      if (!data) return ancestors;
      if (data.id === searchedId) return ancestors;

      if (data.children && data.children.length > 0) {
        for (let child of data.children) {
          if (child.id === searchedId) {
            ancestors.add(data.id);
            return ancestors;
          }
          if (child) {
            const found = findAncestors(child, searchedId, ancestors);
            if (found && found.has(child.id)) {
              ancestors.add(data.id);
              return ancestors;
            }
          }
        }
      }
      return ancestors;
    }

    // Main App
    function App() {
      const [treeData, setTreeData] = useState(null);
      const [expandedMap, setExpandedMap] = useState({});
      const [searchTerm, setSearchTerm] = useState("");
      const [searchId, setSearchId] = useState(null);
      const treeContainerRef = useRef(null);

      // Load data from Firebase on mount
      useEffect(() => {
        const dbRef = ref(database, "familyTree");
        onValue(dbRef, (snapshot) => {
          const val = snapshot.val();
          if (val) {
            setTreeData(val);
          } else {
            // If no data, initialize a default root
            const root = {
              id: "root",
              name: "Root Person",
              born: "",
              died: "",
              spouses: [],
              children: []
            };
            set(treeRef(), root);
            setTreeData(root);
          }
        });
      }, []);

      // Write updated data back to Firebase
      function updateTreeData(newData) {
        setTreeData(newData);
        const treeRef = ref(database, "familyTree");
        set(treeRef, newData);
      }

      // Update member data at path
      function onUpdateMember(path, updatedMember) {
        const newData = updateNested(treeData, path, updatedMember);
        updateTreeData(newData);
      }

      // Add child at given parent path
      function onAddChild(path) {
        const parent = getNested(treeData, path);
        if (!parent) return;
        const newChild = {
          id: `id_${Date.now()}_${nextId++}`,
          name: "New Child",
          born: "",
          died: "",
          spouses: [],
          children: []
        };
        const updatedChildren = [...(parent.children || []), newChild];
        const updatedParent = { ...parent, children: updatedChildren };
        const newData = updateNested(treeData, path, updatedParent);
        updateTreeData(newData);
        setExpandedMap(m => ({ ...m, [path]: true })); // auto expand parent
      }

      // Add spouse at given member path
      function onAddSpouse(path) {
        const member = getNested(treeData, path);
        if (!member) return;
        const newSpouse = {
          id: `spouse_${Date.now()}_${nextId++}`,
          name: "New Spouse",
          born: "",
          died: ""
        };
        const updatedSpouses = [...(member.spouses || []), newSpouse];
        const updatedMember = { ...member, spouses: updatedSpouses };
        const newData = updateNested(treeData, path, updatedMember);
        updateTreeData(newData);
      }

      // Delete spouse by id at member path
      function onDeleteSpouse(path, spouseId) {
        const member = getNested(treeData, path);
        if (!member) return;
        const updatedSpouses = (member.spouses || []).filter(s => s.id !== spouseId);
        const updatedMember = { ...member, spouses: updatedSpouses };
        const newData = updateNested(treeData, path, updatedMember);
        updateTreeData(newData);
      }

      // Toggle expand/collapse at path
      function toggleExpand(path) {
        setExpandedMap(m => ({ ...m, [path]: !m[path] }));
      }

      // Find id by search term (name)
      function handleSearch() {
        if (!treeData || !searchTerm.trim()) {
          setSearchId(null);
          return;
        }

        // Search tree for first member with name matching searchTerm (case insensitive)
        function searchTree(node) {
          if (!node) return null;
          if (node.name.toLowerCase().includes(searchTerm.toLowerCase())) {
            return node.id;
          }
          if (node.children && node.children.length > 0) {
            for (const child of node.children) {
              const found = searchTree(child);
              if (found) return found;
            }
          }
          return null;
        }

        const foundId = searchTree(treeData);
        setSearchId(foundId);
      }

      // Find ancestor ids of searched member for highlighting
      const ancestorsSet = searchId ? findAncestors(treeData, searchId) : new Set();

      // Auto scroll to searched member on searchId change
      useEffect(() => {
        if (!searchId) return;
        // We cannot directly scroll to the element because IDs aren't DOM ids
        // Instead, scroll the container top to show it approx by querying node boxes with highlight/blink classes
        if (treeContainerRef.current) {
          const container = treeContainerRef.current;
          const blinkElements = container.querySelectorAll(".blink-highlight");
          if (blinkElements.length > 0) {
            blinkElements[0].scrollIntoView({ behavior: "smooth", block: "center" });
          }
        }
      }, [searchId]);

      if (!treeData) return <div>Loading family tree...</div>;

      return (
        <div>
          <h1 className="text-3xl font-bold mb-4 text-center text-blue-700">
            Family Tree Editor (Firebase Sync)
          </h1>

          <div className="mb-4 flex items-center justify-center space-x-2">
            <input
              type="text"
              placeholder="Search by name"
              value={searchTerm}
              onChange={e => setSearchTerm(e.target.value)}
              onKeyDown={e => { if (e.key === "Enter") handleSearch(); }}
              className="border border-gray-300 rounded px-3 py-1 w-64"
              aria-label="Search family member by name"
            />
            <button
              onClick={handleSearch}
              className="bg-blue-600 text-white rounded px-4 py-1 hover:bg-blue-700"
              aria-label="Search button"
            >
              Search
            </button>
            <button
              onClick={() => {
                setSearchTerm("");
                setSearchId(null);
              }}
              className="bg-gray-300 text-gray-700 rounded px-3 py-1 hover:bg-gray-400"
              aria-label="Clear search"
            >
              Clear
            </button>
          </div>

          <div
            id="tree-scroll-container"
            ref={treeContainerRef}
            role="tree"
            aria-label="Family tree"
            tabIndex={0}
          >
            <FamilyMember
              member={treeData}
              path=""
              data={treeData}
              onUpdateMember={onUpdateMember}
              onAddChild={onAddChild}
              onAddSpouse={onAddSpouse}
              onDeleteSpouse={onDeleteSpouse}
              highlightAncestors={ancestorsSet.has(treeData.id)}
              highlightSearched={searchId === treeData.id}
              blinkSearched={searchId === treeData.id}
              expandedMap={expandedMap}
              toggleExpand={toggleExpand}
              searchId={searchId}
            />
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
